"use strict";function CEntitiesView(e){this.bToolbarDisabled=App.getUserRole()===Enums.UserRole.TenantAdmin&&"Tenant"===e,Cache.selectedTenantId.subscribe(function(){"Tenant"!==this.sType&&this.requestEntities()},this),this.sType=e,this.oEntityCreateView=EntitiesTabs.getEditView(this.sType),this.oEntityData=EntitiesTabs.getEntityData(this.sType),this.sActionCreateText=this.oEntityData.ActionCreateText,this.sNoEntitiesFoundText=this.oEntityData.NoEntitiesFoundText,this.entities=ko.observableArray([]),this.aFilters=[],this.initFilters(),this.errorMessage=ko.observable(""),this.totalEntitiesCount=ko.observable(0),this.current=ko.observable(0),this.showCreateForm=ko.observable(!1),this.isCreating=ko.observable(!1),this.hasSelectedEntity=ko.computed(function(){var e=_.map(this.entities(),function(e){return e.Id});return-1!==_.indexOf(e,this.current())},this),this.justCreatedId=ko.observable(0),this.fChangeEntityHandler=function(){},ko.computed(function(){0===this.justCreatedId()&&!this.showCreateForm()&&!this.hasSelectedEntity()&&this.entities().length>0&&this.fChangeEntityHandler(this.sType,this.entities()[0].Id)},this).extend({throttle:1}),this.checkedEntities=ko.computed(function(){return _.filter(this.entities(),function(e){return e.checked()},this)},this),this.hasCheckedEntities=ko.computed(function(){return this.checkedEntities().length>0},this),this.deleteCommand=Utils.createCommand(this,this.deleteCheckedEntities,this.hasCheckedEntities),this.selectedCount=ko.computed(function(){return this.checkedEntities().length},this),this.searchValue=ko.observable(""),this.newSearchValue=ko.observable(""),this.isSearchFocused=ko.observable(!1),this.loading=ko.observable(!1),this.searchText=ko.computed(function(){return TextUtils.i18n("%MODULENAME%/INFO_SEARCH_RESULT",{SEARCH:this.searchValue()})},this),this.oPageSwitcher=new CPageSwitcherView(0,Settings.EntitiesPerPage),this.oPageSwitcher.currentPage.subscribe(function(){this.requestEntities()},this),this.totalEntitiesCount.subscribe(function(){this.oPageSwitcher.setCount(this.totalEntitiesCount())},this),this.aIdListDeleteProcess=[],this.aAdditionalButtons=[],this.initAdditionalButtons()}var _=require("underscore"),ko=require("knockout"),TextUtils=require("%PathToCoreWebclientModule%/js/utils/Text.js"),Types=require("%PathToCoreWebclientModule%/js/utils/Types.js"),Utils=require("%PathToCoreWebclientModule%/js/utils/Common.js"),Ajax=require("%PathToCoreWebclientModule%/js/Ajax.js"),Api=require("%PathToCoreWebclientModule%/js/Api.js"),App=require("%PathToCoreWebclientModule%/js/App.js"),Screens=require("%PathToCoreWebclientModule%/js/Screens.js"),CPageSwitcherView=require("%PathToCoreWebclientModule%/js/views/CPageSwitcherView.js"),Popups=require("%PathToCoreWebclientModule%/js/Popups.js"),ConfirmPopup=require("%PathToCoreWebclientModule%/js/popups/ConfirmPopup.js"),Cache=require("modules/%ModuleName%/js/Cache.js"),EntitiesTabs=require("modules/%ModuleName%/js/EntitiesTabs.js"),Settings=require("modules/%ModuleName%/js/Settings.js");CEntitiesView.prototype.ViewTemplate="%ModuleName%_EntitiesView",CEntitiesView.prototype.CreateFormViewTemplate="%ModuleName%_EntityCreateFormView",CEntitiesView.prototype.onShow=function(){this.bShown=!0,this.requestEntities()},CEntitiesView.prototype.onHide=function(){this.bShown=!1},CEntitiesView.prototype.search=function(){this.oPageSwitcher.setPage(1,Settings.EntitiesPerPage),this.requestEntities()},CEntitiesView.prototype.clearSearch=function(){this.newSearchValue(""),this.requestEntities()},CEntitiesView.prototype.initFilters=function(){_.each(this.oEntityData.Filters,function(e){var t={list:ko.computed(function(){var t=[];return _.isFunction(e.mList)?(t=e.mList(),_.isArray(t)||(t=[])):_.isArray(e.mList)&&(t=e.mList),t.length>0&&(e.sAllText&&t.unshift({text:e.sAllText,value:-1}),e.sNotInAnyText&&t.push({text:e.sNotInAnyText,value:0})),t},this),selectedValue:ko.observable(-1),requestValue:ko.observable(-1),sAllText:e.sAllText,sFileld:e.sField,sEntity:e.sEntity};t.selectedValue.subscribe(function(){t.sEntity?this.fChangeEntityHandler(t.sEntity,t.selectedValue()):t.requestValue(t.selectedValue())},this),t.requestValue.subscribe(function(){this.requestEntities()},this),this.aFilters.push(t)}.bind(this))},CEntitiesView.prototype.initAdditionalButtons=function(){_.each(this.oEntityData.AdditionalButtons,function(e){e&&e.ButtonView&&(_.isFunction(e.ButtonView.init)&&e.ButtonView.init(this.hasCheckedEntities,this.checkedEntities),this.aAdditionalButtons.push(e))}.bind(this))},CEntitiesView.prototype.requestEntities=function(){if(this.bShown&&("Tenant"===this.sType||Types.isPositiveNumber(Cache.selectedTenantId()))){var e=this.sType,t={TenantId:Cache.selectedTenantId(),Type:e,Offset:(this.oPageSwitcher.currentPage()-1)*Settings.EntitiesPerPage,Limit:Settings.EntitiesPerPage,Search:this.newSearchValue()};_.each(this.aFilters,function(e){t[e.sFileld]=e.requestValue()}),this.searchValue(this.newSearchValue()),this.loading(!0),this.errorMessage(""),Ajax.send(this.oEntityData.ServerModuleName,this.oEntityData.GetListRequest,t,function(t){if(this.loading(!1),t.Result){var i=_.isArray(t.Result.Items)?t.Result.Items:[],s=[],n=Types.pInt(t.Result.Count);_.each(i,function(t){t&&t.Id&&(t.Id=Types.pInt(t.Id),t.bItsMe="Tenant"===e&&t.Id===App.getTenantId()||"User"===e&&t.Id===App.getUserId(),t.checked=ko.observable(!1),t.trottleChecked=function(e,t){t.stopPropagation(),this.bItsMe||this.checked(!this.checked())},s.push(t))}),this.entities(s),this.totalEntitiesCount(n),0===this.entities().length?this.fChangeEntityHandler(e,void 0,"create"):0!==this.justCreatedId()&&this.fChangeEntityHandler(e,this.justCreatedId()),this.aIdListDeleteProcess=[]}else Types.isNonEmptyString(t.ErrorMessage)?this.errorMessage(t.ErrorMessage):Api.showErrorByCode(t),this.entities([])},this)}},CEntitiesView.prototype.setChangeEntityHandler=function(e){this.fChangeEntityHandler=e},CEntitiesView.prototype.changeEntity=function(e,t){_.each(this.aFilters,function(e){t[e.sEntity]?(e.selectedValue(t[e.sEntity]),e.requestValue(t[e.sEntity])):-1===e.requestValue()&&0===e.requestValue()||(-1===e.selectedValue()||0===e.selectedValue()?e.requestValue(e.selectedValue()):(e.selectedValue(-1),e.requestValue(-1)))}.bind(this)),this.current(Types.pInt(e)),this.justCreatedId(0)},CEntitiesView.prototype.openCreateForm=function(){this.showCreateForm(!0),this.oEntityCreateView.clearFields()},CEntitiesView.prototype.cancelCreatingEntity=function(){this.showCreateForm(!1)},CEntitiesView.prototype.createEntity=function(){if(this.oEntityCreateView&&("Tenant"===this.sType||Types.isPositiveNumber(Cache.selectedTenantId()))&&(!_.isFunction(this.oEntityCreateView.isValidSaveData)||this.oEntityCreateView.isValidSaveData())){var e=this.oEntityCreateView.getParametersForSave();e.TenantId=Cache.selectedTenantId(),this.isCreating(!0),Ajax.send(this.oEntityData.ServerModuleName,this.oEntityData.CreateRequest,e,function(e){e.Result?(Screens.showReport(this.oEntityData.ReportSuccessCreateText),this.justCreatedId(Types.pInt(e.Result)),this.oEntityCreateView.updateSavedState(),this.cancelCreatingEntity()):Api.showErrorByCode(e,this.oEntityData.ErrorCreateText),this.requestEntities(),this.isCreating(!1)},this),this.oEntityCreateView.clearFields()}},CEntitiesView.prototype.deleteCurrentEntity=function(){this.deleteEntities([this.current()])},CEntitiesView.prototype.deleteCheckedEntities=function(){var e=_.map(this.checkedEntities(),function(e){return e.Id});this.deleteEntities(e)},CEntitiesView.prototype.deleteEntities=function(e){if(this.oEntityData.DeleteRequest&&(Types.isNonEmptyArray(this.aIdListDeleteProcess)?(e=_.difference(e,this.aIdListDeleteProcess),this.aIdListDeleteProcess=_.union(e,this.aIdListDeleteProcess)):this.aIdListDeleteProcess=e,e.length>0)){var t="",i=1===e.length?_.find(this.entities(),function(t){return t.Id===e[0]}):null,s={Type:this.sType,Count:e.length,ConfirmText:TextUtils.i18n(this.oEntityData.ConfirmDeleteLangConst,{},null,e.length)};i&&(t=i.Name||i.PublicId),App.broadcastEvent("ConfirmDeleteEntity::before",s),Popups.showPopup(ConfirmPopup,[s.ConfirmText,_.bind(this.confirmedDeleteEntities,this,e),t,TextUtils.i18n("COREWEBCLIENT/ACTION_DELETE")])}},CEntitiesView.prototype.confirmedDeleteEntities=function(e,t){if(t&&Types.isPositiveNumber(Cache.selectedTenantId())){var i={TenantId:Cache.selectedTenantId(),Type:this.sType,IdList:e,DeletionConfirmedByAdmin:!0};Ajax.send(this.oEntityData.ServerModuleName,this.oEntityData.DeleteRequest,i,function(t){t.Result?Screens.showReport(TextUtils.i18n(this.oEntityData.ReportSuccessDeleteLangConst,{},null,e.length)):Screens.showError(TextUtils.i18n(this.oEntityData.ErrorDeleteLangConst,{},null,e.length)),this.requestEntities()},this)}else this.aIdListDeleteProcess=[]},CEntitiesView.prototype.groupCheck=function(){var e=!this.hasCheckedEntities();_.each(this.entities(),function(t){t.bItsMe||t.checked(e)})},module.exports=CEntitiesView;