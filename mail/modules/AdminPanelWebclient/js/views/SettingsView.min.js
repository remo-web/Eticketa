"use strict";function CSettingsView(){CAbstractScreenView.call(this,"%ModuleName%"),this.tenants=Cache.tenants,this.selectedTenant=Cache.selectedTenant,this.currentEntityType=ko.observable(""),this.currentEntitiesId=ko.observable({}),this.lastSavedEntitiesId=ko.observable({}),this.showTenantsSelector=ko.computed(function(){return Settings.EnableMultiTenant&&this.tenants().length>1},this),this.bShowLogout=App.getUserRole()===Enums.UserRole.SuperAdmin,this.aScreens=[],App.getUserRole()===Enums.UserRole.SuperAdmin&&this.aScreens.push({linkHash:ko.observable(Routing.buildHashFromArray(Links.get(""))),sLinkText:Text.i18n("%MODULENAME%/HEADING_SYSTEM_SETTINGS_TABNAME"),sType:"",oView:null}),_.each(EntitiesTabs.getData(),_.bind(function(t){var e=new CEntitiesView(t.Type),i=_.bind(function(t,e,i){if("create"===i)this.openCreateEntity();else if(t===this.currentEntityType())this.changeEntity(t,e,i||"");else{var n=_.clone(this.currentEntitiesId());Types.isNumber(e)?t&&(n[t]=e,delete n[this.currentEntityType()]):n[t]&&delete n[t],Routing.replaceHash(Links.get(this.currentEntityType(),n,""))}},this);e.setChangeEntityHandler(i),this.aScreens.push({linkHash:ko.computed(function(){var e=_.clone(this.lastSavedEntitiesId());return _.extend(e,this.currentEntitiesId()),Routing.buildHashFromArray(Links.get(t.Type,e))},this),sLinkText:Text.i18n(t.LinkTextKey),sType:t.Type,oView:e})},this)),this.currentEntitiesView=ko.computed(function(){var t=this.currentEntityType(),e=_.find(this.aScreens,function(e){return e.sType===t});return e?e.oView:null},this),this.currentEntitiesView.subscribe(function(){this.currentEntitiesView()&&this.currentEntitiesView().onHide()},this,"beforeChange"),this.currentEntitiesView.subscribe(function(){this.currentEntitiesView()&&this.currentEntitiesView().onShow()},this),this.tabs=ko.observableArray([]),this.visibleTabsCount=ko.computed(function(){var t=0;return _.each(this.tabs(),function(e){e.view&&(void 0===e.view.visible||e.view.visible())&&t++}),t},this),this.showModulesTabs=ko.computed(function(){return""===this.currentEntityType()||this.currentEntitiesView().hasSelectedEntity()},this),this.currentTab=ko.observable(null),this.aStartErrors=[],App.subscribeEvent("SendAjaxRequest::before",this.onAjaxSend.bind(this)),App.broadcastEvent("%ModuleName%::ConstructView::after",{Name:this.ViewConstructorName,View:this})}var _=require("underscore"),$=require("jquery"),ko=require("knockout"),Promise=require("bluebird"),Text=require("%PathToCoreWebclientModule%/js/utils/Text.js"),Types=require("%PathToCoreWebclientModule%/js/utils/Types.js"),App=require("%PathToCoreWebclientModule%/js/App.js"),Screens=require("%PathToCoreWebclientModule%/js/Screens.js"),Routing=require("%PathToCoreWebclientModule%/js/Routing.js"),CAbstractScreenView=require("%PathToCoreWebclientModule%/js/views/CAbstractScreenView.js"),Links=require("modules/%ModuleName%/js/utils/Links.js"),Cache=require("modules/%ModuleName%/js/Cache.js"),EntitiesTabs=require("modules/%ModuleName%/js/EntitiesTabs.js"),Settings=require("modules/%ModuleName%/js/Settings.js"),CEntitiesView=require("modules/%ModuleName%/js/views/CEntitiesView.js");_.extendOwn(CSettingsView.prototype,CAbstractScreenView.prototype),CSettingsView.prototype.ViewTemplate="%ModuleName%_SettingsView",CSettingsView.prototype.ViewConstructorName="CSettingsView",CSettingsView.prototype.onAjaxSend=function(t){""===this.currentEntityType()||t.Parameters.TenantId||(t.Parameters.TenantId=Cache.selectedTenantId())},CSettingsView.prototype.selectTenant=function(t){var e=_.clone(this.currentEntitiesId());e.Tenant=t,Routing.setHash(Links.get(this.currentEntityType(),e))},CSettingsView.prototype.registerTab=function(t,e,i){if(_.isFunction(t)){var n=this.tabs;return new Promise(t).then(function(t){n.push({view:t,name:e,title:i})},function(t){console.log("failed to load settings tab",t)})}return!1},CSettingsView.prototype.sortRegisterTabs=function(){this.tabs(_.sortBy(this.tabs(),function(t){var e=_.indexOf(Settings.TabsOrder,t.name);return-1!==e?e:Settings.TabsOrder.length}))},CSettingsView.prototype.registerTabSection=function(t,e){var i=_.findWhere(this.tabs(),{name:e}),n=t();i&&i.view.addSettingsSection(n)},CSettingsView.prototype.cancelCreatingEntity=function(){Routing.setHash(Links.get(this.currentEntityType(),this.currentEntitiesId(),""))},CSettingsView.prototype.openCreateEntity=function(){if(EntitiesTabs.getEntityData(this.currentEntityType()).CreateRequest){var t=_.clone(this.currentEntitiesId());delete t[this.currentEntityType()],"Tenant"!==this.currentEntityType()&&!t.Tenant&&Cache.selectedTenantId()&&(t.Tenant=Cache.selectedTenantId()),Routing.setHash(Links.get(this.currentEntityType(),t,"create"))}},CSettingsView.prototype.changeEntity=function(t,e,i){var n=_.clone(this.currentEntitiesId()),s=!!_.find(this.tabs(),function(t){return t.name===i}),r=this.currentTab()?this.currentTab().name:"";t&&(n[t]=e),"Tenant"!==t&&Cache.selectedTenantId()&&(n.Tenant=Cache.selectedTenantId()),Routing.setHash(Links.get(t,n,s?i:r))},CSettingsView.prototype.onBind=function(){_.each(this.tabs(),_.bind(function(t){if(t.view&&_.isFunction(t.view.getStartError)){var e=t.view.getStartError();_.isFunction(e)&&(e.subscribe(function(){this.showStartError()},this),this.aStartErrors.push(e))}},this)),this.showStartError()},CSettingsView.prototype.showStartError=function(){var t=[];_.each(this.aStartErrors,function(e){var i=e();""!==i&&t.push(i)}),Screens.showError(t.join("<br /><br />"),!0)},CSettingsView.prototype.onRoute=function(t){var e=Links.parse(t);if(!_.find(this.aScreens,function(t){return t.sType===e.CurrentType})&&this.aScreens.length>0)Routing.replaceHash(Links.get(this.aScreens[0].sType,[],""));else{var i=t.slice(1),n=this.currentEntityType()===e.CurrentType,s=this.currentEntitiesId()[e.CurrentType]===e.Entities[e.CurrentType],r=this.currentTab()&&this.currentTab().name===e.Last,o=JSON.stringify(this.currentEntitiesId())===JSON.stringify(e.Entities),a=this.currentTab(),u=_.bind(function(){this.showNewScreenView(e),this.showNewTabView(e.Last,i)},this),c=_.bind(function(){a&&Routing.replaceHashDirectly(Links.get(this.currentEntityType(),this.currentEntitiesId(),this.currentTab()?this.currentTab().name:""))},this);n&&s&&r&&o?a&&a.view.onRoute(i,this.currentEntitiesId()):a&&$.isFunction(a.view.hide)?a.view.hide(u,c):u()}},CSettingsView.prototype.showNewScreenView=function(t){var e=_.find(this.aScreens,function(e){return e.sType===t.CurrentType});if(this.currentEntityType(t.CurrentType),this.currentEntitiesId(t.Entities),_.isEmpty(t.Entities)||this.lastSavedEntitiesId(t.Entities),Cache.setSelectedTenant(t.Entities.Tenant),e&&e.oView){var i=e.oView.oEntityData?e.oView.oEntityData.CreateRequest:"";"create"===t.Last&&Types.isNonEmptyString(i)?e.oView.openCreateForm():e.oView.cancelCreatingEntity(),e.oView.changeEntity(t.Entities[t.CurrentType],t.Entities)}},CSettingsView.prototype.showNewTabView=function(t,e){_.each(this.tabs(),_.bind(function(t){t.view&&_.isFunction(t.view.setAccessLevel)&&t.view.setAccessLevel(this.currentEntityType(),this.currentEntitiesId()[this.currentEntityType()])},this));var i=_.find(this.tabs(),function(e){return e.name===t});i&&i.view&&i.view.visible()||(i=_.find(this.tabs(),function(t){return t.view&&t.view.visible()})),i&&($.isFunction(i.view.onRoute)&&i.view.onRoute(e,this.currentEntitiesId()),this.currentTab(i))},CSettingsView.prototype.changeTab=function(t){var e=this.currentEntityType()?this.currentEntitiesId():{};Routing.setHash(Links.get(this.currentEntityType(),e,t))},CSettingsView.prototype.logout=function(){App.logout()},CSettingsView.prototype.deleteCurrentEntity=function(){this.currentEntitiesView()&&this.currentEntitiesView().deleteCurrentEntity()},CSettingsView.prototype.setAddHash=function(t){Routing.setHash(_.union([Settings.HashModuleName,this.currentTab()?this.currentTab().name:""],t))},module.exports=new CSettingsView;