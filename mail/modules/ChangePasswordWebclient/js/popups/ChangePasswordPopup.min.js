"use strict";function CChangePasswordPopup(){CAbstractPopup.call(this),this.currentPassword=ko.observable(""),this.newPassword=ko.observable(""),this.confirmPassword=ko.observable(""),this.accountId=ko.observable(""),this.hasOldPassword=ko.observable(!1),this.oParams=null}var _=require("underscore"),$=require("jquery"),ko=require("knockout"),TextUtils=require("%PathToCoreWebclientModule%/js/utils/Text.js"),UrlUtils=require("%PathToCoreWebclientModule%/js/utils/Url.js"),ValidationUtils=require("%PathToCoreWebclientModule%/js/utils/Validation.js"),Ajax=require("%PathToCoreWebclientModule%/js/Ajax.js"),Api=require("%PathToCoreWebclientModule%/js/Api.js"),App=require("%PathToCoreWebclientModule%/js/App.js"),Screens=require("%PathToCoreWebclientModule%/js/Screens.js"),Popups=require("%PathToCoreWebclientModule%/js/Popups.js"),AlertPopup=require("%PathToCoreWebclientModule%/js/popups/AlertPopup.js"),CAbstractPopup=require("%PathToCoreWebclientModule%/js/popups/CAbstractPopup.js"),Settings=require("modules/%ModuleName%/js/Settings.js");_.extendOwn(CChangePasswordPopup.prototype,CAbstractPopup.prototype),CChangePasswordPopup.prototype.PopupTemplate="%ModuleName%_ChangePasswordPopup",CChangePasswordPopup.prototype.onOpen=function(e){this.currentPassword(""),this.newPassword(""),this.confirmPassword(""),this.accountId(e.iAccountId),this.hasOldPassword(e.bHasOldPassword),this.oParams=e},CChangePasswordPopup.prototype.change=function(){var e=$.trim(this.newPassword()),s=$.trim(this.confirmPassword());ValidationUtils.checkPassword(e,s)&&this.sendChangeRequest()},CChangePasswordPopup.prototype.sendChangeRequest=function(){var e={AccountId:this.accountId(),CurrentPassword:$.trim(this.currentPassword()),NewPassword:$.trim(this.newPassword())},s={Module:this.oParams.sModule,Method:"ChangePassword"};Ajax.send(this.oParams.sModule,"ChangePassword",e,this.onUpdatePasswordResponse,this),Ajax.abortAndStopSendRequests(s)},CChangePasswordPopup.prototype.onUpdatePasswordResponse=function(e,s){!1===e.Result?(Api.showErrorByCode(e,TextUtils.i18n("%MODULENAME%/ERROR_PASSWORD_NOT_SAVED")),Ajax.startSendRequests()):e.Result&&e.Result.RefreshToken?(App.setAuthToken(e.Result.RefreshToken),Popups.showPopup(AlertPopup,[TextUtils.i18n("%MODULENAME%/REPORT_PASSWORD_CHANGED")+" "+TextUtils.i18n("%MODULENAME%/REPORT_REDIRECT_TO_LOGIN"),function(){App.logout()}])):(this.hasOldPassword()?Screens.showReport(TextUtils.i18n("%MODULENAME%/REPORT_PASSWORD_CHANGED")):Screens.showReport(TextUtils.i18n("%MODULENAME%/REPORT_PASSWORD_SET")),this.closePopup(),$.isFunction(this.oParams.fAfterPasswordChanged)&&this.oParams.fAfterPasswordChanged())},module.exports=new CChangePasswordPopup;