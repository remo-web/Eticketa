"use strict";function BindContactCard(e,o){var n=$("div.item_viewer[data-email='"+o+"']"),t=!1,a=0,s=function(){n&&e&&(t=!0,clearTimeout(a),setTimeout(function(){var o,a,s,r=e.offset();t&&r.left+r.top!==0&&(o=r.left+10,a=r.top+e.height()+6,(s=$(window).width()-(o+396))>0&&(s=0),n.addClass("expand").offset({top:a,left:o+s}))},180))},r=function(){t&&n&&e&&(t=!1,a=setTimeout(function(){t||n.removeClass("expand")},200))};n.length>0?(e.off().on("mouseover",function(){n.off().on("mouseenter",s).on("mouseleave",r).find(".link, .button").off(".links").on("click.links",function(){t=!1,n.removeClass("expand")}),setTimeout(function(){n.find(".link, .button").off("click.links").on("click.links",function(){t=!1,n.removeClass("expand")})}.bind(this),100),s()}).on("mouseout",r),t=!1,n.removeClass("expand")):e.off()}function ClearElement(e){e.next().hasClass("add_contact")&&e.next().remove(),e.removeClass("found"),e.parent().removeClass("found_contact"),e.off()}function OnContactResponse(e,o){_.each(e,function(n){var t=n.attr("data-email"),a=o[t];if(void 0!==a)if(ClearElement(n),null===a){var s=$('<span class="add_contact"></span>');n.after(s),CustomTooltip.init(s,"%MODULENAME%/ACTION_ADD_TO_CONTACTS"),s.on("click",function(){Popups.showPopup(CreateContactPopup,[n.attr("data-name"),t,function(o){_.each(e,function(e){e.attr("data-email")===t&&(ClearElement(e),e.addClass("found"),e.parent().addClass("found_contact"),oContactCardsView.add(o),BindContactCard(e,t))})}])})}else n.addClass("found"),n.parent().addClass("found_contact"),oContactCardsView.add(o),BindContactCard(n,t)})}var _=require("underscore"),$=require("jquery"),ko=require("knockout"),CustomTooltip=require("%PathToCoreWebclientModule%/js/CustomTooltip.js"),ModulesManager=require("%PathToCoreWebclientModule%/js/ModulesManager.js"),Screens=require("%PathToCoreWebclientModule%/js/Screens.js"),ComposeMessageToAddressesFunc=ModulesManager.run("MailWebclient","getComposeMessageToAddresses"),SearchMessagesInCurrentFolderFunc=ModulesManager.run("MailWebclient","getSearchMessagesInCurrentFolder"),Popups=require("%PathToCoreWebclientModule%/js/Popups.js"),CreateContactPopup=require("modules/%ModuleName%/js/popups/CreateContactPopup.js"),ContactsCache=require("modules/%ModuleName%/js/Cache.js"),oContactCardsView={contacts:ko.observableArray([]),ViewTemplate:"%ModuleName%_ContactCardsView",bAllowComposeMessageToAddresses:_.isFunction(ComposeMessageToAddressesFunc),searchMessagesInCurrentFolder:SearchMessagesInCurrentFolderFunc||function(){},bAllowSearchMessagesInCurrentFolder:_.isFunction(SearchMessagesInCurrentFolderFunc),add:function(e){var o=_.filter(this.contacts(),function(o){return-1===$.inArray(o.email(),_.keys(e))});this.contacts(o.concat(_.compact(_.values(e))))}};Screens.showAnyView(oContactCardsView),module.exports={applyTo:function(e){var o=_.map(e,function(e){return $(e)}),n=_.uniq(_.map(o,function(e){return e&&e.attr("data-email")}));ContactsCache.getContactsByEmails(n,_.bind(OnContactResponse,{},o))}};