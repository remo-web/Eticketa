"use strict";function CContactModel(){this.sEmailDefaultType=Enums.ContactsPrimaryEmail.Personal,this.sPhoneDefaultType=Enums.ContactsPrimaryPhone.Mobile,this.sAddressDefaultType=Enums.ContactsPrimaryAddress.Personal,this.uuid=ko.observable(""),this.idUser=ko.observable(""),this.team=ko.observable(!1),this.itsMe=ko.observable(!1),this.storage=ko.observable("personal"),this.isNew=ko.observable(!1),this.readOnly=ko.observable(!1),this.edited=ko.observable(!1),this.extented=ko.observable(!1),this.personalCollapsed=ko.observable(!1),this.businessCollapsed=ko.observable(!1),this.otherCollapsed=ko.observable(!1),this.groupsCollapsed=ko.observable(!1),this.displayName=ko.observable(""),this.firstName=ko.observable(""),this.lastName=ko.observable(""),this.nickName=ko.observable(""),this.skype=ko.observable(""),this.facebook=ko.observable(""),this.displayNameFocused=ko.observable(!1),this.primaryEmail=ko.observable(this.sEmailDefaultType),this.primaryPhone=ko.observable(this.sPhoneDefaultType),this.primaryAddress=ko.observable(this.sAddressDefaultType),this.mainPrimaryEmail=ko.computed({read:this.primaryEmail,write:function(s){s&&0<=$.inArray(s,[Enums.ContactsPrimaryEmail.Personal,Enums.ContactsPrimaryEmail.Business,Enums.ContactsPrimaryEmail.Other])?this.primaryEmail(s):this.primaryEmail(Enums.ContactsPrimaryEmail.Personal)},owner:this}),this.mainPrimaryPhone=ko.computed({read:this.primaryPhone,write:function(s){s&&0<=$.inArray(s,[Enums.ContactsPrimaryPhone.Mobile,Enums.ContactsPrimaryPhone.Personal,Enums.ContactsPrimaryPhone.Business])?this.primaryPhone(s):this.primaryPhone(Enums.ContactsPrimaryPhone.Mobile)},owner:this}),this.mainPrimaryAddress=ko.computed({read:this.primaryAddress,write:function(s){s&&0<=$.inArray(s,[Enums.ContactsPrimaryAddress.Personal,Enums.ContactsPrimaryAddress.Business])?this.primaryAddress(s):this.primaryAddress(Enums.ContactsPrimaryAddress.Personal)},owner:this}),this.personalEmail=ko.observable(""),this.personalStreetAddress=ko.observable(""),this.personalCity=ko.observable(""),this.personalState=ko.observable(""),this.personalZipCode=ko.observable(""),this.personalCountry=ko.observable(""),this.personalWeb=ko.observable(""),this.personalFax=ko.observable(""),this.personalPhone=ko.observable(""),this.personalMobile=ko.observable(""),this.businessEmail=ko.observable(""),this.businessCompany=ko.observable(""),this.businessDepartment=ko.observable(""),this.businessJob=ko.observable(""),this.businessOffice=ko.observable(""),this.businessStreetAddress=ko.observable(""),this.businessCity=ko.observable(""),this.businessState=ko.observable(""),this.businessZipCode=ko.observable(""),this.businessCountry=ko.observable(""),this.businessWeb=ko.observable(""),this.businessFax=ko.observable(""),this.businessPhone=ko.observable(""),this.otherEmail=ko.observable(""),this.otherBirthMonth=ko.observable(0),this.otherBirthDay=ko.observable(0),this.otherBirthYear=ko.observable(0),this.otherNotes=ko.observable(""),this.etag=ko.observable(""),this.sharedToAll=ko.observable(!1),this.birthdayIsEmpty=ko.computed(function(){var s=0===this.otherBirthMonth(),e=0===this.otherBirthDay(),t=0===this.otherBirthYear();return s||e||t},this),this.otherBirthday=ko.computed(function(){var s="",e=this.otherBirthYear(),t=this.otherBirthMonth(),i=this.otherBirthDay(),r=new CDateModel;if(!this.birthdayIsEmpty()){var a=moment().diff(moment(e+"/"+t+"/"+i,"YYYY/MM/DD"),"years"),o=TextUtils.i18n("%MODULENAME%/LABEL_YEARS_PLURAL",{COUNT:a},null,a);r.setDate(e,0<t?t-1:0,i),s=r.getShortDate()+" ("+o+")"}return s},this),this.groups=ko.observableArray([]),this.groupsIsEmpty=ko.computed(function(){return 0===this.groups().length},this),this.email=ko.computed({read:function(){var s="";switch(this.primaryEmail()){case Enums.ContactsPrimaryEmail.Personal:s=this.personalEmail();break;case Enums.ContactsPrimaryEmail.Business:s=this.businessEmail();break;case Enums.ContactsPrimaryEmail.Other:s=this.otherEmail()}return s},write:function(s){switch(this.primaryEmail()){case Enums.ContactsPrimaryEmail.Personal:this.personalEmail(s);break;case Enums.ContactsPrimaryEmail.Business:this.businessEmail(s);break;case Enums.ContactsPrimaryEmail.Other:this.otherEmail(s);break;default:this.primaryEmail(this.sEmailDefaultType),this.email(s)}},owner:this}),this.personalIsEmpty=ko.computed(function(){return""==""+(this.personalEmail()!==this.email()?this.personalEmail():"")+this.personalStreetAddress()+this.personalCity()+this.personalState()+this.personalZipCode()+this.personalCountry()+this.personalWeb()+this.personalFax()+this.personalPhone()+this.personalMobile()},this),this.businessIsEmpty=ko.computed(function(){return""==""+(this.businessEmail()!==this.email()?this.businessEmail():"")+this.businessCompany()+this.businessDepartment()+this.businessJob()+this.businessOffice()+this.businessStreetAddress()+this.businessCity()+this.businessState()+this.businessZipCode()+this.businessCountry()+this.businessWeb()+this.businessFax()+this.businessPhone()},this),this.otherIsEmpty=ko.computed(function(){return""==""+(this.otherEmail()!==this.email()?this.otherEmail():"")+this.otherNotes()&&this.birthdayIsEmpty()},this),this.phone=ko.computed({read:function(){var s="";switch(this.primaryPhone()){case Enums.ContactsPrimaryPhone.Mobile:s=this.personalMobile();break;case Enums.ContactsPrimaryPhone.Personal:s=this.personalPhone();break;case Enums.ContactsPrimaryPhone.Business:s=this.businessPhone()}return s},write:function(s){switch(this.primaryPhone()){case Enums.ContactsPrimaryPhone.Mobile:this.personalMobile(s);break;case Enums.ContactsPrimaryPhone.Personal:this.personalPhone(s);break;case Enums.ContactsPrimaryPhone.Business:this.businessPhone(s);break;default:this.primaryPhone(this.sEmailDefaultType),this.phone(s)}},owner:this}),this.address=ko.computed({read:function(){var s="";switch(this.primaryAddress()){case Enums.ContactsPrimaryAddress.Personal:s=this.personalStreetAddress();break;case Enums.ContactsPrimaryAddress.Business:s=this.businessStreetAddress()}return s},write:function(s){switch(this.primaryAddress()){case Enums.ContactsPrimaryAddress.Personal:this.personalStreetAddress(s);break;case Enums.ContactsPrimaryAddress.Business:this.businessStreetAddress(s);break;default:this.primaryAddress(this.sEmailDefaultType),this.address(s)}},owner:this}),this.emails=ko.computed(function(){var s=[];return""!==this.personalEmail()&&s.push({text:TextUtils.i18n("%MODULENAME%/LABEL_PERSONAL")+": "+this.personalEmail(),value:Enums.ContactsPrimaryEmail.Personal}),""!==this.businessEmail()&&s.push({text:TextUtils.i18n("%MODULENAME%/LABEL_BUSINESS")+": "+this.businessEmail(),value:Enums.ContactsPrimaryEmail.Business}),""!==this.otherEmail()&&s.push({text:TextUtils.i18n("%MODULENAME%/LABEL_OTHER")+": "+this.otherEmail(),value:Enums.ContactsPrimaryEmail.Other}),s},this),this.phones=ko.computed(function(){var s=[];return""!==this.personalMobile()&&s.push({text:TextUtils.i18n("%MODULENAME%/LABEL_MOBILE")+": "+this.personalMobile(),value:Enums.ContactsPrimaryPhone.Mobile}),""!==this.personalPhone()&&s.push({text:TextUtils.i18n("%MODULENAME%/LABEL_PERSONAL")+": "+this.personalPhone(),value:Enums.ContactsPrimaryPhone.Personal}),""!==this.businessPhone()&&s.push({text:TextUtils.i18n("%MODULENAME%/LABEL_BUSINESS")+": "+this.businessPhone(),value:Enums.ContactsPrimaryPhone.Business}),s},this),this.addresses=ko.computed(function(){var s=[];return""!==this.personalStreetAddress()&&s.push({text:TextUtils.i18n("%MODULENAME%/LABEL_PERSONAL")+": "+this.personalStreetAddress(),value:Enums.ContactsPrimaryAddress.Personal}),""!==this.businessStreetAddress()&&s.push({text:TextUtils.i18n("%MODULENAME%/LABEL_BUSINESS")+": "+this.businessStreetAddress(),value:Enums.ContactsPrimaryAddress.Business}),s},this),this.hasEmails=ko.computed(function(){return 0<this.emails().length},this),this.allowSendThisContact=ko.computed(function(){return""!==Settings.SaveVcfServerModuleName},this),this.extented.subscribe(function(s){s&&(this.personalCollapsed(!this.personalIsEmpty()),this.businessCollapsed(!this.businessIsEmpty()),this.otherCollapsed(!this.otherIsEmpty()),this.groupsCollapsed(!this.groupsIsEmpty()))},this),this.birthMonthSelect=CContactModel.birthMonthSelect,this.birthDaySelect=ko.computed(function(){for(var s=1,e=DateUtils.daysInMonth(this.otherBirthMonth(),this.otherBirthYear()),t=[{text:TextUtils.i18n("COREWEBCLIENT/LABEL_DAY"),value:0}];s<=e;s++)t.push({text:s.toString(),value:s});return t},this),this.birthYearSelect=[{text:TextUtils.i18n("%MODULENAME%/LABEL_YEAR"),value:0}];for(var s=(new Date).getFullYear(),e=s,t=s-100;e>=t;e--)this.birthYearSelect.push({text:e.toString(),value:e});this.canBeSave=ko.computed(function(){return""!==this.displayName()||!!this.emails().length},this)}var _=require("underscore"),$=require("jquery"),ko=require("knockout"),moment=require("moment"),AddressUtils=require("%PathToCoreWebclientModule%/js/utils/Address.js"),DateUtils=require("%PathToCoreWebclientModule%/js/utils/Date.js"),TextUtils=require("%PathToCoreWebclientModule%/js/utils/Text.js"),Types=require("%PathToCoreWebclientModule%/js/utils/Types.js"),Ajax=require("modules/%ModuleName%/js/Ajax.js"),Api=require("%PathToCoreWebclientModule%/js/Api.js"),App=require("%PathToCoreWebclientModule%/js/App.js"),CDateModel=require("%PathToCoreWebclientModule%/js/models/CDateModel.js"),Settings=require("modules/%ModuleName%/js/Settings.js");CContactModel.aBirthdayMonths=DateUtils.getMonthNamesArray(),CContactModel.birthMonthSelect=[{text:TextUtils.i18n("COREWEBCLIENT/LABEL_MONTH"),value:0},{text:CContactModel.aBirthdayMonths[0],value:1},{text:CContactModel.aBirthdayMonths[1],value:2},{text:CContactModel.aBirthdayMonths[2],value:3},{text:CContactModel.aBirthdayMonths[3],value:4},{text:CContactModel.aBirthdayMonths[4],value:5},{text:CContactModel.aBirthdayMonths[5],value:6},{text:CContactModel.aBirthdayMonths[6],value:7},{text:CContactModel.aBirthdayMonths[7],value:8},{text:CContactModel.aBirthdayMonths[8],value:9},{text:CContactModel.aBirthdayMonths[9],value:10},{text:CContactModel.aBirthdayMonths[10],value:11},{text:CContactModel.aBirthdayMonths[11],value:12}],CContactModel.prototype.clear=function(){this.isNew(!1),this.readOnly(!1),this.uuid(""),this.idUser(""),this.team(!1),this.storage(""),this.itsMe(!1),this.edited(!1),this.extented(!1),this.personalCollapsed(!1),this.businessCollapsed(!1),this.otherCollapsed(!1),this.groupsCollapsed(!1),this.displayName(""),this.firstName(""),this.lastName(""),this.nickName(""),this.skype(""),this.facebook(""),this.primaryEmail(this.sEmailDefaultType),this.primaryPhone(this.sPhoneDefaultType),this.primaryAddress(this.sAddressDefaultType),this.personalEmail(""),this.personalStreetAddress(""),this.personalCity(""),this.personalState(""),this.personalZipCode(""),this.personalCountry(""),this.personalWeb(""),this.personalFax(""),this.personalPhone(""),this.personalMobile(""),this.businessEmail(""),this.businessCompany(""),this.businessDepartment(""),this.businessJob(""),this.businessOffice(""),this.businessStreetAddress(""),this.businessCity(""),this.businessState(""),this.businessZipCode(""),this.businessCountry(""),this.businessWeb(""),this.businessFax(""),this.businessPhone(""),this.otherEmail(""),this.otherBirthMonth(0),this.otherBirthDay(0),this.otherBirthYear(0),this.otherNotes(""),this.etag(""),this.sharedToAll(!1),this.groups([])},CContactModel.prototype.switchToNew=function(){this.clear(),this.edited(!0),this.extented(!1),this.isNew(!0),App.isMobile()||this.displayNameFocused(!0)},CContactModel.prototype.switchToView=function(){this.edited(!1),this.extented(!1)},CContactModel.prototype.toObject=function(){return{UUID:this.uuid(),PrimaryEmail:this.primaryEmail(),PrimaryPhone:this.primaryPhone(),PrimaryAddress:this.primaryAddress(),FullName:this.displayName(),FirstName:this.firstName(),LastName:this.lastName(),NickName:this.nickName(),Storage:this.storage(),Skype:this.skype(),Facebook:this.facebook(),PersonalEmail:this.personalEmail(),PersonalAddress:this.personalStreetAddress(),PersonalCity:this.personalCity(),PersonalState:this.personalState(),PersonalZip:this.personalZipCode(),PersonalCountry:this.personalCountry(),PersonalWeb:this.personalWeb(),PersonalFax:this.personalFax(),PersonalPhone:this.personalPhone(),PersonalMobile:this.personalMobile(),BusinessEmail:this.businessEmail(),BusinessCompany:this.businessCompany(),BusinessJobTitle:this.businessJob(),BusinessDepartment:this.businessDepartment(),BusinessOffice:this.businessOffice(),BusinessAddress:this.businessStreetAddress(),BusinessCity:this.businessCity(),BusinessState:this.businessState(),BusinessZip:this.businessZipCode(),BusinessCountry:this.businessCountry(),BusinessFax:this.businessFax(),BusinessPhone:this.businessPhone(),BusinessWeb:this.businessWeb(),OtherEmail:this.otherEmail(),Notes:this.otherNotes(),ETag:this.etag(),BirthDay:this.otherBirthDay(),BirthMonth:this.otherBirthMonth(),BirthYear:this.otherBirthYear(),GroupUUIDs:this.groups()}},CContactModel.prototype.parse=function(s){this.uuid(Types.pString(s.UUID)),this.idUser(Types.pString(s.IdUser)),this.team("team"===s.Storage),this.storage(Types.pString(s.Storage)),this.itsMe(!!s.ItsMe),this.readOnly(!!s.ReadOnly),this.displayName(Types.pString(s.FullName)),this.firstName(Types.pString(s.FirstName)),this.lastName(Types.pString(s.LastName)),this.nickName(Types.pString(s.NickName)),this.skype(Types.pString(s.Skype)),this.facebook(Types.pString(s.Facebook)),this.primaryEmail(Types.pInt(s.PrimaryEmail)),this.primaryPhone(Types.pInt(s.PrimaryPhone)),this.primaryAddress(Types.pInt(s.PrimaryAddress)),this.personalEmail(Types.pString(s.PersonalEmail)),this.personalStreetAddress(Types.pString(s.PersonalAddress)),this.personalCity(Types.pString(s.PersonalCity)),this.personalState(Types.pString(s.PersonalState)),this.personalZipCode(Types.pString(s.PersonalZip)),this.personalCountry(Types.pString(s.PersonalCountry)),this.personalWeb(Types.pString(s.PersonalWeb)),this.personalFax(Types.pString(s.PersonalFax)),this.personalPhone(Types.pString(s.PersonalPhone)),this.personalMobile(Types.pString(s.PersonalMobile)),this.businessEmail(Types.pString(s.BusinessEmail)),this.businessCompany(Types.pString(s.BusinessCompany)),this.businessDepartment(Types.pString(s.BusinessDepartment)),this.businessJob(Types.pString(s.BusinessJobTitle)),this.businessOffice(Types.pString(s.BusinessOffice)),this.businessStreetAddress(Types.pString(s.BusinessAddress)),this.businessCity(Types.pString(s.BusinessCity)),this.businessState(Types.pString(s.BusinessState)),this.businessZipCode(Types.pString(s.BusinessZip)),this.businessCountry(Types.pString(s.BusinessCountry)),this.businessWeb(Types.pString(s.BusinessWeb)),this.businessFax(Types.pString(s.BusinessFax)),this.businessPhone(Types.pString(s.BusinessPhone)),this.otherEmail(Types.pString(s.OtherEmail)),this.otherBirthMonth(Types.pInt(s.BirthMonth)),this.otherBirthDay(Types.pInt(s.BirthDay)),this.otherBirthYear(Types.pInt(s.BirthYear)),this.otherNotes(Types.pString(s.Notes)),this.etag(Types.pString(s.ETag)),this.sharedToAll("shared"===s.Storage),_.isArray(s.GroupUUIDs)&&this.groups(s.GroupUUIDs)},CContactModel.prototype.getFullEmail=function(s){return Types.isNonEmptyString(s)||(s=this.email()),AddressUtils.getFullEmail(this.displayName(),s)},CContactModel.prototype.getEmailsString=function(){return _.uniq(_.without([this.email(),this.personalEmail(),this.businessEmail(),this.otherEmail()],"")).join(",")},CContactModel.prototype.sendThisContact=function(){var s=require("%PathToCoreWebclientModule%/js/ModulesManager.js").run("MailWebclient","getComposeMessageWithAttachments"),e={UUID:this.uuid(),FileName:"contact-"+this.getFullEmail().replace('"',"").replace("<","").replace(">","")+".vcf"};Ajax.send("SaveContactAsTempFile",e,function(e){e.Result?_.isFunction(s)&&s([e.Result]):Api.showErrorByCode(e,TextUtils.i18n("%MODULENAME%/ERROR_CONTACT_AS_TEMPFAILE"))},this)},CContactModel.prototype.isStrLink=function(s){return/^http/.test(s)},module.exports=CContactModel;