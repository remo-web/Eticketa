"use strict";function CContactsView(){CAbstractScreenView.call(this,"%ModuleName%"),this.browserTitle=ko.observable(TextUtils.i18n("%MODULENAME%/HEADING_BROWSER_TAB")),this.contactCount=ko.observable(0),this.uploaderArea=ko.observable(null),this.dragActive=ko.observable(!1),this.bDragActiveComp=ko.computed(function(){return this.dragActive()},this),this.sImportContactsLink=Settings.ImportContactsLink,this.loadingList=ko.observable(!1),this.preLoadingList=ko.observable(!1),this.loadingList.subscribe(function(e){this.preLoadingList(e)},this),this.loadingViewPane=ko.observable(!1),this.showPersonalContacts=ko.observable(!1),this.showTeamContacts=ko.observable(!1),this.showSharedToAllContacts=ko.observable(!1),this.showAllContacts=ko.computed(function(){return 1<[this.showPersonalContacts()?"1":"",this.showTeamContacts()?"1":"",this.showSharedToAllContacts()?"1":""].join("").length},this),this.recivedAnimPersonal=ko.observable(!1).extend({autoResetToFalse:500}),this.recivedAnimShared=ko.observable(!1).extend({autoResetToFalse:500}),this.recivedAnimTeam=ko.observable(!1).extend({autoResetToFalse:500}),this.isTeamStorageSelected=ko.observable(!1),this.isNotTeamStorageSelected=ko.observable(!1),this.disableDropToPersonal=ko.observable(!1),this.selectedStorageValue=ko.observable(""),this.selectedStorage=ko.computed({read:function(){return this.selectedStorageValue()},write:function(e){""!==e&&(this.selectedStorageValue(-1!==$.inArray(e,Settings.Storages)?e:Settings.DefaultStorage),"group"!==this.selectedStorageValue()&&(this.selectedGroupInList(null),this.selectedItem(null),this.selector.listCheckedOrSelected(!1),this.currentGroupUUID("")),this.isTeamStorageSelected("team"===this.selectedStorageValue()),this.isNotTeamStorageSelected("team"!==this.selectedStorageValue()),this.disableDropToPersonal("shared"!==this.selectedStorageValue()))},owner:this}),this.selectedGroupInList=ko.observable(null),this.selectedGroupInList.subscribe(function(){var e=this.selectedGroupInList();e&&e.selected(!1)},this,"beforeChange"),this.selectedGroupInList.subscribe(function(e){e&&this.showPersonalContacts()&&(e.selected(!0),this.selectedStorage("group"),this.requestContactList())},this),this.selectedGroup=ko.observable(null),this.selectedContact=ko.observable(null),this.selectedGroupEmails=ko.observableArray([]),this.currentGroupUUID=ko.observable(""),this.oContactModel=new CContactModel,this.oGroupModel=new CGroupModel,this.oImportView=new CImportView(this),this.selectedOldItem=ko.observable(null),this.selectedItem=ko.computed({read:function(){return this.selectedContact()||this.selectedGroup()||null},write:function(e){e instanceof CContactModel?(this.selectedGroup(null),this.selectedContact(e)):e instanceof CGroupModel?(this.selectedContact(null),this.selectedGroup(e),this.currentGroupUUID(e.uuid())):(this.selectedGroup(null),this.selectedContact(null)),this.loadingViewPane(!1)},owner:this}),this.collection=ko.observableArray([]),this.contactUidForRequest=ko.observable(""),this.collection.subscribe(function(){this.collection().length>0&&""!==this.contactUidForRequest()&&(this.requestContact(this.contactUidForRequest()),this.contactUidForRequest(""))},this),this.isSearchFocused=ko.observable(!1),this.searchInput=ko.observable(""),this.search=ko.observable(""),this.groupUidForRequest=ko.observable(""),this.groupFullCollection=ko.observableArray([]),this.groupFullCollection.subscribe(function(){this.groupUidForRequest()&&this.onViewGroupClick(this.groupUidForRequest())},this),this.selectedContact.subscribe(function(e){if(e){var t=e.groups();_.each(this.groupFullCollection(),function(e){e.checked(e&&0<=$.inArray(e.UUID(),t))})}},this),this.pageSwitcherLocked=ko.observable(!1),this.oPageSwitcher=new CPageSwitcherView(0,Settings.ContactsPerPage),this.oPageSwitcher.currentPage.subscribe(function(){this.pageSwitcherLocked()||this.changeRouting()},this),this.currentPage=ko.observable(1),this.search.subscribe(function(e){this.searchInput(e)},this),this.searchSubmitCommand=Utils.createCommand(this,function(){this.changeRouting({Search:this.searchInput()})}),this.searchMessagesInInbox=ModulesManager.run("MailWebclient","getSearchMessagesInInbox"),this.bAllowSearchMessagesInInbox=_.isFunction(this.searchMessagesInInbox),this.composeMessageToAddresses=ModulesManager.run("MailWebclient","getComposeMessageToAddresses"),this.bAllowComposeMessageToAddresses=_.isFunction(this.composeMessageToAddresses),this.selector=new CSelector(this.collection,_.bind(this.viewContact,this),_.bind(this.deleteContact,this),this.bAllowComposeMessageToAddresses?_.bind(this.composeMessageToContact,this):null),this.checkAll=this.selector.koCheckAll(),this.checkAllIncomplite=this.selector.koCheckAllIncomplete(),this.isCheckedOrSelected=ko.computed(function(){return 0<this.selector.listCheckedOrSelected().length},this),this.isEnableAddContacts=this.isCheckedOrSelected,this.isEnableRemoveContactsFromGroup=this.isCheckedOrSelected,this.isEnableDeleting=this.isCheckedOrSelected,this.isEnableSharing=this.isCheckedOrSelected,this.visibleShareCommand=ko.computed(function(){return this.showPersonalContacts()&&this.showSharedToAllContacts()&&"personal"===this.selectedStorage()},this),this.visibleUnshareCommand=ko.computed(function(){return this.showPersonalContacts()&&this.showSharedToAllContacts()&&"shared"===this.selectedStorage()},this),this.isExactlyOneContactSelected=ko.computed(function(){return 1===this.selector.listCheckedOrSelected().length},this),this.isSaving=ko.observable(!1),this.newContactCommand=Utils.createCommand(this,this.executeNewContact,this.isNotTeamStorageSelected),this.newGroupCommand=Utils.createCommand(this,this.executeNewGroup),this.addContactsCommand=Utils.createCommand(this,function(){},this.isEnableAddContacts),this.deleteCommand=Utils.createCommand(this,this.deleteContact,this.isEnableDeleting),this.selectedCount=ko.computed(function(){return _.filter(this.selector.listCheckedOrSelected(),function(e){return!e.ReadOnly()}).length},this),this.shareCommand=Utils.createCommand(this,this.executeShare,this.isEnableSharing),this.removeFromGroupCommand=Utils.createCommand(this,this.executeRemoveFromGroup,this.isEnableRemoveContactsFromGroup),this.importCommand=Utils.createCommand(this,this.executeImport),this.saveCommand=Utils.createCommand(this,this.executeSave),this.updateSharedToAllCommand=Utils.createCommand(this,this.executeUpdateSharedToAll,this.isExactlyOneContactSelected),this.composeMessageCommand=Utils.createCommand(this,this.composeMessage,this.isCheckedOrSelected),this.selector.listCheckedOrSelected.subscribe(function(e){this.oGroupModel.newContactsInGroupCount(e.length)},this),this.isSearch=ko.computed(function(){return""!==this.search()},this),this.isEmptyList=ko.computed(function(){return 0===this.collection().length},this),this.searchText=ko.computed(function(){return TextUtils.i18n("%MODULENAME%/INFO_SEARCH_RESULT",{SEARCH:this.search()})},this),this.visibleDragNDropToGroupText=ko.computed(function(){return!App.isMobile()&&"group"===this.selectedStorage()},this),this.selectedPanel=ko.observable(Enums.MobilePanel.Items),this.enableExport=ko.computed(function(){return this.contactCount()>0},this),this.aExportData=[],_.each(Settings.ImportExportFormats,function(e){Types.isNonEmptyString(e)&&this.aExportData.push({css:e.toLowerCase(),text:TextUtils.i18n("%MODULENAME%/ACTION_EXPORT_AS",{FORMAT:e.toUpperCase()}),command:Utils.createCommand(this,function(){this.executeExport(e)},this.enableExport)})},this),this.isPersonalStorageSelected=ko.computed(function(){return"personal"===this.selectedStorage()},this),this.visibleImportExport=ko.computed(function(){return this.aExportData.length>0},this),this.infoCreateOrImport=this.getCreateOrImportInfo(),this.listChanged=ko.computed(function(){return[this.selectedStorage(),this.currentGroupUUID(),this.search(),this.oPageSwitcher.currentPage(),this.oPageSwitcher.perPage()]},this),this.bRefreshContactList=!1,App.broadcastEvent("%ModuleName%::ConstructView::after",{Name:this.ViewConstructorName,View:this})}var _=require("underscore"),$=require("jquery"),ko=require("knockout"),FileSaver=require("%PathToCoreWebclientModule%/js/vendors/FileSaver.js"),TextUtils=require("%PathToCoreWebclientModule%/js/utils/Text.js"),Types=require("%PathToCoreWebclientModule%/js/utils/Types.js"),Utils=require("%PathToCoreWebclientModule%/js/utils/Common.js"),Api=require("%PathToCoreWebclientModule%/js/Api.js"),App=require("%PathToCoreWebclientModule%/js/App.js"),CJua=require("%PathToCoreWebclientModule%/js/CJua.js"),CSelector=require("%PathToCoreWebclientModule%/js/CSelector.js"),ModulesManager=require("%PathToCoreWebclientModule%/js/ModulesManager.js"),Routing=require("%PathToCoreWebclientModule%/js/Routing.js"),Screens=require("%PathToCoreWebclientModule%/js/Screens.js"),CAbstractScreenView=require("%PathToCoreWebclientModule%/js/views/CAbstractScreenView.js"),CPageSwitcherView=require("%PathToCoreWebclientModule%/js/views/CPageSwitcherView.js"),Popups=require("%PathToCoreWebclientModule%/js/Popups.js"),ConfirmPopup=require("%PathToCoreWebclientModule%/js/popups/ConfirmPopup.js"),LinksUtils=require("modules/%ModuleName%/js/utils/Links.js"),Ajax=require("modules/%ModuleName%/js/Ajax.js"),ContactsCache=require("modules/%ModuleName%/js/Cache.js"),Settings=require("modules/%ModuleName%/js/Settings.js"),CContactListItemModel=require("modules/%ModuleName%/js/models/CContactListItemModel.js"),CContactModel=require("modules/%ModuleName%/js/models/CContactModel.js"),CGroupModel=require("modules/%ModuleName%/js/models/CGroupModel.js"),CImportView=require("modules/%ModuleName%/js/views/CImportView.js"),Enums=window.Enums;_.extendOwn(CContactsView.prototype,CAbstractScreenView.prototype),CContactsView.prototype.ViewTemplate="%ModuleName%_ContactsScreenView",CContactsView.prototype.ViewConstructorName="CContactsView",CContactsView.prototype.getFormatDependentText=function(e){switch(Settings.ImportExportFormats.length){case 0:return"";case 1:return TextUtils.i18n("%MODULENAME%/"+e+"_SINGLE_EXT",{EXTENSION:Settings.ImportExportFormats[0].toUpperCase()});default:return TextUtils.i18n("%MODULENAME%/"+e+"_PLURAL_EXT",{EXTENSIONS:_.initial(Settings.ImportExportFormats).join(", ").toUpperCase(),LASTEXTENSION:_.last(Settings.ImportExportFormats).toUpperCase()})}},CContactsView.prototype.getCreateOrImportInfo=function(){var e=this.getFormatDependentText("INFO_OR_IMPORT");return TextUtils.i18n("%MODULENAME%/INFO_CREATE")+(""===e?"":" "+e)+"."},CContactsView.prototype.executeSave=function(e){var t,o={},s=[];if(e===this.selectedItem()&&this.selectedItem().canBeSave()){if(e instanceof CContactModel&&!e.readOnly())_.each(this.groupFullCollection(),function(e){e&&e.checked()&&s.push(e.UUID())}),e.groups(s),this.selectedItem()&&ContactsCache.clearInfoAboutEmail(this.selectedItem().email()),o=e.toObject(),"personal"!==this.selectedStorage()&&"personal"===o.Storage&&this.recivedAnimPersonal(!0),"team"!==this.selectedStorage()&&"team"===o.Storage&&this.recivedAnimTeam(!0),e.isNew()?("all"===this.selectedStorage()||"group"===this.selectedStorage()?o.Storage="personal":o.Storage=this.selectedStorage(),this.isSaving(!0),Ajax.send("CreateContact",{Contact:o},this.onCreateContactResponse,this)):(this.isSaving(!0),Ajax.send("UpdateContact",{Contact:o},this.onUpdateContactResponse,this));else if(e instanceof CGroupModel&&!e.readOnly()){var i=_.map(this.selector.listCheckedOrSelected(),function(e){return e.UUID()});this.isSaving(!0),t=e.toObject(i),e.isNew()||(t.Contacts=null),Ajax.send(e.isNew()?"CreateGroup":"UpdateGroup",{Group:t},this.onCreateGroupResponse,this)}}else Screens.showError(TextUtils.i18n("%MODULENAME%/ERROR_EMAIL_OR_NAME_BLANK"))},CContactsView.prototype.onCreateContactResponse=function(e,t){this.isSaving(!1),e.Result?(this.requestContactList(),this.viewContact(e.Result.UUID),Screens.showReport(TextUtils.i18n("%MODULENAME%/REPORT_CONTACT_SUCCESSFULLY_ADDED"))):Api.showErrorByCode(e,TextUtils.i18n("%MODULENAME%/ERROR_CREATE_CONTACT"))},CContactsView.prototype.onUpdateContactResponse=function(e,t){this.isSaving(!1),e.Result?(this.selectedContact()&&this.selectedContact().edited()&&this.selectedContact().edited(!1),this.requestContactList(),Screens.showReport(TextUtils.i18n("%MODULENAME%/REPORT_CONTACT_SUCCESSFULLY_UPDATED"))):Api.showErrorByCode(e,TextUtils.i18n("%MODULENAME%/ERROR_UPDATE_CONTACT"))},CContactsView.prototype.changeRouting=function(e,t){var o=void 0===(e=e||{}).Storage?this.selectedStorage():e.Storage,s=void 0===e.GroupUUID?this.currentGroupUUID():e.GroupUUID,i=void 0===e.Search?this.search():e.Search,r=void 0===e.Page?this.oPageSwitcher.currentPage():e.Page,n=void 0===e.ContactUUID?"":e.ContactUUID,a=void 0===e.Action?"":e.Action;t?Routing.replaceHash(LinksUtils.getContacts(o,s,i,r,n,a)):Routing.setHash(LinksUtils.getContacts(o,s,i,r,n,a))},CContactsView.prototype.executeNewContact=function(){if(this.showPersonalContacts()){var e="group"===this.selectedStorage()?this.currentGroupUUID():"";this.changeRouting({GroupUUID:e,Action:"create-contact"})}},CContactsView.prototype.executeNewGroup=function(){var e="group"===this.selectedStorage()?this.currentGroupUUID():"";this.selector.itemSelected()instanceof CContactListItemModel&&this.selector.itemSelected().checked(!0),this.changeRouting({GroupUUID:e,Action:"create-group"})},CContactsView.prototype.deleteContact=function(){var e=this.selectedStorage();if("personal"===e||"shared"===e){var t=_.filter(this.selector.listCheckedOrSelected(),function(e){return!e.ReadOnly()}),o=t.length,s=TextUtils.i18n("%MODULENAME%/CONFIRM_DELETE_CONTACTS_PLURAL",{},null,o),i=_.bind(function(e){e&&this.deleteContacts(t)},this);Popups.showPopup(ConfirmPopup,[s,i,"",TextUtils.i18n("COREWEBCLIENT/ACTION_DELETE")])}else"group"===e&&this.removeFromGroupCommand()},CContactsView.prototype.deleteContacts=function(e){var t=this,o=this.selectedContact(),s=_.map(e,function(e){return e.UUID()});0<s.length&&(this.preLoadingList(!0),_.each(e,function(e){e&&(ContactsCache.clearInfoAboutEmail(e.Email()),!o||e.IsGroup()||e.ReadOnly()||o.readOnly()||o.uuid()!==e.UUID()||(o=null,this.selectedContact(null)))},this),_.each(this.collection(),function(t){-1<$.inArray(t,e)&&t.deleted(!0)}),_.delay(function(){t.collection.remove(function(e){return e.deleted()})},500),Ajax.send("DeleteContacts",{Storage:this.selectedStorage(),UUIDs:s},function(e){e.Result||Api.showErrorByCode(e,TextUtils.i18n("%MODULENAME%/ERROR_DELETE_CONTACTS")),this.requestContactList()},this),ContactsCache.markVcardsNonexistentByUid(s))},CContactsView.prototype.executeRemoveFromGroup=function(){var e=this,t=this.selectedGroupInList(),o=this.selector.listCheckedOrSelected(),s=_.map(o,function(e){return e.UUID()});s=_.compact(s),t&&0<s.length&&(this.preLoadingList(!0),_.each(this.collection(),function(e){-1<$.inArray(e,o)&&e.deleted(!0)}),_.delay(function(){e.collection.remove(function(e){return e.deleted()})},500),Ajax.send("RemoveContactsFromGroup",{GroupUUID:t.UUID(),ContactUUIDs:s},function(e){e.Result||Api.showErrorByCode(e),this.requestContactList()},this))},CContactsView.prototype.executeImport=function(){this.changeRouting({Storage:"personal",GroupUUID:"",Search:"",Page:1,Action:"import"})},CContactsView.prototype.executeExport=function(e){var t=_.map(this.selector.listCheckedOrSelected(),function(e){return e.sUUID}),o=this.selectedStorage();"group"===o&&(o="all"),Ajax.send("Export",{Format:e,Storage:o,GroupUUID:this.currentGroupUUID(),ContactUUIDs:t},function(t){var o=new Blob([t.ResponseText],{type:"text/plain;charset=utf-8"});FileSaver.saveAs(o,"export."+e,!0)},this,{Format:"Raw"})},CContactsView.prototype.executeCancel=function(){var e=this.selectedItem();e&&(e instanceof CContactModel&&!e.readOnly()?e.isNew()?Routing.setPreviousHash():e.edited()?(e.edited(!1),this.requestContact(e.uuid())):this.changeRouting():e instanceof CGroupModel&&!e.readOnly()?e.isNew()?Routing.setPreviousHash():e.edited()?(this.selectedItem(this.selectedOldItem()),e.edited(!1)):this.changeRouting():this.oImportView.visibility()&&Routing.setPreviousHash())},CContactsView.prototype.executeAddContactsToGroup=function(e,t){e&&_.isArray(t)&&0<t.length&&(e.recivedAnim(!0),this.executeAddContactsToGroupUUID(e.UUID(),t))},CContactsView.prototype.executeAddContactsToGroupUUID=function(e,t){e&&_.isArray(t)&&0<t.length&&Ajax.send("AddContactsToGroup",{GroupUUID:e,ContactUUIDs:t},this.onAddContactsToGroupResponse,this)},CContactsView.prototype.onAddContactsToGroupResponse=function(e){e.Result||Api.showErrorByCode(e),this.requestContactList(),this.selector.itemSelected()&&this.requestContact(this.selector.itemSelected().UUID())},CContactsView.prototype.executeAddSelectedContactsToGroup=function(e){var t=this.selector.listCheckedOrSelected(),o=[];e&&_.isArray(t)&&0<t.length&&_.each(t,function(e){e&&!e.IsGroup()&&o.push(e.UUID())},this),this.executeAddContactsToGroup(e,o)},CContactsView.prototype.groupsInContactView=function(e){var t=[],o=[];return e&&!e.groupsIsEmpty()&&(o=e.groups(),t=_.filter(this.groupFullCollection(),function(e){return 0<=$.inArray(e.UUID(),o)})),t},CContactsView.prototype.onShow=function(){this.selector.useKeyboardKeys(!0),this.oPageSwitcher.show(),this.oJua&&this.oJua.setDragAndDropEnabledStatus(!0),this.bRefreshContactList=!0},CContactsView.prototype.onHide=function(){this.selector.listCheckedOrSelected(!1),this.selector.useKeyboardKeys(!1),this.selectedItem(null),this.oPageSwitcher.hide(),this.oJua&&this.oJua.setDragAndDropEnabledStatus(!1)},CContactsView.prototype.onBind=function(){this.selector.initOnApplyBindings(".contact_sub_list .item",".contact_sub_list .selected.item",".contact_sub_list .item .custom_checkbox",$(".contact_list",this.$viewDom),$(".contact_list_scroll.scroll-inner",this.$viewDom));var e=this;this.$viewDom.on("click",".content .item.add_to .dropdown_helper .item",function(){$(this).hasClass("new-group")?e.executeNewGroup():e.executeAddSelectedContactsToGroup(ko.dataFor(this))}),this.showPersonalContacts(-1!==$.inArray("personal",Settings.Storages)),this.showTeamContacts(-1!==$.inArray("team",Settings.Storages)),this.showSharedToAllContacts(-1!==$.inArray("shared",Settings.Storages)),this.selectedStorage(this.selectedStorage()),this.oImportView.onBind(),this.requestGroupFullList(),App.isMobile()||this.hotKeysBind(),this.initUploader()},CContactsView.prototype.hotKeysBind=function(){var e=!1;$(document).on("keydown",_.bind(function(t){var o=t.keyCode,s=this.collection()[0],i=this.isSearchFocused(),r=!1;this.shown()&&!Utils.isTextFieldFocused()&&!i&&t&&o===Enums.Key.s?(t.preventDefault(),this.searchFocus()):s&&(r=s.selected(),s&&i&&t&&o===Enums.Key.Down?(this.isSearchFocused(!1),this.selector.itemSelected(s),e=!0):!i&&e&&r&&t&&o===Enums.Key.Up?(this.isSearchFocused(!0),this.selector.itemSelected(!1),e=!1):r?e=!0:r||(e=!1))},this))},CContactsView.prototype.refreshContactsAndGroups=function(){this.requestContactList(),this.requestGroupFullList()},CContactsView.prototype.requestContactList=function(){var e="group"===this.selectedStorage()&&this.selectedGroupInList()?this.selectedGroupInList().UUID():"",t=""!==e?"all":this.selectedStorage();this.loadingList(!0),Ajax.send("GetContacts",{Offset:(this.currentPage()-1)*Settings.ContactsPerPage,Limit:Settings.ContactsPerPage,SortField:Enums.ContactSortField.Name,Search:this.search(),GroupUUID:e,Storage:t},this.onGetContactsResponse,this)},CContactsView.prototype.requestGroupFullList=function(){Ajax.send("GetGroups",null,this.onGetGroupsResponse,this)},CContactsView.prototype.requestContact=function(e){this.loadingViewPane(!0);var t=_.find(this.collection(),function(t){return t.UUID()===e});t?(this.selector.itemSelected(t),Ajax.send("GetContact",{UUID:t.UUID()},this.onGetContactResponse,this)):(this.contactUidForRequest(e),this.selector.itemSelected(null),this.selectedItem(null))},CContactsView.prototype.editGroup=function(e){var t=new CGroupModel;t.populate(e),this.selectedOldItem(t),e.edited(!0)},CContactsView.prototype.changeGroupType=function(e){this.changeRouting({Storage:e,GroupUUID:""})},CContactsView.prototype.onViewGroupClick=function(e){var t="string"==typeof e?e:e.UUID();this.changeRouting({Storage:"group",GroupUUID:t})},CContactsView.prototype.onRoute=function(e){var t=LinksUtils.parseContacts(e),o=this.selectedStorage()!==t.Storage||this.currentGroupUUID()!==t.GroupUUID||this.search()!==t.Search,s=this.bRefreshContactList;switch(this.bRefreshContactList=!1,this.pageSwitcherLocked(!0),this.oPageSwitcher.perPage()!==Settings.ContactsPerPage&&(s=!0),o?(this.oPageSwitcher.clear(),this.oPageSwitcher.perPage(Settings.ContactsPerPage)):this.oPageSwitcher.setPage(t.Page,Settings.ContactsPerPage),this.pageSwitcherLocked(!1),t.Page!==this.oPageSwitcher.currentPage()&&Routing.replaceHash(LinksUtils.getContacts(t.Storage,t.GroupUUID,t.Search,this.oPageSwitcher.currentPage())),this.currentPage()!==t.Page&&(this.currentPage(t.Page),s=!0),this.selectedStorage()!==t.Storage&&-1!==$.inArray(t.Storage,Settings.Storages)&&"group"!==t.Storage?(this.selectedStorage(t.Storage),s=!0):"group"!==t.Storage||"create-group"===t.Action||this.currentGroupUUID()===t.GroupUUID&&""!==t.ContactUUID||(this.viewGroup(t.GroupUUID)?s=!1:Routing.replaceHash(LinksUtils.getContacts())),this.search()!==t.Search&&(this.search(t.Search),s=!0),this.contactUidForRequest(""),t.ContactUUID?0===this.collection().length?this.contactUidForRequest(t.ContactUUID):this.requestContact(t.ContactUUID):this.selectedItem()instanceof CContactModel&&(this.selector.itemSelected(null),this.selectedItem(null)),t.Action){case"create-contact":var i=this.selectedGroupInList(),r=ContactsCache.getNewContactParams();this.oContactModel.switchToNew(),this.oContactModel.groups(i?[i.UUID()]:[]),r&&(_.each(r,function(e,t){_.isFunction(this.oContactModel[t])&&this.oContactModel[t](e)},this),this.oContactModel.extented(!0)),this.selectedItem(this.oContactModel),this.selector.itemSelected(null),this.oImportView.visibility(!1);break;case"create-group":this.oGroupModel.switchToNew(),this.selectedItem(this.oGroupModel),this.selector.itemSelected(null),this.oImportView.visibility(!1);break;case"import":this.selectedItem(null),this.oImportView.visibility(!0),this.selector.itemSelected(null);break;default:t.ContactUUID||t.GroupUUID||(this.selectedItem(null),this.selector.itemSelected(null)),this.oImportView.visibility(!1)}s&&this.requestContactList(),this.isSaving(!1)},CContactsView.prototype.viewGroup=function(e){var t=_.find(this.groupFullCollection(),function(t){return t&&t.UUID()===e});return t?(this.groupUidForRequest(""),this.oGroupModel.clear(),this.oGroupModel.uuid(t.UUID()).name(t.Name()),t.IsOrganization()&&this.requestGroup(t),this.selectedGroupInList(t),this.selectedItem(this.oGroupModel),this.selector.itemSelected(null),this.selector.listCheckedOrSelected(!1)):this.groupUidForRequest(e),!!t},CContactsView.prototype.deleteGroup=function(e){e&&(this.groupFullCollection.remove(function(t){return t&&t.UUID()===e}),Ajax.send("DeleteGroup",{UUID:e},function(e){e.Result||Api.showErrorByCode(e),this.requestGroupFullList()},this),this.changeGroupType(Settings.DefaultStorage))},CContactsView.prototype.mailGroup=function(e){this.bAllowComposeMessageToAddresses&&e&&Ajax.send("GetContacts",{Storage:"all",Offset:0,Limit:200,SortField:Enums.ContactSortField.Name,GroupUUID:e.uuid()},function(e){var t=e&&e.Result&&e.Result.List,o=(Types.isNonEmptyArray(t)?_.compact(_.map(t,function(e){var t=new CContactListItemModel;return t.parse(e),""!==t.Email()?t.getFullEmail():""})):[]).join(", ");""!==o&&this.composeMessageToAddresses(o)},this)},CContactsView.prototype.dragAndDropHelper=function(e){e&&e.checked(!0);var t=this.selector.itemSelected(),o=Utils.draggableItems(),s=this.selector.listCheckedOrSelected().length,i=0<s?_.map(this.selector.listCheckedOrSelected(),function(e){return e.UUID()}):[];return t&&!t.checked()&&t.checked(!0),o.data("drag-contatcs-storage",this.selectedStorage()),o.data("drag-contatcs-uids",i),$(".count-text",o).text(TextUtils.i18n("%MODULENAME%/LABEL_DRAG_CONTACTS_PLURAL",{COUNT:s},null,s)),o},CContactsView.prototype.contactsDrop=function(e,t,o){if(e){var s=o&&o.helper?o.helper:null,i=s?s.data("drag-contatcs-uids"):null;null!==i&&(Utils.uiDropHelperAnim(t,o),this.executeAddContactsToGroup(e,i))}},CContactsView.prototype.contactsDropToGroupType=function(e,t,o){var s=o&&o.helper,i=s&&s.data("drag-contatcs-storage")||null;null!==(s&&s.data("drag-contatcs-uids")||null)&&null!==i&&e!==i&&(Utils.uiDropHelperAnim(t,o),this.executeShare())},CContactsView.prototype.searchFocus=function(){this.selector.useKeyboardKeys()&&!Utils.isTextFieldFocused()&&this.isSearchFocused(!0)},CContactsView.prototype.viewContact=function(e){if(e){var t="group"===this.selectedStorage()?this.currentGroupUUID():"",o="string"==typeof e?e:e.UUID();this.changeRouting({GroupUUID:t,ContactUUID:o})}},CContactsView.prototype.composeMessageToContact=function(e){var t=e?e.getFullEmail():"";""!==t&&this.composeMessageToAddresses(t)},CContactsView.prototype.composeMessage=function(){var e=this.selector.listCheckedOrSelected(),t=(Types.isNonEmptyArray(e)?_.compact(_.map(e,function(e){return""!==e.Email()?e.getFullEmail():""})):[]).join(", ");""!==t&&this.composeMessageToAddresses(t)},CContactsView.prototype.onClearSearchClick=function(){this.searchInput(""),this.searchSubmitCommand()},CContactsView.prototype.onGetContactResponse=function(e,t){var o=e.Result;if(o){var s=new CContactModel,i=this.selector.itemSelected();s.parse(o),i&&i.UUID()===s.uuid()&&(this.selectedContact()instanceof CContactModel&&s instanceof CContactModel&&this.selectedContact().uuid()===s.uuid()&&s.edited(this.selectedContact().edited()),this.selectedItem(s))}else Api.showErrorByCode(e)},CContactsView.prototype.onGetContactsResponse=function(e,t){var o=e.Result;if(o){var s=Types.pInt(o.ContactCount),i=Types.isNonEmptyArray(o.List)?_.compact(_.map(o.List,function(e){var t=new CContactListItemModel;return t.parse(e),t})):[],r=this.selector.itemSelected(),n=r?_.find(i,function(e){return r.UUID()===e.UUID()}):null,a=this.selector.listChecked(),c=a&&0<a.length?_.map(a,function(e){return e.UUID()}):[];Types.isNonEmptyArray(c)&&_.each(i,function(e){e.checked(-1<$.inArray(e.UUID(),c))}),this.collection(i),this.oPageSwitcher.setCount(s),this.contactCount(s),n?(this.selector.itemSelected(n),this.requestContact(n.UUID())):r&&this.changeRouting({},!0),this.selectedGroupEmails(this.selectedGroup()?_.uniq(_.flatten(_.map(this.collection(),function(e){return e.aEmails}))):[])}else Api.showErrorByCode(e);this.loadingList(!1)},CContactsView.prototype.viewAllMails=function(){this.selectedGroupEmails().length>0&&this.searchMessagesInInbox("email:"+this.selectedGroupEmails().join(","))},CContactsView.prototype.onGetGroupsResponse=function(e,t){var o=e.Result;if(o){var s=0,i=0,r=[],n=_.find(this.groupFullCollection(),function(e){return e.selected()}),a=null;for(this.groupFullCollection(r),this.selectedGroupInList(null),i=o.length;s<i;s++)o[s]&&(o[s].IsGroup=!0,(a=new CContactListItemModel).parse(o[s]),a.IsGroup()&&(n&&n.UUID()===a.UUID()&&this.selectedGroupInList(a),r.push(a)));null===this.selectedGroupInList()&&Routing.replaceHash(LinksUtils.getContacts()),this.groupFullCollection(r)}else Api.showErrorByCode(e)},CContactsView.prototype.onCreateGroupResponse=function(e,t){this.isSaving(!1),e.Result?("string"==typeof e.Result&&""!==e.Result?this.onViewGroupClick(e.Result):this.selectedGroup()&&this.selectedGroup().edited()&&this.selectedGroup().edited(!1),Screens.showReport(TextUtils.i18n("%MODULENAME%/REPORT_GROUP_SUCCESSFULLY_ADDED")),this.requestGroupFullList()):Api.showErrorByCode(e,TextUtils.i18n("%MODULENAME%/ERROR_SAVE_GROUP"))},CContactsView.prototype.executeShare=function(){var e="all"===this.selectedStorage(),t=_.filter(this.selector.listCheckedOrSelected(),function(e){return"team"!==e.sStorage}),o=_.map(t,function(e){return e.UUID()});0<(o=_.compact(o)).length&&(_.each(t,function(e){e&&ContactsCache.clearInfoAboutEmail(e.Email())},this),e||(-1<$.inArray(this.selectedContact(),t)&&this.selectedContact(null),_.each(this.collection(),function(e){-1<$.inArray(e,t)&&e.deleted(!0)}),_.delay(function(){this.collection.remove(function(e){return e.deleted()})}.bind(this),500)),"shared"===this.selectedStorage()?this.recivedAnimPersonal(!0):this.recivedAnimShared(!0),Ajax.send("UpdateSharedContacts",{UUIDs:o},function(){e&&(this.selector.listCheckedOrSelected(!1),this.requestContactList())},this))},CContactsView.prototype.requestGroup=function(e){this.loadingViewPane(!0),e&&Ajax.send("GetGroup",{UUID:e.UUID()},this.onGetGroupResponse,this)},CContactsView.prototype.onGetGroupResponse=function(e,t){if(e.Result){var o=e.Result;this.oGroupModel.uuid(Types.pString(o.UUID)).name(o.Name).isOrganization(o.IsOrganization).company(o.Company).country(o.Country).state(o.State).city(o.City).street(o.Street).zip(o.Zip).phone(o.Phone).fax(o.Fax).email(o.Email).web(o.Web)}else Api.showErrorByCode(e)},CContactsView.prototype.onGetGroupEventsResponse=function(e,t){if(e.Result){var o=e.Result;this.oGroupModel.events(o)}},CContactsView.prototype.initUploader=function(){this.uploaderArea()&&(this.oJua=new CJua({action:"?/Api/",name:"jua-uploader",queueSize:2,dragAndDropElement:this.uploaderArea(),disableAjaxUpload:!1,disableFolderDragAndDrop:!1,disableDragAndDrop:!1,hidden:_.extendOwn({Module:Settings.ServerModuleName,Method:"Import",Parameters:_.bind(function(){return JSON.stringify({GroupUUID:this.currentGroupUUID(),Storage:"personal"})},this)},App.getCommonRequestParameters())}),this.oJua.on("onSelect",_.bind(this.onImportSelect,this)).on("onComplete",_.bind(this.onImportComplete,this)).on("onBodyDragEnter",_.bind(this.dragActive,this,!0)).on("onBodyDragLeave",_.bind(this.dragActive,this,!1)))},CContactsView.prototype.onImportSelect=function(e,t){var o=this.isNotTeamStorageSelected(),s=!1;return o&&(_.each(Settings.ImportExportFormats,function(e){e.toLowerCase()===t.FileName.substr(t.FileName.length-e.length).toLowerCase()&&(s=!0)}),s||(Screens.showError(this.getFormatDependentText("ERROR_FILE_EXTENSION")),o=!1)),o},CContactsView.prototype.onImportComplete=function(e,t,o){var s=0;!(t&&o&&o.Result)?o&&o.ErrorCode===Enums.Errors.IncorrectFileExtension?Screens.showError(this.getFormatDependentText("ERROR_FILE_EXTENSION")):Screens.showError(TextUtils.i18n("COREWEBCLIENT/ERROR_UPLOAD_FILE")):0<(s=Types.pInt(o.Result.ImportedCount))?Screens.showReport(TextUtils.i18n("%MODULENAME%/REPORT_CONTACTS_IMPORTED_PLURAL",{NUM:s},null,s)):Screens.showError(TextUtils.i18n("%MODULENAME%/ERROR_IMPORT_NO_CONTACT")),this.requestGroupFullList(),this.requestContactList()},module.exports=CContactsView;