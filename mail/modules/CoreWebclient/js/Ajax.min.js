"use strict";function CAjax(){this.requests=ko.observableArray([]),this.aOnAllRequestsClosedHandlers=[],this.requests.subscribe(function(){0===this.requests().length&&_.each(this.aOnAllRequestsClosedHandlers,function(e){$.isFunction(e)&&e()})},this),this.aAbortRequestHandlers={},this.bAllowRequests=!0,this.bInternetConnectionProblem=!1,App.subscribeEvent("%ModuleName%::GetDebugInfo",_.bind(function(e){var t=[];_.each(this.requests(),function(e){t.push(e.Request.Module+":"+e.Request.Method+":"+e.Xhr.readyState+(Types.isString(e.Xhr.statusText)?":"+e.Xhr.statusText:""))}),e.Info.push(t.join(", "))},this))}var _=require("underscore"),$=require("jquery"),moment=require("moment"),ko=require("knockout"),TextUtils=require("%PathToCoreWebclientModule%/js/utils/Text.js"),Types=require("%PathToCoreWebclientModule%/js/utils/Types.js"),Utils=require("%PathToCoreWebclientModule%/js/utils/Common.js"),Popups=require("%PathToCoreWebclientModule%/js/Popups.js"),AlertPopup=require("%PathToCoreWebclientModule%/js/popups/AlertPopup.js"),App=require("%PathToCoreWebclientModule%/js/App.js"),Screens=require("%PathToCoreWebclientModule%/js/Screens.js");CAjax.prototype.getOpenedRequest=function(e,t){var s=_.find(this.requests(),function(s){return s.Request.Module===e&&s.Request.Method===t});return s?s.Request:null},CAjax.prototype.hasOpenedRequests=function(e,t){return e=Types.pString(e),""===(t=Types.pString(t))?this.requests().length>0:!!_.find(this.requests(),function(s){if(s){var o=4===s.Xhr.readyState,r=0===s.Xhr.readyState&&"abort"===s.Xhr.statusText,n=s.Request.Module===e&&s.Request.Method===t;return!o&&!r&&n}return!1})},CAjax.prototype.registerAbortRequestHandler=function(e,t){this.aAbortRequestHandlers[e]=t},CAjax.prototype.registerOnAllRequestsClosedHandler=function(e){this.aOnAllRequestsClosedHandlers.push(e)},CAjax.prototype.send=function(e,t,s,o,r,n,u){s=s||{};var i=_.extendOwn({Module:e,Method:t,Parameters:s},App.getCommonRequestParameters());if(u&&(i=_.extendOwn(i,u)),this.bAllowRequests&&!this.bInternetConnectionProblem){var a={Module:e,Method:t,Parameters:s,ResponseHandler:o,Context:r,Continue:!0};App.broadcastEvent("SendAjaxRequest::before",a),a.Continue&&(this.abortRequests(i),this.doSend(i,o,r,n))}else{var l={Result:!1,ErrorCode:Enums.Errors.NotDisplayedError};this.executeResponseHandler(o,r,l,i,"error")}},CAjax.prototype.doSend=function(e,t,s,o){var r=_.bind(this.done,this,e,t,s),n=_.bind(this.fail,this,e,t,s),u=_.bind(this.always,this,e),i=null,a=_.clone(e),l=$.cookie("AuthToken")||"",d={"X-Client":"WebClient"};""===l&&App.getUserRole()!==Enums.UserRole.Anonymous&&App.logoutAndGotoLogin(),""!==l&&(d.Authorization="Bearer "+l),a.Parameters=JSON.stringify(a.Parameters),i=$.ajax({url:"?/Api/",type:"POST",async:!0,dataType:"json",headers:d,data:a,success:r,error:n,complete:u,timeout:void 0===o?5e4:o}),this.requests().push({Request:e,Xhr:i,Time:moment()})},CAjax.prototype.abortRequests=function(e){var t=this.aAbortRequestHandlers[e.Module];$.isFunction(t)&&this.requests().length>0&&(_.each(this.requests(),_.bind(function(s,o){if(s){var r=s.Request;e.Module===r.Module&&t(e,r)&&(s.Xhr.abort(),this.requests()[o]=void 0)}},this)),this.requests(_.compact(this.requests())))},CAjax.prototype.abortAllRequests=function(e){"object"!=typeof e&&(e={Module:"",Method:""}),_.each(this.requests(),function(t){!t||t.Request.Module===e.Module&&t.Request.Method===e.Method||t.Xhr.abort()},this),this.requests([])},CAjax.prototype.abortAndStopSendRequests=function(e){this.bAllowRequests=!1,this.abortAllRequests(e)},CAjax.prototype.startSendRequests=function(){this.bAllowRequests=!0},CAjax.prototype.done=function(e,t,s,o,r,n){if(App.getUserRole()!==Enums.UserRole.Anonymous&&o&&Types.isNumber(o.AuthenticatedUserId)&&0!==o.AuthenticatedUserId&&o.AuthenticatedUserId!==App.getUserId()&&Popups.showPopup(AlertPopup,[TextUtils.i18n("%MODULENAME%/ERROR_AUTHENTICATED_USER_CONFLICT"),function(){App.logoutAndGotoLogin()},"",TextUtils.i18n("%MODULENAME%/ACTION_LOGOUT")]),o&&(!1===o.Result||null===o.Result||void 0===o.Result)){switch(o.ErrorCode){case Enums.Errors.InvalidToken:this.abortAndStopSendRequests(),App.tokenProblem();break;case Enums.Errors.AuthError:App.getUserRole()!==Enums.UserRole.Anonymous&&App.logoutAndGotoLogin()}o.Result=!1}this.executeResponseHandler(t,s,o,e,r)},CAjax.prototype.fail=function(e,t,s,o,r,n){var u={Result:!1,ErrorCode:0};switch(r){case"abort":u={Result:!1,ErrorCode:Enums.Errors.NotDisplayedError};break;default:case"error":case"parseerror":u=""===n?{Result:!1,ErrorCode:Enums.Errors.NotDisplayedError,ResponseText:o.responseText}:{Result:!1,ErrorCode:Enums.Errors.DataTransferFailed,ResponseText:o.responseText}}this.executeResponseHandler(t,s,u,e,r)},CAjax.prototype.executeResponseHandler=function(e,t,s,o,r){s||(s={Result:!1,ErrorCode:0}),this.checkConnection(o.Module,o.Method,r),$.isFunction(e)&&!s.StopExecuteResponse&&e.apply(t,[s,o]),App.broadcastEvent("ReceiveAjaxResponse::after",{Request:o,Response:s})},CAjax.prototype.always=function(e,t,s){"abort"!==s&&(_.each(this.requests(),function(t,s){t&&(_.isEqual(t.Request,e)?this.requests()[s]=void 0:moment().diff(t.Time)>3e5&&(Utils.log("always, request is in the list more than 5 minutes",t),this.requests()[s]=void 0))},this),this.requests(_.compact(this.requests())))},CAjax.prototype.checkConnection=function(){var e=-1;return function(t,s,o){clearTimeout(e),"error"!==o?(Ajax.bInternetConnectionProblem=!1,Screens.hideError(!0)):"Core"===t&&"Ping"===s?(Ajax.bInternetConnectionProblem=!0,Screens.showError(TextUtils.i18n("%MODULENAME%/ERROR_NO_INTERNET_CONNECTION"),!0,!0),e=setTimeout(function(){Ajax.doSend({Module:"Core",Method:"Ping"})},1e4)):Ajax.doSend({Module:"Core",Method:"Ping"})}}();var Ajax=new CAjax;module.exports={getOpenedRequest:_.bind(Ajax.getOpenedRequest,Ajax),hasInternetConnectionProblem:function(){return Ajax.bInternetConnectionProblem},hasOpenedRequests:_.bind(Ajax.hasOpenedRequests,Ajax),registerAbortRequestHandler:_.bind(Ajax.registerAbortRequestHandler,Ajax),registerOnAllRequestsClosedHandler:_.bind(Ajax.registerOnAllRequestsClosedHandler,Ajax),abortAndStopSendRequests:_.bind(Ajax.abortAndStopSendRequests,Ajax),startSendRequests:_.bind(Ajax.startSendRequests,Ajax),send:_.bind(Ajax.send,Ajax)};