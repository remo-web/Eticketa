"use strict";function InitNotMobileRequires(){require("%PathToCoreWebclientModule%/js/CustomTooltip.js"),require("%PathToCoreWebclientModule%/js/koBindingsNotMobile.js")}function InitModernizr(){modernizr&&navigator&&(modernizr.addTest("pdf",function(){return!!_.find(navigator.mimeTypes,function(e){return"application/pdf"===e.type})||Browser.firefox}),modernizr.addTest("newtab",function(){return App.isNewTab()}),modernizr.addTest("mobile",function(){return App.isMobile()}),navigator&&modernizr.addTest("native-android-browser",function(){var e=navigator.userAgent;return e.indexOf("Mozilla/5.0")>-1&&e.indexOf("Android ")>-1&&e.indexOf("534")>-1&&e.indexOf("AppleWebKit")>-1}))}function CApp(){this.iUserRole=window.auroraAppData.User?Types.pInt(window.auroraAppData.User.Role):Enums.UserRole.Anonymous,this.iTenantId=window.auroraAppData.User?Types.pInt(window.auroraAppData.User.TenantId):0,this.sUserName=window.auroraAppData.User?Types.pString(window.auroraAppData.User.Name):"",this.sUserPublicId=window.auroraAppData.User?Types.pString(window.auroraAppData.User.PublicId):"",this.iUserId=window.auroraAppData.User?Types.pInt(window.auroraAppData.User.Id):0,this.bPublic=!1,this.bNewTab=!1,this.userAuthAccountsCountsArray=ko.observableArray([]),this.userAccountsCount=ko.computed(function(){return _.reduce(this.userAuthAccountsCountsArray(),function(e,t){return e+t()},0)},this),this.userAccountsWithPass=ko.observableArray([]),this.firstAccountWithPassLogin=ko.computed(function(){var e="";return _.each(this.userAccountsWithPass(),function(t){var o=t();!Types.isNonEmptyString(e)&&o.length>0&&Types.isNonEmptyString(o[0])&&(e=o[0])}),e},this),this.mobileCredentialsHintText=ko.computed(function(){var e=this.firstAccountWithPassLogin()||this.getUserPublicId();return TextUtils.i18n("COREWEBCLIENT/INFO_MOBILE_CREDENTIALS",{LOGIN:e})},this)}require("%PathToCoreWebclientModule%/js/koExtendings.js");var _=require("underscore"),$=require("jquery"),ko=require("knockout"),modernizr=require("%PathToCoreWebclientModule%/js/vendors/modernizr.js"),TextUtils=require("%PathToCoreWebclientModule%/js/utils/Text.js"),Types=require("%PathToCoreWebclientModule%/js/utils/Types.js"),UrlUtils=require("%PathToCoreWebclientModule%/js/utils/Url.js"),Api=require("%PathToCoreWebclientModule%/js/Api.js"),Browser=require("%PathToCoreWebclientModule%/js/Browser.js"),ModulesManager=require("%PathToCoreWebclientModule%/js/ModulesManager.js"),Routing=require("%PathToCoreWebclientModule%/js/Routing.js"),Screens=require("%PathToCoreWebclientModule%/js/Screens.js"),UserSettings=require("%PathToCoreWebclientModule%/js/Settings.js"),WindowOpener=require("%PathToCoreWebclientModule%/js/WindowOpener.js"),Popups=require("%PathToCoreWebclientModule%/js/Popups.js"),ConfirmPopup=require("%PathToCoreWebclientModule%/js/popups/ConfirmPopup.js");require("%PathToCoreWebclientModule%/js/enums.js"),require("%PathToCoreWebclientModule%/js/koBindings.js"),require("%PathToCoreWebclientModule%/js/koOtherBindings.js"),require("%PathToCoreWebclientModule%/js/vendors/inputosaurus.js"),require("%PathToCoreWebclientModule%/js/vendors/jquery.cookie.js"),CApp.prototype.registerUserAccountsCount=function(e){this.userAuthAccountsCountsArray.push(e)},CApp.prototype.registerAccountsWithPass=function(e){this.userAccountsWithPass.push(e)},CApp.prototype.isAccountDeletingAvailable=function(){return!(this.userAccountsCount()<=1)||(Screens.showError(TextUtils.i18n("%MODULENAME%/ERROR_ACCOUNT_DELETING_DISABLE"),!0),!1)},CApp.prototype.getUserRole=function(){return this.iUserRole},CApp.prototype.isUserNormalOrTenant=function(){return this.iUserRole===Enums.UserRole.NormalUser||this.iUserRole===Enums.UserRole.TenantAdmin},CApp.prototype.getTenantId=function(){return this.iTenantId},CApp.prototype.getUserName=function(){return this.sUserName},CApp.prototype.getUserPublicId=function(){return this.sUserPublicId},CApp.prototype.getUserId=function(){return this.iUserId},CApp.prototype.setPublic=function(){this.bPublic=!0},CApp.prototype.isPublic=function(){return this.bPublic},CApp.prototype.setNewTab=function(){this.bNewTab=!0},CApp.prototype.isNewTab=function(){return this.bNewTab},CApp.prototype.isMobile=function(){return 1===UserSettings.IsMobile},CApp.prototype.init=function(){if(ModulesManager.run("StandardLoginFormWebclient","beforeAppRunning",[this.iUserRole!==Enums.UserRole.Anonymous]),App.isUserNormalOrTenant()&&UserSettings.AllowChangeSettings&&ModulesManager.run("SettingsWebclient","registerSettingsTab",[function(){return require("%PathToCoreWebclientModule%/js/views/CommonSettingsFormView.js")},"common",TextUtils.i18n("%MODULENAME%/LABEL_COMMON_SETTINGS_TABNAME")]),App.getUserRole()===Enums.UserRole.SuperAdmin&&ModulesManager.run("AdminPanelWebclient","registerAdminPanelTab",[function(e){require.ensure(["%PathToCoreWebclientModule%/js/views/CommonSettingsFormView.js"],function(){e(require("%PathToCoreWebclientModule%/js/views/CommonSettingsFormView.js"))},"admin-bundle")},"system",TextUtils.i18n("%MODULENAME%/LABEL_COMMON_SETTINGS_TABNAME")]),ModulesManager.run("Ios","routeToIos"),this.iUserRole!==Enums.UserRole.Anonymous&&!this.bPublic){var e=ModulesManager.run("MailWebclient","getAccountList");e?(this.currentAccountId=e.currentId,this.hasAccountWithId=_.bind(e.hasAccountWithId,e),this.currentAccountEmail=ko.computed(function(){var t=e.getAccount(this.currentAccountId());return t?t.email():""},this),this.getAttendee=function(t){return e.getAttendee(_.map(t,function(e){return Types.isString(e)?e:e.email},this))}):this.currentAccountEmail=_.bind(function(){return this.sUserName},this)}this.isMobile()||InitNotMobileRequires(),Screens.init(this.iUserRole===Enums.UserRole.Anonymous),Routing.init(),require("%PathToCoreWebclientModule%/js/AppTab.js"),this.bNewTab||require("%PathToCoreWebclientModule%/js/Prefetcher.js"),this.useGoogleAnalytics(),this.isMobile()||$(window).on("unload",function(){WindowOpener.closeAll()}),window.onbeforeunload=_.bind(function(){if(Screens.hasUnsavedChanges()||Popups.hasUnsavedChanges())return"";WindowOpener.getOpenedWindows()},this),Browser.ie8AndBelow&&$("body").css("overflow","hidden"),this.checkCookies(),this.showLastErrorOnLogin(),!1===UserSettings.IsSystemConfigured&&Screens.showError(TextUtils.i18n("%MODULENAME%/ERROR_SYSTEM_NOT_CONFIGURED"),!0)},CApp.prototype.showLastErrorOnLogin=function(){if(this.iUserRole===Enums.UserRole.Anonymous){var e=Types.pInt(UrlUtils.getRequestParam("error")),t=Types.pString(UrlUtils.getRequestParam("module"));0!==e&&Api.showErrorByCode({ErrorCode:e,Module:t},"",!0),UserSettings.LastErrorCode===Enums.Errors.AuthError&&Screens.showError(TextUtils.i18n("%MODULENAME%/ERROR_AUTH_PROBLEM"),!0)}},CApp.prototype.logout=function(){if(Screens.hasUnsavedChanges()||Popups.hasUnsavedChanges()){var e=_.isFunction(Screens.getCurrentScreen)?Screens.getCurrentScreen():null;this.askDiscardChanges(this.logoutAndGotoLogin.bind(this),null,e)}else this.logoutAndGotoLogin()},CApp.prototype.logoutAndGotoLogin=function(){if($.cookie("AuthToken")){var e=require("%PathToCoreWebclientModule%/js/Ajax.js");e.send("Core","Logout",null),e.abortAndStopSendRequests(),$.removeCookie("AuthToken"),Routing.finalize(),this.iUserRole=Enums.UserRole.Anonymous,this.sUserName="",this.sUserPublicId="",this.iUserId=0}Types.isNonEmptyString(UserSettings.CustomLogoutUrl)?window.location.href=UserSettings.CustomLogoutUrl:UrlUtils.clearAndReloadLocation(Browser.ie8AndBelow,!0)},CApp.prototype.askDiscardChanges=function(e,t,o){var r=TextUtils.i18n("COREWEBCLIENT/CONFIRM_DISCARD_CHANGES"),n=_.bind(function(r){r&&_.isFunction(e)?(o&&_.isFunction(o.discardChanges)&&o.discardChanges(),e()):_.isFunction(t)&&t()},this);Popups.showPopup(ConfirmPopup,[r,n])},CApp.prototype.tokenProblem=function(){var e=TextUtils.i18n("%MODULENAME%/ERROR_TOKEN_PROBLEM_HTML",{RELOAD_FUNC:"window.location.reload(); return false;"});Screens.showError(e,!0)},CApp.prototype.checkMobile=function(){if(UserSettings.AllowMobile&&-1===UserSettings.IsMobile){var e=require("%PathToCoreWebclientModule%/js/Ajax.js"),t=!window.matchMedia("all and (min-width: 768px)").matches;return e.send("Core","SetMobile",{Mobile:t},function(e){t&&e.Result&&window.location.reload()},this),t}if(this.iUserRole===Enums.UserRole.SuperAdmin&&UserSettings.AllowMobile&&1===UserSettings.IsMobile){return(e=require("%PathToCoreWebclientModule%/js/Ajax.js")).send("Core","SetMobile",{Mobile:!1},function(e){window.location.reload()},this),!1}return!1},CApp.prototype.useGoogleAnalytics=function(){var e=null,t=null;UserSettings.GoogleAnalyticsAccount&&0<UserSettings.GoogleAnalyticsAccount.length&&(window._gaq=window._gaq||[],window._gaq.push(["_setAccount",UserSettings.GoogleAnalyticsAccount]),window._gaq.push(["_trackPageview"]),(e=document.createElement("script")).type="text/javascript",e.async=!0,e.src=("https:"===document.location.protocol?"https://ssl":"http://www")+".google-analytics.com/ga.js",(t=document.getElementsByTagName("script")[0]).parentNode.insertBefore(e,t))},CApp.prototype.checkCookies=function(){$.cookie.defaults={path:UserSettings.CookiePath,secure:UserSettings.CookieSecure},$.cookie("checkCookie","1");var e="1"===$.cookie("checkCookie");if($.removeCookie("checkCookie"),e)if(this.iUserRole===Enums.UserRole.Anonymous)$.removeCookie("AuthToken");else{var t=$.cookie("AuthToken");t&&this.setAuthToken(t)}else Screens.showError(TextUtils.i18n("%MODULENAME%/ERROR_COOKIES_DISABLED"),!0);return e},CApp.prototype.setAuthToken=function(e){var t={};UserSettings.AuthTokenCookieExpireTime>0&&(t.expires=UserSettings.AuthTokenCookieExpireTime),$.cookie("AuthToken",e,t)},CApp.prototype.getCommonRequestParameters=function(){return{TenantName:UserSettings.TenantName}},CApp.prototype.broadcastEvent=function(e,t){return!(!_.isArray(this.aEventsCallbacks)||!_.isArray(this.aEventsCallbacks[e]))&&(_.each(this.aEventsCallbacks[e],function(e){e(t)}),!0)},CApp.prototype.subscribeEvent=function(e,t){_.isArray(this.aEventsCallbacks)||(this.aEventsCallbacks=[]),_.isArray(this.aEventsCallbacks[e])||(this.aEventsCallbacks[e]=[]),this.aEventsCallbacks[e].push(t)};var App=new CApp;InitModernizr(),module.exports=App;