"use strict";function isUndefined(e){return void 0===e}function contains(e,t){var n=!1;return e&&t&&(n=e===t||(e.contains?e.contains(t):!!t.compareDocumentPosition&&!!(8&t.compareDocumentPosition(e)))),n}function mainClearTimeout(e){0<e&&clearTimeout(e),e=0}function getEvent(e){return(e=e&&(e.originalEvent?e.originalEvent:e)||window.event).dataTransfer?e:null}function getValue(e,t,n){return e&&t&&!isUndefined(e[t])?e[t]:n}function setValue(e,t,n){e[t]=n}function scopeBind(e,t){return function(){return e.apply(isUndefined(t)?null:t,Array.prototype.slice.call(arguments))}}function fakeMd5(e){var t="",n="0123456789abcdefghijklmnopqrstuvwxyz";for(e=isUndefined(e)?32:Types.pInt(e);t.length<e;)t+=n.substr(Math.round(Math.random()*n.length),1);return t}function getNewUid(){return"jua-uid-"+fakeMd5(16)+"-"+(new Date).getTime().toString()}function getDataFromFile(e,t){return{FileName:isUndefined(e.fileName)?isUndefined(e.name)?null:e.name:e.fileName,Size:isUndefined(e.fileSize)?isUndefined(e.size)?null:e.size:e.fileSize,Type:isUndefined(e.type)?null:e.type,Folder:isUndefined(t)?"":t,File:e}}function getDataFromFiles(e,t,n,o,i,r){var a=0,l=0,s=0,u=null,p=null,d=!1,c=!1,f=function(e,t,n,l){if(e&&!isUndefined(e.name))if(t=t||"",e.isFile)e.file(function(e){!d||0<=--i?n(getDataFromFile(e,t)):d&&!c&&0>i&&r&&(c=!0,r(a))});else if(o&&e.isDirectory&&e.createReader){var s=e.createReader(),u=0,p=0;s&&s.readEntries&&s.readEntries(function(o){if(o&&Types.isNonEmptyArray(o))for(u=0,p=o.length;u<p;u++)f(o[u],t+e.name+"/",n,l)})}};if(o=!!isUndefined(o)||!!o,n=!isUndefined(n)&&!!n,i=isUndefined(i)?iDefLimit:Types.pInt(i),a=i,d=0<i,e=e&&0<e.length?e:null)for(s=0,l=e.length;s<l;s++)(u=e[s])&&(n?"file"===u.kind&&u.webkitGetAsEntry&&(p=u.webkitGetAsEntry())&&f(p,"",t,r):!d||0<=--i?t(getDataFromFile(u)):d&&!c&&0>i&&r&&(c=!0,r(a)))}function getDataFromInput(e,t,n,o){var i=e&&e.files&&0<e.files.length?e.files:null;i?getDataFromFiles(i,t,!1,!1,n,o):t({FileName:e.value.split("\\").pop().split("/").pop(),Size:null,Type:null,Folder:"",File:null})}function eventContainsFiles(e){var t=!1;if(e&&e.dataTransfer&&e.dataTransfer.types&&e.dataTransfer.types.length)for(var n=0,o=e.dataTransfer.types.length;n<o;n++)if("files"===e.dataTransfer.types[n].toLowerCase()){t=!0;break}return t}function getDataFromDragEvent(e,t,n,o,i){var r=null,a=null;(e=getEvent(e))&&((r=(e.dataTransfer?getValue(e.dataTransfer,"items",null):null)||getValue(e,"items",null))&&0<r.length&&r[0]&&r[0].webkitGetAsEntry?getDataFromFiles(r,t,!0,i,n,o):eventContainsFiles(e)&&(a=getValue(e,"files",null)||(e.dataTransfer?getValue(e.dataTransfer,"files",null):null))&&0<a.length&&getDataFromFiles(a,t,!1,!1,n,o))}function createNextLabel(){return $('<label style="position: absolute; background-color:#fff; right: 0px; top: 0px; left: 0px; bottom: 0px; margin: 0px; padding: 0px; cursor: pointer;"></label>').css({opacity:0})}function createNextInput(e,t){return""!==t&&(t=' accept="'+t+'"'),$('<input type="file" tabindex="-1" hidefocus="hidefocus" style="position: absolute; '+e+': -9999px;"'+t+" />")}function getNewInput(e,t,n,o){e=isUndefined(e)?"":e.toString();var i=createNextInput(n=isUndefined(n)?"left":n.toString(),o=isUndefined(o)?"":o.toString());return 0<e.length&&i.attr("name",e),(isUndefined(t)||t)&&i.prop("multiple",!0),i}function getStringOrCallFunction(e,t){return Types.pString(_.isFunction(e)?e.apply(null,_.isArray(t)?t:[]):e)}function AjaxDriver(e,t){this.oXhrs={},this.oUids={},this.oJua=e,this.oOptions=t}function IframeDriver(e,t){this.oUids={},this.oForms={},this.oJua=e,this.oOptions=t}function CJua(e){e=isUndefined(e)?{}:e;var t=this;t.bEnableDnD=!0,t.bEnableButton=!0,t.oEvents={onDialog:null,onSelect:null,onStart:null,onComplete:null,onCompleteAll:null,onProgress:null,onDragEnter:null,onDragLeave:null,onDrop:null,onBodyDragEnter:null,onBodyDragLeave:null,onLimitReached:null},t.oOptions=_.extend({action:"",name:"",hidden:{},queueSize:10,clickElement:!1,dragAndDropElement:!1,dragAndDropBodyElement:!1,disableAjaxUpload:!1,disableFolderDragAndDrop:!0,disableDragAndDrop:!1,disableMultiple:!1,disableDocumentDropPrevent:!1,disableAutoUploadOnDrop:!1,multipleSizeLimit:50,hiddenElementsPosition:"left"},e),t.oQueue=queue(Types.pInt(getValue(t.oOptions,"queueSize",10))),t.runEvent("onCompleteAll")&&t.oQueue.await(function(){t.runEvent("onCompleteAll")}),t.oDriver=t.isAjaxUploaderSupported()&&!getValue(t.oOptions,"disableAjaxUpload",!1)?new AjaxDriver(t,t.oOptions):new IframeDriver(t,t.oOptions),t.oClickElement=getValue(t.oOptions,"clickElement",null),t.oClickElement&&($(t.oClickElement).css({position:"relative",overflow:"hidden"}),"inline"===$(this.oClickElement).css("display")&&$(this.oClickElement).css("display","inline-block"),this.oDriver.generateNewInput(this.oClickElement)),this.oDriver.isDragAndDropSupported()&&getValue(this.oOptions,"dragAndDropElement",!1)&&!getValue(this.oOptions,"disableAjaxUpload",!1)?function(e){var t=$(document),n=$(getValue(e.oOptions,"dragAndDropBodyElement",!1)||t),o=getValue(e.oOptions,"dragAndDropElement",!1);o&&(getValue(e.oOptions,"disableDocumentDropPrevent",!1)||t.on("dragover",function(t){if(e.bEnableDnD&&t&&(t=getEvent(t))&&t.dataTransfer&&eventContainsFiles(t))try{t.dataTransfer.dropEffect="none",t.preventDefault()}catch(e){}}),n&&n[0]&&n.on("dragover",function(t){e.bEnableDnD&&t&&mainClearTimeout(e.iDocTimer)}).on("dragenter",function(t){e.bEnableDnD&&t&&(t=getEvent(t))&&eventContainsFiles(t)&&(mainClearTimeout(e.iDocTimer),t.preventDefault(),e.runEvent("onBodyDragEnter",[t]))}).on("dragleave",function(t){e.bEnableDnD&&t&&(t=getEvent(t))&&(mainClearTimeout(e.iDocTimer),e.iDocTimer=setTimeout(function(){e.runEvent("onBodyDragLeave",[t])},200))}).on("drop",function(t){if(e.bEnableDnD&&t&&(t=getEvent(t))){var n=eventContainsFiles(t);return n&&t.preventDefault(),e.runEvent("onBodyDragLeave",[t]),!n}return!1}),$(o).bind("dragenter",function(t){e.bEnableDnD&&t&&(t=getEvent(t))&&eventContainsFiles(t)&&(mainClearTimeout(e.iDocTimer),t.preventDefault(),e.runEvent("onDragEnter",[o,t]))}).bind("dragover",function(t){if(e.bEnableDnD&&t&&(t=getEvent(t))&&t.dataTransfer&&eventContainsFiles(t))try{var o=t.dataTransfer.effectAllowed;mainClearTimeout(e.iDocTimer),t.dataTransfer.dropEffect="move"===o||"linkMove"===o?"move":"copy",t.stopPropagation(),t.preventDefault(),n.trigger("dragover",t)}catch(e){}}).bind("dragleave",function(t){if(e.bEnableDnD&&t&&(t=getEvent(t))){var n=document.elementFromPoint?document.elementFromPoint(t.clientX,t.clientY):null;if(n&&contains(this,n))return;mainClearTimeout(e.iDocTimer),e.runEvent("onDragLeave",[o,t])}}).bind("drop",function(t){e.bEnableDnD&&t&&(t=getEvent(t))&&eventContainsFiles(t)&&(t.preventDefault(),getDataFromDragEvent(t,function(n){n&&(getValue(e.oOptions,"disableAutoUploadOnDrop",!1)?e.runEvent("onDrop",[n,t,function(){e.addNewFile(n),mainClearTimeout(e.iDocTimer)}]):(e.runEvent("onDrop",[n,t]),e.addNewFile(n),mainClearTimeout(e.iDocTimer)))},getValue(e.oOptions,"multipleSizeLimit",iDefLimit),e.getEvent("onLimitReached"),!getValue(e.oOptions,"disableFolderDragAndDrop",!0))),e.runEvent("onDragLeave",[t])}))}(t):t.bEnableDnD=!1,setValue(t,"on",t.on),setValue(t,"cancel",t.cancel),setValue(t,"isDragAndDropSupported",t.isDragAndDropSupported),setValue(t,"isAjaxUploaderSupported",t.isAjaxUploaderSupported),setValue(t,"setDragAndDropEnabledStatus",t.setDragAndDropEnabledStatus)}var $=require("jquery"),_=require("underscore"),ko=require("knockout"),queue=require("%PathToCoreWebclientModule%/js/vendors/queue.js"),Types=require("%PathToCoreWebclientModule%/js/utils/Types.js"),App=require("%PathToCoreWebclientModule%/js/App.js"),iDefLimit=20;AjaxDriver.prototype.oXhrs={},AjaxDriver.prototype.oUids={},AjaxDriver.prototype.oJua=null,AjaxDriver.prototype.oOptions={},AjaxDriver.prototype.isDragAndDropSupported=function(){return!0},AjaxDriver.prototype.regTaskUid=function(e){this.oUids[e]=!0},AjaxDriver.prototype.uploadTask=function(e,t,n,o,i,r,a){if(!1===this.oUids[e]||!t||!t.File)return o(null,e),!1;try{var l=this,s=new XMLHttpRequest,u=new FormData,p=getValue(this.oOptions,"action",""),d=_.clone(getValue(this.oOptions,"hidden",{})),c=this.oJua.getEvent("onStart"),f=this.oJua.getEvent("onComplete"),g=this.oJua.getEvent("onProgress");return s.open("POST",p,!0),s.setRequestHeader("Authorization","Bearer "+$.cookie("AuthToken")),s.setRequestHeader("X-Client","WebClient"),g&&s.upload&&(s.upload.onprogress=function(n){n&&n.lengthComputable&&!isUndefined(n.loaded)&&!isUndefined(n.total)&&(void 0===a?g(e,n.loaded,n.total):g(e,a+n.loaded>t.Size?t.Size:a+n.loaded,t.Size))}),s.onreadystatechange=function(){if(4===s.readyState&&200===s.status){if(f&&!i){var t=!1,n=null;try{n=$.parseJSON(s.responseText),t=!0}catch(e){n=null}f(e,t,n)}isUndefined(l.oXhrs[e])||(l.oXhrs[e]=null),r?o(s.responseText,e):o(null,e)}else 4===s.readyState&&(f(e,!1,null),o(null,e))},c&&c(e),u.append("jua-post-type","ajax"),u.append(getValue(this.oOptions,"name","juaFile"),t.File,t.FileName),n=_.extend(n,t.Hidden||{}),d.Parameters=JSON.stringify(n),$.each(d,function(e,n){u.append(e,getStringOrCallFunction(n,[t]))}),s.send(u),this.oXhrs[e]=s,!0}catch(e){window.console&&window.console.error(e)}return o(null,e),!1},AjaxDriver.prototype.generateNewInput=function(e){var t=this,n=null,o=null;e&&(o=getNewInput("",!getValue(this.oOptions,"disableMultiple",!1),getValue(this.oOptions,"hiddenElementsPosition","left"),getValue(this.oOptions,"accept","")),(n=createNextLabel()).append(o),$(e).append(n),o.on("click",function(e){if(t.oJua.bEnableButton){var n=t.oJua.getEvent("onDialog");n&&n()}else e.preventDefault()}).on("change",function(){getDataFromInput(this,function(o){t.oJua.addNewFile(o),t.generateNewInput(e),setTimeout(function(){n.remove()},10)},getValue(t.oOptions,"multipleSizeLimit",iDefLimit),t.oJua.getEvent("onLimitReached"))}))},AjaxDriver.prototype.cancel=function(e){if(this.oUids[e]=!1,this.oXhrs[e]){try{this.oXhrs[e].abort&&this.oXhrs[e].abort()}catch(e){}this.oXhrs[e]=null}},IframeDriver.prototype.oUids={},IframeDriver.prototype.oForms={},IframeDriver.prototype.oJua=null,IframeDriver.prototype.oOptions={},IframeDriver.prototype.isDragAndDropSupported=function(){return!1},IframeDriver.prototype.regTaskUid=function(e){this.oUids[e]=!0},IframeDriver.prototype.uploadTask=function(e,t,n,o,i,r,a){if(!1===this.oUids[e])return o(null,e),!1;var l=this.oForms[e],s=_.clone(getValue(this.oOptions,"hidden",{})),u=this.oJua.getEvent("onStart"),p=this.oJua.getEvent("onComplete");return l?(l.append($('<input type="hidden" />').attr("name","jua-post-type").val("iframe")),n=_.extend(n,t.Hidden||{}),s.Parameters=JSON.stringify(n),$.each(s,function(e,n){l.append($('<input type="hidden" />').attr("name",e).val(getStringOrCallFunction(n,[t])))}),l.trigger("submit"),u&&u(e),l.find("iframe").on("load",function(t){var n=!1,i=null,r={};if(p){try{i=this.contentDocument?this.contentDocument:this.contentWindow.document,r=$.parseJSON(i.body.innerHTML),n=!0}catch(e){r={}}p(e,n,r)}o(null,e),window.setTimeout(function(){l.remove()},100)})):o(null,e),!0},IframeDriver.prototype.generateNewInput=function(e){var t=this,n="",o=null,i=null,r=getValue(this.oOptions,"action",""),a=null,l=getValue(this.oOptions,"hiddenElementsPosition","left");e&&(n=getNewUid(),o=getNewInput(getValue(this.oOptions,"name","juaFile"),!getValue(this.oOptions,"disableMultiple",!1),getValue(this.oOptions,"hiddenElementsPosition","left"),getValue(this.oOptions,"accept","")),a=$('<form action="'+r+'" target="iframe-'+n+'"  method="POST" enctype="multipart/form-data" style="display: block; cursor: pointer;"></form>'),i=$('<iframe name="iframe-'+n+'" tabindex="-1" src="javascript:void(0);"  style="position: absolute; top: -1000px; '+l+': -1000px; cursor: pointer;" />').css({opacity:0}),a.append(createNextLabel().append(o)).append(i),$(e).append(a),this.oForms[n]=a,o.on("click",function(e){if(t.oJua.bEnableButton){var n=t.oJua.getEvent("onDialog");n&&n()}else e.preventDefault()}).on("change",function(){getDataFromInput(this,function(o){if(o){var i=getValue(t.oOptions,"hiddenElementsPosition","left");a.css({position:"absolute",top:-1e3}),a.css(i,-1e3),t.oJua.addFile(n,o),t.generateNewInput(e)}},getValue(t.oOptions,"multipleSizeLimit",iDefLimit),t.oJua.getEvent("onLimitReached"))}))},IframeDriver.prototype.cancel=function(e){this.oUids[e]=!1,this.oForms[e]&&(this.oForms[e].remove(),this.oForms[e]=!1)},CJua.prototype.bEnableDnD=!0,CJua.prototype.iDocTimer=0,CJua.prototype.oOptions={},CJua.prototype.oEvents={},CJua.prototype.oQueue=null,CJua.prototype.oDriver=null,CJua.prototype.on=function(e,t){return this.oEvents[e]=t,this},CJua.prototype.runEvent=function(e,t){this.oEvents[e]&&this.oEvents[e].apply(null,t||[])},CJua.prototype.getEvent=function(e){return this.oEvents[e]||null},CJua.prototype.cancel=function(e){this.oDriver.cancel(e)},CJua.prototype.isAjaxUploaderSupported=function(){return function(){var e=document.createElement("input");return e.type="file",!!("XMLHttpRequest"in window&&"multiple"in e&&"FormData"in window&&(new XMLHttpRequest).upload)}()},CJua.prototype.setDragAndDropEnabledStatus=function(e){this.bEnableDnD=!!e},CJua.prototype.isDragAndDropSupported=function(){return this.oDriver.isDragAndDropSupported()},CJua.prototype.addNewFile=function(e){this.addFile(getNewUid(),e)},CJua.prototype.addFile=function(e,t){var n=this.getEvent("onSelect"),o=null,i=getValue(this.oOptions,"hidden",{}),r=this.getEvent("onComplete"),a=_.bind(function(e,t){var n=getValue(this.oOptions,"hidden",{}),o=JSON.parse(getStringOrCallFunction(n.Parameters,[t]));this.oDriver.regTaskUid(e),this.oQueue.defer(scopeBind(this.oDriver.uploadTask,this.oDriver),e,t,o)},this),l=this.getEvent("onCancel");if(!t||n&&!1===n(e,t))this.oDriver.cancel(e);else{o=_.bind(function(e,t,n,i,a,l){var s=null;s=function(t,i){var a=null;try{a=$.parseJSON(t)}catch(e){}a&&a.Result&&!a.Result.Error&&!a.ErrorCode?n(e,o):a&&a.Result&&a.Result.Error?(App.broadcastEvent("Jua::FileUploadingError"),r(i,!1,{ErrorCode:a.Result.Error})):a&&a.ErrorCode?(App.broadcastEvent("Jua::FileUploadingError"),r(i,!1,{ErrorCode:a.ErrorCode})):(App.broadcastEvent("Jua::FileUploadingError"),r(i,!1))};var u=getValue(this.oOptions,"hidden",{}),p=JSON.parse(getStringOrCallFunction(u.Parameters,[t]));this.oDriver.regTaskUid(e),this.oDriver.uploadTask(e,t,p,s,i<a,!0,l)},this);var s=ko.observable(!0),u=JSON.parse(getStringOrCallFunction(i.Parameters,[t]));App.broadcastEvent("Jua::FileUpload::isUploadAvailable",{isUploadAvailable:s,sModuleName:i.Module,sUid:e,oFileInfo:t}),s()?!1===App.broadcastEvent("Jua::FileUpload::before",{sUid:e,oFileInfo:t,fOnChunkReadyCallback:o,sModuleName:i.Module,fRegularUploadFileCallback:a,fCancelFunction:l,sStorageType:u.Type})&&a(e,t):_.isFunction(l)&&l(e)}},CJua.prototype.setOption=function(e,t){this.oOptions[e]=t},module.exports=CJua;