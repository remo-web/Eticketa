"use strict";function CSelector(e,t,i,s,o,l,c,n,h,r,u){this.fSelectCallback=t||function(){},this.fDeleteCallback=i||function(){},this.fDblClickCallback=!App.isMobile()&&s?s:function(){},this.fEnterCallback=o||function(){},this.bResetCheckedOnClick=!!c,this.bCheckOnSelect=!!n,this.bUnselectOnCtrl=!!h,this.bDisableMultiplySelection=!!r,this.bChangeOnSelect=void 0===u||!!u,this.useKeyboardKeys=ko.observable(!1),this.list=ko.observableArray([]),e&&e.subscribe&&e.subscribe(function(e){this.list(e)},this),this.multiplyLineFactor=l,this.oLast=null,this.oListScope=null,this.oScrollScope=null,this.iTimer=0,this.iFactor=1,this.KeyUp=Enums.Key.Up,this.KeyDown=Enums.Key.Down,this.KeyLeft=Enums.Key.Up,this.KeyRight=Enums.Key.Down,this.multiplyLineFactor&&(this.multiplyLineFactor.subscribe?this.multiplyLineFactor.subscribe(function(e){this.iFactor=0<e?e:1},this):this.iFactor=Types.pInt(this.multiplyLineFactor),this.KeyUp=Enums.Key.Up,this.KeyDown=Enums.Key.Down,this.KeyLeft=Enums.Key.Left,this.KeyRight=Enums.Key.Right,$("html").hasClass("rtl")&&(this.KeyLeft=Enums.Key.Right,this.KeyRight=Enums.Key.Left)),this.sActionSelector="",this.sSelectabelSelector="",this.sCheckboxSelector="";var a=this;this.listChecked=ko.computed({read:function(){return _.filter(this.list(),function(e){var t=e.checked(),i=e.selected();return t||a.bCheckOnSelect&&i})},write:function(e){e=!!e,_.each(this.list(),function(t){t.checked(e)}),this.list.valueHasMutated()},owner:this}),this.checkAll=ko.computed({read:function(){return 0<this.listChecked().length},write:function(e){this.listChecked(!!e)},owner:this}),this.selectorHook=ko.observable(null),this.selectorHook.subscribe(function(){var e=this.selectorHook();e&&_.isFunction(e.selected)&&e.selected(!1)},this,"beforeChange"),this.selectorHook.subscribe(function(e){e&&e.selected(!0)},this),this.itemSelected=ko.computed({read:this.selectorHook,write:function(e){this.selectorHook(e),e&&(a.scrollToSelected(),this.oLast=e)},owner:this}),this.list.subscribe(function(e){if(_.isArray(e)){var t=this.itemSelected();t&&(_.find(e,function(e){return t===e})||this.itemSelected(null))}else this.itemSelected(null)},this),this.listCheckedOrSelected=ko.computed({read:function(){var e=this.itemSelected(),t=this.listChecked();return 0<t.length?t:e?[e]:[]},write:function(e){e?this.listChecked(!0):(this.itemSelected(null),this.listChecked(!1))},owner:this}),this.listCheckedAndSelected=ko.computed({read:function(){var e=[],t=this.itemSelected(),i=this.listChecked();return i&&(e=i.slice(0)),t&&-1===_.indexOf(i,t)&&e.push(t),e},write:function(e){e?this.listChecked(!0):(this.itemSelected(null),this.listChecked(!1))},owner:this}),this.isIncompleteChecked=ko.computed(function(){var e=this.list().length,t=this.listChecked().length;return 0<e&&0<t&&e>t},this),this.onKeydownBound=_.bind(this.onKeydown,this)}var _=require("underscore"),$=require("jquery"),ko=require("knockout"),Types=require("%PathToCoreWebclientModule%/js/utils/Types.js"),Utils=require("%PathToCoreWebclientModule%/js/utils/Common.js"),App=require("%PathToCoreWebclientModule%/js/App.js"),Browser=require("%PathToCoreWebclientModule%/js/Browser.js"),Popups=require("%PathToCoreWebclientModule%/js/Popups.js");CSelector.prototype.iTimer=0,CSelector.prototype.bResetCheckedOnClick=!1,CSelector.prototype.bCheckOnSelect=!1,CSelector.prototype.bUnselectOnCtrl=!1,CSelector.prototype.bDisableMultiplySelection=!1,CSelector.prototype.getLastOrSelected=function(){var e=0,t=null;return _.each(this.list(),function(i){i.checked()&&e++,i.selected()&&(t=i)}),0===e&&t?t:this.oLast},CSelector.prototype.initOnApplyBindings=function(e,t,i,s,o){$(document).on("keydown",this.onKeydownBound),this.oListScope=s,this.oScrollScope=o,this.sActionSelector=e,this.sSelectabelSelector=t,this.sCheckboxSelector=i;var l=this,c=function(e,t,i){var s=0,o=0,c=null,n=!1,h=!1,r=[],u=!1;if(t=t||null,i&&i.shiftKey&&null!==t&&null!==e&&t!==e)for(r=l.list(),u=t.checked(),s=0,o=r.length;s<o;s++)n=!1,(c=r[s])!==e&&c!==t||(n=!0),n&&(h=!h),(h||n)&&c.checked(u);t&&(l.oLast=t)};$(this.oListScope).on("dblclick",e,function(e){var t=ko.dataFor(this);!t||!e||e.ctrlKey||e.altKey||e.shiftKey||l.onDblClick(t)}),Browser.mobileDevice&&$(this.oListScope).on("touchstart",e,function(e){if(e){var t=e.timeStamp,i=t-($(this).data("lastTouch")||t),s=e.originalEvent&&e.originalEvent.touches?e.originalEvent.touches.length:0;$(this).data("lastTouch",t),!i||i>250||s>1||(e.preventDefault(),$(this).trigger("dblclick"))}}),$(this.oListScope).on("click",e,function(e){var t=!0,i=null,s=l.getLastOrSelected(),o=ko.dataFor(this);o&&e&&(e.shiftKey?(t=!1,l.bDisableMultiplySelection||(null===l.oLast&&(l.oLast=o),o.checked(!o.checked()),c(s,o,e))):e.ctrlKey&&(t=!1,l.bDisableMultiplySelection||(l.oLast=o,!(i=l.itemSelected())||i.checked()||o.checked()||i.checked(!0),l.bUnselectOnCtrl&&o===l.itemSelected()?(o.checked(!o.selected()),l.itemSelected(null)):o.checked(!o.checked()))),t&&l.selectionFunc(o))}),$(this.oListScope).on("click",i,function(e){var t=ko.dataFor(this);t&&e&&!l.bDisableMultiplySelection&&(e.shiftKey?(null===l.oLast&&(l.oLast=t),c(l.getLastOrSelected(),t,e)):l.oLast=t),e&&e.stopPropagation&&e.stopPropagation()}),$(this.oListScope).on("dblclick",i,function(e){e&&e.stopPropagation&&e.stopPropagation()})},CSelector.prototype.getResultSelection=function(e,t){var i=this,s=!1,o=!1,l=null,c=this.iFactor,n=!!this.multiplyLineFactor,h=0,r=0,u=[];if(!e&&-1<$.inArray(t,[this.KeyUp,this.KeyDown,this.KeyLeft,this.KeyRight,Enums.Key.PageUp,Enums.Key.PageDown,Enums.Key.Home,Enums.Key.End]))(u=this.list())&&0<u.length&&(-1<$.inArray(t,[this.KeyDown,this.KeyRight,Enums.Key.PageUp,Enums.Key.Home])?l=u[0]:-1<$.inArray(t,[this.KeyUp,this.KeyLeft,Enums.Key.PageDown,Enums.Key.End])&&(l=u[u.length-1]));else if(e&&(u=this.list(),0<(r=u?u.length:0)))if(Enums.Key.Home===t||Enums.Key.PageUp===t||Enums.Key.End===t||Enums.Key.PageDown===t||n&&(Enums.Key.Left===t||Enums.Key.Right===t)||!n&&(Enums.Key.Up===t||Enums.Key.Down===t))_.each(u,function(c){if(!s)switch(t){case i.KeyUp:case i.KeyLeft:e===c?s=!0:l=c;break;case Enums.Key.Home:case Enums.Key.PageUp:l=c,s=!0;break;case i.KeyDown:case i.KeyRight:o?(l=c,s=!0):e===c&&(o=!0);break;case Enums.Key.End:case Enums.Key.PageDown:l=c}});else if(n&&this.KeyDown===t){for(;h<r;h++)if(e===u[h]){r-1<(h+=c)&&(h-=c),l=u[h];break}}else if(n&&this.KeyUp===t)for(h=r;h>=0;h--)if(e===u[h]){0>(h-=c)&&(h+=c),l=u[h];break}return l},CSelector.prototype.shiftClickResult=function(e,t,i){if(t){var s=!!this.multiplyLineFactor,o=!1,l=!1;-1<$.inArray(i,s?[Enums.Key.Left,Enums.Key.Right]:[Enums.Key.Up,Enums.Key.Down])?t.checked(!t.checked()):-1<$.inArray(i,s?[Enums.Key.Up,Enums.Key.Down,Enums.Key.PageUp,Enums.Key.PageDown,Enums.Key.Home,Enums.Key.End]:[Enums.Key.Left,Enums.Key.Right,Enums.Key.PageUp,Enums.Key.PageDown,Enums.Key.Home,Enums.Key.End])&&(l=!t.checked(),_.each(this.list(),function(i){var s=!1;i!==e&&t!==i||(o=!o,s=!0),(o||s)&&(i.checked(l),s=!1)}),s&&e&&(i===Enums.Key.Up||i===Enums.Key.Down)&&e.checked(!e.checked()))}},CSelector.prototype.clickNewSelectPosition=function(e,t){var i=this.itemSelected(),s=this.getResultSelection(i,e);s&&(t&&this.shiftClickResult(s,i,e),this.selectionFunc(s))},CSelector.prototype.onKeydown=function(e){var t=!0,i=0;return this.useKeyboardKeys()&&e&&!Utils.isTextFieldFocused()&&!Popups.hasOpenedMaximizedPopups()&&(i=e.keyCode,e.ctrlKey||this.KeyUp!==i&&this.KeyDown!==i&&this.KeyLeft!==i&&this.KeyRight!==i&&Enums.Key.PageUp!==i&&Enums.Key.PageDown!==i&&Enums.Key.Home!==i&&Enums.Key.End!==i?Enums.Key.Del!==i||e.ctrlKey||e.shiftKey?Enums.Key.Enter===i?0<this.list().length&&!e.ctrlKey&&(this.onEnter(this.itemSelected()),t=!1):!e.ctrlKey||e.altKey||e.shiftKey||Enums.Key.a!==i||(this.checkAll(!(this.checkAll()&&!this.isIncompleteChecked())),t=!1):0<this.list().length&&(this.onDelete(),t=!1):(this.clickNewSelectPosition(i,e.shiftKey),t=!1)),t},CSelector.prototype.onDelete=function(){this.fDeleteCallback.call(this,this.listCheckedOrSelected())},CSelector.prototype.onEnter=function(e){this.fEnterCallback.call(this,e)},CSelector.prototype.selectionFunc=function(e){this.bChangeOnSelect&&this.itemSelected(null),this.bResetCheckedOnClick&&this.listChecked(!1),this.bChangeOnSelect&&this.itemSelected(e),this.fSelectCallback.call(this,e)},CSelector.prototype.onDblClick=function(e){this.fDblClickCallback.call(this,e)},CSelector.prototype.koCheckAll=function(){return ko.computed({read:this.checkAll,write:this.checkAll,owner:this})},CSelector.prototype.koCheckAllIncomplete=function(){return ko.computed({read:this.isIncompleteChecked,write:this.isIncompleteChecked,owner:this})},CSelector.prototype.scrollToSelected=function(){if(!this.oListScope||!this.oScrollScope)return!1;var e=$(this.sSelectabelSelector,this.oScrollScope),t=e.position(),i=this.oScrollScope.height(),s=e.outerHeight();return!(!t||!(t.top<0||t.top+s>i))&&(t.top<0?this.oScrollScope.scrollTop(this.oScrollScope.scrollTop()+t.top-20):this.oScrollScope.scrollTop(this.oScrollScope.scrollTop()+t.top-i+s+20),!0)},module.exports=CSelector;