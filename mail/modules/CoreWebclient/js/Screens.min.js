"use strict";function CScreens(){var e=$(window);this.resizeAll=_.debounce(function(){e.resize()},100),this.oGetScreenFunctions={},this.screens=ko.observable({}),this.oModulesNames={},this.currentScreen=ko.observable(""),this.sDefaultScreen="",this.browserTitle=ko.computed(function(){var e=this.screens()[this.currentScreen()];return e&&_.isFunction(e.browserTitle)?e.browserTitle():""},this),this.informationScreen=ko.observable(null)}var _=require("underscore"),$=require("jquery"),ko=require("knockout"),Types=require("%PathToCoreWebclientModule%/js/utils/Types.js"),ModulesManager=require("%PathToCoreWebclientModule%/js/ModulesManager.js"),Settings=require("%PathToCoreWebclientModule%/js/Settings.js");CScreens.prototype.init=function(e){var n=ModulesManager.getModulesScreens(),t=ModulesManager.getModulesTabs(!1),i=[],o=e?Settings.DefaultAnonymScreenHash.toLowerCase():Settings.DefaultUserScreenHash.toLowerCase();_.each(n,_.bind(function(e,n){this.addToScreenList(n,e)},this)),this.addToScreenList("",require("%PathToCoreWebclientModule%/js/screenList.js")),this.oGetScreenFunctions[o]&&(this.sDefaultScreen=o),""===this.sDefaultScreen&&(i=_.keys(this.oGetScreenFunctions),Types.isNonEmptyArray(i)&&(this.sDefaultScreen=i[0])),t.length>0&&this.showView("header"),this.initInformation()},CScreens.prototype.addToScreenList=function(e,n){_.each(n,_.bind(function(n,t){this.oGetScreenFunctions[t]=n,this.oModulesNames[t]=e},this))},CScreens.prototype.hasScreenData=function(e){return!(!this.screens()[e]&&!this.oGetScreenFunctions[e])},CScreens.prototype.route=function(e){var n=this.currentScreen(),t=this.screens()[n],i=e.shift(),o=this;(""===i||""===n&&!this.oModulesNames[i])&&(i=this.sDefaultScreen),""!==n||ModulesManager.isModuleEnabled(this.oModulesNames[i])&&this.hasScreenData(i)||(i=_.find(_.keys(this.oModulesNames),_.bind(function(e){return ModulesManager.isModuleEnabled(this.oModulesNames[e])&&this.hasScreenData(e)},this))||this.sDefaultScreen),ModulesManager.isModuleEnabled(this.oModulesNames[i])&&this.hasScreenData(i)&&(n!==i?(this.currentScreen(i),t&&_.isFunction(t.hideView)&&t.hideView(),t=this.showView(i,function(n){o.onRouteCallback(n,e)})):t&&this.onRouteCallback(t,e))},CScreens.prototype.onRouteCallback=function(e,n){e&&_.isFunction(e.onRoute)&&e.onRoute(n)},CScreens.prototype.showView=function(e,n){var t=e,i=this.oGetScreenFunctions[t],o=this.screens()[t],s=this;return!o&&i?(this.initView(t,i,function(){s.showView(e,n)}),null):(o&&_.isFunction(o.showView)&&o.showView(),_.isFunction(n)&&n(o),o)},CScreens.prototype.initView=function(e,n,t){var i=this,o=n();_.isFunction(o.then)?o.then(function(n){i.initViewCallback.call(i,e,n),n&&_.isFunction(t)&&t(n)}):(this.initViewCallback.call(this,e,o),o&&_.isFunction(t)&&t(o))},CScreens.prototype.initViewCallback=function(e,n){if(n.ViewTemplate){var t=$("\x3c!-- ko template: { name: '"+n.ViewTemplate+"' } --\x3e\x3c!-- /ko --\x3e").appendTo($("#auroraContent .screens"));t.length>0&&(ko.applyBindings(n,t[0]),n.$viewDom=t.next(),n.onBind())}this.screens()[e]=n,this.screens.valueHasMutated(),delete this.oGetScreenFunctions[e]},CScreens.prototype.showAnyView=function(e){if(e.ViewTemplate){var n=$("\x3c!-- ko template: { name: '"+e.ViewTemplate+"' } --\x3e\x3c!-- /ko --\x3e").appendTo($("#auroraContent .screens"));n.length>0&&ko.applyBindings(e,n[0])}},CScreens.prototype.showLoading=function(e){this.informationScreen()&&this.informationScreen().showLoading(e)},CScreens.prototype.hideLoading=function(){this.informationScreen()&&this.informationScreen().hideLoading()},CScreens.prototype.showReport=function(e,n){this.informationScreen()&&this.informationScreen().showReport(e,n)},CScreens.prototype.hideReport=function(){this.informationScreen()&&this.informationScreen().hideReport()},CScreens.prototype.showError=function(e,n,t){this.informationScreen()&&this.informationScreen().showError(e,n,t)},CScreens.prototype.hideError=function(e){this.informationScreen()&&this.informationScreen().hideError(e)},CScreens.prototype.initInformation=function(){var e=this;this.showView("information",function(n){n&&e.informationScreen(n)})},CScreens.prototype.hasUnsavedChanges=function(){var e=this.screens()[this.currentScreen()];return e&&_.isFunction(e.hasUnsavedChanges)&&e.hasUnsavedChanges()},CScreens.prototype.getCurrentScreen=function(){return this.screens()[this.currentScreen()]};var Screens=new CScreens;module.exports=Screens;