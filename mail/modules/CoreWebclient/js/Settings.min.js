"use strict";var _=require("underscore"),$=require("jquery"),ko=require("knockout"),moment=require("moment-timezone"),UrlUtils=require("%PathToCoreWebclientModule%/js/utils/Url.js"),Types=require("%PathToCoreWebclientModule%/js/utils/Types.js"),AppData=window.auroraAppData,bRtl=$("html").hasClass("rtl"),Settings={ServerModuleName:"Core",HashModuleName:"core",DebugMode:Types.isString(UrlUtils.getRequestParam("debugmode")),AuthTokenCookieExpireTime:30,AutodetectLanguage:!1,UserSelectsDateFormat:!1,dateFormat:ko.observable("DD/MM/YYYY"),DateFormatList:["DD/MM/YYYY"],EUserRole:{},IsSystemConfigured:!1,Language:"English",LastErrorCode:0,ShortLanguage:"en",SiteName:"Afterlogic Platform",SocialName:"",TenantName:"",timeFormat:ko.observable("0"),timezone:ko.observable(""),UserId:0,PasswordMinLength:0,PasswordMustBeComplex:!1,CookiePath:"/",CookieSecure:!1,Version:"",ProductName:"",AdminHasPassword:"",AdminLanguage:"",AdminLogin:"",CommonLanguage:"",DbHost:"",DbLogin:"",DbName:"",SaltNotEmpty:!1,StoreAuthTokenInDB:!1,dbSettingsChanged:ko.observable(!1).extend({autoResetToFalse:100}),AllowChangeSettings:!1,AllowClientDebug:!1,AllowDesktopNotifications:!1,AllowMobile:!1,AllowPrefetch:!0,AttachmentSizeLimit:0,AutoRefreshIntervalMinutes:1,CustomLogoutUrl:"",DefaultAnonymScreenHash:"",DefaultUserScreenHash:"",GoogleAnalyticsAccount:"",HeaderModulesOrder:[],IsDemo:!1,IsMobile:-1,LanguageList:[{name:"English",text:"English"}],ShowQuotaBar:!1,QuotaWarningPerc:0,Theme:"Default",ThemeList:["Default"],MobileTheme:"Default",MobileThemeList:["Default"],LogoUrl:"",IsRTL:bRtl,init:function(e){var t=e[Settings.ServerModuleName],s=e["%ModuleName%"],i=e.CoreMobileWebclient,o=e.BrandingWebclient;_.isEmpty(t)||(this.AuthTokenCookieExpireTime=Types.pInt(t.AuthTokenCookieExpireTime,this.AuthTokenCookieExpireTime),this.AutodetectLanguage=Types.pBool(t.AutodetectLanguage,this.AutodetectLanguage),this.UserSelectsDateFormat=Types.pBool(t.UserSelectsDateFormat,this.UserSelectsDateFormat),this.dateFormat(Types.pString(t.DateFormat,this.dateFormat())),this.DateFormatList=Types.pArray(t.DateFormatList,this.DateFormatList),this.EUserRole=Types.pObject(t.EUserRole,this.EUserRole),this.IsSystemConfigured=Types.pBool(t.IsSystemConfigured,this.IsSystemConfigured),this.Language=Types.pString(t.Language,this.Language),this.LastErrorCode=Types.pInt(t.LastErrorCode,this.LastErrorCode),this.ShortLanguage=Types.pString(t.ShortLanguage,this.ShortLanguage),this.SiteName=Types.pString(t.SiteName,this.SiteName),this.SocialName=Types.pString(t.SocialName,this.SocialName),this.TenantName=Types.pString(t.TenantName||UrlUtils.getRequestParam("tenant"),this.TenantName),this.timeFormat(Types.pString(t.TimeFormat,this.timeFormat())),this.timezone(Types.pString(t.Timezone,this.timezone())),this.UserId=Types.pInt(t.UserId,this.UserId),this.PasswordMinLength=Types.pNonNegativeInt(t.PasswordMinLength,this.PasswordMinLength),this.PasswordMustBeComplex=Types.pBool(t.PasswordMustBeComplex,this.PasswordMustBeComplex),this.CookiePath=Types.pString(t.CookiePath,this.CookiePath),""===this.CookiePath&&(this.CookiePath="/"),this.CookieSecure=Types.pBool(t.CookieSecure,this.CookieSecure),this.Version=Types.pString(t.Version,this.Version),this.ProductName=Types.pString(t.ProductName,this.ProductName),this.AdminHasPassword=Types.pBool(t.AdminHasPassword,this.AdminHasPassword),this.AdminLanguage=Types.pString(t.AdminLanguage,this.AdminLanguage),this.AdminLogin=Types.pString(t.AdminLogin,this.AdminLogin),this.CommonLanguage=Types.pString(t.CommonLanguage,this.CommonLanguage),this.DbHost=Types.pString(t.DBHost,this.DbHost),this.DbLogin=Types.pString(t.DBLogin,this.DbLogin),this.DbName=Types.pString(t.DBName,this.DbName),this.SaltNotEmpty=Types.pBool(t.SaltNotEmpty,this.SaltNotEmpty),this.StoreAuthTokenInDB=Types.pBool(t.StoreAuthTokenInDB,this.StoreAuthTokenInDB)),_.isEmpty(s)||(this.AllowChangeSettings=Types.pBool(s.AllowChangeSettings,this.AllowChangeSettings),this.AllowClientDebug=Types.pBool(s.AllowClientDebug,this.AllowClientDebug),this.AllowDesktopNotifications=Types.pBool(s.AllowDesktopNotifications,this.AllowDesktopNotifications),this.AllowMobile=Types.pBool(s.AllowMobile,this.AllowMobile),this.AllowPrefetch=Types.pBool(s.AllowPrefetch,this.AllowPrefetch),this.AttachmentSizeLimit=Types.pNonNegativeInt(s.AttachmentSizeLimit,this.AttachmentSizeLimit),this.AutoRefreshIntervalMinutes=Types.pNonNegativeInt(s.AutoRefreshIntervalMinutes,this.AutoRefreshIntervalMinutes),this.CustomLogoutUrl=Types.pString(s.CustomLogoutUrl,this.CustomLogoutUrl),this.DefaultAnonymScreenHash=Types.pString(s.DefaultAnonymScreenHash,this.DefaultAnonymScreenHash),this.DefaultUserScreenHash=Types.pString(s.DefaultUserScreenHash,this.DefaultUserScreenHash),this.GoogleAnalyticsAccount=Types.pString(s.GoogleAnalyticsAccount,this.GoogleAnalyticsAccount),this.HeaderModulesOrder=Types.pArray(s.HeaderModulesOrder,this.HeaderModulesOrder),this.IsDemo=Types.pBool(s.IsDemo,this.IsDemo),this.IsMobile=Types.pInt(s.IsMobile,this.IsMobile),this.LanguageList=Types.pArray(s.LanguageListWithNames,this.LanguageList),this.ShowQuotaBar=Types.pBool(s.ShowQuotaBar,this.ShowQuotaBar),this.QuotaWarningPerc=Types.pInt(s.QuotaWarningPerc,this.QuotaWarningPerc),this.Theme=Types.pString(s.Theme,this.Theme),this.ThemeList=Types.pArray(s.ThemeList,this.ThemeList)),_.isEmpty(i)||(this.MobileTheme=Types.pString(i.Theme,this.MobileTheme),this.MobileThemeList=Types.pArray(i.ThemeList,this.MobileThemeList)),_.isEmpty(o)||(this.LogoUrl=Types.pString(o.TabsbarLogo,this.LogoUrl)),moment.locale()!==this.ShortLanguage&&"Arabic"!==this.Language&&"Persian"!==this.Language&&moment.locale(this.ShortLanguage),setTimeout(_.bind(this.initTimezone,this),1e3)},initTimezone:function(){if(require("%PathToCoreWebclientModule%/js/App.js").isUserNormalOrTenant()){var e=require("%PathToCoreWebclientModule%/js/utils/Text.js"),t=require("%PathToCoreWebclientModule%/js/Ajax.js"),s=require("%PathToCoreWebclientModule%/js/Screens.js"),i=require("%PathToCoreWebclientModule%/js/Storage.js"),o=moment(),a=moment.tz.guess(),n=this.timezone();""===n?t.send("Core","UpdateUserTimezone",{Timezone:a}):(n!==a&&i.getData("showNewTimezone")!==a&&(s.showReport(e.i18n("%MODULENAME%/CONFIRM_TIMEZONE_CHANGES",{OLDTIME:o.clone().tz(n).format("HH:mm")+" ("+n+")",NEWTIME:o.format("HH:mm")+" ("+a+")"}),0),$(".report_panel.report a").on("click",_.bind(function(){i.removeData("showNewTimezone"),t.send("Core","UpdateUserTimezone",{Timezone:a},_.bind(function(t){s.hideReport(),!0===t.Result?(i.setData("showNewTimezone",a),this.timezone(a)):s.showError(e.i18n("%MODULENAME%/ERROR_TIMEZONE_CHANGES"))},this))},this))),i.setData("showNewTimezone",a))}},update:function(e,t,s,i,o,a,n,r){"string"==typeof e&&(this.SiteName=e),"string"==typeof o&&(this.Language=o),"string"==typeof a&&this.timeFormat(a),"string"==typeof n&&this.dateFormat(n),"boolean"==typeof r&&(this.AllowDesktopNotifications=r),"number"==typeof t&&(this.AutoRefreshIntervalMinutes=t),"string"==typeof s&&(this.Theme=s),"string"==typeof i&&(this.MobileTheme=i)},updateSecurity:function(e,t){this.AdminHasPassword=t,this.AdminLogin=e},updateDb:function(e,t,s){this.DbHost=s,this.DbLogin=e,this.DbName=t,this.dbSettingsChanged(!0)}};Settings.init(AppData),module.exports=Settings;