"use strict";function removeActiveFocus(){if(document&&document.activeElement&&document.activeElement.blur){var e=$(document.activeElement);(e.is("input")||e.is("textarea"))&&document.activeElement.blur()}}var ko=require("knockout"),_=require("underscore"),$=require("jquery"),Utils=require("%PathToCoreWebclientModule%/js/utils/Common.js"),Browser=require("%PathToCoreWebclientModule%/js/Browser.js"),Storage=require("%PathToCoreWebclientModule%/js/Storage.js"),Splitter=require("%PathToCoreWebclientModule%/js/vendors/split.js");require("jquery-ui/ui/widgets/droppable"),require("jquery-ui/ui/widgets/draggable"),require("jquery-ui/ui/widgets/autocomplete"),require("%PathToCoreWebclientModule%/js/vendors/customscroll.js"),require("%PathToCoreWebclientModule%/js/autocomplete.js"),ko.bindingHandlers.splitterFlex={valiateStorageData:function(e,t){return(!_.isArray(e)||_.contains(e,0)||_.contains(e,null)||_.contains(e,NaN))&&_.isArray(t)&&(e=t),e},init:function(e,t){_.defer(function(){var n=_.defaults(t(),{minSize:200,name:""}),o=ko.bindingHandlers.splitterFlex.valiateStorageData(Storage.getData(n.name+"ResizerWidth"),n.sizes),i=null,a=[].slice.call(e.children),l={minSize:n.minSize,gutterSize:0,gutter:function(e,t){var n=document.createElement("div");return n.appendChild(document.createElement("div")),n.className="gutter gutter-"+t,n},onDragEnd:function(){n.name&&Storage.setData(n.name+"ResizerWidth",i.getSizes())}};_.isArray(o)&&(l.sizes=o),n.direction&&"vertical"===n.direction&&(l.direction="vertical"),i=Splitter(a,l)})}},ko.bindingHandlers.customScrollbar={init:function(e,t,n,o){var i=$(e),a=_.defaults(t(),{oScroll:null,scrollToTopTrigger:null,scrollToBottomTrigger:null,scrollTo:null}),l=null;a=a,i.addClass("scroll-wrap").customscroll(a),l=i.data("customscroll"),a.oScroll&&$.isFunction(a.oScroll.subscribe)?a.oScroll(l):a.oScroll=l,a.reset||(e._customscroll_reset=_.throttle(function(){l.reset()},100)),a.scrollToTopTrigger&&$.isFunction(a.scrollToTopTrigger.subscribe)&&a.scrollToTopTrigger.subscribe(function(){l&&l.scrollToTop()}),a.scrollToBottomTrigger&&$.isFunction(a.scrollToBottomTrigger.subscribe)&&a.scrollToBottomTrigger.subscribe(function(){l&&l.scrollToBottom()}),a.scrollTo&&$.isFunction(a.scrollTo.subscribe)&&a.scrollTo.subscribe(function(){l&&l.scrollTo(a.scrollTo())})},update:function(e,t,n,o,i){e._customscroll_reset&&e._customscroll_reset(),t().top&&$(e).data("customscroll").vertical.set(t().top)}},ko.bindingHandlers.draggable={init:function(e,t){$(e).attr("draggable",ko.utils.unwrapObservable(t()))}},ko.bindingHandlers.draggablePlace={init:function(e,t,n,o,i){if(null===t())return null;var a=n?n():null;$(e).draggable({distance:20,handle:".dragHandle",cursorAt:{top:0,left:0},helper:function(e){return t().apply(o,e&&e.target?[ko.dataFor(e.target),e.ctrlKey]:null)},start:a&&a.draggableDragStartCallback?a.draggableDragStartCallback:function(){},stop:a&&a.draggableDragStopCallback?a.draggableDragStopCallback:function(){}}).on("mousedown",function(){removeActiveFocus()})}},ko.bindingHandlers.droppable={init:function(e,t){var n=t(),o=n.valueFunc,i=n.switchObserv;!1!==o&&$(e).droppable({hoverClass:"droppableHover",drop:function(e,t){o(e,t)}}),i&&!1!==o&&(i.subscribe(function(t){$(e).data().droppable&&(t?$(e).droppable("disable"):$(e).droppable("enable"))},this),i.valueHasMutated())}},ko.bindingHandlers.quickReplyAnim={update:function(e,t,n,o,i){var a=e.jqTextarea||null,l=e.jqStatus||null,s=e.jqButtons||null,r=e.jqElement||null,u=e.oPrevActions||null,c=t(),d=null;d=_.defaults(c,{saveAction:!1,sendAction:!1,activeAction:!1}),r||(e.jqElement=r=$(e),e.jqTextarea=a=r.find("textarea"),e.jqStatus=l=r.find(".status"),e.jqButtons=s=r.find(".buttons"),e.oPrevActions=u={saveAction:null,sendAction:null,activeAction:null}),Browser.ie9AndBelow?(!a||r.defualtHeight||a.defualtHeight||(r.defualtHeight=r.outerHeight(),a.defualtHeight=a.outerHeight(),l.defualtHeight=s.outerHeight(),s.defualtHeight=s.outerHeight()),_.defer(function(){var e=u.activeAction!==d.activeAction,t=u.sendAction!==d.sendAction,n=u.saveAction!==d.saveAction;e&&(d.activeAction?(a.animate({height:a.defualtHeight+50},300),r.animate({"max-height":r.defualtHeight+s.defualtHeight+50},300)):(a.animate({height:a.defualtHeight},300),r.animate({"max-height":r.defualtHeight},300))),(t||n)&&(d.sendAction?(r.animate({"max-height":"30px"},300),l.animate({"max-height":"30px",opacity:1},300)):d.saveAction?r.animate({"max-height":0},300):(r.animate({"max-height":r.defualtHeight+s.defualtHeight+50},300),l.animate({"max-height":0,opacity:0},300)))})):(r.toggleClass("saving",d.saveAction),r.toggleClass("sending",d.sendAction),r.toggleClass("active",d.activeAction)),_.defer(function(){u=d})}},ko.bindingHandlers.onCtrlEnter={init:function(e,t,n,o){var i=$(e);i.on("keydown",function(e){e.ctrlKey&&e.keyCode===Enums.Key.Enter&&(i.trigger("change"),t().call(o))})}},ko.bindingHandlers.onEsc={init:function(e,t,n,o){var i=$(e);i.on("keydown",function(e){e.keyCode===Enums.Key.Esc&&(i.trigger("change"),t().call(o))})}},ko.bindingHandlers.autocompleteSimple={init:function(e,t,n,o,i){var a=$(e),l=t(),s=l.callback,r=l.dataAccessor?l.dataAccessor:Utils.emptyFunction(),u=function(){fDeleteAccessor(d);var e=a.data("customAutocomplete")||a.data("uiAutocomplete")||a.data("autocomplete")||a.data("ui-autocomplete");$.ui.autocomplete.prototype.__response.call(e,_.filter(c,function(e){return e.value!==d.value}))},c=null,d=null;s&&a&&a[0]&&(a.autocomplete({minLength:1,autoFocus:!0,position:{collision:"flip"},source:function(e,t){s(e,function(e){c=e,t(e)})},focus:function(e,t){d=t.item},open:function(e,t){$(a.autocomplete("widget")).find("span.del").on("click",function(e,t){Utils.calmEvent(e),u()})},select:function(e,t){return _.delay(function(){a.trigger("change")},5),r(t.item),!0}}).on("click",function(e,t){""===a.val()&&($(a.autocomplete("widget")).is(":visible")?a.autocomplete("close"):(a.autocomplete("option","minLength",0),a.autocomplete("search"),a.autocomplete("option","minLength",1)))}).on("keydown",function(e,t){c&&d&&!d.global&&e.keyCode===Enums.Key.Del&&e.shiftKey&&(Utils.calmEvent(e),u())}),a.autocomplete("widget").addClass("autocomplete-simple"))}},ko.bindingHandlers.customSelect={init:function(e,t,n,o){var i=$(e),a=_.defaults(t(),{disabled:"disabled",selected:"selected",expand:"expand",control:!0,input:!1,expandState:function(){}}),l=[],s=a.control?i.find(".control"):i,r=i.find(".dropdown_content"),u=i.find(".link"),c=function(e){_.each(l,function(e){e.removeClass(a.selected)});var t=_.find(a.options,function(t){return t[a.optionsValue]===e});return t?(l[_.indexOf(a.options,t)].addClass(a.selected),u.text($.trim(t[a.optionsText]))):t=a.options[0],t[a.optionsValue]},d=function(e){r.empty(),l=[],_.each(e||a.options,function(e){var t=$('<span class="item"></span>').text(e[a.optionsText]).data("value",e[a.optionsValue]),n=e.isDisabled;n?t.data("isDisabled",n).addClass("disabled"):t.data("isDisabled",n).removeClass("disabled"),l.push(t),r.append(t)},this)};d(),r.on("click",".item",function(){var e=$(this);e.data("isDisabled")||a.value(e.data("value"))}),!a.input&&a.value&&a.value.subscribe&&(a.value.subscribe(function(){var e=c(a.value());a.value()!==e&&a.value(e)},o),a.value.valueHasMutated()),a.input&&a.value&&a.value.subscribe&&(a.value.subscribe(function(){c(a.value())},o),a.value.valueHasMutated()),a.input&&a.value&&a.value.subscribe&&(a.value.subscribe(function(){c(a.value())},o),a.value.valueHasMutated()),a.alarmOptions&&a.alarmOptions.subscribe(function(){d()},o),a.timeOptions&&a.timeOptions.subscribe(function(e){d(e)},o),i.removeClass(a.expand),s.click(function(e){if(!i.hasClass(a.disabled)&&(i.toggleClass(a.expand),a.expandState(i.hasClass(a.expand)),i.hasClass(a.expand))){var t=i.find(".dropdown_content"),n=t.find(".selected");n.position()&&(t.scrollTop(0),t.scrollTop(n.position().top-100)),_.defer(function(){$(document).one("click",function(){i.removeClass(a.expand),a.expandState(!1)})})}})}};