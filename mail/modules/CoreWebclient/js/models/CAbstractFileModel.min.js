"use strict";function CAbstractFileModel(){this.id=ko.observable(""),this.index=ko.observable(0),this.fileName=ko.observable(""),this.tempName=ko.observable(""),this.displayName=ko.observable(""),this.extension=ko.observable(""),this.fileName.subscribe(function(t){this.id(t),this.displayName(t),this.extension(Utils.getFileExtension(t))},this),this.size=ko.observable(0),this.friendlySize=ko.computed(function(){return this.size()>0?TextUtils.getFriendlySize(this.size()):""},this),this.hash=ko.observable(""),this.thumbUrlInQueue=ko.observable(""),this.thumbUrlInQueueSubscribtion=this.thumbUrlInQueue.subscribe(function(){this.getInThumbQueue()},this),this.thumbnailSrc=ko.observable(""),this.thumbnailLoaded=ko.observable(!1),this.thumbnailSessionUid=ko.observable(""),this.mimeType=ko.observable(""),this.uploadUid=ko.observable(""),this.uploaded=ko.observable(!1),this.uploadError=ko.observable(!1),this.downloading=ko.observable(!1),this.isViewMimeType=ko.computed(function(){return-1!==$.inArray(this.mimeType(),aViewMimeTypes)},this),this.bHasHtmlEmbed=!1,this.otherTemplates=ko.observableArray([]),this.visibleCancelButton=ko.observable(!0),this.statusText=ko.observable(""),this.statusTooltip=ko.computed(function(){return this.uploadError()?this.statusText():""},this),this.progressPercent=ko.observable(0),this.visibleProgress=ko.observable(!1),this.uploadStarted=ko.observable(!1),this.uploadStarted.subscribe(function(){this.uploadStarted()?(this.uploaded(!1),this.visibleProgress(!0),this.progressPercent(20)):(this.progressPercent(100),this.visibleProgress(!1),this.uploaded(!0))},this),this.downloading.subscribe(function(){this.downloading()?this.visibleProgress(!0):(this.visibleProgress(!1),this.progressPercent(0))},this),this.allowDrag=ko.observable(!1),this.allowUpload=ko.observable(!1),this.allowPublicLink=ko.observable(!1),this.bIsSecure=ko.observable(!1),this.isShared=ko.observable(!1),this.sHeaderText="",this.oActionsData={view:{Text:TextUtils.i18n("COREWEBCLIENT/ACTION_VIEW_FILE"),Handler:_.bind(function(){this.viewFile()},this)},download:{Text:TextUtils.i18n("COREWEBCLIENT/ACTION_DOWNLOAD_FILE"),Handler:_.bind(function(){this.downloadFile()},this),Tooltip:ko.computed(function(){var t=TextUtils.i18n("%MODULENAME%/INFO_CLICK_TO_DOWNLOAD_FILE",{FILENAME:this.fileName(),SIZE:this.friendlySize()});return""===this.friendlySize()&&(t=t.replace(" ()","")),t},this)}},this.allowActions=ko.observable(!0),this.iconAction=ko.observable("download"),this.cssClasses=ko.computed(function(){return this.getCommonClasses().join(" ")},this),this.actions=ko.observableArray([]),this.firstAction=ko.computed(function(){return this.actions().length>1?this.actions()[0]:""},this),this.secondAction=ko.computed(function(){return 1===this.actions().length?this.actions()[0]:this.actions().length>1?this.actions()[1]:""},this),this.subFiles=ko.observableArray([]),this.subFilesExpanded=ko.observable(!1)}var _=require("underscore"),$=require("jquery"),ko=require("knockout"),App=require("%PathToCoreWebclientModule%/js/App.js"),FilesUtils=require("%PathToCoreWebclientModule%/js/utils/Files.js"),TextUtils=require("%PathToCoreWebclientModule%/js/utils/Text.js"),Types=require("%PathToCoreWebclientModule%/js/utils/Types.js"),UrlUtils=require("%PathToCoreWebclientModule%/js/utils/Url.js"),Utils=require("%PathToCoreWebclientModule%/js/utils/Common.js"),WindowOpener=require("%PathToCoreWebclientModule%/js/WindowOpener.js"),aViewMimeTypes=["image/jpeg","image/png","image/gif","text/html","text/plain","text/css","text/rfc822-headers","message/delivery-status","application/x-httpd-php","application/javascript"],aViewExtensions=[];$("html").hasClass("pdf")&&(aViewMimeTypes.push("application/pdf"),aViewMimeTypes.push("application/x-pdf")),CAbstractFileModel.prototype.addAction=function(t,e,i){e?this.actions.unshift(t):this.actions.push(t),this.actions(_.compact(this.actions())),i&&(this.oActionsData[t]=i)},CAbstractFileModel.prototype.removeAction=function(t){this.actions(_.without(this.actions(),t))},CAbstractFileModel.prototype.getMainAction=function(){return this.actions()[0]},CAbstractFileModel.prototype.hasAction=function(t){return-1!==_.indexOf(this.actions(),t)},CAbstractFileModel.prototype.getActionText=function(t){return this.hasAction(t)&&this.oActionsData[t]&&("string"==typeof this.oActionsData[t].Text||_.isFunction(this.oActionsData[t].Text))?_.isFunction(this.oActionsData[t].Text)?this.oActionsData[t].Text():this.oActionsData[t].Text:""},CAbstractFileModel.prototype.getActionUrl=function(t){return this.hasAction(t)&&this.oActionsData[t]?this.oActionsData[t].Url||"":""},CAbstractFileModel.prototype.executeAction=function(t){this.hasAction(t)&&this.oActionsData[t]&&_.isFunction(this.oActionsData[t].Handler)&&this.oActionsData[t].Handler()},CAbstractFileModel.prototype.getTooltip=function(t){var e=this.hasAction(t)&&this.oActionsData[t]?this.oActionsData[t].Tooltip:"";return"string"==typeof e?e:_.isFunction(e)?e():""},CAbstractFileModel.prototype.getCommonClasses=function(){var t=[];return(this.allowUpload()&&!this.uploaded()||this.downloading())&&t.push("incomplete"),this.uploadError()?t.push("fail"):t.push("success"),t},CAbstractFileModel.prototype.parse=function(t){this.fileName(Types.pString(t.FileName)),this.tempName(Types.pString(t.TempName)),""===this.tempName()&&this.tempName(this.fileName()),this.mimeType(Types.pString(t.MimeType)),this.size(t.EstimatedSize?Types.pInt(t.EstimatedSize):Types.pInt(t.SizeInBytes)),this.hash(Types.pString(t.Hash)),this.parseActions(t),this.uploadUid(this.hash()),this.uploaded(!0),$.isFunction(this.additionalParse)&&this.additionalParse(t)},CAbstractFileModel.prototype.parseActions=function(t){this.thumbUrlInQueue(""!==Types.pString(t.ThumbnailUrl)?Types.pString(t.ThumbnailUrl)+"/"+Math.random():""),this.commonParseActions(t),this.commonExcludeActions()},CAbstractFileModel.prototype.commonExcludeActions=function(){this.isViewSupported()||this.actions(_.without(this.actions(),"view"))},CAbstractFileModel.prototype.commonParseActions=function(t){_.each(t.Actions,function(t,e){this.oActionsData[e]||(this.oActionsData[e]={}),this.oActionsData[e].Url=Types.pString(t.url),this.actions.push(e)},this)},CAbstractFileModel.addViewExtensions=function(t){_.isArray(t)&&(aViewExtensions=_.union(aViewExtensions,t))},CAbstractFileModel.prototype.isViewSupported=function(){return-1!==$.inArray(this.mimeType(),aViewMimeTypes)||-1!==$.inArray(this.extension(),aViewExtensions)},CAbstractFileModel.prototype.getInThumbQueue=function(){""===this.thumbUrlInQueue()||this.linked&&(!this.linked||this.linked())||(this.thumbnailSessionUid(Date.now().toString()),FilesUtils.thumbQueue(this.thumbnailSessionUid(),this.thumbUrlInQueue(),this.thumbnailSrc))},CAbstractFileModel.prototype.downloadFile=function(){var t=this.getActionUrl("download"),e={File:this,CancelDownload:!1};t.length>0&&"#"!==t&&(App.broadcastEvent("AbstractFileModel::FileDownload::before",e),e.CancelDownload||(_.isFunction(e.CustomDownloadHandler)?e.CustomDownloadHandler():UrlUtils.downloadByUrl(t)))},CAbstractFileModel.prototype.viewFile=function(t,e){Utils.calmEvent(e),this.viewCommonFile()},CAbstractFileModel.prototype.viewCommonFile=function(t){var e=null,i=null;Types.isNonEmptyString(t)||(t=UrlUtils.getAppPath()+this.getActionUrl("view")),t.length>0&&"#"!==t&&(i={sUrl:t,index:this.index(),bBreakView:!1},App.broadcastEvent("AbstractFileModel::FileView::before",i),i.bBreakView||(e=WindowOpener.open(t,t,!1))&&e.focus())},CAbstractFileModel.prototype.eventDragStart=function(t,e){var i=e.originalEvent||e;return t&&i&&i.dataTransfer&&i.dataTransfer.setData&&i.dataTransfer.setData("DownloadURL",this.generateTransferDownloadUrl()),!0},CAbstractFileModel.prototype.generateTransferDownloadUrl=function(){var t=this.getActionUrl("download");return"http"!==t.substr(0,4)&&(t=UrlUtils.getAppPath()+t),this.mimeType()+":"+this.fileName()+":"+t},CAbstractFileModel.prototype.onUploadSelect=function(t,e,i){i||(this.fileName(Types.pString(e.FileName)),this.mimeType(Types.pString(e.Type)),this.size(Types.pInt(e.Size))),this.uploadUid(t),this.uploaded(!1),this.statusText(""),this.progressPercent(0),this.visibleProgress(!1)},CAbstractFileModel.prototype.onUploadStart=function(){this.visibleProgress(!0)},CAbstractFileModel.prototype.onUploadProgress=function(t,e){e>0&&(this.progressPercent(Math.ceil(t/e*100)),this.visibleProgress(!0))},CAbstractFileModel.prototype.onDownloadProgress=function(t,e){e>0&&(this.progressPercent(Math.ceil(t/e*100)),this.visibleProgress(this.progressPercent()<100))},CAbstractFileModel.prototype.onUploadComplete=function(t,e,i){var s=!(e&&i&&!i.ErrorCode&&i.Result&&!i.Result.Error),o=i&&i.ErrorCode&&i.ErrorCode===Enums.Errors.CanNotUploadFileLimit?TextUtils.i18n("%MODULENAME%/ERROR_UPLOAD_SIZE"):TextUtils.i18n("%MODULENAME%/ERROR_UPLOAD_UNKNOWN");this.progressPercent(0),this.visibleProgress(!1),this.uploaded(!0),this.uploadError(s),this.statusText(s?o:TextUtils.i18n("%MODULENAME%/REPORT_UPLOAD_COMPLETE")),s||(this.fillDataAfterUploadComplete(i,t),setTimeout(function(t){return function(){t.statusText("")}}(this),3e3))},CAbstractFileModel.prototype.fillDataAfterUploadComplete=function(t,e){},CAbstractFileModel.prototype.onImageLoad=function(t,e){""===this.thumbUrlInQueue()||this.thumbnailLoaded()||(this.thumbnailLoaded(!0),FilesUtils.thumbQueue(this.thumbnailSessionUid()))},CAbstractFileModel.prototype.stopDownloading=function(){this.downloading(!1)},CAbstractFileModel.prototype.startDownloading=function(){this.downloading(!0)},module.exports=CAbstractFileModel;