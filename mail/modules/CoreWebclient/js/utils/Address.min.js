"use strict";var _=require("underscore"),$=require("jquery"),AddressUtils={};AddressUtils.isCorrectEmail=function(r){return!!r.match(/^[A-Z0-9\"!#\$%\^\{\}`~&'\+\-=_\.]+@[A-Z0-9\.\-]+$/i)},AddressUtils.getFullEmail=function(r,s){return s.length>0?r.length>0?AddressUtils.isCorrectEmail(r)||-1!==r.indexOf(",")?'"'+r+'" <'+s+">":r+" <"+s+">":s:r},AddressUtils.getEmailParts=function(r,s){for(var i=r.indexOf('"'),t=r.indexOf('"',i+1),e=r.indexOf("<",t),l=-1,n=-1,d="",a="";-1!==e;)l=e,e=r.indexOf("<",e+1);return e=l,n=r.indexOf(">",e+1),-1===e?a=$.trim(r):(d=-1===(i=s?-1:i)?$.trim(r.substring(0,e)):$.trim(r.substring(i+1,t)),a=$.trim(r.substring(e+1,n))),{name:d,email:a,fullEmail:AddressUtils.getFullEmail(d,a)}},AddressUtils.getArrayRecipients=function(r,s){for(var i=[",",";"," "],t="",e=r,l=0,n=0,d="",a=null,u=[];e.length>0;){for(n=l=AddressUtils._getFirstSeparatorPosition(e,i);-1!==_.indexOf(i,e[n+1]);)n++;-1===l?(d=t+e,a=AddressUtils.getEmailParts(d),(s||AddressUtils.isCorrectEmail(a.email))&&u.push(a),e=""):(d=t+e.substring(0,l),a=AddressUtils.getEmailParts(d),AddressUtils.isCorrectEmail(a.email)?(u.push(a),t=""):t+=e.substring(0,n+1),e=e.substring(n+1))}return u},AddressUtils._getFirstSeparatorPosition=function(r,s){var i=-1;return _.each(s,function(s){var t=r.indexOf(s);-1!==t&&(-1===i||t<i)&&(i=t)}),i},AddressUtils.getIncorrectEmailsFromAddressString=function(r){for(var s=r.replace(/"[^"]*"/g,"").replace(/;/g,",").split(","),i=[],t=0,e=s.length,l=null;t<e;t++)$.trim(s[t]).length>0&&(l=AddressUtils.getEmailParts($.trim(s[t])),AddressUtils.isCorrectEmail(l.email)||i.push(l.email));return i},module.exports=AddressUtils;