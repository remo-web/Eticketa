"use strict";function GetAutocomplete(e){return e.data("customAutocomplete")||e.data("uiAutocomplete")||e.data("autocomplete")||e.data("ui-autocomplete")}var _=require("underscore"),$=require("jquery"),AddressUtils=require("%PathToCoreWebclientModule%/js/utils/Address.js"),TextUtils=require("%PathToCoreWebclientModule%/js/utils/Text.js");require("jquery-ui/ui/widgets/autocomplete");var inputosaurustext={version:"0.1.6",eventprefix:"inputosaurus",options:{inputDelimiters:[",",";"],outputDelimiter:",",allowDuplicates:!1,parseOnBlur:!1,wrapperElement:null,width:null,autoCompleteAppendTo:null,autoCompleteSource:"",activateFinalResult:!1,parseHook:null,placeholder:null,openedByClick:!1,sourceResponse:function(){},deleteSelectedItem:function(e){var t=this;this.autoCompleteDeleteItem(this.selectedItem),this.sourceResponseItems=_.filter(this.sourceResponseItems,function(e){return e.id!==t.selectedItem.id}),$.ui.autocomplete.prototype.__response.call(GetAutocomplete($(e.elements.input)),this.sourceResponseItems)},sourceResponseItems:null,selectedItem:null,autoCompleteDeleteItem:function(){}},_create:function(e){var t=this,i={},n=t.options,s=n.placeholder||this.element.attr("placeholder")||null,u=this.element.attr("tabindex"),o=u?' tabindex="'+u+'"':"",a=null;this._chosenValues=[],i.ul=$('<ul class="inputosaurus-container" style="padding: 3px;">'),i.fakeSpan=$('<span class="inputosaurus-fake-span"></span>'),i.input=$('<input type="text"'+o+' autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" />'),i.inputCont=$('<li class="inputosaurus-input inputosaurus-required"></li>'),i.origInputCont=$('<li class="inputosaurus-input-hidden inputosaurus-required"></li>'),i.lastEdit="",s&&(n.placeholder=s,i.input.attr("placeholder",n.placeholder),n.width&&i.input.css("min-width",n.width-50)),n.wrapperElement&&n.wrapperElement.append(i.ul),this.element.replaceWith(n.wrapperElement||i.ul),i.origInputCont.append(this.element).hide(),i.inputCont.append(i.input),i.ul.append(i.inputCont),i.ul.append(i.origInputCont),i.ul.append(i.fakeSpan),n.width&&i.ul.css("width",n.width),a=i.ul.parent(),!t.options.mobileDevice&&a.droppable&&a.droppable({drop:function(e,n){var s=$(n.draggable),u=n.helper.__widget,o=s.data("full");u&&u._removeLiTag(s,u),_.defer(function(){$(i.input).val(o),$(t.element).inputosaurus("parseInput")})}}),this.elements=i,t._attachEvents(),$.trim(this.element.val())&&(i.input.val(this.element.val()),this.parseInput()),this._instAutocomplete()},_instAutocomplete:function(){if(this.options.autoCompleteSource){var e=this,t="";this.elements.input.autocomplete({position:{of:this.elements.ul},source:function(i,n){t=i.term,e.options.sourceResponse=n,e.options.autoCompleteSource(i,function(t){e.options.sourceResponseItems=t,e.options.sourceResponse(t)})},minLength:1,autoFocus:!0,appendTo:this.options.autoCompleteAppendTo||"body",select:function(i,n){if($(this).val()!==t)return GetAutocomplete($(this)).close(),!1;i.preventDefault(),e.elements.input.val(n.item.value),e.parseInput()},open:function(){var t,i,n=GetAutocomplete($(this)).menu||null;n&&(n.element.width(0+e.elements.ul.outerWidth(!1)-20),i=$(window).height()-e.elements.ul.outerHeight()-e.elements.ul.offset().top+window.pageYOffset,n.element.css("max-height",i>200?i-50:i-2),e.options.activateFinalResult&&1===(t=n.element.find("li")).length&&n[n.activate?"activate":"focus"]($.Event("click"),t),n.element.find("span.del").on("click",function(t,i){t.preventDefault(),t.stopPropagation(),e.options.deleteSelectedItem(e)}))},close:function(){setTimeout(function(){e.options.openedByClick=!1}.bind(this),200)},focus:function(t,i){return e.options.selectedItem=i.item,!1}})}},_autoCompleteMenuPosition:function(){this.options.autoCompleteSource&&GetAutocomplete(this.elements.input).menu.element.position({of:this.elements.ul,my:"left top",at:"left bottom",collision:"none"})},parseInput:function(e){var t=e&&e.data.widget||this,i=t.elements.input.val(),n=[],s=i&&i.length>0?i[i.length-1]:"",u=AddressUtils.getArrayRecipients(i,!1),o=u.length>0&&$.inArray(s,[",",";"," "])>-1,a=!e||e.which===$.ui.keyCode.ENTER&&!$(".ui-menu-item .ui-state-focus").length&&!$("#ui-active-menuitem").length,l=e&&"blur"===e.type&&!$("#ui-active-menuitem").length;(o||a||l)&&(0===(n=_.map(u,function(e){return e.fullEmail})).length&&a&&n.push(i),a&&e&&e.preventDefault()),$.isFunction(t.options.parseHook)&&(n=t.options.parseHook(n)),n.length&&(t.elements.input.val(""),t._resizeInput(),t._setChosen(n)),t._resetPlaceholder(),t._resizeInput()},_inputFocus:function(e){var t=e.data.widget||this;t.elements.input.value||t.elements.input.autocomplete("option","minLength")&&t.options.autoCompleteSource.length&&t.elements.input.autocomplete("search",""),t._resizeInput(),$.isFunction(t.options.focus)&&t.options.focus()},_inputKeypress:function(e){var t=e.data,i=e.data.widget||this,n="";switch("keyup"===e.type&&i._trigger("keyup",e,i),!0){case 86===e.which&&e.ctrlKey:$.isFunction(i.options.paste)&&(n=i.options.paste())&&(i._setChosen([n]),e.preventDefault());break;case e.which===$.ui.keyCode.BACKSPACE:case e.which===$.ui.keyCode.LEFT:"keydown"===e.type&&i._inputBackspace(e);break;default:"keydown"===e.type&&setTimeout(function(){e.data=t,i.parseInput(e)},0)}i.options.sourceResponseItems&&i.options.selectedItem&&!i.options.selectedItem.global&&e.keyCode===$.ui.keyCode.DELETE&&e.shiftKey&&(e.preventDefault(),e.stopPropagation(),i.options.deleteSelectedItem(i))},resizeInput:function(){this._resizeInput()},_resizeInput:function(e){var t=e&&e.data.widget||this;t.elements.input.is(":focus")||""!==t.elements.input.val()?""===t.elements.lastEdit?t._resizeEndInput(t,100):this._resizeAnyPlaceInput(t,100):t.elements.input.width(1)},_resizeAnyPlaceInput:function(e,t){var i=e.elements.ul.outerWidth()-10,n=0;e.elements.fakeSpan.text(e.elements.input.val()),n=(n=(n=20+e.elements.fakeSpan.width())<i?n:i)<t?t:n,e.elements.input.width(n)},_resizeEndInput:function(e,t){var i=e.elements.ul.find("li:not(.inputosaurus-required):last"),n=e.elements.ul.outerWidth(),s=e.elements.ul.position().left,u=n+s-(i&&i.length>0?i.outerWidth():0)-(i&&i.length>0?i.position().left:s)-25;u<t&&(u=n-25),e.elements.input.width(u+"px")},_resetPlaceholder:function(){var e=this.options.placeholder,t=this.elements.input,i=this.options.width||"inherit";e&&0===this.element.val().length?t.attr("placeholder",e).css("min-width",i-50):t.attr("placeholder","").css("min-width","inherit")},_inputBackspace:function(e){var t=(e&&e.data.widget||this).elements.ul.find("li:not(.inputosaurus-required):last");e.stopPropagation(),(!$(e.currentTarget).val()||"selectionStart"in e.currentTarget&&0===e.currentTarget.selectionStart&&0===e.currentTarget.selectionEnd)&&t.length&&(e.preventDefault(),t.find("a").focus())},_editTag:function(e){var t=e&&e.data.widget||this,i="",n=$(e.currentTarget).closest("li"),s=n.data("inputosaurus");if(s){e.preventDefault();var u=null,o=!1;$.each(t._chosenValues,function(e,t){t.key===s?(i=t.value,o=!0):o&&!u&&(u=t)}),u&&(t.elements.lastEdit=u.value),n.after(t.elements.inputCont),t.elements.input.val(i),setTimeout(function(){t.elements.input.select()},100),t._removeTag(e)}},_tagKeypress:function(e){var t=e.data.widget;switch(e.which){case 88:e.ctrlKey&&$.isFunction(t.options.copy)&&t.options.copy(t._cutTag(e));break;case 67:e.ctrlKey&&$.isFunction(t.options.copy)&&t.options.copy(t._copyTag(e));break;case 69:case $.ui.keyCode.ENTER:t._editTag(e);break;case $.ui.keyCode.BACKSPACE:case $.ui.keyCode.DELETE:t._removeTag(e),e&&e.preventDefault(),e&&e.stopPropagation();break;case $.ui.keyCode.LEFT:"keydown"===e.type&&t._prevTag(e);break;case $.ui.keyCode.RIGHT:"keydown"===e.type&&t._nextTag(e);break;case $.ui.keyCode.DOWN:"keydown"===e.type&&t._focus(e)}},_cutTag:function(e){var t=this._copyTag(e);return this._removeTag(e),t},_copyTag:function(e){var t=e&&e.data.widget||this,i=$(e.currentTarget).closest("li").data("inputosaurus"),n="";return i?(e.preventDefault(),$.each(t._chosenValues,function(e,t){t.key===i&&(n=t.value)}),n):n},_prevTag:function(e){var t=e&&e.data.widget||this,i=$(e.currentTarget).closest("li").prev();i.is("li")?i.find("a").focus():t._focus()},_nextTag:function(e){var t=e&&e.data.widget||this,i=$(e.currentTarget).closest("li").next();i.is("li:not(.inputosaurus-input)")?i.find("a").focus():t._focus()},_containsDelimiter:function(e){var t=!1;return $.each(this.options.inputDelimiters,function(i,n){-1!==e.indexOf(n)&&(t=n)}),t},_setChosen:function(e){var t=this;_.isArray(e)&&($.each(e,function(e,i){var n=!1,s=-1,u={key:"",value:""};i=$.trim(i),$.each(t._chosenValues,function(e,u){u.value===t.elements.lastEdit&&(s=e),u.value===i&&(n=!0)}),""===i||n&&!t.options.allowDuplicates||(u.key="mi_"+Math.random().toString(16).slice(2,10),u.value=i,-1<s?t._chosenValues.splice(s,0,u):t._chosenValues.push(u),t.elements.lastEdit="",t._renderTags())}),1===e.length&&""===e[0]&&""!==t.elements.lastEdit&&(t.elements.lastEdit="",t._renderTags()),t._setValue(t._buildValue()))},_buildValue:function(){var e=this,t="";return $.each(this._chosenValues,function(i,n){t+=t.length?e.options.outputDelimiter+n.value:n.value}),this.elements.input.val().length>0&&(t+=t.length?e.options.outputDelimiter+this.elements.input.val():this.elements.input.val()),t},_setValue:function(e){this.element.val()!==e&&(this.options.openedByClick=!1,this.element.val(e),this._trigger("change"))},_createTag:function(e,t){var i=AddressUtils.getEmailParts(t,!0),n=TextUtils.encodeHtml(i.name?i.name:i.email),s=t?' title="'+TextUtils.i18n("%MODULENAME%/ACTION_EDIT_ADDRESS",{EMAIL:t.replace(/"/g,"&quot;")})+'"':"",u=TextUtils.i18n("%MODULENAME%/ACTION_DELETE_ADDRESS"),o=null,a=this;return void 0!==n&&(o=$('<li class="address_capsule" data-inputosaurus="'+e+'"'+s+">"+('<a href="javascript:void(0);" class="ficon" title="'+u+'">&#x2716;</a>')+"<span>"+n+"</span></li>"),a.options.mobileDevice||(o.data("full",t),o.draggable&&o.draggable({revert:"invalid",helper:function(){var e=$(this),t=e.parent().parent().parent().parent(),i=e.clone();return e.css("visibility","hidden"),$('<div class="inputosaurus-moving-container"><div>').appendTo(t).append(i)},start:function(e,t){t.helper.__widget=a},stop:function(e,t){$(this).css("visibility","visible")}}))),o},_renderTags:function(){var e=this;this.elements.ul.find("li:not(.inputosaurus-required)").remove(),$.each(this._chosenValues,function(t,i){var n=e._createTag(i.key,i.value);e.elements.ul.find("li.inputosaurus-input").before(n)})},_removeTag:function(e){var t=e&&e.data.widget||this;t._removeLiTag($(e.currentTarget).closest("li"),t),t.options.openedByClick=!1},_removeLiTag:function(e,t){var i=e.data("inputosaurus"),n=!1;$.each(t._chosenValues,function(e,t){i===t.key&&(n=e)}),!1!==n&&t._chosenValues.splice(n,1),t._setValue(t._buildValue()),e.remove(),setTimeout(function(){t.elements.input.focus()},100),t._resizeInput()},focus:function(){this.elements.input.focus()},_focus:function(e){var t=e&&e.data.widget||this,i=e&&e.target?$(e.target).closest("li"):null;i&&i.is("li")&&i.find("a").focus(),e&&$(e.target).closest("li").data("inputosaurus")||t.elements.input.focus()},_click:function(e){var t=e&&e.data.widget||this;(""!==t.elements.input.val()||e)&&$(e.target).closest("li").data("inputosaurus")||(t.options.openedByClick?t.options.openedByClick=!1:(t.elements.input.autocomplete("option","minLength",0),t.elements.input.autocomplete("search"),setTimeout(function(){t.elements.input.autocomplete("option","minLength",1)}.bind(this),0),t.options.openedByClick=!0))},_tagFocus:function(e){$(e.currentTarget).parent()["focusout"===e.type?"removeClass":"addClass"]("inputosaurus-selected")},refresh:function(){var e=this.element.val(),t=[],i=AddressUtils.getArrayRecipients(e,!0);t=_.map(i,function(e){return e.fullEmail}),this._chosenValues=[],$.isFunction(this.options.parseHook)&&(t=this.options.parseHook(t)),this._setChosen(t),this._renderTags(),this.elements.input.val(""),this._resizeInput()},_attachEvents:function(){var e=this;this.elements.input.on("keyup.inputosaurus",{widget:e},this._inputKeypress),this.elements.input.on("keydown.inputosaurus",{widget:e},this._inputKeypress),this.elements.input.on("change.inputosaurus",{widget:e},this._inputKeypress),this.elements.input.on("focus.inputosaurus",{widget:e},this._inputFocus),this.options.parseOnBlur&&this.elements.input.on("blur.inputosaurus",{widget:e},this.parseInput),this.elements.input.on("focus.inputosaurus",function(){e.elements.input.show()}),this.elements.ul.on("click.inputosaurus",{widget:e},this._click),this.elements.ul.on("click.inputosaurus",{widget:e},this._focus),this.elements.ul.on("click.inputosaurus","a",{widget:e},this._removeTag),this.elements.ul.on("dblclick.inputosaurus","li",{widget:e},this._editTag),this.elements.ul.on("focus.inputosaurus","a",{widget:e},this._tagFocus),this.elements.ul.on("blur.inputosaurus","a",{widget:e},this._tagFocus),this.elements.ul.on("keydown.inputosaurus","a",{widget:e},this._tagKeypress),e.options.mobileDevice&&(this.elements.ul.on("tap.inputosaurus",{widget:e},this._focus),this.elements.ul.on("doubletap.inputosaurus","li",{widget:e},this._editTag))},_destroy:function(){this.elements.input.unbind(".inputosaurus"),this.elements.ul.replaceWith(this.element)}};$.widget("ui.inputosaurus",inputosaurustext),module.exports={};