"use strict";function ImportExportPopup(){CAbstractPopup.call(this),this.zipFile=ko.observable(null),this.status=ko.observable(""),this.iAutoReloadTimer=-1,this.opened=ko.observable(!1),this.options=ko.observableArray([]),this.selectedFolder=ko.observable(""),this.uploaderButton=ko.observable(null),this.oJua=null,this.defaultOptionsAfterRender=Utils.defaultOptionsAfterRender,this.exportButtonText=ko.observable(TextUtils.i18n("%MODULENAME%/POPUP_ACTION_EXPORT")),this.importButtonText=ko.observable(TextUtils.i18n("%MODULENAME%/POPUP_ACTION_IMPORT")),this.processing=ko.computed(function(){return"ready"!==this.status()&&"error"!==this.status()&&""!==this.status()},this),this.status.subscribe(function(t){"ready"===t?(this.opened()||this.openPopup({}),this.exportButtonText(TextUtils.i18n("%MODULENAME%/POPUP_ACTION_DOWNLOAD_ZIP")),clearTimeout(this.iAutoReloadTimer)):"error"===t&&(Screens.showError(TextUtils.i18n("%MODULENAME%/POPUP_ERROR_GENERATE_ZIP")),this.exportButtonText(TextUtils.i18n("%MODULENAME%/POPUP_ACTION_EXPORT")),clearTimeout(this.iAutoReloadTimer))},this)}var _=require("underscore"),ko=require("knockout"),Utils=require("%PathToCoreWebclientModule%/js/utils/Common.js"),TextUtils=require("%PathToCoreWebclientModule%/js/utils/Text.js"),Ajax=require("%PathToCoreWebclientModule%/js/Ajax.js"),CJua=require("%PathToCoreWebclientModule%/js/CJua.js"),Screens=require("%PathToCoreWebclientModule%/js/Screens.js"),App=require("%PathToCoreWebclientModule%/js/App.js"),Api=require("%PathToCoreWebclientModule%/js/Api.js"),CAbstractPopup=require("%PathToCoreWebclientModule%/js/popups/CAbstractPopup.js"),MailCache=require("modules/MailWebclient/js/Cache.js"),Settings=require("modules/%ModuleName%/js/Settings.js");_.extendOwn(ImportExportPopup.prototype,CAbstractPopup.prototype),ImportExportPopup.prototype.PopupTemplate="%ModuleName%_ImportExportPopup",ImportExportPopup.prototype.onOpen=function(){this.options(MailCache.folderList().getOptions("",!0,!1,!1))},ImportExportPopup.prototype.onShow=function(){this.opened(!0),this.initUploader()},ImportExportPopup.prototype.onCancelClick=function(){this.opened(!1),this.closeCommand()},ImportExportPopup.prototype.exportMail=function(){""===this.status()?(this.status("prepare"),Ajax.send(Settings.ModuleName,"ExportMailPrepare",{},this.onExportMailResponse,this),this.setAutoReloadTimer()):"ready"===this.status()&&this.Download()},ImportExportPopup.prototype.setAutoReloadTimer=function(){var t=this;clearTimeout(this.iAutoReloadTimer),this.iAutoReloadTimer=setTimeout(function(){t.Status()},1e4)},ImportExportPopup.prototype.Status=function(){this.setAutoReloadTimer(),""!==this.status()&&Ajax.send(Settings.ModuleName,"ExportMailStatus",{Zip:this.zipFile()},this.onStatusResponse,this)},ImportExportPopup.prototype.onExportMailResponse=function(t){var e=t.Result;e&&"prepare"===this.status()&&e.Zip&&(this.zipFile(e.Zip),this.exportButtonText(TextUtils.i18n("%MODULENAME%/POPUP_GENERATING_ZIP")),Ajax.send(Settings.ModuleName,"ExportMailGenerate",{AccountId:MailCache.currentAccountId(),Folder:this.selectedFolder(),Zip:this.zipFile()}))},ImportExportPopup.prototype.onStatusResponse=function(t){var e=t.Result;e&&e.Status&&this.status(e.Status)},ImportExportPopup.prototype.Download=function(){"ready"===this.status()&&(this.status(""),this.exportButtonText(TextUtils.i18n("%MODULENAME%/POPUP_ACTION_EXPORT")),window.location.href="?transfer-mail/export/"+this.zipFile())},ImportExportPopup.prototype.initUploader=function(){var t=this;this.uploaderButton()&&null===this.oJua&&(this.oJua=new CJua({action:"?/Api/",name:"jua-uploader",queueSize:2,clickElement:this.uploaderButton(),disableAjaxUpload:!1,disableFolderDragAndDrop:!0,disableDragAndDrop:!0,hidden:_.extendOwn({Module:Settings.ModuleName,Method:"ImportMail",Parameters:function(){return JSON.stringify({AccountId:MailCache.currentAccountId(),Folder:t.selectedFolder()})}},App.getCommonRequestParameters())}),this.oJua.bEnableButton=!0,this.oJua.on("onSelect",_.bind(this.onFileUploadSelect,this)).on("onStart",_.bind(this.onFileUploadStart,this)).on("onComplete",_.bind(this.onFileUploadComplete,this)))},ImportExportPopup.prototype.onFileUploadSelect=function(t,e){if(Settings.UploadSizeLimitMb>0&&e.Size/1048576>Settings.UploadSizeLimitMb)return Screens.showError(TextUtils.i18n("%MODULENAME%/ERROR_SIZE_LIMIT",{SIZE:Settings.UploadSizeLimitMb})),!1},ImportExportPopup.prototype.onFileUploadStart=function(){this.status("upload"),this.importButtonText(TextUtils.i18n("%MODULENAME%/POPUP_IMPORTING_ZIP"))},ImportExportPopup.prototype.onFileUploadComplete=function(t,e,o){var i=!(e&&o&&o.Result);this.status(""),this.importButtonText(TextUtils.i18n("%MODULENAME%/POPUP_ACTION_IMPORT")),i?Api.showErrorByCode(o,TextUtils.i18n("%MODULENAME%/UNKNOWN_ERROR")):Screens.showReport(TextUtils.i18n("%MODULENAME%/INFO_UPLOAD_COMPLETED"))},module.exports=new ImportExportPopup;