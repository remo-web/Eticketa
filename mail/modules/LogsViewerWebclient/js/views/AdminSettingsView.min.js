"use strict";function CLoggingAdminSettingsView(){CAbstractSettingsFormView.call(this,"Core"),this.iViewLogSizeBytes=Settings.ViewLastLogSize,this.aLevelOptions=[{text:TextUtils.i18n("%MODULENAME%/LABEL_LOGGING_DEBUG"),value:Enums.LogLevel.Full},{text:TextUtils.i18n("%MODULENAME%/LABEL_LOGGING_WARNINGS"),value:Enums.LogLevel.Warning},{text:TextUtils.i18n("%MODULENAME%/LABEL_LOGGING_ERRORS"),value:Enums.LogLevel.Error}],this.logSize=ko.observable(Settings.LogSizeBytes),this.downloadLogText=ko.computed(function(){return TextUtils.i18n("%MODULENAME%/BUTTON_LOGGING_DOWNLOAD",{SIZE:TextUtils.getFriendlySize(this.logSize())})},this),this.viewLogText=ko.computed(function(){return this.logSize()<this.iViewLogSizeBytes?TextUtils.i18n("%MODULENAME%/BUTTON_LOGGING_VIEW"):TextUtils.i18n("%MODULENAME%/BUTTON_LOGGING_VIEW_LAST",{SIZE:TextUtils.getFriendlySize(this.iViewLogSizeBytes)})},this),this.eventsLogSize=ko.observable(Settings.EventLogSizeBytes),this.downloadEventsLogText=ko.computed(function(){return TextUtils.i18n("%MODULENAME%/BUTTON_LOGGING_DOWNLOAD_EVENTS",{SIZE:TextUtils.getFriendlySize(this.eventsLogSize())})},this),this.viewEventsLogText=ko.computed(function(){return this.eventsLogSize()<this.iViewLogSizeBytes?TextUtils.i18n("%MODULENAME%/BUTTON_LOGGING_VIEW"):TextUtils.i18n("%MODULENAME%/BUTTON_LOGGING_VIEW_LAST",{SIZE:TextUtils.getFriendlySize(this.iViewLogSizeBytes)})},this),this.usersWithSeparateLog=ko.observableArray([]),this.enableLogging=ko.observable(Settings.EnableLogging),this.enableEventLogging=ko.observable(Settings.EnableEventLogging),this.loggingLevel=ko.observable(Settings.LoggingLevel)}var _=require("underscore"),$=require("jquery"),ko=require("knockout"),FileSaver=require("%PathToCoreWebclientModule%/js/vendors/FileSaver.js"),TextUtils=require("%PathToCoreWebclientModule%/js/utils/Text.js"),Types=require("%PathToCoreWebclientModule%/js/utils/Types.js"),Ajax=require("%PathToCoreWebclientModule%/js/Ajax.js"),Api=require("%PathToCoreWebclientModule%/js/Api.js"),WindowOpener=require("%PathToCoreWebclientModule%/js/WindowOpener.js"),UserSettings=require("%PathToCoreWebclientModule%/js/Settings.js"),Settings=require("modules/%ModuleName%/js/Settings.js"),ModulesManager=require("%PathToCoreWebclientModule%/js/ModulesManager.js"),CAbstractSettingsFormView=ModulesManager.run("AdminPanelWebclient","getAbstractSettingsFormViewClass");_.extendOwn(CLoggingAdminSettingsView.prototype,CAbstractSettingsFormView.prototype),CLoggingAdminSettingsView.prototype.ViewTemplate="%ModuleName%_AdminSettingsView",CLoggingAdminSettingsView.prototype.onRouteChild=function(){this.setUpdateStatusTimer();""===UserSettings.DbLogin||""===UserSettings.DbName||""===UserSettings.DbHost||Ajax.send(Settings.ServerModuleName,"GetUsersWithSeparateLog",null,function(e){e.Result?this.usersWithSeparateLog(_.isArray(e.Result)?e.Result:[]):Api.showErrorByCode(e)},this)},CLoggingAdminSettingsView.prototype.turnOffSeparateLogs=function(){this.usersWithSeparateLog([]),Ajax.send(Settings.ServerModuleName,"TurnOffSeparateLogs")},CLoggingAdminSettingsView.prototype.clearSeparateLogs=function(){Ajax.send(Settings.ServerModuleName,"ClearSeparateLogs")},CLoggingAdminSettingsView.prototype.setUpdateStatusTimer=function(){this.bShown&&setTimeout(_.bind(function(){Ajax.send(Settings.ServerModuleName,"GetLogFilesData",null,function(e){e.Result&&(Settings.updateLogsData(e.Result),this.logSize(Settings.LogSizeBytes),this.eventsLogSize(Settings.EventLogSizeBytes)),this.setUpdateStatusTimer()},this)},this),5e3)},CLoggingAdminSettingsView.prototype.getCurrentValues=function(){return[this.enableLogging(),this.enableEventLogging(),Types.pInt(this.loggingLevel())]},CLoggingAdminSettingsView.prototype.revertGlobalValues=function(){this.enableLogging(Settings.EnableLogging),this.enableEventLogging(Settings.EnableEventLogging),this.loggingLevel(Settings.LoggingLevel)},CLoggingAdminSettingsView.prototype.getParametersForSave=function(){return{EnableLogging:this.enableLogging(),EnableEventLogging:this.enableEventLogging(),LoggingLevel:Types.pInt(this.loggingLevel())}},CLoggingAdminSettingsView.prototype.applySavedValues=function(e){Settings.updateLogging(e.EnableLogging,e.EnableEventLogging,e.LoggingLevel)},CLoggingAdminSettingsView.prototype.setAccessLevel=function(e,t){this.visible(""===e)},CLoggingAdminSettingsView.prototype.downloadLog=function(e,t){Ajax.send(Settings.ServerModuleName,"GetLogFile",{EventsLog:e,PublicId:t||""},function(i){var n=new Blob([i.ResponseText],{type:"text/plain;charset=utf-8"}),o=""!==Types.pString(t)?t+"-":"";FileSaver.saveAs(n,e?Settings.EventLogFileName:o+Settings.LogFileName)},this,void 0,{Format:"Raw"})},CLoggingAdminSettingsView.prototype.viewLog=function(e){Ajax.send(Settings.ServerModuleName,"GetLog",{EventsLog:e},function(e){if(e.Result){var t=WindowOpener.open("","view-log");t&&$(t.document.body).html("<pre>"+e.Result+"</pre>")}},this)},CLoggingAdminSettingsView.prototype.clearLog=function(e){Ajax.send(Settings.ServerModuleName,"ClearLog",{EventsLog:e},function(t){t.Result&&(e?this.eventsLogSize(0):this.logSize(0))},this)},module.exports=new CLoggingAdminSettingsView;