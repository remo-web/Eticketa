"use strict";function CLoginView(){CAbstractScreenView.call(this,"%ModuleName%"),this.sCustomLogoUrl=Settings.CustomLogoUrl,this.sInfoText=Settings.InfoText,this.sBottomInfoHtmlText=Settings.BottomInfoHtmlText,this.login=ko.observable(""),this.username=ko.observable(""),this.password=ko.observable(""),this.usernameFocus=ko.observable(!1),this.passwordFocus=ko.observable(!1),this.loginFocus=ko.observable(!1),this.loading=ko.observable(!1),this.bUseSignMe=Settings.LoginSignMeType===Enums.LoginSignMeType.Unuse,this.signMe=ko.observable(Enums.LoginSignMeType.DefaultOn===Settings.LoginSignMeType),this.signMeFocused=ko.observable(!1),this.canBeLogin=ko.computed(function(){return!this.loading()},this),this.signInButtonText=ko.computed(function(){return this.loading()?TextUtils.i18n("COREWEBCLIENT/ACTION_SIGN_IN_IN_PROGRESS"):TextUtils.i18n("COREWEBCLIENT/ACTION_SIGN_IN")},this),this.loginCommand=Utils.createCommand(this,this.signIn,this.canBeLogin),this.username(Settings.DemoLogin||""),this.password(Settings.DemoPassword||""),this.shake=ko.observable(!1).extend({autoResetToFalse:800}),this.bRtl=UserSettings.IsRTL,this.aLanguages=UserSettings.LanguageList,this.currentLanguage=ko.observable(UserSettings.Language),this.bAllowChangeLanguage=Settings.AllowChangeLanguage&&!App.isMobile(),this.bUseDropdownLanguagesView=Settings.UseDropdownLanguagesView,this.domains=ko.observableArray([]),this.selectedDomain=ko.observable(""),this.firstDomain=ko.computed(function(){return this.domains().length>0?this.domains()[0]:""},this),this.selectedServer=ko.observable(""),this.beforeButtonsControllers=ko.observableArray([]),App.broadcastEvent("AnonymousUserForm::PopulateBeforeButtonsControllers",{ModuleName:"%ModuleName%",RegisterBeforeButtonsController:this.registerBeforeButtonsController.bind(this)}),App.broadcastEvent("%ModuleName%::ConstructView::after",{Name:this.ViewConstructorName,View:this})}var _=require("underscore"),$=require("jquery"),ko=require("knockout"),TextUtils=require("%PathToCoreWebclientModule%/js/utils/Text.js"),UrlUtils=require("%PathToCoreWebclientModule%/js/utils/Url.js"),Utils=require("%PathToCoreWebclientModule%/js/utils/Common.js"),Ajax=require("%PathToCoreWebclientModule%/js/Ajax.js"),Api=require("%PathToCoreWebclientModule%/js/Api.js"),App=require("%PathToCoreWebclientModule%/js/App.js"),Browser=require("%PathToCoreWebclientModule%/js/Browser.js"),CAbstractScreenView=require("%PathToCoreWebclientModule%/js/views/CAbstractScreenView.js"),UserSettings=require("%PathToCoreWebclientModule%/js/Settings.js"),Settings=require("modules/%ModuleName%/js/Settings.js"),$html=$("html");_.extendOwn(CLoginView.prototype,CAbstractScreenView.prototype),CLoginView.prototype.ViewTemplate="%ModuleName%_LoginView",CLoginView.prototype.ViewConstructorName="CLoginView",CLoginView.prototype.onBind=function(){$html.addClass("non-adjustable-valign")},CLoginView.prototype.onShow=function(){_.delay(_.bind(function(){""===this.username()&&this.usernameFocus(!0)},this),1),Ajax.send("%ModuleName%","GetMailDomains",{},function(e,t){_.isArray(e.Result)&&this.domains(e.Result)},this,1e5)},CLoginView.prototype.signIn=function(){if(!this.loading()){var e="",t="",o=$.trim(this.password()),s=null;if(0===(t=$.trim(this.username())).length?s=this.usernameFocus:e=this.domains().length>1?this.selectedDomain():this.firstDomain(),t.length>0&&o.length>0){var i={Domain:e,Login:t,Password:o,Language:$.cookie("aurora-selected-lang")||"",SignMe:this.signMe()};App.broadcastEvent("AnonymousUserForm::PopulateFormSubmitParameters",{Module:"%ModuleName%",Parameters:i}),this.loading(!0),Ajax.send("%ModuleName%","Login",i,this.onSystemLoginResponse,this,1e5)}else s?s(!0):0===o.length&&this.passwordFocus(!0),this.shake(!0)}},CLoginView.prototype.onSystemLoginResponse=function(e,t){!1===e.Result?(this.loading(!1),this.shake(!0),Api.showErrorByCode(e,TextUtils.i18n("COREWEBCLIENT/ERROR_PASS_INCORRECT"))):(App.setAuthToken(e.Result.AuthToken),$.removeCookie("aurora-selected-lang"),""!==window.location.search&&null===UrlUtils.getRequestParam("reset-pass")&&null===UrlUtils.getRequestParam("invite-auth")&&null===UrlUtils.getRequestParam("oauth")?UrlUtils.clearAndReloadLocation(Browser.ie8AndBelow,!0):UrlUtils.clearAndReloadLocation(Browser.ie8AndBelow,!1))},CLoginView.prototype.changeLanguage=function(e){e&&this.bAllowChangeLanguage&&($.cookie("aurora-lang-on-login",e,{expires:30}),$.cookie("aurora-selected-lang",e,{expires:30}),window.location.reload())},CLoginView.prototype.registerBeforeButtonsController=function(e){this.beforeButtonsControllers.push(e)},module.exports=new CLoginView;