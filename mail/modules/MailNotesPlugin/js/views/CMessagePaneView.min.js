"use strict";function GetPlainText(e){if("string"!=typeof e)return"";return e.replace(/\r\n/g," ").replace(/\n/g," ").replace(/<style[^>]*>[^<]*<\/style>/gi,"\n").replace(/<br *\/{0,1}>/gi,"\n").replace(/<\/p>/gi,"\n").replace(/(<\/div>)*$/,"").replace(/<(\/div>)+/gi,"\n").replace(/<a [^>]*href="([^"]*?)"[^>]*>(.*?)<\/a>/gi,function(e,s,t){var i=s.replace(/(\w{3,4}:\/\/)(.*)/,"$2");return s===t||i===t?s:t+" ("+s+")"}).replace(/<[^>]*>/g,"").replace(/&nbsp;/g," ").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&amp;/g,"&").replace(/&quot;/g,'"')}function CMessagePaneView(e,s){MailCache=e,this.fRouteMessageView=s,this.currentMessage=MailCache.currentMessage,this.currentMessage.subscribe(this.onCurrentMessageSubscribe,this),this.messageText=ko.observable(""),this.messageText.focused=ko.observable(!1),ko.computed(function(){this.messageText(),this.messageText.focused(!0)},this).extend({throttle:5}),this.sMessageUid="",this.sMessageText="",this.isLoading=ko.observable(!1),this.isSaving=ko.observable(!1),this.createMode=ko.observable(!1),this.saveButtonText=ko.computed(function(){return this.isSaving()?TextUtils.i18n("COREWEBCLIENT/ACTION_SAVE_IN_PROGRESS"):TextUtils.i18n("COREWEBCLIENT/ACTION_SAVE")},this),this.bBinded=!1}var _=require("underscore"),$=require("jquery"),ko=require("knockout"),TextUtils=require("%PathToCoreWebclientModule%/js/utils/Text.js"),Ajax=require("%PathToCoreWebclientModule%/js/Ajax.js"),Api=require("%PathToCoreWebclientModule%/js/Api.js"),ModulesManager=require("%PathToCoreWebclientModule%/js/ModulesManager.js"),MailCache=null;CMessagePaneView.prototype.ViewTemplate="%ModuleName%_MessagePaneView",CMessagePaneView.prototype.ViewConstructorName="CMessagePaneView",CMessagePaneView.prototype.onShow=function(){this.bShown=!0},CMessagePaneView.prototype.onHide=function(){this.bShown=!1},CMessagePaneView.prototype.hasUnsavedChanges=function(){var e=this.currentMessage();return(!e||this.sMessageUid===e.uid())&&this.sMessageText!==this.messageText()},CMessagePaneView.prototype.discardChanges=function(){this.currentMessage()||(this.sMessageUid="",this.sMessageText="",this.messageText(""))},CMessagePaneView.prototype.getSubjectFromText=function(e){var s=e.split(/\r\n|\n/i),t=_.find(s,function(e){return""!==$.trim(e)});return(t=$.trim(t)).length>50&&(t=t.substring(0,50)),t},CMessagePaneView.prototype.onCurrentMessageSubscribe=function(){var e=this.currentMessage();if(e){if(e.isPlain()?this.messageText(e.textRaw()):this.messageText(GetPlainText(e.textRaw())),this.sMessageUid=e.uid(),this.sMessageText=this.messageText(),this.isLoading(""!==e.uid()&&!e.completelyFilled()),!e.completelyFilled())var s=e.completelyFilled.subscribe(function(){this.onCurrentMessageSubscribe(),s.dispose()},this);this.isSaving(!1)}else this.sMessageUid="",this.sMessageText="",this.messageText("")},CMessagePaneView.prototype.onBind=function(e){this.bBinded||(ModulesManager.run("SessionTimeoutWeblient","registerFunction",[_.bind(function(){this.saveNote()},this)]),$(document).on("keydown",$.proxy(function(e){e.ctrlKey&&e.keyCode===Enums.Key.s&&(e.preventDefault(),this.saveNote())},this)),this.bBinded=!0)},CMessagePaneView.prototype.onRoute=function(e,s){MailCache.setCurrentMessage(s.Uid,s.Folder),"create-note"===s.Custom?(this.messageText(""),this.createMode(!0)):this.createMode(!1),this.isSaving(!1)},CMessagePaneView.prototype.saveNote=function(){this.createMode()?this.saveNewNote():this.saveEditedNote()},CMessagePaneView.prototype.saveNewNote=function(){var e=MailCache.getCurrentFolder(),s={AccountId:MailCache.currentAccountId(),FolderFullName:e.fullName(),Text:TextUtils.encodeHtml(this.messageText()).replace(/\n/g,"<br />").replace(/\r\n/g,"<br />"),Subject:this.getSubjectFromText(this.messageText())};this.isSaving(!0),this.sMessageText=this.messageText(),Ajax.send("%ModuleName%","SaveNote",s,function(e){if(this.isSaving(!1),e.Result){if(this.bShown)var t=MailCache.messagesLoading.subscribe(function(){!this.bShown||MailCache.messagesLoading()||this.currentMessage()||(this.fRouteMessageView(s.FolderFullName,e.Result),t.dispose())},this)}else Api.showErrorByCode(e,TextUtils.i18n("%MODULENAME%/ERROR_NOTE_SAVING"));MailCache.executeCheckMail(!0)},this)},CMessagePaneView.prototype.saveEditedNote=function(e){if(e||(e=this.currentMessage()),e){var s={AccountId:MailCache.currentAccountId(),FolderFullName:e.folder(),MessageUid:e.uid(),Text:TextUtils.encodeHtml(this.messageText()).replace(/\n/g,"<br />").replace(/\r\n/g,"<br />"),Subject:this.getSubjectFromText(this.messageText())};MailCache.getFolderByFullName(MailCache.currentAccountId(),e.folder()).markDeletedByUids([e.uid()]),MailCache.excludeDeletedMessages(),this.isSaving(!0),this.sMessageText=this.messageText(),Ajax.send("%ModuleName%","SaveNote",s,function(e){if(this.isSaving(!1),e.Result){if(this.bShown)var t=MailCache.messagesLoading.subscribe(function(){!this.bShown||MailCache.messagesLoading()||this.currentMessage()||(this.fRouteMessageView(s.FolderFullName,e.Result),t.dispose())},this)}else Api.showErrorByCode(e,TextUtils.i18n("%MODULENAME%/ERROR_NOTE_SAVING"));MailCache.executeCheckMail(!0)},this)}},CMessagePaneView.prototype.cancel=function(){this.sMessageText=this.messageText(),ModulesManager.run("MailWebclient","setCustomRouting",["Notes",1,"","","",""])},module.exports=CMessagePaneView;