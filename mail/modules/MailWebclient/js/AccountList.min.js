"use strict";function CAccountListModel(){this.collection=ko.observableArray([])}var _=require("underscore"),ko=require("knockout"),Types=require("%PathToCoreWebclientModule%/js/utils/Types.js"),App=require("%PathToCoreWebclientModule%/js/App.js"),MainTab=App.isNewTab()&&window.opener?window.opener.MainTabMailMethods:null,Routing=require("%PathToCoreWebclientModule%/js/Routing.js"),CoreAjax=require("%PathToCoreWebclientModule%/js/Ajax.js"),Ajax=require("modules/%ModuleName%/js/Ajax.js"),LinksUtils=require("modules/%ModuleName%/js/utils/Links.js"),Settings=require("modules/%ModuleName%/js/Settings.js"),CAccountModel=require("modules/%ModuleName%/js/models/CAccountModel.js"),CFetcherModel=require("modules/%ModuleName%/js/models/CFetcherModel.js"),CIdentityModel=require("modules/%ModuleName%/js/models/CIdentityModel.js");CAccountListModel.prototype.getAccountByHash=function(t){return _.find(this.collection(),function(e){return e.hash()===t},this)},CAccountListModel.prototype.changeCurrentAccountByHash=function(t){var e=this.getAccountByHash(t);e&&e.id()!==this.currentId()&&this.changeCurrentAccount(e.id(),!1)},CAccountListModel.prototype.changeCurrentAccount=function(t,e){var i=this.getCurrent(),n=this.getAccount(t);n&&this.currentId()!==t?(i&&i.isCurrent(!1),this.currentId(t),n.isCurrent(!0)):i||this.currentId(0),e&&Routing.setHash(LinksUtils.getMailbox())},CAccountListModel.prototype.changeEditedAccountByHash=function(t){var e=this.getAccountByHash(t);e&&e.id()!==this.editedId()&&this.changeEditedAccount(e.id())},CAccountListModel.prototype.changeEditedAccount=function(t){var e=this.getEdited(),i=this.getAccount(t);i&&this.editedId()!==t?(e&&e.isEdited(!1),this.editedId(t),i.isEdited(!0)):e||this.editedId(0)},CAccountListModel.prototype.getDefaultFriendlyName=function(){var t=this.getCurrent(),e=_.find(t&&t.identities()||[],function(t){return t.isDefault()})||t;return e?e.friendlyName()||e.email():""},CAccountListModel.prototype.getIdentityByHash=function(t){var e=null;return _.each(this.collection(),function(i){e||(e=_.find(i.identities()||[],function(e){return e.hash()===t}))},this),e},CAccountListModel.prototype.getFetcherByHash=function(t){var e=null;return _.each(this.collection(),function(i){e||(e=_.find(i.fetchers(),function(e){return e.hash()===t}))},this),e},CAccountListModel.prototype.parse=function(t){_.isArray(t)&&(this.collection(_.map(t,function(t){return new CAccountModel(t)})),this.initObservables(this.collection().length>0?this.collection()[0].id():0))},CAccountListModel.prototype.initObservables=function(t){var e=this.getAccount(t);e&&(e.isCurrent(!0),e.isEdited(!0)),this.currentId=ko.observable(t),this.editedId=ko.observable(t)},CAccountListModel.prototype.hasAccount=function(){return this.collection().length>0},CAccountListModel.prototype.getAccount=function(t){return _.find(this.collection(),function(e){return e.id()===t},this)},CAccountListModel.prototype.getDefault=function(){return _.find(this.collection(),function(t){return t.bDefault},this)},CAccountListModel.prototype.getCurrent=function(){return this.getAccount(this.currentId())},CAccountListModel.prototype.getEdited=function(){return this.getAccount(this.editedId())},CAccountListModel.prototype.getEmail=function(t){t=t||this.currentId();var e="",i=this.getAccount(t);return i&&(e=i.email()),e},CAccountListModel.prototype.addAccount=function(t){this.collection.push(t)},CAccountListModel.prototype.deleteAccount=function(t){this.collection.remove(function(e){return e.id()===t});var e=this.collection().length>0?this.collection()[0].id():0;this.changeCurrentAccount(e,!1),this.changeEditedAccount(e)},CAccountListModel.prototype.hasAccountWithId=function(t){return!!_.find(this.collection(),function(e){return e.id()===t},this)},CAccountListModel.prototype.populateFetchersIdentities=function(){this.populateFetchers(),this.populateIdentities()},CAccountListModel.prototype.populateFetchers=function(){Settings.AllowFetchers&&CoreAjax.send(Settings.FetchersServerModuleName,"GetFetchers",{AccountID:this.editedId()},this.onGetFetchersResponse,this)},CAccountListModel.prototype.onGetFetchersResponse=function(t,e){var i={};Types.isNonEmptyArray(t.Result)&&_.each(t.Result,function(t){var e=new CFetcherModel;e.parse(t),i[e.accountId()]||(i[e.accountId()]=[]),i[e.accountId()].push(e)}),_.each(this.collection(),function(t){var e=Types.isNonEmptyArray(i[t.id()])?i[t.id()]:[];t.fetchers(e)},this)},CAccountListModel.prototype.populateIdentities=function(t){Settings.AllowIdentities&&this.collection().length>=1&&Ajax.send("GetIdentities",null,function(e,i){this.onGetIdentitiesResponse(e,i),_.isFunction(t)&&t()},this)},CAccountListModel.prototype.onGetIdentitiesResponse=function(t,e){var i={};Types.isNonEmptyArray(t.Result)&&_.each(t.Result,function(t){var e=new CIdentityModel,n=-1;e.parse(t),n=e.accountId(),i[n]||(i[n]=[]),i[n].push(e)}),_.each(this.collection(),function(t){var e=i[t.id()],n=new CIdentityModel;Types.isNonEmptyArray(e)||(e=[]),n.parse({"@Object":"Object/Aurora\\Modules\\Mail\\Classes\\Identity",AccountPart:!0,Default:!_.find(e,function(t){return t.isDefault()}),Email:t.email(),FriendlyName:t.friendlyName(),IdAccount:t.id(),EntityId:1e5*t.id(),Signature:t.signature(),UseSignature:t.useSignature()}),e.unshift(n),t.identities(e)})},CAccountListModel.prototype.populateIdentitiesFromSourceAccount=function(t){t&&_.each(this.collection(),function(e){var i=t.getAccount(e.id());i&&(e.fetchers(i.fetchers()),e.identities(i.identities()),e.signature(i.signature()),e.useSignature(i.useSignature()))})},CAccountListModel.prototype.getAccountsEmails=function(){return _.uniq(_.map(this.collection(),function(t){return t.email()}))},CAccountListModel.prototype.getAllFullEmails=function(){var t=[];return _.each(this.collection(),function(e){e&&(Types.isNonEmptyArray(e.identities())?_.each(e.identities(),function(e){t.push(e.fullEmail())}):t.push(e.fullEmail()),_.each(e.fetchers(),function(e){e.isEnabled()&&e.isOutgoingEnabled()&&""!==e.fullEmail()&&t.push(e.fullEmail())}))}),t},CAccountListModel.prototype.getCurrentFetchersAndFiltersFolderNames=function(){var t=this.getCurrent(),e=[];return t&&(t.filters()&&_.each(t.filters().collection(),function(t){e.push(t.folder())},this),_.each(t.fetchers(),function(t){e.push(t.folder())},this)),e},CAccountListModel.prototype.getAttendee=function(t){var e=[],i="";return _.each(this.collection(),function(t){e=t.isCurrent()?_.union([t.email()],t.getFetchersIdentitiesEmails(),e):_.union(e,[t.email()],t.getFetchersIdentitiesEmails())}),e=_.uniq(e),_.each(e,_.bind(function(e){if(""===i){_.find(t,function(t){return t===e})===e&&(i=e)}},this)),i};var AccountList=new CAccountListModel;window.auroraAppData.Mail&&_.isArray(window.auroraAppData.Mail.Accounts)?AccountList.parse(window.auroraAppData.Mail.Accounts):AccountList.parse([]),MainTab&&AccountList.populateIdentitiesFromSourceAccount(MainTab.getAccountList()),module.exports=AccountList;