"use strict";function CCrea(e){this.oOptions=_.extend({creaId:"creaId",fontNameArray:["Tahoma"],defaultFontName:"Tahoma",defaultFontSize:3,alwaysTryUseImageWhilePasting:!0,dropableArea:null,isRtl:!1,onChange:function(){},onCursorMove:function(){},onFocus:function(){},onBlur:function(){},onUrlIn:function(){},onUrlOut:function(){},onImageSelect:function(){},onImageBlur:function(){},onItemOver:null,onItemOut:null,openInsertLinkDialog:function(){},onUrlClicked:!1},void 0===e?{}:e)}var _=require("underscore"),$=require("jquery"),Types=require("%PathToCoreWebclientModule%/js/utils/Types.js"),Browser=require("%PathToCoreWebclientModule%/js/Browser.js");CCrea.prototype.oOptions={},CCrea.prototype.$container=null,CCrea.prototype.$editableArea=null,CCrea.prototype.aEditableAreaHtml=[],CCrea.prototype.iUndoRedoPosition=0,CCrea.prototype.bEditable=!1,CCrea.prototype.bFocused=!1,CCrea.prototype.bEditing=!1,CCrea.prototype.aSizes=[{inNumber:1,inPixels:10},{inNumber:2,inPixels:13},{inNumber:3,inPixels:16},{inNumber:4,inPixels:18},{inNumber:5,inPixels:24},{inNumber:6,inPixels:32},{inNumber:7,inPixels:48}],CCrea.prototype.bInUrl=!1,CCrea.prototype.oCurrLink=null,CCrea.prototype.oCurrImage=null,CCrea.prototype.bInImage=!1,CCrea.prototype.sBasicFontName="",CCrea.prototype.sBasicFontSize="",CCrea.prototype.sBasicDirection="",CCrea.prototype.start=function(e){function t(e){return/^(ftp|http|https):\/\/(\w+:{0,1}\w*@)?(\S+)(:[0-9]+)?(\/|\/([\w#!:.?+=&%@!\-\/]))?$/.test(e)}function i(e){return!!e.match(/^[A-Z0-9\"!#\$%\^\{\}`~&'\+\-=_\.]+@[A-Z0-9\.\-]+$/i)}this.aRanges=null,this.$container=$("#"+this.oOptions.creaId),this.$editableArea=$("<div></div>").addClass("crea-content-editable").prop("contentEditable","true").appendTo(this.$container);var o=this;this.$editableArea.on("focus",function(){o.bFocused=!0}),this.$editableArea.on("blur",function(){o.bFocused=!1}),this.$editableArea.on("click","img",function(e){var t=$(this);o.bInImage=!0,o.oCurrImage=t,o.oOptions.onImageSelect(t,e),e.stopPropagation()}),this.$editableArea.on("click",function(e){o.bInImage=!1,o.oCurrImage=null,o.oOptions.onImageBlur()}),null!==o.oOptions.onItemOver&&this.$editableArea.on("mouseover",function(e){o.oOptions.onItemOver(e)}),null!==o.oOptions.onItemOver&&this.$editableArea.on("mouseout",function(e){o.oOptions.onItemOut(e)}),this.$editableArea.on("cut paste",function(){o.bEditing=!0,o.editableSave(),_.defer(function(){o.editableSave()})}),this.$editableArea.on("paste",function(e){if((e=e.originalEvent||e).clipboardData){var n,r=e.clipboardData.getData("text/plain"),a=e.clipboardData.getData("text/html");o.oOptions.alwaysTryUseImageWhilePasting&&o.pasteImage(e)?e.preventDefault():t(r)?(e.preventDefault(),o.execCom("insertHTML",'<a href="'+r+'">'+r+"</a>")):i(r)?(e.preventDefault(),o.execCom("insertHTML",'<a href="mailto:'+r+'">'+r+"</a>")):""!==a&&(e.preventDefault(),3===(n=a.split(/<!--StartFragment-->|<!--EndFragment-->/gi)).length&&(a=n[1]),a=o.replacePToBr(a),o.execCom("insertHTML",a))}}),this.$editableArea.on("keydown",function(e){var n=e.keyCode||e.which||e.charCode||0,r=e.ctrlKey||e.metaKey,a=e.altKey,s=e.shiftKey,l="";if(o.bEditing=!0,s&&r&&n===Enums.Key.z||r&&n===Enums.Key.y)e.preventDefault(),o.editableRedo();else if(r&&!a&&n===Enums.Key.z)e.preventDefault(),o.editableUndo();else if(!r||n!==Enums.Key.k&&n!==Enums.Key.b&&n!==Enums.Key.i&&n!==Enums.Key.u)a||s||r||n!==Enums.Key.Del&&n!==Enums.Key.Backspace||o.editableSave();else switch(e.preventDefault(),n){case Enums.Key.k:t(l=o.getSelectedText())?o.insertLink(l):i(l)?o.insertLink("mailto:"+l):o.oOptions.openInsertLinkDialog();break;case Enums.Key.b:o.bold();break;case Enums.Key.i:o.italic();break;case Enums.Key.u:o.underline()}}),this.$editableArea.on("keyup",function(e){var t=e.keyCode||e.which||e.charCode||0,i=e.ctrlKey||e.metaKey,n=e.altKey,r=e.shiftKey;n||r||i||(t===Enums.Key.Space||t===Enums.Key.Enter||t===Enums.Key.Del||t===Enums.Key.Backspace?o.editableSave():o.oOptions.onChange())}),this.initContentEditable(),this.setEditable(e)},CCrea.prototype.clearUndoRedo=function(){this.aEditableAreaHtml=[],this.iUndoRedoPosition=0,this.bEditing=!1},CCrea.prototype.isUndoAvailable=function(){return this.iUndoRedoPosition>0},CCrea.prototype.clearRedo=function(){this.aEditableAreaHtml=this.aEditableAreaHtml.slice(0,this.iUndoRedoPosition+1)},CCrea.prototype.editableSave=function(){var e=this.$editableArea.html(),t=_.last(this.aEditableAreaHtml);e!==(t?t[0]:"")&&(this.clearRedo(),this.aEditableAreaHtml.push([e,this.getCaretPos(this.$editableArea[0])]),this.iUndoRedoPosition=this.aEditableAreaHtml.length-1,this.oOptions.onChange())},CCrea.prototype.editableUndo=function(){var e=this.$editableArea.html(),t=this.aEditableAreaHtml[this.iUndoRedoPosition];e!==(t?t[0]:"")&&this.editableSave(),this.iUndoRedoPosition>0&&(this.iUndoRedoPosition--,this.$editableArea.html(this.aEditableAreaHtml[this.iUndoRedoPosition]),this.setCaretPos(this.$editableArea[0],this.aEditableAreaHtml[this.iUndoRedoPosition][1]))},CCrea.prototype.editableRedo=function(){this.iUndoRedoPosition<this.aEditableAreaHtml.length-1&&(this.iUndoRedoPosition++,this.$editableArea.html(this.aEditableAreaHtml[this.iUndoRedoPosition]),this.setCaretPos(this.$editableArea[0],this.aEditableAreaHtml[this.iUndoRedoPosition]?this.aEditableAreaHtml[this.iUndoRedoPosition][1]:{}))},CCrea.prototype.getCaretPos=function(e){var t=null,i={},o={},n=0,r={};return window.getSelection&&document.createRange?(t=window.getSelection()).rangeCount>0&&((o=(i=t.getRangeAt(0)).cloneRange()).selectNodeContents(e),o.setEnd(i.startContainer,i.startOffset),r={start:n=o.toString().length,end:n+i.toString().length}):document.selection&&document.body.createTextRange&&(i=document.selection.createRange(),(o=document.body.createTextRange()).moveToElementText(e),"function"==typeof o.setEndPoint&&o.setEndPoint("EndToStart",i),r={start:n=o.text.length,end:n+i.text.length}),r},CCrea.prototype.setCaretPos=function(e,t){if(window.getSelection&&document.createRange){var i=[e],o={},n={},r=!1,a=!1,s=0,l=0,c=0,d=document.createRange();for(d.setStart(e,0),d.collapse(!0),o=i.pop();!a&&o;){if(3===o.nodeType)l=s+o.length,!r&&t.start>=s&&t.start<=l&&(d.setStart(o,t.start-s),r=!0),r&&t.end>=s&&t.end<=l&&(d.setEnd(o,t.end-s),a=!0),s=l;else for(c=o.childNodes.length;c--;)i.push(o.childNodes[c]);o=i.pop()}(n=window.getSelection()).removeAllRanges(),n.addRange(d)}else if(document.selection&&document.body.createTextRange){var u=document.body.createTextRange();u.moveToElementText(e),u.collapse(!0),u.moveEnd("character",t.end),u.moveStart("character",t.start),u.select()}},CCrea.prototype.setTabIndex=function(e){e&&this.$editableArea.attr("tabindex",e)},CCrea.prototype.initContentEditable=function(){this.$editableArea.bind({mousemove:_.bind(this.storeSelectionPosition,this),mouseup:_.bind(this.onCursorMove,this),keydown:_.bind(this.onButtonPressed,this),keyup:_.bind(this.onCursorMove,this),click:_.bind(this.onClickWith,this),focus:this.oOptions.onFocus,blur:this.oOptions.onBlur}),window.File&&window.FileReader&&window.FileList&&this.oOptions.enableDrop&&this.$editableArea.bind({dragover:_.bind(this.onDragOver,this),dragleave:_.bind(this.onDragLeave,this),drop:_.bind(this.onFileSelect,this)});var e=this,t=_.debounce(function(){e.oCurrLink=null,e.bInUrl=!1,e.oOptions.onUrlOut()},300);$("html, body").on("scroll",t)},CCrea.prototype.onCursorMove=function(e){var t=-1;window.event?t=window.event.keyCode:e&&(t=e.which),13===t&&this.breakQuotes(e),17===t&&this.$editableArea.find("a").css("cursor","inherit"),8===t&&this.uniteWithNextQuote(e),46===t&&Browser.chrome&&this.uniteWithPrevQuote(e),this.storeSelectionPosition(),this.oOptions.onCursorMove()},CCrea.prototype.onClickWith=function(e){e.ctrlKey&&"A"===e.target.nodeName&&window.open(e.target.href,"_blank"),this.checkAnchorNode()},CCrea.prototype.onButtonPressed=function(e){var t=-1;window.event?t=window.event.keyCode:e&&(t=e.which),17===t&&this.$editableArea.find("a").css("cursor","pointer")},CCrea.prototype.onFileSelect=function(e){if(e=(e&&e.originalEvent?e.originalEvent:e)||window.event){e.stopPropagation(),e.preventDefault();var t=null,i=null,o=e.files||(e.dataTransfer?e.dataTransfer.files:null),n=this;o&&1===o.length&&this.checkIsImage(o[0])&&(i=o[0],(t=new window.FileReader).onload=function(e){n.insertImage(e.target.result)},t.readAsDataURL(i))}},CCrea.prototype.onDragLeave=function(){this.$editableArea.removeClass("editorDragOver")},CCrea.prototype.onDragOver=function(e){e.stopPropagation(),e.preventDefault(),this.$editableArea.addClass("editorDragOver")},CCrea.prototype.pasteImage=function(e){var t=e.clipboardData&&e.clipboardData.items,i=this,o=!1;return window.File&&window.FileReader&&window.FileList&&t&&_.each(t,function(e){if(i.checkIsImage(e)&&e.getAsFile){var t=null,n=e.getAsFile();n&&((t=new window.FileReader).onload=function(e){i.insertImage(e.target.result)},t.readAsDataURL(n),o=!0)}}),o},CCrea.prototype.checkIsImage=function(e){return e&&e.type&&0===e.type.indexOf("image/")},CCrea.prototype.setPlainText=function(e){"string"!=typeof e&&(e=""),this.$editableArea&&(this.editableSave(),this.$editableArea.empty().text(e).css("white-space","pre"),this.editableSave())},CCrea.prototype.setText=function(e){if("string"!=typeof e&&(e=""),this.$editableArea){0===e.length&&(e="<br />");var t=$(e),i=$(e),o=i.children(),n=o.first(),r=1===i.length&&"font-wrapper"===i.data("crea"),a=1===i.length&&1===o.length&&"body"===i.data("xDivType")&&"font-wrapper"===n.data("crea");r?(this.setBasicStyles(i.css("font-family"),i.css("font-size"),i.css("direction")),t=i.contents()):a?(this.setBasicStyles(n.css("font-family"),n.css("font-size"),n.css("direction")),t=n.contents()):this.setBasicStyles(this.oOptions.defaultFontName,this.convertFontSizeToPixels(this.oOptions.defaultFontSize),this.oOptions.isRtl?"rtl":"ltr"),this.$editableArea.empty().append(t).css("white-space","normal"),this.clearUndoRedo(),this.editableSave()}},CCrea.prototype.setBasicStyles=function(e,t,i){this.sBasicFontName=e,this.sBasicFontSize=t,this.sBasicDirection=i,this.$editableArea.css({"font-family":this.getFontNameWithFamily(this.sBasicFontName),"font-size":this.sBasicFontSize,direction:this.sBasicDirection})},CCrea.prototype.replacePToBr=function(e){return e.replace(/<\/p>/gi,"<br />").replace(/<p [^>]*>/gi,"").replace(/<p>/gi,"")},CCrea.prototype.getPlainText=function(){var e="";return this.$editableArea&&(e=this.$editableArea.html().replace(/([^>]{1})<div>/gi,"$1\n").replace(/<style[^>]*>[^<]*<\/style>/gi,"\n").replace(/<br *\/{0,1}>/gi,"\n").replace(/<\/p>/gi,"\n").replace(/<\/div>/gi,"\n").replace(/<a [^>]*href="([^"]*?)"[^>]*>(.*?)<\/a>/gi,"$2 ($1)").replace(/<[^>]*>/g,"").replace(/&nbsp;/g," ").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&amp;/g,"&").replace(/&quot;/g,'"')),e},CCrea.prototype.getText=function(e){var t="";return this.$editableArea&&this.$editableArea.length>0&&(e&&this.$editableArea.find('div[data-anchor="signature"]').removeAttr("data-anchor"),t=this.$editableArea.html(),t=this.replacePToBr(t),t='<div data-crea="font-wrapper" style="font-family: '+this.getFontNameWithFamily(this.sBasicFontName)+"; font-size: "+this.sBasicFontSize+"; direction: "+this.sBasicDirection+'">'+t+"</div>"),t},CCrea.prototype.changeSignatureContent=function(e,t){var i,o,n,r,a,s,l,c=this.$editableArea.find('div[data-anchor="signature"]'),d=$(e).closest('div[data-crea="font-wrapper"]'),u=$(t).closest('div[data-crea="font-wrapper"]');if(c.length>0)n=c.html(),""===t?c.html(n+e):-1!==n.indexOf(t)?c.html(n.replace(t,e)):-1!==n.indexOf(e)||(i=0===d.length||0===u.length?t:u.html(),o=0===d.length||0===u.length?e:d.html(),-1!==n.indexOf(i)?c.html(n.replace(i,e)):-1!==n.indexOf(o)||c.html(n+e));else{s=t;try{r=this.$editableArea.find('*:contains("'+s+'")')}catch(e){r=$("")}if(0===r.length&&u.length>0){s=u.html();try{r=this.$editableArea.find('*:contains("'+s+'")')}catch(e){r=$("")}}r.length>0&&(a=(r=$(r[0])).closest("blockquote")),a&&0===a.length?r.html(r.html().replace(s,e)):(l=(c=this.$editableArea.find('div[data-anchor="reply-title"]')).length>0?$(c[0]).closest("blockquote"):c,(0===c.length||l.length>0)&&(c=this.$editableArea.find("blockquote")),c.length>0?$(c[0]).before($('<br /><div data-anchor="signature">'+e+"</div><br />")):this.$editableArea.append($('<br /><div data-anchor="signature">'+e+"</div><br />")))}this.editableSave()},CCrea.prototype.isFocused=function(){return this.bFocused},CCrea.prototype.setFocus=function(e){var t=this.$editableArea.contents(),i=null,o="";this.$editableArea.focus(),e&&_.isArray(this.aRanges)&&this.aRanges.length>0?this.restoreSelectionPosition():t.length>0&&(3===t[0].nodeType?i=$(t[0]):(i=$(document.createTextNode("")),$(t[0]).before(i)),o=i.text(),this.setCursorPosition(i[0],o.length))},CCrea.prototype.setBlur=function(){this.$editableArea.blur()},CCrea.prototype.setEditable=function(e){e?this.enableContentEditable():this.disableContentEditable()},CCrea.prototype.disableContentEditable=function(){this.bEditable=!1,this.$editableArea.prop("contentEditable","false")},CCrea.prototype.enableContentEditable=function(){this.$editableArea.prop("contentEditable","true"),setTimeout(_.bind(function(){this.bEditable=!0},this),0)},CCrea.prototype.fixFirefoxCursorBug=function(){Browser.firefox&&(this.disableContentEditable(),setTimeout(_.bind(function(){this.enableContentEditable()},this),0))},CCrea.prototype.setRtlDirection=function(){this.setBasicStyles(this.sBasicFontName,this.sBasicFontSize,"rtl")},CCrea.prototype.setLtrDirection=function(){this.setBasicStyles(this.sBasicFontName,this.sBasicFontSize,"ltr")},CCrea.prototype.pasteHtmlAtCaret=function(e){var t,i;if(window.getSelection){if((t=window.getSelection()).getRangeAt&&t.rangeCount){(i=t.getRangeAt(0)).deleteContents();var o=document.createElement("div");o.innerHTML=e;for(var n,r,a=document.createDocumentFragment();n=o.firstChild;)r=a.appendChild(n);i.insertNode(a),r&&((i=i.cloneRange()).setStartAfter(r),i.collapse(!0),t.removeAllRanges(),t.addRange(i))}}else document.selection&&"Control"!==document.selection.type&&(i=document.selection.createRange())&&i.pasteHTML&&i.pasteHTML(e)},CCrea.prototype.execCom=function(e,t,i){var o,n=!1;return this.bEditable&&(this.editableSave(),Browser.opera&&this.restoreSelectionPosition(),"insertHTML"===e&&Browser.ie?this.pasteHtmlAtCaret(t):n=void 0===t?window.document.execCommand(e):window.document.execCommand(e,!1,t),Browser.chrome&&(this.storeSelectionPosition(),"insertHTML"===e&&this.aRanges.length>0&&((o=this.aRanges[0]).setEnd(o.startContainer,o.startOffset),this.restoreSelectionPosition())),i||this.editableSave()),n},CCrea.prototype.insertHtml=function(e,t){this.execCom("insertHTML",e,t)},CCrea.prototype.changeImageSource=function(e,t){this.$editableArea.find('img[id="'+e+'"]').attr("src",t),this.editableSave()},CCrea.prototype.insertEmailLink=function(e){this.restoreSelectionPosition(),""===this.getSelectedText()?this.execCom("insertHTML",'<a href="mailto:'+e+'">'+e+"</a>"):this.insertLink("mailto:"+e)},CCrea.prototype.insertLink=function(e){if(e=this.normaliseURL(e),this.restoreSelectionPosition(e),""===this.getSelectedText()&&Browser.ie)this.execCom("insertHTML",'<a href="'+e+'">'+e+"</a>");else{var t=Browser.ie8AndBelow?"CreateLink":"createlink";this.execCom(t,e)}this.changeFocusLink(e)},CCrea.prototype.removeLink=function(){var e=Browser.ie8AndBelow?"Unlink":"unlink";this.execCom(e)},CCrea.prototype.insertImage=function(e){var t=Browser.ie8AndBelow?"InsertImage":"insertimage";return this.isFocused()?this.restoreSelectionPosition():this.setFocus(!0),this.execCom(t,e)},CCrea.prototype.numbering=function(){this.execCom("InsertOrderedList")},CCrea.prototype.bullets=function(){this.execCom("InsertUnorderedList")},CCrea.prototype.horizontalLine=function(){this.execCom("InsertHorizontalRule")},CCrea.prototype.getFontNameWithFamily=function(e){var t="";switch(e){case"Arial":case"Arial Black":case"Tahoma":case"Verdana":t=", sans-serif";break;case"Courier New":t=", monospace";break;case"Times New Roman":t=", serif"}return e+t},CCrea.prototype.fontName=function(e){var t=!this.aRanges;this.setFocus(!0),this.execCom("FontName",this.getFontNameWithFamily(e)),t&&this.setBasicStyles(e,this.sBasicFontSize,this.sBasicDirection)},CCrea.prototype.fontSize=function(e){var t=!this.aRanges;this.setFocus(!0),this.execCom("FontSize",e),t&&this.setBasicStyles(this.sBasicFontName,this.convertFontSizeToPixels(e),this.sBasicDirection)},CCrea.prototype.bold=function(){this.execCom("Bold"),this.$editableArea.focus()},CCrea.prototype.italic=function(){this.execCom("Italic"),this.$editableArea.focus()},CCrea.prototype.underline=function(){this.execCom("Underline"),this.$editableArea.focus()},CCrea.prototype.strikeThrough=function(){this.execCom("StrikeThrough"),this.$editableArea.focus()},CCrea.prototype.undo=function(){this.editableUndo()},CCrea.prototype.redo=function(){this.editableRedo()},CCrea.prototype.alignLeft=function(){this.execCom("JustifyLeft")},CCrea.prototype.center=function(){this.execCom("JustifyCenter")},CCrea.prototype.alignRight=function(){this.execCom("JustifyRight")},CCrea.prototype.justify=function(){this.execCom("JustifyFull")},CCrea.prototype.textColor=function(e){this.execCom("ForeColor",e),this.$editableArea.focus()},CCrea.prototype.backgroundColor=function(e){var t=Browser.ie?"BackColor":"hilitecolor";this.execCom(t,e),this.$editableArea.focus()},CCrea.prototype.removeFormat=function(){this.execCom("removeformat"),this.$editableArea.focus()},CCrea.prototype.getFontName=function(){if(this.bEditable){var e=window.document.queryCommandValue("FontName"),t=this.sBasicFontName,i="";"string"==typeof e&&(e=e.replace(/'/g,""),$.each(this.oOptions.fontNameArray,function(t,o){(e.indexOf(o)>-1||e.indexOf(o.toLowerCase())>-1)&&(i=o)}),""!==i&&(t=i))}return t},CCrea.prototype.getIsBold=function(){if(this.bEditable)var e=window.document.queryCommandState("bold");return e},CCrea.prototype.getIsItalic=function(){if(this.bEditable)var e=window.document.queryCommandState("italic");return e},CCrea.prototype.getIsUnderline=function(){if(this.bEditable)var e=window.document.queryCommandState("underline");return e},CCrea.prototype.getIsEnumeration=function(){if(this.bEditable)var e=window.document.queryCommandState("insertOrderedList");return e},CCrea.prototype.getIsBullets=function(){if(this.bEditable)var e=window.document.queryCommandState("insertUnorderedList");return e},CCrea.prototype.getIsStrikeThrough=function(){if(this.bEditable)var e=window.document.queryCommandState("StrikeThrough");return e},CCrea.prototype.convertFontSizeToPixels=function(e){var t=0;return $.each(this.aSizes,function(i,o){0===t&&e<=o.inNumber&&(t=o.inPixels)}),t+"px"},CCrea.prototype.convertFontSizeToNumber=function(e){var t=Types.pInt(e),i=0;return t>0&&$.each(this.aSizes,function(e,o){0===i&&t<=o.inPixels&&(i=o.inNumber)}),i},CCrea.prototype.getFontSizeInNumber=function(){var e="",t=0;return this.bEditable&&(e=window.document.queryCommandValue("FontSize"),t=Types.pInt(e)),(isNaN(t)||t<=0)&&(t=this.convertFontSizeToNumber(this.sBasicFontSize)),t},CCrea.prototype.changeLink=function(e){var t=this.normaliseURL(e),i=$(this.oCurrLink);this.oCurrLink&&(i.attr("href")===i.text()&&i.text(t),"A"===this.oCurrLink.tagName?i.attr("href",t):i.parent().attr("href",t),this.oCurrLink=null,this.bInUrl=!1)},CCrea.prototype.removeCurrentLink=function(){if(this.oCurrLink&&document.createRange&&window.getSelection){var e=document.createRange(),t=window.getSelection();e.selectNodeContents(this.oCurrLink),t.removeAllRanges(),t.addRange(e),this.removeLink(),this.oCurrLink=null,this.bInUrl=!1,this.oOptions.onUrlOut()}},CCrea.prototype.changeFocusLink=function(e){var t=null,i=null;Browser.firefox&&window.getSelection&&(i=(t=window.getSelection()).focusNode?t.focusNode.parentElement:null)&&"A"===i.tagName&&$(i).attr("href",e)},CCrea.prototype.removeCurrentImage=function(){this.oCurrImage&&(this.oCurrImage.remove(),this.oCurrImage=null,this.bInImage=!1,this.oOptions.onImageBlur()),this.setFocus(!0)},CCrea.prototype.changeCurrentImage=function(e){if(this.oCurrImage&&void 0!==e){var t=this.oCurrImage;$.each(e,function(e,i){t.css(e,i)})}this.setFocus(!0)},CCrea.prototype.showImageTooltip=function(e){if(this.oCurrImage&&void 0!==e){var t=this.oCurrImage;$.each(e,function(e,i){t.css(e,i)})}},CCrea.prototype.normaliseURL=function(e){return-1!==e.search(/^https?:\/\/|^mailto:|^tel:/g)?e:"http://"+e},CCrea.prototype.getSelectedText=function(){var e="",t=null;return window.getSelection&&(t=window.getSelection()).rangeCount>0&&(e=t.getRangeAt(0).toString()),e},CCrea.prototype.storeSelectionPosition=function(){var e=this.getSelectionRanges();_.isArray(e)&&e.length>0&&(this.aRanges=e)},CCrea.prototype.editableIsActive=function(){return!(!$(document.activeElement).hasClass("crea-content-editable")&&!$(document.activeElement).children().first().hasClass("crea-content-editable"))},CCrea.prototype.getSelectionRanges=function(){var e=[];if(window.getSelection&&this.editableIsActive())for(var t=window.getSelection(),i=null,o=0,n=t.rangeCount;o<n;o++)i=t.getRangeAt(o),e.push(i);return e},CCrea.prototype.checkAnchorNode=function(){if(window.getSelection&&this.editableIsActive()){var e=window.getSelection(),t=null;e.anchorNode&&(e.anchorNode.parentElement||e.anchorNode.parentNode)&&("A"===(t=e.anchorNode.parentElement||e.anchorNode.parentNode).tagName||"A"===t.parentNode.tagName||"A"===t.parentElement.tagName?this.bInUrl&&t===this.oCurrLink?this.bInUrl&&t===this.oCurrLink&&(this.oCurrLink=null,this.bInUrl=!1,this.oOptions.onUrlOut()):(this.oCurrLink=t,this.bInUrl=!0,this.oOptions.onUrlIn($(t))):this.bInUrl&&(this.oCurrLink=null,this.bInUrl=!1,this.oOptions.onUrlOut()))}},CCrea.prototype.restoreSelectionPosition=function(e){var t="",i=null,o=null,n=null;t=this.setSelectionRanges(this.aRanges),window.getSelection&&_.isArray(this.aRanges)&&(e=void 0!==e?e:"",Browser.firefox&&""===t&&""!==e&&(window.getSelection&&window.getSelection().getRangeAt?(i=window.getSelection()).getRangeAt&&i.rangeCount>0&&(n=(o=i.getRangeAt(0)).createContextualFragment(e),o.insertNode(n)):document.selection&&document.selection.createRange&&document.selection.createRange().pasteHTML(e)))},CCrea.prototype.setSelectionRanges=function(e){var t=null,i=null,o=0,n=0,r="";if(window.getSelection&&_.isArray(e))for(n=e.length,t=window.getSelection(),Browser.ie10AndAbove||t.removeAllRanges();o<n;o++)(i=e[o])&&(t.addRange(i),r+=""+i);return r},CCrea.prototype.uniteWithNextQuote=function(){var e=window.getSelection?window.getSelection():null,t=e?e.focusNode:null,i=t?this.getLastBlockQuote(t):null,o=i?$(i).next():null,n=o&&o.length>0&&"BLOCKQUOTE"===o[0].tagName?o[0]:null,r=[],a=0,s=0,l=null;if(i&&n){for($("<br />").appendTo(i),s=(r=$(n).contents()).length,a=0;a<s;a++)l=r[a],$(l).appendTo(i);$(n).remove()}},CCrea.prototype.uniteWithPrevQuote=function(){var e=window.getSelection?window.getSelection():null,t=e?e.focusNode:null,i=t?this.getLastBlockQuote(t):null;this.getPrevAndUnite(i),this.getPrevAndUnite(i)},CCrea.prototype.getPrevAndUnite=function(e){var t=e?$(e).prev():null,i=t&&t.length>0&&"BLOCKQUOTE"===t[0].tagName?t[0]:null,o=[],n=0,r=null;if(e&&i){for($("<br />").prependTo(e),n=(o=$(i).contents()).length-1;n>0;n--)r=o[n],$(r).prependTo(e);$(i).remove()}},CCrea.prototype.getLastBlockQuote=function(e){for(var t=e,i=null;t&&t.parentNode;)"BLOCKQUOTE"===t.tagName&&(i=t),t=t.parentNode;return i},CCrea.prototype.breakQuotes=function(e){var t=window.getSelection?window.getSelection():null,i=t?t.focusNode:null,o=i?this.getLastBlockQuote(i):null;i&&o&&this.breakBlocks(i,o,t.focusOffset)},CCrea.prototype.setCursorPosition=function(e,t){if(document.createRange&&window.getSelection){var i=document.createRange(),o=window.getSelection();o.removeAllRanges(),i.setStart(e,t),i.setEnd(e,t),i.collapse(!0),o.addRange(i),this.aRanges=[i]}},CCrea.prototype.cloneNode=function(e){var t=null,i="";try{t=$(e).clone()}catch(o){i=e.tagName,t=$("<"+i+"></"+i+">")}return t},CCrea.prototype.breakBlocks=function(e,t,i){for(var o=e,n=null,r=[],a=0,s=0,l=null,c=!0,d=null,u=null,h=null,p=null,C=!0,m=null;C&&o.parentNode;){for(h=d,p=u,d=this.cloneNode(o).empty(),u=this.cloneNode(o).empty(),s=(r=$(o).contents()).length,c=!0,null===n&&(n=r[i]),0===s&&(d=null),a=0;a<s;a++)(l=r[a])===n?(null===h?a===i&&"BR"===l.tagName||$(l).appendTo(u):(h.html().length>0&&h.appendTo(d),p.appendTo(u)),c=!1):c?$(l).appendTo(d):$(l).appendTo(u);t===o&&(C=!1),n=o,o=o.parentNode}null!==d&&null!==u&&(d.insertBefore($(t)),m=$("<span>&nbsp;</span>").insertBefore($(t)),$("<br>").insertBefore($(t)),u.insertBefore($(t)),$(t).remove(),this.setCursorPosition(m[0],0))},module.exports=CCrea;