"use strict";function CMailCache(){this.currentAccountId=AccountList.currentId,this.currentAccountId.subscribe(function(e){var s=AccountList.getAccount(e),t=this.oFolderListItems[e];s?(s.quotaRecieved(!1),this.messagesLoadingError(!1),t?this.folderList(t):(this.messagesLoading(!0),this.folderList(new CFolderListModel),this.messages([]),this.currentMessage(null),this.getFolderList(e))):this.folderList(new CFolderListModel)},this),this.editedAccountId=AccountList.editedId,this.editedAccountId.subscribe(function(e){var s=this.oFolderListItems[e];s?this.editedFolderList(s):(this.editedFolderList(new CFolderListModel),this.currentAccountId()!==e&&this.getFolderList(e))},this),this.oFolderListItems={},this.quotaChangeTrigger=ko.observable(!1),this.checkMailStarted=ko.observable(!1),this.checkMailStartedAccountId=ko.observable(0),this.folderList=ko.observable(new CFolderListModel),this.folderListLoading=ko.observableArray([]),this.editedFolderList=ko.observable(new CFolderListModel),this.newMessagesCount=ko.computed(function(){var e=this.folderList().inboxFolder();return e?e.unseenMessageCount():0},this),this.messages=ko.observableArray([]),this.messages.subscribe(function(){this.messages().length>0&&this.messagesLoadingError(!1)},this),this.uidList=ko.observable(new CUidListModel),this.page=ko.observable(1),this.messagesLoading=ko.observable(!1),this.messagesLoadingError=ko.observable(!1),this.currentMessage=ko.observable(null),this.nextMessageUid=ko.observable(""),this.prevMessageUid=ko.observable(""),this.savingDraftUid=ko.observable(""),this.editedDraftUid=ko.observable(""),this.disableComposeAutosave=ko.observable(!1),this.aResponseHandlers=[],this.iAutoCheckMailTimer=-1,this.waitForUnseenMessages=ko.observable(!0),this.iSetMessagesSeenCount=0,App.subscribeEvent("ReceiveAjaxResponse::after",_.bind(function(e){!this.checkMailStarted()&&"Ping"===e.Response.Method&&"Core"===e.Response.Module&&e.Response.Result&&this.executeCheckMail()},this))}var _=require("underscore"),$=require("jquery"),ko=require("knockout"),moment=require("moment"),TextUtils=require("%PathToCoreWebclientModule%/js/utils/Text.js"),Types=require("%PathToCoreWebclientModule%/js/utils/Types.js"),Utils=require("%PathToCoreWebclientModule%/js/utils/Common.js"),Api=require("%PathToCoreWebclientModule%/js/Api.js"),App=require("%PathToCoreWebclientModule%/js/App.js"),Pulse=require("%PathToCoreWebclientModule%/js/Pulse.js"),Routing=require("%PathToCoreWebclientModule%/js/Routing.js"),UserSettings=require("%PathToCoreWebclientModule%/js/Settings.js"),WindowOpener=require("%PathToCoreWebclientModule%/js/WindowOpener.js"),Popups=require("%PathToCoreWebclientModule%/js/Popups.js"),ConfirmPopup=require("%PathToCoreWebclientModule%/js/popups/ConfirmPopup.js"),LinksUtils=require("modules/%ModuleName%/js/utils/Links.js"),AccountList=require("modules/%ModuleName%/js/AccountList.js"),Ajax=require("modules/%ModuleName%/js/Ajax.js"),MessagesDictionary=require("modules/%ModuleName%/js/MessagesDictionary.js"),Prefetcher=null,Settings=require("modules/%ModuleName%/js/Settings.js"),CFolderListModel=require("modules/%ModuleName%/js/models/CFolderListModel.js"),CUidListModel=require("modules/%ModuleName%/js/models/CUidListModel.js"),MainTab=App.isNewTab()&&window.opener&&window.opener.MainTabMailMethods;CMailCache.prototype.requirePrefetcher=function(){Prefetcher=require("modules/%ModuleName%/js/Prefetcher.js")},CMailCache.prototype.init=function(){if(Ajax.registerOnAllRequestsClosedHandler(function(){_.delay(function(){Ajax.hasOpenedRequests()||(MailCache.checkMailStarted(!1),MailCache.folderListLoading.removeAll())},10),Ajax.hasOpenedRequests()||MailCache.savingDraftUid("")}),MainTab){if(this.oFolderListItems=MainTab.getFolderListItems(),this.uidList(MainTab.getUidList()),window.name){var e=Types.pInt(window.name);0===e&&(e=MainTab.getComposedMessageAccountId(window.name)),0!==e&&this.currentAccountId(e)}this.currentAccountId.valueHasMutated(),this.initPrevNextSubscribes()}else this.currentAccountId.valueHasMutated(),this.initPrevNextSubscribes()},CMailCache.prototype.initPrevNextSubscribes=function(){this.bInThreadLevel=!1,this.currentMessage.subscribe(this.calcNextMessageUid,this),this.uidList.subscribe(this.calcNextMessageUid,this),this.currentMessage.subscribe(this.calcPrevMessageUid,this),this.uidList.subscribe(this.calcPrevMessageUid,this)},CMailCache.prototype.calcNextMessageUid=function(){var e="",s="",t=null,i=null,r=!1;this.currentMessage()&&(r=this.currentMessage().threadPart()&&""!==this.currentMessage().threadParentUid(),t=this.folderList().getFolderByFullName(this.currentMessage().folder()),e=this.currentMessage().uid(),this.bInThreadLevel||r?(this.bInThreadLevel=!!MainTab,r&&(i=t.getMessageByUid(this.currentMessage().threadParentUid()))&&(_.each(i.threadUids(),function(t,i,r){t===e&&i>0&&(s=r[i-1])}),Types.isNonEmptyString(s)||(s=i.uid()))):(_.each(this.uidList().collection(),function(t,i,r){t===e&&i>0&&(s=r[i-1]||"")}),""===s&&MainTab&&(this.requirePrefetcher(),Prefetcher.prefetchNextPage(e)))),this.nextMessageUid(s)},CMailCache.prototype.calcPrevMessageUid=function(){var e=this.currentMessage()?this.currentMessage().uid():"",s="",t=null,i=null,r=!1;this.currentMessage()&&(r=this.currentMessage().threadPart()&&""!==this.currentMessage().threadParentUid(),t=this.folderList().getFolderByFullName(this.currentMessage().folder()),e=this.currentMessage().uid(),this.bInThreadLevel||r?(this.bInThreadLevel=!0,r?(i=t.getMessageByUid(this.currentMessage().threadParentUid()))&&_.each(i.threadUids(),function(t,i,r){t===e&&i+1<r.length&&(s=r[i+1]||"")}):this.currentMessage().threadCount()>0&&(s=this.currentMessage().threadUids()[0])):(_.each(this.uidList().collection(),function(t,i,r){t===e&&i+1<r.length&&(s=r[i+1]||"")}),""===s&&MainTab&&(this.requirePrefetcher(),Prefetcher.prefetchPrevPage(e)))),this.prevMessageUid(s)},CMailCache.prototype.getCurrentFolder=function(){return this.folderList().currentFolder()},CMailCache.prototype.getFolderByFullName=function(e,s){var t=this.oFolderListItems[e];return t?t.getFolderByFullName(s):null},CMailCache.prototype.checkCurrentFolderList=function(){var e=AccountList.getCurrent(),s=e?this.oFolderListItems[e.id()]:null;!e||s||this.messagesLoading()||(this.messagesLoading(!0),this.messagesLoadingError(!1),this.getFolderList(e.id()))},CMailCache.prototype.getFolderList=function(e){AccountList.getAccount(e)?(this.folderListLoading.push(e),Ajax.send("GetFolders",{AccountID:e},this.onGetFoldersResponse,this)):e===this.currentAccountId()&&this.messagesLoading(!1)},CMailCache.prototype.markMessageReplied=function(e,s,t,i){var r=this.oFolderListItems[e],o=null;r&&(o=r.getFolderByFullName(s))&&o.markMessageReplied(t,i)},CMailCache.prototype.hideThreads=function(e){var s=AccountList.getCurrent();s&&s.threadingIsAvailable()&&e.folder()===this.folderList().currentFolderFullName()&&!e.threadOpened()&&this.folderList().currentFolder().hideThreadMessages(e)},CMailCache.prototype.showOpenedThreads=function(e){this.messages(this.getMessagesWithThreads(e,this.uidList(),this.messages()))},CMailCache.prototype.useThreadingInCurrentList=function(e){e=e||this.uidList();var s=AccountList.getCurrent(),t=this.folderList().currentFolder(),i=t&&t.withoutThreads(),r=""===e.search()&&""===e.filters();return s&&s.threadingIsAvailable()&&!i&&r},CMailCache.prototype.getMessagesWithThreads=function(e,s,t){var i=[],r=[],o=this.folderList().currentFolder();return o&&e===o.fullName()&&this.useThreadingInCurrentList(s)?(r=_.filter(t,function(e){return!e.threadPart()}),_.each(r,function(e){var s=[];i.push(e),e.threadCount()>0&&(e.threadOpened()&&(s=this.folderList().currentFolder().getThreadMessages(e),i=_.union(i,s)),o.computeThreadData(e))},this),i):t},CMailCache.prototype.setMessagesFromUidList=function(e,s,t){var i=e.getUidsForOffset(s),r=_.map(i,function(s){return MessagesDictionary.get([e.iAccountId,e.sFullName,s])},this),o=r.length;return t&&(this.messages(this.getMessagesWithThreads(this.folderList().currentFolderFullName(),e,r)),s+o<e.resultCount()&&o<Settings.MailsPerPage&&(e.filters()!==Enums.FolderFilter.Unseen||this.waitForUnseenMessages())&&this.messagesLoading(!0),this.currentMessage()&&(this.currentMessage().deleted()||this.currentMessage().folder()!==this.folderList().currentFolderFullName())&&this.currentMessage(null)),i},CMailCache.prototype.getNamesOfFoldersToRefresh=function(){var e=this.oFolderListItems[this.currentAccountId()],s=e?e.getNamesOfFoldersToRefresh():[],t=AccountList.getCurrentFetchersAndFiltersFolderNames();return s=_.uniq(_.compact(_.union(s,t)))},CMailCache.prototype.getUseListStatusIfPossibleValue=function(e){var s=this.oFolderListItems[this.currentAccountId()];return(s?s.getFoldersCount():0)<100||e>50},CMailCache.prototype.executeCheckMail=function(e){clearTimeout(this.iAutoCheckMailTimer);var s=this.currentAccountId(),t=this.getNamesOfFoldersToRefresh(),i=this.checkMailStarted()&&this.checkMailStartedAccountId()===s,r=null;App.getUserRole()!==Enums.UserRole.Anonymous&&(e||!Ajax.hasOpenedRequests("GetRelevantFoldersInformation")||!i)&&t.length>0&&(r={AccountID:s,Folders:t,UseListStatusIfPossible:this.getUseListStatusIfPossibleValue(t.length)},this.checkMailStarted(!0),this.checkMailStartedAccountId(s),AccountList.getAccount(s)&&Ajax.send("GetRelevantFoldersInformation",r,this.onGetRelevantFoldersInformationResponse,this))},CMailCache.prototype.setAutocheckmailTimer=function(){clearTimeout(this.iAutoCheckMailTimer),!App.isNewTab()&&UserSettings.AutoRefreshIntervalMinutes>0&&(this.iAutoCheckMailTimer=setTimeout(function(){MailCache.isSearchExecuting()||(MailCache.checkMessageFlags(),MailCache.executeCheckMail(!1))},60*UserSettings.AutoRefreshIntervalMinutes*1e3))},CMailCache.prototype.isSearchExecuting=function(){var e=Ajax.getOpenedRequest("GetMessages"),s=e&&e.Parameters;return s&&""!==s.Search},CMailCache.prototype.checkMessageFlags=function(){var e=this.folderList().inboxFolder(),s=e?e.getFlaggedMessageUids():[],t={Folder:this.folderList().inboxFolderFullName(),Uids:s};s.length>0&&Ajax.send("GetMessagesFlags",t,this.onGetMessagesFlagsResponse,this)},CMailCache.prototype.onGetMessagesFlagsResponse=function(e,s){var t=s.Parameters,i=this.oFolderListItems[t.AccountID],r=i?i.inboxFolder():null;r&&(e.Result&&_.each(e.Result,function(e,s){-1===_.indexOf(e,"\\flagged")&&r.setMessageUnflaggedByUid(s)}),r.removeFlaggedMessageListsFromCache(),this.requirePrefetcher(),Prefetcher.prefetchStarredMessageList())},CMailCache.prototype.changeCurrentMessageList=function(e,s,t,i,r,o){this.requestCurrentMessageList(e,s,t,i,r,o,!0)},CMailCache.prototype.requestCurrentMessageList=function(e,s,t,i,r,o,a){var n=this.requestMessageList(e,s,t,i||"",r,o,!0,a||!1),l=60*UserSettings.AutoRefreshIntervalMinutes*1e3,u=n.Folder.oRelevantInformationLastMoment?moment().diff(n.Folder.oRelevantInformationLastMoment):l+1;this.uidList(n.UidList),this.page(s),this.messagesLoading(n.RequestStarted),this.messagesLoadingError(!1),!n.RequestStarted&&l>0&&u>l&&this.executeCheckMail(!0)},CMailCache.prototype.requestMessageList=function(e,s,t,i,r,o,a,n,l){l=Types.pBool(l,!1);var u=this.oFolderListItems[this.currentAccountId()],d=u?u.getFolderByFullName(e):null,h=d&&d.withoutThreads(),c=AccountList.getCurrent(),g=c&&c.threadingIsAvailable()&&!h&&""===t&&""===i,M=d?d.getUidList(t,i,r,o):null,p=M&&-1===M.resultCount(),f=(s-1)*Settings.MailsPerPage,m={Folder:e,Offset:f,Limit:Settings.MailsPerPage,Search:t,Filters:i,SortBy:r,SortOrder:o,UseThreading:g},C=!1,F=!1,L=a?this.onCurrentGetMessagesResponse:this.onGetMessagesResponse,y=[];return d.type()===Enums.FolderTypes.Inbox&&""===i?m.InboxUidnext=d.sUidNext:m.InboxUidnext="",p&&M.iAccountId===this.uidList().iAccountId&&M.sFullName===this.uidList().sFullName&&M.search()===this.uidList().search()&&M.filters()===this.uidList().filters()&&M.sortBy()===this.uidList().sortBy()&&M.sortOrder()===this.uidList().sortOrder()&&(M=this.uidList()),M&&(y=this.setMessagesFromUidList(M,f,n),d.updateLastAccessTime(y)),M&&(F=p||f+y.length<M.resultCount()&&y.length<Settings.MailsPerPage,C=!l&&(d.hasChanges()||F)),C?Ajax.send("GetMessages",m,L,this):this.waitForUnseenMessages(!1),{UidList:M,RequestStarted:C,DataExpected:F,Folder:d}},CMailCache.prototype.executeEmptyTrash=function(){var e=this.folderList().trashFolder();e&&e.emptyFolder()},CMailCache.prototype.executeEmptySpam=function(){var e=this.folderList().spamFolder();e&&e.emptyFolder()},CMailCache.prototype.onClearFolder=function(e){if(e&&e.selected()){this.messages.removeAll(),this.currentMessage(null);var s=e?e.getUidList(this.uidList().search(),this.uidList().filters(),this.uidList().sortBy(),this.uidList().sortOrder()):null;s?this.uidList(s):this.uidList(new CUidListModel),this.checkMailStarted(!1),this.setAutocheckmailTimer()}},CMailCache.prototype.getOpenedDraftUids=function(){var e=WindowOpener.getOpenedWindows(),s=_.map(e,function(e){return e.SlaveTabMailMethods?e.SlaveTabMailMethods.getEditedDraftUid():""});return Popups.hasOpenedMinimizedPopups()&&s.push(this.editedDraftUid()),_.uniq(_.compact(s))},CMailCache.prototype.closeComposesWithDraftUids=function(e){var s=WindowOpener.getOpenedWindows();if(_.each(s,function(s){s.SlaveTabMailMethods&&-1!==$.inArray(s.SlaveTabMailMethods.getEditedDraftUid(),e)&&s.close()}),-1!==$.inArray(this.editedDraftUid(),e)){var t=require("modules/%ModuleName%/js/utils/Compose.js");_.isFunction(t.closeComposePopup)&&t.closeComposePopup()}},CMailCache.prototype.moveMessagesToFolder=function(e,s){if(s.length>0){var t=this.folderList().currentFolder(),i=t&&t.type()===Enums.FolderTypes.Drafts,r=i&&this.getOpenedDraftUids(),o=i&&_.find(s,_.bind(function(e){return-1!==$.inArray(e,r)},this)),a=this.folderList().getFolderByFullName(e),n={Folder:t?t.fullName():"",ToFolder:e,Uids:s.join(",")},l=null,u=_.bind(function(){this.uidList().filters()===Enums.FolderFilter.Unseen&&this.uidList().resultCount()>Settings.MailsPerPage&&this.waitForUnseenMessages(!0),l=t.markDeletedByUids(s),a.addMessagesCountsDiff(l.MinusDiff,l.UnseenMinusDiff),a.recivedAnim(!0),this.excludeDeletedMessages(),a.markHasChanges(),Ajax.send("MoveMessages",n,this.onMoveMessagesResponse,this)},this);t&&a&&(o?(this.disableComposeAutosave(!0),Popups.showPopup(ConfirmPopup,[TextUtils.i18n("%MODULENAME%/CONFIRM_MESSAGE_FOR_DELETE_IS_EDITED"),_.bind(function(e){e&&(this.closeComposesWithDraftUids(s),u()),this.disableComposeAutosave(!1)},this),"",TextUtils.i18n("%MODULENAME%/ACTION_CLOSE_DELETE_DRAFT")])):u())}},CMailCache.prototype.copyMessagesToFolder=function(e,s){if(s.length>0){var t=this.folderList().currentFolder(),i=this.folderList().getFolderByFullName(e),r={Folder:t?t.fullName():"",ToFolder:e,Uids:s.join(",")};t&&i&&(i.recivedAnim(!0),i.markHasChanges(),Ajax.send("CopyMessages",r,this.onCopyMessagesResponse,this))}},CMailCache.prototype.excludeDeletedMessages=function(){_.delay(_.bind(function(){var e=(this.page()-1)*Settings.MailsPerPage;this.setMessagesFromUidList(this.uidList(),e,!0)},this),500)},CMailCache.prototype.removeOneMessageFromCacheForFolder=function(e,s,t){var i=this.oFolderListItems[e],r=i?i.getFolderByFullName(s):null;r&&r.type()===Enums.FolderTypes.Drafts&&(this.currentMessage()&&this.currentMessage().folder()===s&&this.currentMessage().uid()===t&&this.currentMessage(null),r.markDeletedByUids([t]),r.commitDeleted([t]))},CMailCache.prototype.startMessagesLoadingWhenDraftSaving=function(e,s){var t=this.oFolderListItems[e],i=t?t.getFolderByFullName(s):null;i&&i.type()===Enums.FolderTypes.Drafts&&i.selected()&&this.messagesLoading(!0)},CMailCache.prototype.removeMessagesFromCacheForFolder=function(e,s){var t=this.oFolderListItems[e],i=t?t.getFolderByFullName(s):null,r=t?t.currentFolderFullName():null;i&&(i.markHasChanges(),this.currentAccountId()===e&&s===r&&this.requestCurrentMessageList(r,this.page(),this.uidList().search(),"",this.uidList().sortBy(),this.uidList().sortOrder(),!0))},CMailCache.prototype.deleteMessages=function(e){var s=this.folderList().currentFolder();s&&this.deleteMessagesFromFolder(s,e)},CMailCache.prototype.deleteMessagesFromFolder=function(e,s){var t={Folder:e.fullName(),Uids:s.join(",")};e.markDeletedByUids(s),this.excludeDeletedMessages(),Ajax.send("DeleteMessages",t,this.onMoveMessagesResponse,this)},CMailCache.prototype.showExternalPictures=function(e){var s=[],t=null;this.currentMessage()&&(s=this.currentMessage().oFrom.aCollection,t=this.folderList().getFolderByFullName(this.currentMessage().folder()),e&&s.length>0?t.alwaysShowExternalPicturesForSender(s[0].sEmail):t.showExternalPictures(this.currentMessage().uid()))},CMailCache.prototype.setCurrentMessage=function(e,s){var t=this.folderList().currentFolder(),i=null;!App.isNewTab()||t&&t.fullName()===s||(this.folderList().setCurrentFolder(s,""),t=this.folderList().currentFolder()),t&&e&&(i=MessagesDictionary.get([t.iAccountId,t.fullName(),e])),i&&!i.deleted()?(this.currentMessage(i),this.currentMessage().seen()||this.executeGroupOperation("SetMessagesSeen",[this.currentMessage().uid()],"seen",!0),t.getCompletelyFilledMessage(e,this.onCurrentMessageResponse,this)):(this.currentMessage(null),App.isNewTab()&&t&&t.getCompletelyFilledMessage(e,this.onCurrentMessageResponse,this))},CMailCache.prototype.onCurrentMessageResponse=function(e,s,t){var i=this.currentMessage()?this.currentMessage().uid():"";null===e&&MainTab&&t&&Api.showErrorByCode(t,"",!0),null===e&&i===s?this.currentMessage(null):e&&i===s?this.currentMessage.valueHasMutated():App.isNewTab()&&e&&null===this.currentMessage()&&this.currentMessage(e)},CMailCache.prototype.getMessage=function(e,s,t,i){var r=this.folderList().getFolderByFullName(e);r&&r.getCompletelyFilledMessage(s,t,i)},CMailCache.prototype.executeGroupOperation=function(e,s,t,i){var r=this.folderList().currentFolder(),o={Folder:r?r.fullName():"",Uids:s.join(","),SetAction:i},a=(this.page()-1)*Settings.MailsPerPage,n=s.length,l=this.folderList().oStarredFolder?this.folderList().oStarredFolder.messageCount():0,u=r?r.getUidList("",Enums.FolderFilter.Flagged,Settings.MessagesSortBy.DefaultSortBy,Settings.MessagesSortBy.DefaultSortOrder):null,d="SetMessagesSeen"===e?this.onSetMessagesSeenResponse:function(){};r&&("SetMessagesSeen"===e&&this.iSetMessagesSeenCount++,Ajax.send(e,o,d,this),r.executeGroupOperation(t,s,i),r.type()===Enums.FolderTypes.Inbox&&"flagged"===t&&(this.uidList().filters()===Enums.FolderFilter.Flagged?i||(this.uidList().deleteUids(s),this.folderList().oStarredFolder&&this.folderList().oStarredFolder.messageCount(u.resultCount())):(r.removeFlaggedMessageListsFromCache(),""===this.uidList().search()&&this.folderList().oStarredFolder&&(i?this.folderList().oStarredFolder.messageCount(l+n):this.folderList().oStarredFolder.messageCount(l-n>0?l-n:0)))),"seen"===t&&r.removeUnseenMessageListsFromCache(),(this.uidList().filters()!==Enums.FolderFilter.Unseen||this.waitForUnseenMessages())&&this.setMessagesFromUidList(this.uidList(),a,!0))},CMailCache.prototype.onSetMessagesSeenResponse=function(e,s){this.iSetMessagesSeenCount--,this.iSetMessagesSeenCount<0&&(this.iSetMessagesSeenCount=0),this.folderList().currentFolder()&&0===this.iSetMessagesSeenCount&&(this.uidList().filters()!==Enums.FolderFilter.Unseen||this.waitForUnseenMessages())&&this.requestCurrentMessageList(this.folderList().currentFolder().fullName(),this.page(),this.uidList().search(),this.uidList().filters(),this.uidList().sortBy(),this.uidList().sortOrder(),!1)},CMailCache.prototype.onGetFoldersResponse=function(e,s){var t=s.Parameters,i=new CFolderListModel,r=t.AccountID,o=this.oFolderListItems[r],a=o?o.oNamedCollection:{};!1===e.Result?(Api.showErrorByCode(e),t.AccountID===this.currentAccountId()&&0===this.messages().length&&(this.messagesLoading(!1),this.messagesLoadingError(!0))):(i.parse(r,e.Result,a),o&&i.oStarredFolder.messageCount(o.oStarredFolder.messageCount()),this.__oldFolderList=this.oFolderListItems[r],this.oFolderListItems[r]=i,this.__oldFolderList&&(this.__oldFolderList.destroyFolders(),Utils.destroyObjectWithObservables(this,"__oldFolderList")),setTimeout(_.bind(this.getAllFoldersRelevantInformation,this,r),2e3),this.currentAccountId()===r&&this.folderList(i),this.editedAccountId()===r&&this.editedFolderList(i)),this.folderListLoading.remove(r)},CMailCache.prototype.getAllFoldersRelevantInformation=function(e){var s=this.oFolderListItems[e],t=s?s.getFoldersWithoutCountInfo():[],i={AccountID:e,Folders:t,UseListStatusIfPossible:this.getUseListStatusIfPossibleValue(t.length)};t.length>0&&AccountList.getAccount(e)&&Ajax.send("GetRelevantFoldersInformation",i,this.onGetRelevantFoldersInformationResponse,this)},CMailCache.prototype.onGetRelevantFoldersInformationResponse=function(e,s){var t=!1,i=s.Parameters.AccountID,r=this.oFolderListItems[i],o=this.folderList().currentFolderFullName(),a=this.currentAccountId()===i;!1===e.Result?(Api.showErrorByCode(e),Ajax.hasOpenedRequests("GetRelevantFoldersInformation")&&(t=!0)):r&&(_.each(e.Result&&e.Result.Counts,function(e,s){if(_.isArray(e)&&e.length>3){var i=e[0],n=e[1],l=e[2],u=e[3],d=!1,h=!1,c=null;(c=r.getFolderByFullName(s))&&(h=a&&c.fullName()===o,d=c.setRelevantInformation(l,u,i,n,h),h&&d&&this.uidList().filters()!==Enums.FolderFilter.Unseen&&(this.requestCurrentMessageList(c.fullName(),this.page(),this.uidList().search(),this.uidList().filters(),this.uidList().sortBy(),this.uidList().sortOrder(),!1),t=!0))}},this),r.countsCompletelyFilled(!0)),this.checkMailStarted(t),this.checkMailStarted()||this.setAutocheckmailTimer()},CMailCache.prototype.showNotificationsForNewMessages=function(e){var s=this.folderList().currentFolderFullName(),t=0,i="",r={},o="",a=[];e.Result.New&&e.Result.New.length>0&&(t=e.Result.New.length,i=e.Result.New[0].Uid,r={action:"show",icon:"static/styles/images/logo_140x140.png",title:TextUtils.i18n("%MODULENAME%/INFO_NEW_MESSAGES_PLURAL",{COUNT:t},null,t),timeout:5e3,callback:function(){window.focus(),Routing.setHash(LinksUtils.getMailbox(s,1,i,"",""))}},1===t&&(Types.isNonEmptyString(e.Result.New[0].Subject)&&a.push(TextUtils.i18n("%MODULENAME%/LABEL_SUBJECT")+": "+e.Result.New[0].Subject),o=_.map(e.Result.New[0].From,function(e){return""!==e.DisplayName?e.DisplayName:e.Email}).join(", "),Types.isNonEmptyString(o)&&a.push(TextUtils.i18n("%MODULENAME%/LABEL_FROM")+": "+o),r.body=a.join("\r\n")),Utils.desktopNotify(r))},CMailCache.prototype.onCurrentGetMessagesResponse=function(e,s){this.checkMailStarted(!1),e.Result?(this.messagesLoadingError(!1),this.parseMessageList(e,s)):(Api.showErrorByCode(e),!0!==this.messagesLoading()||0!==this.messages().length&&e.ErrorCode===Enums.Errors.NotDisplayedError||this.messagesLoadingError(!0),this.messagesLoading(!1),this.setAutocheckmailTimer())},CMailCache.prototype.onGetMessagesResponse=function(e,s){e&&e.Result?this.parseMessageList(e,s):Utils.log("onGetMessagesResponse, there was an error while getting message list",e,s)},CMailCache.prototype.parseMessageList=function(e,s){var t=e.Result,i=s.Parameters,r=i.AccountID,o=this.oFolderListItems[r],a=null,n=null,l=i.UseThreading,u=!1,d=this.currentAccountId()===r&&this.folderList().currentFolderFullName()===t.FolderName,h=d&&this.uidList().search()===t.Search&&this.uidList().filters()===t.Filters,c=this.page()===t.Offset/Settings.MailsPerPage+1,g=[];this.showNotificationsForNewMessages(e),!1!==t&&"Collection/MessageCollection"===t["@Object"]&&((a=o.getFolderByFullName(t.FolderName)).setRelevantInformation(t.UidNext.toString(),t.FolderHash,t.MessageCount,t.MessageUnseenCount,d&&!h),u=a.hasChanges(),a.removeAllMessageListsFromCacheIfHasChanges(),(n=a.getUidList(t.Search,t.Filters,s.Parameters.SortBy,s.Parameters.SortOrder)).setUidsAndCount(t),_.each(t["@Collection"],function(e){var s=a.parseAndCacheMessage(e,!1,l);g.push(s)},this),h&&(this.uidList(n),c&&(n.filters()!==Enums.FolderFilter.Unseen||this.waitForUnseenMessages())&&(this.messagesLoading(!1),this.waitForUnseenMessages(!1),this.setMessagesFromUidList(n,t.Offset,!0),this.messagesLoading()||this.setAutocheckmailTimer())),!u||!d||h&&c||this.uidList().filters()===Enums.FolderFilter.Unseen||this.requestCurrentMessageList(this.folderList().currentFolderFullName(),this.page(),this.uidList().search(),this.uidList().filters(),this.uidList().sortBy(),this.uidList().sortOrder(),!1),a.type()===Enums.FolderTypes.Inbox&&n.filters()===Enums.FolderFilter.Flagged&&""===n.search()&&this.folderList().oStarredFolder&&(this.folderList().oStarredFolder.messageCount(n.resultCount()),this.folderList().oStarredFolder.hasExtendedInfo(!0)))},CMailCache.prototype.increaseStarredCount=function(){this.folderList().oStarredFolder&&this.folderList().oStarredFolder.increaseCountIfHasNotInfo()},CMailCache.prototype.onMoveMessagesResponse=function(e,s){var t=e.Result,i=s.Parameters,r=i.Uids.split(","),o=this.folderList().getFolderByFullName(i.Folder),a=this.folderList().getFolderByFullName(i.ToFolder),n=a&&a.type()===Enums.FolderTypes.Trash,l=a&&a.type()===Enums.FolderTypes.Spam,u=null,d=n?TextUtils.i18n("%MODULENAME%/CONFIRM_MESSAGES_DELETE_WITHOUT_TRASH"):TextUtils.i18n("%MODULENAME%/CONFIRM_MESSAGES_MARK_SPAM_WITHOUT_SPAM"),h=_.bind(function(e){e&&o&&this.deleteMessagesFromFolder(o,r)},this),c=this.folderList().currentFolder(),g=c?c.fullName():"",M=!1;if(!1===t?(o&&(u=o.revertDeleted(r)),a?(u&&a.addMessagesCountsDiff(-u.PlusDiff,-u.UnseenPlusDiff),e.ErrorCode===Enums.MailErrors.CannotMoveMessageQuota&&(n||l)?(Types.isNonEmptyString(e.ErrorMessage)&&(d+=" ("+e.ErrorMessage+")"),Popups.showPopup(ConfirmPopup,[d,h])):Api.showErrorByCode(e,TextUtils.i18n("%MODULENAME%/ERROR_MOVING_MESSAGES"))):Api.showErrorByCode(e,TextUtils.i18n("%MODULENAME%/ERROR_DELETING_MESSAGES")),M=!0):o&&(o.commitDeleted(r),_.each(r,function(e){Routing.replaceHashWithoutMessageUid(e)})),o&&g===o.fullName()||a&&g===a.fullName())switch(c.markHasChanges(),this.uidList().filters()){case Enums.FolderFilter.Flagged:break;case Enums.FolderFilter.Unseen:this.waitForUnseenMessages()&&this.requestCurrentMessageList(g,this.page(),this.uidList().search(),this.uidList().filters(),this.uidList().sortBy(),this.uidList().sortOrder(),M);break;default:this.requestCurrentMessageList(g,this.page(),this.uidList().search(),this.uidList().filters(),this.uidList().sortBy(),this.uidList().sortOrder(),M)}else o&&g!==o.fullName()?(this.requirePrefetcher(),Prefetcher.startFolderPrefetch(o)):a&&g!==a.fullName()&&(this.requirePrefetcher(),Prefetcher.startFolderPrefetch(a))},CMailCache.prototype.onCopyMessagesResponse=function(e,s){var t=e.Result,i=s.Parameters,r=this.folderList().getFolderByFullName(i.Folder),o=this.folderList().getFolderByFullName(i.ToFolder),a=this.folderList().currentFolder(),n=a.fullName();!1===t&&Api.showErrorByCode(e,TextUtils.i18n("%MODULENAME%/ERROR_COPYING_MESSAGES")),n===r.fullName()||o&&n===o.fullName()?(a.markHasChanges(),this.requestCurrentMessageList(n,this.page(),this.uidList().search(),"",this.uidList().sortBy(),this.uidList().sortOrder(),!1)):n!==r.fullName()?(this.requirePrefetcher(),Prefetcher.startFolderPrefetch(r)):o&&n!==o.fullName()&&(this.requirePrefetcher(),Prefetcher.startFolderPrefetch(o))},CMailCache.prototype.searchMessagesInCurrentFolder=function(e){var s=this.folderList().currentFolderFullName()||"INBOX",t=this.currentMessage()?this.currentMessage().uid():"",i=this.uidList().filters();Routing.setHash(LinksUtils.getMailbox(s,1,t,e,i))},CMailCache.prototype.searchMessagesInInbox=function(e){Routing.setHash(LinksUtils.getMailbox(this.folderList().inboxFolderFullName()||"INBOX",1,"",e,""))},CMailCache.prototype.getFolderHash=function(e){return Routing.buildHashFromArray(LinksUtils.getMailbox(e,1,"","",""))},CMailCache.prototype.countMessages=function(e){var s=[],t=function(e){_.each(e.subfolders(),function(e,i){e.subscribed()&&(s.push(e.unseenMessageCount()),e.subfolders().length&&e.subscribed()&&t(e))},this)};e.expanded()||e.bNamespace?e.subfoldersMessagesCount(0):(t(e),e.subfoldersMessagesCount(_.reduce(s,function(e,s){return e+s},0)))},CMailCache.prototype.changeDatesInMessages=function(){MessagesDictionary.updateMomentDates()},CMailCache.prototype.clearMessagesCache=function(e){var s=this.oFolderListItems[e];_.each(s.collection(),function(e){e.markHasChanges(),e.removeAllMessageListsFromCacheIfHasChanges()},this),e===this.currentAccountId()&&this.messages([])},CMailCache.prototype.getTemplateFolder=function(){var e=this.folderList(),s="",t=e.currentFolder()?e.currentFolder().fullName():"";return Types.isNonEmptyArray(this.getCurrentTemplateFolders())&&(s=-1!==$.inArray(t,this.getCurrentTemplateFolders())?t:_.find(this.getCurrentTemplateFolders(),function(s){return!!e.oNamedCollection[s]})),"string"==typeof s?s:""},CMailCache.prototype.getCurrentTemplateFolders=function(){return Settings.AllowTemplateFolders?this.folderList().aTemplateFolders:[]},CMailCache.prototype.changeTemplateFolder=function(e,s){Settings.AllowTemplateFolders&&this.folderList().changeTemplateFolder(e,s)};var MailCache=new CMailCache;Pulse.registerDayOfMonthFunction(_.bind(MailCache.changeDatesInMessages,MailCache)),UserSettings.timeFormat.subscribe(MailCache.changeDatesInMessages,MailCache),UserSettings.dateFormat.subscribe(MailCache.changeDatesInMessages,MailCache),module.exports=MailCache;