"use strict";var _=require("underscore"),App=require("%PathToCoreWebclientModule%/js/App.js"),UserSettings=require("%PathToCoreWebclientModule%/js/Settings.js"),AccountList=require("modules/%ModuleName%/js/AccountList.js"),Ajax=require("modules/%ModuleName%/js/Ajax.js"),Settings=require("modules/%ModuleName%/js/Settings.js"),MailCache=require("modules/%ModuleName%/js/Cache.js"),MessagesDictionary=require("modules/%ModuleName%/js/MessagesDictionary.js"),Prefetcher={},bFetchersIdentitiesPrefetched=!1;Prefetcher.prefetchFetchersIdentities=function(){return!(App.isNewTab()||bFetchersIdentitiesPrefetched||!Settings.AllowFetchers&&!Settings.AllowIdentities)&&(AccountList.populateFetchersIdentities(),bFetchersIdentitiesPrefetched=!0,!0)},Prefetcher.prefetchAccountFilters=function(){var e=AccountList.getCurrent(),t=!1;return e&&e.allowFilters()&&!e.filters()&&(e.requestFilters(),t=!0),t},Prefetcher.prefetchMessageList=function(e,t,r,s){var a={page:t,search:r,filters:s},i=e.hasListBeenRequested(a),c=null;return c=MailCache.requestMessageList(e.fullName(),a.page,a.search,a.filters,Settings.MessagesSortBy.DefaultSortBy,Settings.MessagesSortBy.DefaultSortOrder,!1,!1,i),!i&&!!c&&c.RequestStarted},Prefetcher.prefetchStarredMessageList=function(){var e=MailCache.folderList(),t=e?e.inboxFolder():null,r=!1;return t&&(r=this.prefetchMessageList(t,1,"",Enums.FolderFilter.Flagged)),r},Prefetcher.prefetchUnseenMessageList=function(){var e=MailCache.folderList(),t=e?e.inboxFolder():null,r=!1;return t&&(r=this.prefetchMessageList(t,1,"",Enums.FolderFilter.Unseen)),r},Prefetcher.prefetchNextPage=function(e){var t=MailCache.uidList(),r=_.indexOf(t.collection(),e),s=Math.ceil(r/Settings.MailsPerPage)+1;this.startPagePrefetch(s-1)},Prefetcher.prefetchPrevPage=function(e){var t=MailCache.uidList(),r=_.indexOf(t.collection(),e),s=Math.ceil((r+1)/Settings.MailsPerPage)+1;this.startPagePrefetch(s)},Prefetcher.startPagePrefetch=function(e){var t=MailCache.folderList().currentFolder(),r=MailCache.uidList(),s=(e-1)*Settings.MailsPerPage,a=e>0&&s<r.resultCount(),i=!1;return t&&!t.hasChanges()&&a&&(i=this.prefetchMessageList(t,e,r.search(),"")),i},Prefetcher.startOtherFoldersPrefetch=function(){var e=MailCache.folderList(),t=e.currentFolderFullName(),r=MailCache.getNamesOfFoldersToRefresh(),s=e?[e.inboxFolderFullName(),e.sentFolderFullName(),e.draftsFolderFullName(),e.spamFolderFullName()]:[],a=r.length<5?this.getOtherFolderNames(5-r.length):[],i=_.uniq(_.compact(_.union(s,r,a))),c=!1;return _.each(i,_.bind(function(r){c||t===r||(c=this.startFolderPrefetch(e.getFolderByFullName(r)))},this)),c},Prefetcher.getOtherFolderNames=function(e){var t=MailCache.folderList().inboxFolder(),r=t?t.subfolders():[],s=_.filter(MailCache.folderList().collection(),function(e){return!e.isSystem()},this),a=_.first(_.union(r,s),e);return _.map(a,function(e){return e.fullName()})},Prefetcher.startFolderPrefetch=function(e){var t=!1;return e&&(t=this.prefetchMessageList(e,1,"","")),t},Prefetcher.startThreadListPrefetch=function(){var e=[],t=MailCache.getCurrentFolder();return _.each(MailCache.messages(),function(r){r.threadCount()>0&&_.each(r.threadUids(),function(r){t.hasThreadUidBeenRequested(r)||e.push(r)})},this),e.length>0&&(e=e.slice(0,Settings.MailsPerPage),t.addRequestedThreadUids(e),t.loadThreadMessages(e),!0)},Prefetcher.startMessagesPrefetch=function(){var e=MailCache.currentAccountId(),t=MailCache.getCurrentFolder(),r=t?t.fullName():"",s=0,a=Settings.MaxMessagesBodiesSizeToPrefetch,i=[],c=null,n=function(e){var r=!e.deleted()&&!e.completelyFilled(),c=!_.find(i,function(t){return t===e.uid()},this),n=!t.hasUidBeenRequested(e.uid()),h=e.textSize()<Settings.MessageBodyTruncationThreshold?e.textSize():Settings.MessageBodyTruncationThreshold;s<a&&r&&c&&n&&(i.push(e.uid()),s+=h+2048)};return!!(t&&t.selected()&&(_.each(MailCache.messages(),n),t.doForAllMessages(n),i.length>0))&&(t.addRequestedUids(i),c={AccountID:e,Folder:r,Uids:i,MessageBodyTruncationThreshold:Settings.MessageBodyTruncationThreshold},Ajax.send("GetMessagesBodies",c,this.onGetMessagesBodiesResponse,this),!0)},Prefetcher.onGetMessagesBodiesResponse=function(e,t){var r=t.Parameters,s=MailCache.getFolderByFullName(r.AccountID,r.Folder);_.isArray(e.Result)&&_.each(e.Result,function(e){s.parseAndCacheMessage(e,!1,!1)})},Prefetcher.prefetchAccountQuota=function(){var e=AccountList.getCurrent(),t=e&&!e.quotaRecieved();return!(!UserSettings.ShowQuotaBar||!t)&&(e.updateQuotaParams(),!0)},module.exports={startMin:function(){var e=!1;return(e=Prefetcher.prefetchFetchersIdentities())||(e=Prefetcher.prefetchAccountFilters()),e||(e=Prefetcher.prefetchStarredMessageList()),e||(e=Prefetcher.prefetchAccountQuota()),e},startAll:function(){var e=!1;return(e=Prefetcher.prefetchFetchersIdentities())||(e=Prefetcher.prefetchAccountFilters()),e||(e=Prefetcher.startMessagesPrefetch()),e||(e=Prefetcher.startThreadListPrefetch()),e||(e=Prefetcher.prefetchStarredMessageList()),e||(e=Prefetcher.startPagePrefetch(MailCache.page()+1)),e||(e=Prefetcher.startPagePrefetch(MailCache.page()-1)),e||(e=Prefetcher.prefetchUnseenMessageList()),e||(e=Prefetcher.prefetchAccountQuota()),e||(e=Prefetcher.startOtherFoldersPrefetch()),e},prefetchStarredMessageList:function(){Prefetcher.prefetchStarredMessageList()},startFolderPrefetch:function(e){Prefetcher.startFolderPrefetch(e)},prefetchNextPage:function(e){Prefetcher.prefetchNextPage(e)},prefetchPrevPage:function(e){Prefetcher.prefetchPrevPage(e)}};