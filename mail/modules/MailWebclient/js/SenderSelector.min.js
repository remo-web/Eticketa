"use strict";function CSenderSelector(){this.senderList=ko.observableArray([]),this.senderAccountId=ko.observable(AccountList.currentId()),this.selectedFetcherOrIdentity=ko.observable(null),this.lockSelectedSender=ko.observable(!1),this.selectedSender=ko.observable(""),this.selectedSender.subscribe(function(){if(!this.lockSelectedSender()){var e=AccountList.getAccount(this.senderAccountId()),t=this.selectedSender(),i=null;Types.isNonEmptyString(t)&&(0===t.indexOf("fetcher")?(t=t.replace("fetcher",""),i=_.find(e.fetchers(),function(e){return e.id()===Types.pInt(t)})):i=_.find(e.identities(),function(e){return e.id()===Types.pInt(t)})),i&&this.selectedFetcherOrIdentity(i)}},this)}var _=require("underscore"),ko=require("knockout"),Types=require("%PathToCoreWebclientModule%/js/utils/Types.js"),SendingUtils=require("modules/%ModuleName%/js/utils/Sending.js"),AccountList=require("modules/%ModuleName%/js/AccountList.js");CSenderSelector.prototype.changeSelectedSender=function(e){if(e){var t=Types.pString(e.id());e.FETCHER&&(t="fetcher"+t),_.find(this.senderList(),function(e){return e.id===t})&&(this.lockSelectedSender(!0),this.selectedSender(t),this.selectedFetcherOrIdentity(e),this.lockSelectedSender(!1))}},CSenderSelector.prototype.changeSenderAccountId=function(e,t){var i=!1;this.senderAccountId()!==e&&(AccountList.hasAccountWithId(e)?(this.senderAccountId(e),i=!0):AccountList.hasAccountWithId(this.senderAccountId())||(this.senderAccountId(AccountList.currentId()),i=!0)),(i||0===this.senderList().length)&&(this.fillSenderList(t),i=!0),!i&&t&&this.changeSelectedSender(t)},CSenderSelector.prototype.fillSenderList=function(e){var t=[],i=AccountList.getAccount(this.senderAccountId());i&&(_.isArray(i.identities())&&_.each(i.identities(),function(e){t.push({fullEmail:e.fullEmail(),id:Types.pString(e.id())})},this),i.identitiesSubscribtion&&i.identitiesSubscribtion.dispose(),i.identitiesSubscribtion=i.identities.subscribe(function(){this.fillSenderList(e),this.changeSelectedSender(i.getDefaultIdentity())},this),_.each(i.fetchers(),function(e){var i=e.fullEmail();e.isEnabled()&&e.isOutgoingEnabled()&&i.length>0&&t.push({fullEmail:i,id:"fetcher"+e.id()})},this),i.fetchersSubscribtion&&i.fetchersSubscribtion.dispose(),i.fetchersSubscribtion=i.fetchers.subscribe(function(){this.fillSenderList(e)},this)),this.senderList(t),this.changeSelectedSender(e)},CSenderSelector.prototype.setFetcherOrIdentityByReplyMessage=function(e){var t=e.oTo.aCollection.concat(e.oCc.aCollection),i=SendingUtils.getFirstFetcherOrIdentityByRecipientsOrDefault(t,e.accountId());i&&this.changeSelectedSender(i)},module.exports=new CSenderSelector;