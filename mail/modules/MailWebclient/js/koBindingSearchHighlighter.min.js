"use strict";function getCaretOffset(e){var t=null,n={},r={},o=0;return window.getSelection&&document.createRange?(t=window.getSelection()).rangeCount>0&&((r=(n=t.getRangeAt(0)).cloneRange()).selectNodeContents(e),r.setEnd(n.startContainer,n.startOffset),o=r.toString().length,$(e).html().length<o&&(o=0)):document.selection&&document.body.createTextRange&&(n=document.selection.createRange(),(r=document.body.createTextRange()).moveToElementText(e),"function"==typeof r.setEndPoint&&r.setEndPoint("EndToStart",n),o=r.text.length),o}function setCursor(e,t){var n,r,o;if(!e)return!1;if(document.createRange)(n=document.createRange()).selectNodeContents(e),n.setStart(e,t),n.setEnd(e,t),(r=window.getSelection()).removeAllRanges(),r.addRange(n);else{if(e.createTextRange)return(o=e.createTextRange()).collapse(!0),o.moveEnd(t),o.moveStart(t),o.select(),!0;if(e.setSelectionRange)return e.setSelectionRange(t,t),!0}return!1}var _=require("underscore"),$=require("jquery"),ko=require("knockout");ko.bindingHandlers.highlighter={init:function(e,t,n,r,o){function a(t){if(y){var n=0,r=i.text().split(g),o=[];_.each(r,function(e){var t=e.split("");_.any(d,function(t){return t===e})?_.each(t,function(e){o.push($(e.replace(/(.)/,'<span class="search_highlight">$&</span>')))}):_.each(t,function(e){" "===e?o.push(document.createTextNode(" ")):o.push(document.createTextNode(e))})}),i.is(":focus")?(n=getCaretOffset(e),i.empty().append(o),setCursor(e,n)):i.empty().append(o)}}var i=$(e),u=t(),c=u.valueObserver?u.valueObserver:null,s=u.highlighterValueObserver?u.highlighterValueObserver:null,l=u.highlightTrigger?u.highlightTrigger:null,d=["from:","to:","subject:","text:","email:","has:","date:","text:","body:"],g=function(){var e="";return $.each(d,function(t,n){e=t?e+"|\\b"+n:e+"\\b"+n}),new RegExp("("+e+")","g")}(),h=function(e){return e.replace(/\xC2\xA0/g," ").replace(/\xA0/g," ").replace(/[\s]+/g," ")},m=-1,f=window.navigator.language||window.navigator.userLanguage,y=!_.include(["zh","zh-TW","zh-CN","zh-HK","zh-SG","zh-MO","ja","ja-JP","ko","ko-KR","vi","vi-VN","th","th-TH"],f);$(e).on("keydown",function(e){return e.keyCode!==Enums.Key.Enter}).on("keyup",function(e){var t=[Enums.Key.Left,Enums.Key.Right,Enums.Key.Home,Enums.Key.End],n=-1!==$.inArray(e.keyCode,t);return e.keyCode===Enums.Key.Shift||e.keyCode===Enums.Key.Alt||e.keyCode===Enums.Key.Ctrl||e.keyCode===Enums.Key.Dash||e.keyCode===Enums.Key.Apostrophe||e.keyCode===Enums.Key.Six&&e.shiftKey||n||(e.ctrlKey||m===Enums.Key.Ctrl)&&e.keyCode===Enums.Key.a||(c(h(i.text())),a()),m=e.keyCode,!0}).on("paste",function(e){if(document.queryCommandSupported("insertText")){e.preventDefault();var t="";e.clipboardData||e.originalEvent.clipboardData?t=(e.originalEvent||e).clipboardData.getData("text/plain"):window.clipboardData&&(t=window.clipboardData.getData("Text")),document.execCommand("insertText",!1,t)}setTimeout(function(){c(h(i.text())),a()},0)}),setTimeout(function(){a()},0),l.notifySubscribers(),l.subscribe(function(e){setTimeout(function(){a()},0)},this),s.subscribe(function(){var e=i.text(),t=c();e.replace(" "," ")!==t.replace(" "," ")&&i.text(t)},this)}};