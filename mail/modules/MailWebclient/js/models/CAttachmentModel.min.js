"use strict";function CAttachmentModel(){this.folderName=ko.observable(""),this.messageUid=ko.observable(""),this.cid=ko.observable(""),this.contentLocation=ko.observable(""),this.inline=ko.observable(!1),this.linked=ko.observable(!1),this.mimePartIndex=ko.observable(""),this.messagePart=ko.observable(null),CAbstractFileModel.call(this),this.content=ko.observable(""),this.isMessageType=ko.computed(function(){return this.mimeType(),this.mimePartIndex(),"message/rfc822"===this.mimeType()},this)}var _=require("underscore"),$=require("jquery"),ko=require("knockout"),TextUtils=require("%PathToCoreWebclientModule%/js/utils/Text.js"),Types=require("%PathToCoreWebclientModule%/js/utils/Types.js"),App=require("%PathToCoreWebclientModule%/js/App.js"),WindowOpener=require("%PathToCoreWebclientModule%/js/WindowOpener.js"),CAbstractFileModel=require("%PathToCoreWebclientModule%/js/models/CAbstractFileModel.js"),Ajax=require("modules/%ModuleName%/js/Ajax.js");_.extendOwn(CAttachmentModel.prototype,CAbstractFileModel.prototype),CAttachmentModel.prototype.getNewInstance=function(){return new CAttachmentModel},CAttachmentModel.prototype.getCopy=function(){var e=new CAttachmentModel;return e.copyProperties(this),e},CAttachmentModel.prototype.copyProperties=function(e){this.fileName(e.fileName()),this.tempName(e.tempName()),this.size(e.size()),this.hash(e.hash()),this.mimeType(e.mimeType()),this.cid(e.cid()),this.contentLocation(e.contentLocation()),this.inline(e.inline()),this.linked(e.linked()),this.thumbnailSrc(e.thumbnailSrc()),this.thumbnailLoaded(e.thumbnailLoaded()),this.statusText(e.statusText()),this.uploaded(e.uploaded()),this.oActionsData=e.oActionsData,this.actions(e.actions()),this.thumbUrlInQueue(e.thumbUrlInQueue())},CAttachmentModel.prototype.additionalParse=function(e){this.content(Types.pString(e.Content)),this.mimePartIndex(Types.pString(e.MimePartIndex)),this.isMessageType()&&""===this.mimePartIndex()&&this.actions(_.without(this.actions(),"view")),this.cid(Types.pString(e.CID)),this.contentLocation(Types.pString(e.ContentLocation)),this.inline(!!e.IsInline),this.linked(!!e.IsLinked),App.broadcastEvent("%ModuleName%::ParseFile::after",this)},CAttachmentModel.prototype.setMessageData=function(e,t){this.folderName(e),this.messageUid(t)},CAttachmentModel.prototype.onGetMessageResponse=function(e,t){var s=t.Parameters,i=(e=e.Result,new(require("modules/%ModuleName%/js/models/CMessageModel.js")));e&&this.oNewWindow&&(i.parse(e,s.AccountID,!1,!0),this.messagePart(i),this.messagePart().viewMessage(this.oNewWindow),this.oNewWindow=void 0)},CAttachmentModel.prototype.viewFile=function(){this.isMessageType()?this.viewMessageFile():this.viewCommonFile()},CAttachmentModel.prototype.viewMessageFile=function(){var e=null,t='<div style="margin: 30px; text-align: center; font: normal 14px Tahoma;">'+TextUtils.i18n("COREWEBCLIENT/INFO_LOADING")+"</div>";(e=WindowOpener.open("",this.fileName()))&&(this.messagePart()?this.messagePart().viewMessage(e):($(e.document.body).html(t),this.oNewWindow=e,Ajax.send("GetMessage",{Folder:this.folderName(),Uid:this.messageUid(),Rfc822MimeIndex:this.mimePartIndex()},this.onGetMessageResponse,this)),e.focus())},CAttachmentModel.prototype.fillDataAfterUploadComplete=function(e,t){this.cid(Types.pString(t)),e&&e.Result&&e.Result.Attachment&&(this.tempName(Types.pString(e.Result.Attachment.TempName)),this.mimeType(Types.pString(e.Result.Attachment.MimeType)),this.size(Types.pInt(e.Result.Attachment.Size)),this.hash(Types.pString(e.Result.Attachment.Hash)),this.parseActions(e.Result.Attachment))},CAttachmentModel.prototype.parseFromUpload=function(e,t,s){this.setMessageData(t,s),this.fileName(Types.pString(e.Name)),this.tempName(e.TempName?Types.pString(e.TempName):this.fileName()),this.mimeType(Types.pString(e.MimeType)),this.size(Types.pInt(e.Size)),this.hash(Types.pString(e.Hash)),this.parseActions(e),this.uploadUid(this.hash()),this.uploaded(!0),this.uploadStarted(!1)},CAttachmentModel.prototype.parseActions=function(e){this.thumbUrlInQueue(""!==Types.pString(e.ThumbnailUrl)?Types.pString(e.ThumbnailUrl)+"/"+Math.random():""),this.commonParseActions(e),this.isMessageType()?""!==this.folderName()&&""!==this.messageUid()?(this.hasAction("view")||this.actions.unshift("view"),this.otherTemplates.push({name:"%ModuleName%_PrintMessageView",data:this.messagePart})):this.actions(_.without(this.actions(),"view")):this.commonExcludeActions()},CAttachmentModel.prototype.errorFromUpload=function(){this.uploaded(!0),this.uploadError(!0),this.uploadStarted(!1),this.statusText(TextUtils.i18n("COREWEBCLIENT/ERROR_UPLOAD_UNKNOWN"))},module.exports=CAttachmentModel;