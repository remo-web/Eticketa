"use strict";function CFolderListModel(){this.iAccountId=0,this.initialized=ko.observable(!1),this.bExpandFolders=!1,this.expandNames=ko.observableArray([]),this.collection=ko.observableArray([]),this.options=ko.observableArray([]),this.sNamespaceFolder="",this.oStarredFolder=null,this.oNamedCollection={},this.aLinedCollection=[];var e=this,t=function(e){return function(t){t&&t.type(e)}},o=function(t){return{read:function(){return this.collection(),t()?t().fullName():""},write:function(e){t(this.getFolderByFullName(e))},owner:e}};this.currentFolder=ko.observable(null),this.inboxFolder=ko.observable(null),this.sentFolder=ko.observable(null),this.draftsFolder=ko.observable(null),this.spamFolder=ko.observable(null),this.trashFolder=ko.observable(null),this.aTemplateFolders=[],this.countsCompletelyFilled=ko.observable(!1),this.inboxFolder.subscribe(t(Enums.FolderTypes.User),this,"beforeChange"),this.sentFolder.subscribe(t(Enums.FolderTypes.User),this,"beforeChange"),this.draftsFolder.subscribe(t(Enums.FolderTypes.User),this,"beforeChange"),this.spamFolder.subscribe(t(Enums.FolderTypes.User),this,"beforeChange"),this.trashFolder.subscribe(t(Enums.FolderTypes.User),this,"beforeChange"),this.inboxFolder.subscribe(t(Enums.FolderTypes.Inbox)),this.sentFolder.subscribe(t(Enums.FolderTypes.Sent)),this.draftsFolder.subscribe(t(Enums.FolderTypes.Drafts)),this.spamFolder.subscribe(t(Enums.FolderTypes.Spam)),this.trashFolder.subscribe(t(Enums.FolderTypes.Trash)),this.inboxFolderFullName=ko.computed(o(this.inboxFolder)),this.sentFolderFullName=ko.computed(o(this.sentFolder)),this.draftsFolderFullName=ko.computed(o(this.draftsFolder)),this.spamFolderFullName=ko.computed(o(this.spamFolder)),this.trashFolderFullName=ko.computed(o(this.trashFolder)),this.currentFolderFullName=ko.computed(o(this.currentFolder)),this.currentFolderType=ko.computed(function(){return this.currentFolder()?this.currentFolder().type():Enums.FolderTypes.User},this),this.sDelimiter=""}var _=require("underscore"),ko=require("knockout"),Types=require("%PathToCoreWebclientModule%/js/utils/Types.js"),Utils=require("%PathToCoreWebclientModule%/js/utils/Common.js"),Storage=require("%PathToCoreWebclientModule%/js/Storage.js"),Settings=require("modules/%ModuleName%/js/Settings.js"),CFolderModel=require("modules/%ModuleName%/js/models/CFolderModel.js");CFolderListModel.prototype.getFoldersCount=function(){return this.aLinedCollection.length},CFolderListModel.prototype.getTotalMessageCount=function(){var e=0;return _.each(this.oNamedCollection,function(t){e+=t.messageCount()},this),e},CFolderListModel.prototype.getFoldersWithoutCountInfo=function(){return _.compact(_.map(this.oNamedCollection,function(e,t){return e.canBeSelected()&&!e.hasExtendedInfo()?t:null}))},CFolderListModel.prototype.getNamesOfFoldersToRefresh=function(){var e=[this.inboxFolderFullName(),this.spamFolderFullName(),this.currentFolderFullName()];return _.each(this.oNamedCollection,function(t){t.isAlwaysRefresh()&&e.push(t.fullName())}),_.uniq(e)},CFolderListModel.prototype.setCurrentFolder=function(e,t){var o=this.getFolderByFullName(e);null!==o&&o.canBeSelected()||(o=this.inboxFolder()),null!==o&&(this.currentFolder()&&(this.currentFolder().selected(!1),this.oStarredFolder&&this.oStarredFolder.selected(!1)),this.currentFolder(o),t===Enums.FolderFilter.Flagged?this.oStarredFolder&&this.oStarredFolder.selected(!0):this.currentFolder().selected(!0))},CFolderListModel.prototype.getFolderByFullName=function(e){var t=this.oNamedCollection[e];return t||null},CFolderListModel.prototype.renameFolder=function(e,t,o){var s=this.oNamedCollection[e];s.fullName(t),s.fullNameHash(o),this.oNamedCollection[t]=s,delete this.oNamedCollection[e]},CFolderListModel.prototype.changeTemplateFolder=function(e,t){Settings.AllowTemplateFolders&&(t?this.aTemplateFolders.push(e):this.aTemplateFolders=_.without(this.aTemplateFolders,e))},CFolderListModel.prototype.parse=function(e,t,o){var s=Types.pString(t.Namespace),l=t.Folders["@Collection"];s.length>0&&(this.sNamespaceFolder=s.substring(0,s.length-1)),this.iAccountId=e,this.initialized(!0),this.bExpandFolders=Settings.FoldersExpandedByDefault&&!Storage.hasData("folderAccordion"),Storage.hasData("folderAccordion")||Storage.setData("folderAccordion",[]),this.oNamedCollection={},this.aLinedCollection=[],this.collection(this.parseRecursively(l,o))},CFolderListModel.prototype.destroyFolders=function(){Utils.destroyObjectWithObservables(this,"oStarredFolder"),this.collection.removeAll(),this.aLinedCollection=[];for(var e in this.oNamedCollection)Utils.destroyObjectWithObservables(this.oNamedCollection,e)},CFolderListModel.prototype.parseRecursively=function(e,t,o,s){var l=[],r=0,i=0,d=null,n=null,a="",u=null,h=[];if(s=s||"",void 0===o&&(o=-1),o++,_.isArray(e)){for(i=e.length;r<i;r++){switch(a=Types.pString(e[r].FullNameRaw),n=t[a],d=n||new CFolderModel(this.iAccountId),u=d.parse(e[r],s,this.sNamespaceFolder),delete t[a],this.bExpandFolders&&null!==u&&(d.expanded(!0),this.expandNames().push(Types.pString(e[r].Name))),d.setDisplayedLevel(o),d.type()){case Enums.FolderTypes.Inbox:this.inboxFolder(d),this.sDelimiter=d.sDelimiter;break;case Enums.FolderTypes.Sent:this.sentFolder(d);break;case Enums.FolderTypes.Drafts:this.draftsFolder(d);break;case Enums.FolderTypes.Trash:this.trashFolder(d);break;case Enums.FolderTypes.Spam:this.spamFolder(d);break;case Enums.FolderTypes.Template:this.aTemplateFolders.push(d.fullName())}this.oNamedCollection[d.fullName()]=d,this.aLinedCollection.push(d),l.push(d),null===u&&d.type()===Enums.FolderTypes.Inbox?(this.createStarredFolder(d.fullName(),o),this.oStarredFolder&&l.push(this.oStarredFolder)):null!==u&&(h=d.bNamespace&&d.type()===Enums.FolderTypes.Inbox?this.parseRecursively(u["@Collection"],t,o-1,d.fullName()):this.parseRecursively(u["@Collection"],t,o,d.fullName()),d.type()===Enums.FolderTypes.Inbox&&(this.createStarredFolder(d.fullName(),o),d.bNamespace?this.oStarredFolder&&h.unshift(this.oStarredFolder):this.oStarredFolder&&l.push(this.oStarredFolder)),d.subfolders(h))}this.bExpandFolders&&Storage.setData("folderAccordion",this.expandNames())}return l},CFolderListModel.prototype.createStarredFolder=function(e,t){this.oStarredFolder=new CFolderModel(this.iAccountId),this.oStarredFolder.initStarredFolder(t,e)},CFolderListModel.prototype.repopulateLinedCollection=function(){function e(o){_.each(o,function(o){t.aLinedCollection.push(o),o.subfolders().length>0&&e(o.subfolders())})}var t=this;return this.aLinedCollection=[],e(this.collection()),this.aLinedCollection},CFolderListModel.prototype.getOptions=function(e,t,o,s,l){t=!!t,o=!!o,s=!!s,l=!!l;var r=[];return _.each(this.aLinedCollection,function(e){if(e&&!e.bVirtual&&(!o||Enums.FolderTypes.Inbox!==e.type())&&(!l||e.subscribed())){var i=new Array(e.getDisplayedLevel()+1).join("    ");r.push({name:e.name(),fullName:e.fullName(),displayName:i+e.name(),translatedDisplayName:i+e.displayName(),disable:!t&&e.isSystem()||!s&&!e.canBeSelected()})}}),""!==e&&r.unshift({name:e,fullName:"",displayName:e,translatedDisplayName:e,disable:!1}),r},module.exports=CFolderListModel;