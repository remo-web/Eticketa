"use strict";function CFolderModel(e){this.iAccountId=e,this.bNamespace=!1,this.iDisplayedLevel=0,this.bIgnoreImapSubscription=Settings.IgnoreImapSubscription,this.bAllowTemplateFolders=Settings.AllowTemplateFolders,this.isTemplateStorage=ko.observable(!1),this.bAllowAlwaysRefreshFolders=Settings.AllowAlwaysRefreshFolders,this.isAlwaysRefresh=ko.observable(!1),this.sDelimiter="",this.bExists=!0,this.sUidNext="",this.sHash="",this.messageCount=ko.observable(0),this.unseenMessageCount=ko.observable(0),this.iRealUnseenMessageCount=0,this.hasExtendedInfo=ko.observable(!1),this.fullName=ko.observable(""),this.fullNameHash=ko.observable(""),this.bSelectable=!0,this.subscribed=ko.observable(!0),this.name=ko.observable(""),this.nameForEdit=ko.observable(""),this.subfolders=ko.observableArray([]),this.subfoldersMessagesCount=ko.observable(0),this.type=ko.observable(Enums.FolderTypes.User),this.bVirtual=!1,this.selected=ko.observable(!1),this.expanded=ko.observable(!1),this.recivedAnim=ko.observable(!1).extend({autoResetToFalse:500}),this.edited=ko.observable(!1),this.aMessagesDictionaryUids=[],this.oUids={},this.aResponseHandlers=[],this.aRequestedUids=[],this.aRequestedThreadUids=[],this.requestedLists=[],this.hasChanges=ko.observable(!1),this.oRelevantInformationLastMoment=null,this.bSubscribtionsInitialized=!1}var _=require("underscore"),$=require("jquery"),ko=require("knockout"),moment=require("moment"),Utils=require("%PathToCoreWebclientModule%/js/utils/Common.js"),TextUtils=require("%PathToCoreWebclientModule%/js/utils/Text.js"),Types=require("%PathToCoreWebclientModule%/js/utils/Types.js"),Ajax=require("modules/%ModuleName%/js/Ajax.js"),Api=require("%PathToCoreWebclientModule%/js/Api.js"),App=require("%PathToCoreWebclientModule%/js/App.js"),Routing=require("%PathToCoreWebclientModule%/js/Routing.js"),Storage=require("%PathToCoreWebclientModule%/js/Storage.js"),Popups=require("%PathToCoreWebclientModule%/js/Popups.js"),ConfirmPopup=require("%PathToCoreWebclientModule%/js/popups/ConfirmPopup.js"),LinksUtils=require("modules/%ModuleName%/js/utils/Links.js"),AccountList=require("modules/%ModuleName%/js/AccountList.js"),MailCache=null,MessagesDictionary=require("modules/%ModuleName%/js/MessagesDictionary.js"),Settings=require("modules/%ModuleName%/js/Settings.js"),CMessageModel=require("modules/%ModuleName%/js/models/CMessageModel.js"),CUidListModel=require("modules/%ModuleName%/js/models/CUidListModel.js");CFolderModel.prototype.requireMailCache=function(){null===MailCache&&(MailCache=require("modules/%ModuleName%/js/Cache.js"))},CFolderModel.prototype.setDisplayedLevel=function(e){this.iDisplayedLevel=e},CFolderModel.prototype.getDisplayedLevel=function(){return this.iDisplayedLevel},CFolderModel.prototype.getMessageByUid=function(e){return MessagesDictionary.get([this.iAccountId,this.fullName(),e])},CFolderModel.prototype.removeMessageFromDict=function(e){MessagesDictionary.remove([this.iAccountId,this.fullName(),e]),this.aMessagesDictionaryUids=_.without(this.aMessagesDictionaryUids,e),this.aRequestedUids=_.without(this.aRequestedUids,e),this.aRequestedThreadUids=_.without(this.aRequestedThreadUids,e)},CFolderModel.prototype.updateLastAccessTime=function(e){_.each(e,function(e){var s=this.getMessageByUid(e);s&&s.updateLastAccessTime()},this)},CFolderModel.prototype.doForAllMessages=function(e){var s=[];_.each(this.aMessagesDictionaryUids,function(t){var i=this.getMessageByUid(t);i?e(i):s.push(t)},this),s.length>0&&(this.aMessagesDictionaryUids=_.difference(this.aMessagesDictionaryUids,s),this.aRequestedUids=_.difference(this.aRequestedUids,s),this.aRequestedThreadUids=_.difference(this.aRequestedThreadUids,s))},CFolderModel.prototype.getFlaggedMessageUids=function(){var e=[];return this.doForAllMessages(function(s){s.flagged()&&e.push(s.uid())}),e},CFolderModel.prototype.setMessageUnflaggedByUid=function(e){var s=this.getMessageByUid(e);s&&s.flagged(!1)},CFolderModel.prototype.hideThreadMessages=function(e){_.each(e.threadUids(),function(e){var s=this.getMessageByUid(e);s&&(s.deleted()||(s.threadShowAnimation(!1),s.threadHideAnimation(!0),setTimeout(function(){s.threadHideAnimation(!1)},1e3)))},this)},CFolderModel.prototype.getThreadMessages=function(e){var s=[],t=[],i=[],o=0,r=null;return _.each(e.threadUids(),function(n){if(o<e.threadCountForLoad()){var a=this.getMessageByUid(n);a?a.deleted()||(a.markAsThreadPart(50,e.uid()),s.push(a),i.push(a.uid()),o++,r=a):(t.push(n),i.push(n),o++)}else i.push(n)},this),e.threadLoading()||this.loadThreadMessages(t),e.changeThreadUids(i,s.length),r&&s.length<e.threadUids().length&&r.showNextLoadingLink(_.bind(e.increaseThreadCountForLoad,e)),this.addThreadUidsToUidLists(e.uid(),e.threadUids()),s},CFolderModel.prototype.computeThreadData=function(e){var s=0,t=!1,i=[],o=[],r=e.oFrom.getFirstEmail();_.each(e.threadUids(),function(e){var n=this.getMessageByUid(e),a="";n&&!n.deleted()&&(n.seen()||s++,n.flagged()&&(t=!0),(a=n.oFrom.getFirstEmail())!==r&&-1===$.inArray(a,o)&&(o.push(a),a===AccountList.getEmail()?i.push(TextUtils.i18n("%MODULENAME%/LABEL_ME_SENDER")):i.push(n.oFrom.getFirstDisplay())))},this),e.threadUnreadCount(s),e.partialFlagged(t)},CFolderModel.prototype.addThreadUidsToUidLists=function(e,s){_.each(this.oUids,function(t){t.addThreadUids(e,s)})},CFolderModel.prototype.loadThreadMessages=function(e){if(e.length>0){var s={Folder:this.fullName(),Uids:e};Ajax.send("GetMessagesByUids",s,this.onGetMessagesByUidsResponse,this)}},CFolderModel.prototype.getThreadCheckedUidsFromList=function(e){var s=this,t=[];return _.each(e,function(e){e.threadCount()>0&&!e.threadOpened()&&_.each(e.threadUids(),function(e){var i=s.getMessageByUid(e);i&&!i.deleted()&&i.checked()&&t.push(e)})}),t},CFolderModel.prototype.parseAndCacheMessage=function(e,s,t){var i=e.Uid.toString(),o=!1,r=this.getMessageByUid(i);return r||(o=!0,r=new CMessageModel),r.parse(e,this.iAccountId,s,t),this.type()===Enums.FolderTypes.Inbox&&o&&r.flagged()&&(this.requireMailCache(),MailCache.increaseStarredCount()),MessagesDictionary.set([this.iAccountId,this.fullName(),i],r),o&&(this.aRequestedUids=_.without(this.aRequestedUids,i),this.aRequestedThreadUids=_.without(this.aRequestedThreadUids,i),-1===_.indexOf(this.aMessagesDictionaryUids,i)&&this.aMessagesDictionaryUids.push(i)),r},CFolderModel.prototype.onGetMessagesByUidsResponse=function(e,s){var t=e.Result;t&&"Collection/MessageCollection"===t["@Object"]&&(_.each(t["@Collection"],function(e){this.parseAndCacheMessage(e,!0,!0)},this),this.requireMailCache(),MailCache.showOpenedThreads(this.fullName()))},CFolderModel.prototype.addRequestedUids=function(e){this.aRequestedUids=_.union(this.aRequestedUids,e)},CFolderModel.prototype.hasUidBeenRequested=function(e){return-1!==_.indexOf(this.aRequestedUids,e)},CFolderModel.prototype.addRequestedThreadUids=function(e){this.aRequestedThreadUids=_.union(this.aRequestedThreadUids,e)},CFolderModel.prototype.hasThreadUidBeenRequested=function(e){return-1!==_.indexOf(this.aRequestedThreadUids,e)},CFolderModel.prototype.hasListBeenRequested=function(e){var s=_.where(this.requestedLists,e).length>0;return s||this.requestedLists.push(e),s},CFolderModel.prototype.markMessageReplied=function(e,s){var t=this.getMessageByUid(e);if(t)switch(s){case Enums.ReplyType.Reply:case Enums.ReplyType.ReplyAll:t.answered(!0);break;case Enums.ReplyType.Forward:case Enums.ReplyType.ForwardAsAttach:t.forwarded(!0)}},CFolderModel.prototype.removeAllMessages=function(){var e=this.oUids,s=this.aMessagesDictionaryUids;this.aMessagesDictionaryUids=[],this.aRequestedUids=[],this.aRequestedThreadUids=[],this.requestedLists=[],this.oUids={},this.messageCount(0),this.unseenMessageCount(0),this.iRealUnseenMessageCount=0,this.getUidList("","",Settings.MessagesSortBy.DefaultSortBy,Settings.MessagesSortBy.DefaultSortOrder).resultCount(0),MailCache.currentMessage()&&MailCache.currentMessage().accountId()===this.iAccountId&&MailCache.currentMessage().folder()===this.fullName()&&(Utils.log("removeAllMessages, the current message is in the list to remove",MailCache.currentMessage()?{accountId:MailCache.currentMessage().accountId(),folder:MailCache.currentMessage().folder(),uid:MailCache.currentMessage().uid()}:null),s=_.without(s,MailCache.currentMessage().uid())),_.each(s,function(e){this.removeMessageFromDict(e)},this),s=null,_.each(e,function(e){e.clearData()}),e=null},CFolderModel.prototype.removeAllMessageListsFromCacheIfHasChanges=function(){this.hasChanges()&&(this.oUids={},this.requestedLists=[],this.aRequestedThreadUids=[],this.hasChanges(!1))},CFolderModel.prototype.removeFlaggedMessageListsFromCache=function(){_.each(this.oUids,function(e){e.filters()===Enums.FolderFilter.Flagged&&e.clearData()},this)},CFolderModel.prototype.removeUnseenMessageListsFromCache=function(){_.each(this.oUids,function(e){e.filters()===Enums.FolderFilter.Unseen&&e.clearData()},this)},CFolderModel.prototype.setRelevantInformation=function(e,s,t,i,o){var r=this.hasExtendedInfo()&&(this.sHash!==s||this.iRealUnseenMessageCount!==i||this.unseenMessageCount()!==i);return this.sHash=s,this.iRealUnseenMessageCount=i,this.hasExtendedInfo()&&o||(this.sUidNext=e,this.messageCount(t),this.unseenMessageCount(i),0===i&&this.unseenMessageCount.valueHasMutated()),this.hasExtendedInfo(!0),r&&this.markHasChanges(),this.oRelevantInformationLastMoment=moment(),r},CFolderModel.prototype.increaseCountIfHasNotInfo=function(){this.hasExtendedInfo()||this.messageCount(this.messageCount()+1)},CFolderModel.prototype.markHasChanges=function(){this.hasChanges(!0)},CFolderModel.prototype.addMessagesCountsDiff=function(e,s){var t=this.messageCount()+e,i=this.unseenMessageCount()+s;t<0&&(t=0),this.messageCount(t),i<0&&(i=0),i>t&&(i=t),this.unseenMessageCount(i)},CFolderModel.prototype.markDeletedByUids=function(e){var s=0,t=0;return _.each(e,function(e){var i=this.getMessageByUid(e);i&&(s++,i.seen()||t++,i.deleted(!0))},this),this.addMessagesCountsDiff(-s,-t),{MinusDiff:s,UnseenMinusDiff:t}},CFolderModel.prototype.revertDeleted=function(e){var s=0,t=0;return _.each(e,function(e){var i=this.getMessageByUid(e);i&&i.deleted()&&(s++,i.seen()||t++,i.deleted(!1))},this),this.addMessagesCountsDiff(s,t),{PlusDiff:s,UnseenPlusDiff:t}},CFolderModel.prototype.commitDeleted=function(e){_.each(e,_.bind(function(e){MailCache.currentMessage()&&MailCache.currentMessage().accountId()===this.iAccountId&&MailCache.currentMessage().folder()===this.fullName()&&MailCache.currentMessage().uid()===e?Utils.log("commitDeleted, the current message is to remove",MailCache.currentMessage()?{accountId:MailCache.currentMessage().accountId(),folder:MailCache.currentMessage().folder(),uid:MailCache.currentMessage().uid()}:null):this.removeMessageFromDict(e),this.aMessagesDictionaryUids=_.without(this.aMessagesDictionaryUids,e),this.aRequestedUids=_.without(this.aRequestedUids,e),this.aRequestedThreadUids=_.without(this.aRequestedThreadUids,e)},this)),_.each(this.oUids,function(s){s.deleteUids(e)})},CFolderModel.prototype.getUidList=function(e,s,t,i){var o=JSON.stringify([e,s,t,i]),r=null;return void 0===this.oUids[o]&&((r=new CUidListModel).iAccountId=this.iAccountId,r.sFullName=this.fullName(),r.search(e),r.filters(s),r.sortBy(t),r.sortOrder(i),this.oUids[o]=r),this.oUids[o]},CFolderModel.prototype.initStarredFolder=function(e,s){this.bVirtual=!0,this.setDisplayedLevel(e),this.fullName(s),this.name(TextUtils.i18n("%MODULENAME%/LABEL_FOLDER_STARRED")),this.type(Enums.FolderTypes.Starred),this.initSubscriptions(""),this.initComputedFields(!0)},CFolderModel.prototype.parse=function(e,s,t){var i="",o=Enums.FolderTypes.User,r=Storage.getData("folderAccordion")||[];return"Object/Folder"===e["@Object"]?(i=Types.pString(e.Name),this.name(i),this.nameForEdit(i),this.fullName(Types.pString(e.FullNameRaw)),this.fullNameHash(Types.pString(e.FullNameHash)),this.sDelimiter=e.Delimiter,o=Types.pInt(e.Type),Settings.AllowTemplateFolders||o!==Enums.FolderTypes.Template||(o=Enums.FolderTypes.User),(Settings.AllowSpamFolder||o!==Enums.FolderTypes.Spam)&&this.type(o),this.isTemplateStorage(this.type()===Enums.FolderTypes.Template),this.bNamespace=t===this.fullName(),this.isAlwaysRefresh(Settings.AllowAlwaysRefreshFolders&&!!e.AlwaysRefresh),this.subscribed(!!Settings.IgnoreImapSubscription||e.IsSubscribed),this.bSelectable=e.IsSelectable,this.bExists=e.Exists,e.Extended&&this.setRelevantInformation(e.Extended.UidNext.toString(),e.Extended.Hash,e.Extended.MessageCount,e.Extended.MessageUnseenCount,!1),_.find(r,function(e){return e===this.name()},this)&&this.expanded(!0),this.initSubscriptions(s),this.initComputedFields(),App.broadcastEvent("%ModuleName%::ParseFolder::after",this),e.SubFolders):null},CFolderModel.prototype.initSubscriptions=function(e){this.bSubscribtionsInitialized||(this.requireMailCache(),this.unseenMessageCount.subscribe(function(){_.delay(_.bind(function(){MailCache.countMessages(this)},this),1e3)},this),this.subscribed.subscribe(function(){if(e){var s=MailCache.folderList().getFolderByFullName(e);s&&MailCache.countMessages(s)}},this),this.edited.subscribe(function(e){!1===e&&this.nameForEdit(this.name())},this),this.hasChanges.subscribe(function(){this.requestedLists=[]},this),this.bSubscribtionsInitialized=!0)},CFolderModel.prototype.initComputedFields=function(){this.routingHash=ko.computed(function(){return this.bVirtual?Routing.buildHashFromArray(LinksUtils.getMailbox(this.fullName(),1,"","",Enums.FolderFilter.Flagged)):Routing.buildHashFromArray(LinksUtils.getMailbox(this.fullName()))},this),this.isSystem=ko.computed(function(){return this.type()!==Enums.FolderTypes.User},this),this.withoutThreads=ko.computed(function(){return this.type()===Enums.FolderTypes.Drafts||this.type()===Enums.FolderTypes.Spam||this.type()===Enums.FolderTypes.Trash},this),this.enableEmptyFolder=ko.computed(function(){return(this.type()===Enums.FolderTypes.Spam||this.type()===Enums.FolderTypes.Trash)&&this.messageCount()>0},this),this.virtualEmpty=ko.computed(function(){return this.bVirtual&&0===this.messageCount()},this),this.hasSubscribedSubfolders=ko.computed(function(){return _.any(this.subfolders(),function(e){return e.subscribed()})},this),this.canExpand=ko.computed(function(){return!this.bNamespace&&this.hasSubscribedSubfolders()},this),this.unseenMessagesCountToShow=ko.computed(function(){return!App.isMobile()&&this.canExpand()?this.unseenMessageCount()+this.subfoldersMessagesCount():this.unseenMessageCount()},this),this.showUnseenMessagesCount=ko.computed(function(){return this.unseenMessagesCountToShow()>0&&this.type()!==Enums.FolderTypes.Drafts},this),this.showMessagesCount=ko.computed(function(){return this.messageCount()>0&&(this.type()===Enums.FolderTypes.Drafts||Settings.AllowShowMessagesCountInFolderList&&Settings.showMessagesCountInFolderList())},this),this.visible=ko.computed(function(){return this.subscribed()||this.isSystem()||this.hasSubscribedSubfolders()},this),this.canBeSelected=ko.computed(function(){return this.bExists&&this.bSelectable&&this.subscribed()},this),this.canSubscribe=ko.computed(function(){return!Settings.IgnoreImapSubscription&&!this.isSystem()&&this.bExists&&this.bSelectable},this),this.canDelete=ko.computed(function(){return!this.isSystem()&&this.hasExtendedInfo()&&0===this.messageCount()&&0===this.subfolders().length},this),this.canRename=this.canSubscribe,this.visibleTemplateTrigger=ko.computed(function(){return Settings.AllowTemplateFolders&&(this.bSelectable&&!this.isSystem()||this.isTemplateStorage())},this),this.templateButtonHint=ko.computed(function(){return this.visibleTemplateTrigger()?this.isTemplateStorage()?TextUtils.i18n("%MODULENAME%/ACTION_TURN_TEMPLATE_FOLDER_OFF"):TextUtils.i18n("%MODULENAME%/ACTION_TURN_TEMPLATE_FOLDER_ON"):""},this),this.alwaysRefreshButtonHint=ko.computed(function(){return Settings.AllowAlwaysRefreshFolders?this.isAlwaysRefresh()?TextUtils.i18n("%MODULENAME%/ACTION_TURN_ALWAYS_REFRESH_OFF"):TextUtils.i18n("%MODULENAME%/ACTION_TURN_ALWAYS_REFRESH_ON"):""},this),this.subscribeButtonHint=ko.computed(function(){return this.canSubscribe()?this.subscribed()?TextUtils.i18n("%MODULENAME%/ACTION_HIDE_FOLDER"):TextUtils.i18n("%MODULENAME%/ACTION_SHOW_FOLDER"):""},this),this.deleteButtonHint=ko.computed(function(){return this.canDelete()?TextUtils.i18n("%MODULENAME%/ACTION_DELETE_FOLDER"):""},this),this.usedAs=ko.computed(function(){switch(this.type()){case Enums.FolderTypes.Inbox:return TextUtils.i18n("%MODULENAME%/LABEL_USED_AS_INBOX");case Enums.FolderTypes.Sent:return TextUtils.i18n("%MODULENAME%/LABEL_USED_AS_SENT");case Enums.FolderTypes.Drafts:return TextUtils.i18n("%MODULENAME%/LABEL_USED_AS_DRAFTS");case Enums.FolderTypes.Trash:return TextUtils.i18n("%MODULENAME%/LABEL_USED_AS_TRASH");case Enums.FolderTypes.Spam:return TextUtils.i18n("%MODULENAME%/LABEL_USED_AS_SPAM")}return""},this),this.displayName=ko.computed(function(){switch(this.type()){case Enums.FolderTypes.Inbox:return TextUtils.i18n("%MODULENAME%/LABEL_FOLDER_INBOX");case Enums.FolderTypes.Sent:return TextUtils.i18n("%MODULENAME%/LABEL_FOLDER_SENT");case Enums.FolderTypes.Drafts:return TextUtils.i18n("%MODULENAME%/LABEL_FOLDER_DRAFTS");case Enums.FolderTypes.Trash:return TextUtils.i18n("%MODULENAME%/LABEL_FOLDER_TRASH");case Enums.FolderTypes.Spam:return TextUtils.i18n("%MODULENAME%/LABEL_FOLDER_SPAM")}return this.name()},this)},CFolderModel.prototype.onGetMessageResponse=function(e,s){var t=e.Result,i=s.Parameters,o=null,r=t?t.Uid.toString():i.Uid.toString(),n=this.getMessageByUid(r),a=!!n&&n.selected(),l=!1;t?n=this.parseAndCacheMessage(t,!1,!1):(a&&(Api.showErrorByCode(e,TextUtils.i18n("COREWEBCLIENT/ERROR_UNKNOWN")),Routing.replaceHashWithoutMessageUid(r)),n=null,l=!0),(o=this.aResponseHandlers[r])&&(o.handler.call(o.context,n,r,l?e:null),delete this.aResponseHandlers[r])},CFolderModel.prototype.getCompletelyFilledMessage=function(e,s,t){var i=this.getMessageByUid(e),o={AccountID:i?i.accountId():0,Folder:this.fullName(),Uid:e,MessageBodyTruncationThreshold:Settings.MessageBodyTruncationThreshold};e.length>0&&(i&&i.completelyFilled()&&!i.truncated()?s&&t&&s.call(t,i,e):(s&&t&&(this.aResponseHandlers[e]={handler:s,context:t}),Ajax.send("GetMessage",o,this.onGetMessageResponse,this)))},CFolderModel.prototype.showExternalPictures=function(e){var s=this.getMessageByUid(e);void 0!==s&&s.showExternalPictures()},CFolderModel.prototype.alwaysShowExternalPicturesForSender=function(e){this.doForAllMessages(function(s){var t=s.oFrom.aCollection;t.length>0&&t[0].sEmail===e&&s.alwaysShowExternalPicturesForSender()})},CFolderModel.prototype.executeGroupOperation=function(e,s,t){var i=0;this.doForAllMessages(function(o){s.length>0?_.each(s,function(s){o.uid()===s&&o[e]()!==t&&(o[e](t),i++)}):o[e](t)}),0===s.length&&(i=t?this.unseenMessageCount():this.messageCount()-this.unseenMessageCount()),"seen"===e&&i>0&&(t?this.addMessagesCountsDiff(0,-i):this.addMessagesCountsDiff(0,i),this.markHasChanges())},CFolderModel.prototype.emptyFolder=function(){var e=TextUtils.i18n("%MODULENAME%/CONFIRM_EMPTY_FOLDER"),s=_.bind(this.clearFolder,this);this.enableEmptyFolder()&&Popups.showPopup(ConfirmPopup,[e,s])},CFolderModel.prototype.clearFolder=function(e){this.enableEmptyFolder()&&e&&(Ajax.send("ClearFolder",{Folder:this.fullName()}),this.requireMailCache(),MailCache.onClearFolder(this),this.removeAllMessages())},CFolderModel.prototype.onAccordion=function(e,s){var t=!this.expanded(),i=Storage.getData("folderAccordion")||[];t?i.push(this.name()):i=_.reject(i,function(e){return e===this.name()},this),Storage.setData("folderAccordion",i),this.expanded(t),this.requireMailCache(),MailCache.countMessages(this),s&&s.stopPropagation()},CFolderModel.prototype.executeUnseenFilter=function(){return this.unseenMessagesCountToShow()>this.unseenMessageCount()&&this.onAccordion(),!(this.unseenMessageCount()>0)||(this.requireMailCache(),MailCache.waitForUnseenMessages(!0),Routing.setHash(LinksUtils.getMailbox(this.fullName(),1,"","",Enums.FolderFilter.Unseen))&&MailCache.changeCurrentMessageList(this.fullName(),1,"",Enums.FolderFilter.Unseen,Settings.MessagesSortBy.DefaultSortBy,Settings.MessagesSortBy.DefaultSortOrder),!1)},CFolderModel.prototype.onDeleteClick=function(){var e=TextUtils.i18n("%MODULENAME%/CONFIRM_DELETE_FOLDER"),s=_.bind(this.deleteAfterConfirm,this);this.canDelete()?Popups.showPopup(ConfirmPopup,[e,s]):App.broadcastEvent("%ModuleName%::AttemptDeleteNonemptyFolder")},CFolderModel.prototype.deleteAfterConfirm=function(e){if(e){var s=MailCache.editedFolderList(),t=this.fullName(),i=function(e){return t===e.fullName()||(e.subfolders.remove(i),!1)};s.collection.remove(i),Ajax.send("DeleteFolder",{AccountID:AccountList.editedId(),Folder:this.fullName()},function(e){e.Result||(Api.showErrorByCode(e,TextUtils.i18n("%MODULENAME%/ERROR_DELETE_FOLDER")),MailCache.getFolderList(AccountList.editedId()))},this)}},CFolderModel.prototype.onSubscribeClick=function(){if(this.canSubscribe()){var e={AccountID:AccountList.editedId(),Folder:this.fullName(),SetAction:!this.subscribed()};this.subscribed(!this.subscribed()),Ajax.send("SubscribeFolder",e,function(e){e.Result||(this.subscribed()?Api.showErrorByCode(e,TextUtils.i18n("%MODULENAME%/ERROR_SUBSCRIBE_FOLDER")):Api.showErrorByCode(e,TextUtils.i18n("%MODULENAME%/ERROR_UNSUBSCRIBE_FOLDER")),MailCache.getFolderList(AccountList.editedId()))},this)}},CFolderModel.prototype.afterMove=function(e){_.each(e,function(e){_.isFunction(e.afterMove)&&e.afterMove()})},CFolderModel.prototype.cancelNameEdit=function(){this.edited(!1)},CFolderModel.prototype.applyNameEdit=function(){if(this.name()!==this.nameForEdit()){var e={AccountID:AccountList.editedId(),PrevFolderFullNameRaw:this.fullName(),NewFolderNameInUtf8:this.nameForEdit()};Ajax.send("RenameFolder",e,_.bind(this.onResponseFolderRename,this),this),this.name(this.nameForEdit())}this.edited(!1)},CFolderModel.prototype.onResponseFolderRename=function(e,s){if(e&&e.Result){if(e&&e.Result&&e.Result.FullName){MailCache.editedFolderList().renameFolder(this.fullName(),e.Result.FullName,e.Result.FullNameHash)}}else Api.showErrorByCode(e,TextUtils.i18n("%MODULENAME%/ERROR_RENAME_FOLDER")),MailCache.getFolderList(AccountList.editedId())},CFolderModel.prototype.triggerTemplateState=function(){if(this.visibleTemplateTrigger()){this.isTemplateStorage()?(this.type(Enums.FolderTypes.User),this.isTemplateStorage(!1)):(this.type(Enums.FolderTypes.Template),this.isTemplateStorage(!0)),MailCache.changeTemplateFolder(this.fullName(),this.isTemplateStorage());var e={FolderFullName:this.fullName(),SetTemplate:this.isTemplateStorage()};Ajax.send("SetTemplateFolderType",e,this.onSetTemplateFolderType,this)}},CFolderModel.prototype.onSetTemplateFolderType=function(e){e.Result||(Api.showErrorByCode(e,TextUtils.i18n("%MODULENAME%/ERROR_SETUP_SPECIAL_FOLDERS")),MailCache.getFolderList(AccountList.editedId()))},CFolderModel.prototype.triggerAlwaysRefreshState=function(){if(Settings.AllowAlwaysRefreshFolders){this.isAlwaysRefresh(!this.isAlwaysRefresh());var e={AccountID:this.iAccountId,FolderFullName:this.fullName(),AlwaysRefresh:this.isAlwaysRefresh()};Ajax.send("SetAlwaysRefreshFolder",e,this.onSetAlwaysRefreshFolder,this)}},CFolderModel.prototype.onSetAlwaysRefreshFolder=function(e){e.Result||(Api.showErrorByCode(e),MailCache.getFolderList(AccountList.editedId()))},module.exports=CFolderModel;