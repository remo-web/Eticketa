"use strict";function CMessageModel(){this.accountId=ko.observable(AccountList.currentId()),this.folder=ko.observable(""),this.uid=ko.observable(""),this.sUniq="",this.subject=ko.observable(""),this.emptySubject=ko.computed(function(){return""===$.trim(this.subject())},this),this.subjectForDisplay=ko.computed(function(){return this.emptySubject()?TextUtils.i18n("%MODULENAME%/LABEL_NO_SUBJECT"):this.subject()},this),this.messageId=ko.observable(""),this.size=ko.observable(0),this.friendlySize=ko.computed(function(){return TextUtils.getFriendlySize(this.size())},this),this.textSize=ko.observable(0),this.oDateModel=new CDateModel,this.fullDate=ko.observable(""),this.oFrom=new CAddressListModel,this.fullFrom=ko.observable(""),this.oTo=new CAddressListModel,this.to=ko.observable(""),this.fromOrToText=ko.observable(""),this.oCc=new CAddressListModel,this.cc=ko.observable(""),this.oBcc=new CAddressListModel,this.bcc=ko.observable(""),this.oReplyTo=new CAddressListModel,this.seen=ko.observable(!1),this.flagged=ko.observable(!1),this.partialFlagged=ko.observable(!1),this.answered=ko.observable(!1),this.forwarded=ko.observable(!1),this.hasAttachments=ko.observable(!1),this.hasIcalAttachment=ko.observable(!1),this.hasVcardAttachment=ko.observable(!1),this.folderObject=ko.computed(function(){return this.requireMailCache(),MailCache.getFolderByFullName(this.accountId(),this.folder())},this),this.threadsAllowed=ko.computed(function(){var e=AccountList.getAccount(this.accountId()),t=this.folderObject(),s=t&&(t.type()===Enums.FolderTypes.Drafts||t.type()===Enums.FolderTypes.Spam||t.type()===Enums.FolderTypes.Trash);return e&&e.threadingIsAvailable()&&!s},this),this.otherSendersAllowed=ko.computed(function(){var e=this.folderObject();return e&&e.type()!==Enums.FolderTypes.Drafts&&e.type()!==Enums.FolderTypes.Sent},this),this.threadPart=ko.observable(!1),this.threadPart.subscribe(function(){this.threadPart()&&this.partialFlagged(!1)},this),this.threadParentUid=ko.observable(""),this.threadUids=ko.observableArray([]),this.threadCount=ko.computed(function(){return this.threadUids().length},this),this.threadUnreadCount=ko.observable(0),this.threadOpened=ko.observable(!1),this.threadLoading=ko.observable(!1),this.threadLoadingVisible=ko.computed(function(){return this.threadsAllowed()&&this.threadOpened()&&this.threadLoading()},this),this.threadCountVisible=ko.computed(function(){return this.threadsAllowed()&&this.threadCount()>0&&!this.threadLoading()},this),this.threadCountHint=ko.computed(function(){return this.threadCount()>0?this.threadOpened()?TextUtils.i18n("%MODULENAME%/ACTION_FOLD_THREAD"):this.threadUnreadCount()>0?TextUtils.i18n("%MODULENAME%/ACTION_UNFOLD_THREAD_WITH_UNREAD",{},null,this.threadUnreadCount()):TextUtils.i18n("%MODULENAME%/ACTION_UNFOLD_THREAD"):""},this),this.threadCountForLoad=ko.observable(5),this.threadNextLoadingVisible=ko.observable(!1),this.threadNextLoadingLinkVisible=ko.observable(!1),this.threadFunctionLoadNext=null,this.threadShowAnimation=ko.observable(!1),this.threadHideAnimation=ko.observable(!1),this.importance=ko.observable(Enums.Importance.Normal),this.draftInfo=ko.observableArray([]),this.hash=ko.observable(""),this.sDownloadAsEmlUrl="",this.completelyFilled=ko.observable(!1),this.iLastAccessTime=0,this.updateLastAccessTime(),this.checked=ko.observable(!1),this.checked.subscribe(function(e){if(this.requireMailCache(),!this.threadOpened()&&MailCache.useThreadingInCurrentList()){var t=MailCache.folderList().getFolderByFullName(this.folder());_.each(this.threadUids(),function(s){var i=MessagesDictionary.get([t.iAccountId,t.fullName(),s]);i&&i.checked(e)})}},this),this.selected=ko.observable(!1),this.deleted=ko.observable(!1),this.truncated=ko.observable(!1),this.inReplyTo=ko.observable(""),this.references=ko.observable(""),this.readingConfirmationAddressee=ko.observable(""),this.sensitivity=ko.observable(Enums.Sensitivity.Nothing),this.isPlain=ko.observable(!1),this.text=ko.observable(""),this.textBodyForNewWindow=ko.observable(""),this.$text=null,this.rtl=ko.observable(!1),this.hasExternals=ko.observable(!1),this.isExternalsShown=ko.observable(!1),this.isExternalsAlwaysShown=ko.observable(!1),this.foundCids=ko.observableArray([]),this.attachments=ko.observableArray([]),this.safety=ko.observable(!1),this.sourceHeaders=ko.observable(""),this.date=ko.observable(""),this.textRaw=ko.observable(""),this.domMessageForPrint=ko.observable(null),this.Custom={}}var _=require("underscore"),$=require("jquery"),ko=require("knockout"),moment=require("moment"),TextUtils=require("%PathToCoreWebclientModule%/js/utils/Text.js"),Types=require("%PathToCoreWebclientModule%/js/utils/Types.js"),UrlUtils=require("%PathToCoreWebclientModule%/js/utils/Url.js"),App=require("%PathToCoreWebclientModule%/js/App.js"),Screens=require("%PathToCoreWebclientModule%/js/Screens.js"),CAddressListModel=require("%PathToCoreWebclientModule%/js/models/CAddressListModel.js"),CDateModel=require("%PathToCoreWebclientModule%/js/models/CDateModel.js"),MessageUtils=require("modules/%ModuleName%/js/utils/Message.js"),AccountList=require("modules/%ModuleName%/js/AccountList.js"),MailCache=null,MessagesDictionary=require("modules/%ModuleName%/js/MessagesDictionary.js"),CAttachmentModel=require("modules/%ModuleName%/js/models/CAttachmentModel.js");CMessageModel.prototype.requireMailCache=function(){null===MailCache&&(MailCache=require("modules/%ModuleName%/js/Cache.js"))},CMessageModel.prototype.updateLastAccessTime=function(){this.iLastAccessTime=moment().unix(),_.each(this.threadUids(),function(e){var t=MessagesDictionary.get([this.accountId(),this.folder(),e]);t&&t.updateLastAccessTime()},this)},CMessageModel.prototype.viewMessage=function(e){var t=this.getDomText(UrlUtils.getAppPath()),s="";this.textBodyForNewWindow(t.html()),s=$(this.domMessageForPrint()).html(),e&&($(e.document.body).html(s),e.focus(),_.each(this.attachments(),function(t){var s=$(e.document.body).find("[data-hash='download-"+t.hash()+"']");t.hasAction("download")?s.on("click",_.bind(t.executeAction,t,"download")):s.hide(),s=$(e.document.body).find("[data-hash='view-"+t.hash()+"']"),t.hasAction("view")?s.on("click",_.bind(t.executeAction,t,"view")):s.hide()},this))},CMessageModel.prototype.fillFromOrToText=function(){this.requireMailCache();var e=MailCache.getFolderByFullName(this.accountId(),this.folder()),t=AccountList.getAccount(this.accountId());e.type()===Enums.FolderTypes.Drafts||e.type()===Enums.FolderTypes.Sent?this.fromOrToText(this.oTo.getDisplay(TextUtils.i18n("%MODULENAME%/LABEL_ME_RECIPIENT"),t.email())):this.fromOrToText(this.oFrom.getDisplay(TextUtils.i18n("%MODULENAME%/LABEL_ME_SENDER"),t.email()))},CMessageModel.prototype.changeThreadUids=function(e,t){this.threadUids(e),this.threadLoading(t<Math.min(this.threadUids().length,this.threadCountForLoad()))},CMessageModel.prototype.showNextLoadingLink=function(e){this.threadNextLoadingLinkVisible()&&(this.threadNextLoadingVisible(!0),this.threadFunctionLoadNext=e)},CMessageModel.prototype.increaseThreadCountForLoad=function(){this.threadCountForLoad(this.threadCountForLoad()+5),this.requireMailCache(),MailCache.showOpenedThreads(this.folder())},CMessageModel.prototype.loadNextMessages=function(){this.threadFunctionLoadNext&&(this.threadFunctionLoadNext(),this.threadNextLoadingLinkVisible(!1),this.threadFunctionLoadNext=null)},CMessageModel.prototype.markAsThreadPart=function(e,t){var s=this;this.threadPart(!0),this.threadParentUid(t),this.threadUids([]),this.threadNextLoadingVisible(!1),this.threadNextLoadingLinkVisible(!0),this.threadFunctionLoadNext=null,this.threadHideAnimation(!1),setTimeout(function(){s.threadShowAnimation(!0)},e)},CMessageModel.prototype.parse=function(e,t,s,i){var o="",a="";i&&this.threadPart(s),this.threadPart()||this.threadParentUid(""),"Object/MessageListItem"===e["@Object"]&&(this.seen(!!e.IsSeen),this.flagged(!!e.IsFlagged),this.answered(!!e.IsAnswered),this.forwarded(!!e.IsForwarded),e.Custom&&(this.Custom=e.Custom)),"Object/Message"!==e["@Object"]&&"Object/MessageListItem"!==e["@Object"]||(this.Custom.Sensitivity=e.Sensitivity,this.accountId(t),this.folder(e.Folder),this.uid(Types.pString(e.Uid)),this.sUniq=this.accountId()+this.folder()+this.uid(),this.subject(Types.pString(e.Subject)),this.messageId(Types.pString(e.MessageId)),this.size(e.Size),this.textSize(e.TextSize),this.oDateModel.parse(e.TimeStampInUTC),this.oFrom.parse(e.From),this.oTo.parse(e.To),this.fillFromOrToText(),this.oCc.parse(e.Cc),this.oBcc.parse(e.Bcc),this.oReplyTo.parse(e.ReplyTo),this.fullDate(this.oDateModel.getFullDate()),this.fullFrom(this.oFrom.getFull()),this.to(this.oTo.getFull()),this.cc(this.oCc.getFull()),this.bcc(this.oBcc.getFull()),this.hasAttachments(!!e.HasAttachments),this.hasIcalAttachment(!!e.HasIcalAttachment),this.hasVcardAttachment(!!e.HasVcardAttachment),"Object/MessageListItem"===e["@Object"]&&i&&this.threadUids(_.map(e.Threads,function(e){return e.toString()},this)),this.importance(Types.pInt(e.Importance)),Enums.has("Importance",this.importance())||this.importance(Enums.Importance.Normal),this.sensitivity(Types.pInt(e.Sensitivity)),Enums.has("Sensitivity",this.sensitivity())||this.sensitivity(Enums.Sensitivity.Nothing),_.isArray(e.DraftInfo)&&this.draftInfo(e.DraftInfo),this.hash(Types.pString(e.Hash)),this.sDownloadAsEmlUrl=Types.pString(e.DownloadAsEmlUrl),"Object/Message"===e["@Object"]&&(this.truncated(e.Truncated),this.inReplyTo(e.InReplyTo),this.references(e.References),this.readingConfirmationAddressee(Types.pString(e.ReadingConfirmationAddressee)),o=Types.pString(e.Html),a=Types.pString(e.Plain),""!==o?(this.textRaw(e.HtmlRaw),this.text(o),this.isPlain(!1)):(this.textRaw(e.PlainRaw),this.text(""!==a?"<div>"+a+"</div>":""),this.isPlain(!0)),this.$text=null,this.isExternalsShown(!1),this.rtl(e.Rtl),this.hasExternals(!!e.HasExternals),this.foundCids(e.FoundedCIDs),this.parseAttachments(e.Attachments,t),this.safety(e.Safety),this.sourceHeaders(e.Headers),this.aExtend=e.Extend,this.completelyFilled(!0),App.broadcastEvent("MailWebclient::ParseMessage::after",{msg:this})),this.updateMomentDate())},CMessageModel.prototype.updateMomentDate=function(){this.date(this.oDateModel.getShortDate(moment().clone().subtract(1,"days").format("L")===moment.unix(this.oDateModel.getTimeStampInUTC()).format("L")))},CMessageModel.prototype.getDomText=function(e,t){var s=this.$text;return e=e||"",null!==this.$text&&""===e||(this.completelyFilled()?(this.$text=$(this.text()),this.showInlinePictures(e),!0===this.safety()&&this.alwaysShowExternalPicturesForSender(),t&&this.isExternalsShown()&&this.showExternalPictures(),s=this.$text):s=$("")),s.clone()},CMessageModel.prototype.getConvertedHtml=function(e,t){var s=this.getDomText(e,t);return s.length>0?s.wrap("<p>").parent().html():""},CMessageModel.prototype.parseAttachments=function(e,t){var s=e?e["@Collection"]:[];this.attachments([]),Types.isNonEmptyArray(s)&&this.attachments(_.map(s,function(e){var t=new CAttachmentModel;return t.setMessageData(this.folder(),this.uid()),t.parse(e,this.folder(),this.uid()),t},this))},CMessageModel.prototype.parseAddressArray=function(e){var t=[];return _.isArray(e)&&(t=_.map(e,function(e){var t=new CAddressModel;return t.parse(e),t})),t},CMessageModel.prototype.showInlinePictures=function(e){var t=_.map(this.attachments(),function(e){return{CID:e.cid(),ContentLocation:e.contentLocation(),ViewLink:e.getActionUrl("view")}});MessageUtils.showInlinePictures(this.$text,t,this.foundCids(),e)},CMessageModel.prototype.showExternalPictures=function(){MessageUtils.showExternalPictures(this.$text),this.isExternalsShown(!0)},CMessageModel.prototype.alwaysShowExternalPicturesForSender=function(){this.completelyFilled()&&(this.isExternalsAlwaysShown(!0),this.isExternalsShown()||this.showExternalPictures())},CMessageModel.prototype.openThread=function(){if(this.threadCountVisible()){var e=this.folder();this.threadOpened(!this.threadOpened()),this.requireMailCache(),this.threadOpened()?MailCache.showOpenedThreads(e):(MailCache.hideThreads(this),setTimeout(function(){MailCache.showOpenedThreads(e)},500))}},CMessageModel.prototype.getAttachmentsHashes=function(){var e=_.filter(this.attachments(),function(e){return!e.linked()});return _.map(e,function(e){return e.hash()})},CMessageModel.prototype.onSaveAttachmentsToFilesResponse=function(e,t){var s=t.Parameters,i=0,o=s.Attachments.length;e.Result&&_.each(s.Attachments,function(t){void 0!==e.Result[t]&&i++}),0===i?Screens.showError(TextUtils.i18n("%MODULENAME%/ERROR_CANT_SAVE_ATTACHMENTS_TO_FILES")):i<o?Screens.showError(TextUtils.i18n("%MODULENAME%/ERROR_SOME_ATTACHMENTS_WERE_NOT_SAVED",{SAVED_COUNT:i,TOTAL_COUNT:o})):Screens.showReport(TextUtils.i18n("%MODULENAME%/REPORT_ATTACHMENTS_SAVED_TO_FILES"))},CMessageModel.prototype.downloadAllAttachmentsSeparately=function(){_.each(this.attachments(),function(e){e.linked()||e.executeAction("download")})},CMessageModel.prototype.toJSON=function(){return{uid:this.uid(),accountId:this.accountId(),to:this.to(),subject:this.subject(),threadPart:this.threadPart(),threadUids:this.threadUids(),threadOpened:this.threadOpened()}},module.exports=CMessageModel;