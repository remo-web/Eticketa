"use strict";function CreateAccountShortFormPopup(){CAbstractPopup.call(this),this.loading=ko.observable(!1),this.friendlyName=ko.observable(""),this.email=ko.observable(""),this.email.focused=ko.observable(!1),this.password=ko.observable(""),this.password.focused=ko.observable(!1),this.aRequiredFields=[this.email,this.password]}var _=require("underscore"),$=require("jquery"),ko=require("knockout"),TextUtils=require("%PathToCoreWebclientModule%/js/utils/Text.js"),Types=require("%PathToCoreWebclientModule%/js/utils/Types.js"),ValidationUtils=require("%PathToCoreWebclientModule%/js/utils/Validation.js"),Api=require("%PathToCoreWebclientModule%/js/Api.js"),CAbstractPopup=require("%PathToCoreWebclientModule%/js/popups/CAbstractPopup.js"),Popups=require("%PathToCoreWebclientModule%/js/Popups.js"),CreateAccountPopup=require("modules/%ModuleName%/js/popups/CreateAccountPopup.js"),ModulesManager=require("%PathToCoreWebclientModule%/js/ModulesManager.js"),AccountList=require("modules/%ModuleName%/js/AccountList.js"),Ajax=require("modules/%ModuleName%/js/Ajax.js"),CAccountModel=require("modules/%ModuleName%/js/models/CAccountModel.js"),CServerModel=require("modules/%ModuleName%/js/models/CServerModel.js");_.extendOwn(CreateAccountShortFormPopup.prototype,CAbstractPopup.prototype),CreateAccountShortFormPopup.prototype.PopupTemplate="%ModuleName%_Settings_CreateAccountShortFormPopup",CreateAccountShortFormPopup.prototype.init=function(){this.friendlyName(""),this.email(""),this.password("")},CreateAccountShortFormPopup.prototype.onOpen=function(e){this.fCallback=e,this.init(),this.focusFieldToEdit()},CreateAccountShortFormPopup.prototype.focusFieldToEdit=function(){var e=_.find(this.aRequiredFields,function(e){return""===e()});e?e.focused(!0):this.aRequiredFields.length>0&&this.aRequiredFields[0].focused(!0)},CreateAccountShortFormPopup.prototype.onClose=function(){this.init()},CreateAccountShortFormPopup.prototype.save=function(){if(ValidationUtils.checkIfFieldsEmpty(this.aRequiredFields,TextUtils.i18n("%MODULENAME%/ERROR_REQUIRED_FIELDS_EMPTY"))){var e={Domain:$.trim(this.email()).split("@")[1],AllowWildcardDomain:!0};this.loading(!0),Ajax.send("GetMailServerByDomain",e,this.onGetMailServerByDomain,this)}else this.loading(!1)},CreateAccountShortFormPopup.prototype.onGetMailServerByDomain=function(e,t){var o=null;if(e.Result&&void 0!==e.Result.Server&&void 0!==e.Result.FoundWithWildcard)if(e.Result.FoundWithWildcard){var i=$.trim(this.email()).split("@")[1],r=AccountList.getDefault()?AccountList.getDefault().email():"";i===$.trim(r).split("@")[1]&&(o=new CServerModel(e.Result.Server))}else o=new CServerModel(e.Result.Server);if(o){var s={FriendlyName:this.friendlyName(),Email:$.trim(this.email()),IncomingLogin:$.trim(this.email()),IncomingPassword:$.trim(this.password()),Server:{ServerId:o.iId}};Ajax.send("CreateAccount",s,this.onAccountCreateResponse,this)}else this.loading(!1),Popups.showPopup(CreateAccountPopup,[_.bind(function(e){var t=AccountList.getAccount(e);t&&this.editAccount(t.hash())},this),this.friendlyName(),$.trim(this.email()),$.trim(this.password())]),this.closePopup()},CreateAccountShortFormPopup.prototype.onAccountCreateResponse=function(e,t){if(this.loading(!1),e.Result){var o=Types.pInt(e.Result.AccountID),i=new CAccountModel(e.Result);AccountList.addAccount(i),AccountList.populateIdentities(),AccountList.changeEditedAccount(o),1===AccountList.collection().length&&AccountList.changeCurrentAccount(o),this.fCallback&&this.fCallback(o),this.closePopup()}else Api.showErrorByCode(e,TextUtils.i18n("%MODULENAME%/ERROR_CREATE_ACCOUNT"))},CreateAccountShortFormPopup.prototype.editAccount=function(e){ModulesManager.run("SettingsWebclient","setAddHash",[["account",e]])},module.exports=new CreateAccountShortFormPopup;