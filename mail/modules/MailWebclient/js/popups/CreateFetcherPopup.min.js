"use strict";function CCreateFetcherPopup(){CAbstractPopup.call(this),this.iAccountId=0,this.loading=ko.observable(!1),this.newFolderCreating=ko.observable(!1),this.incomingLogin=ko.observable(""),this.incomingPassword=ko.observable(""),this.oIncoming=new CServerPropertiesView(110,995,"fectcher_add_incoming",TextUtils.i18n("%MODULENAME%/LABEL_POP3_SERVER")),this.folder=ko.observable(""),this.options=ko.observableArray([]),MailCache.folderList.subscribe(function(){this.populateOptions()},this),this.addNewFolderCommand=Utils.createCommand(this,this.onAddNewFolderClick),this.leaveMessagesOnServer=ko.observable(!1),this.loginIsSelected=ko.observable(!1),this.passwordIsSelected=ko.observable(!1),this.defaultOptionsAfterRender=Utils.defaultOptionsAfterRender}var _=require("underscore"),$=require("jquery"),ko=require("knockout"),TextUtils=require("%PathToCoreWebclientModule%/js/utils/Text.js"),Utils=require("%PathToCoreWebclientModule%/js/utils/Common.js"),Api=require("%PathToCoreWebclientModule%/js/Api.js"),Screens=require("%PathToCoreWebclientModule%/js/Screens.js"),CoreAjax=require("%PathToCoreWebclientModule%/js/Ajax.js"),Popups=require("%PathToCoreWebclientModule%/js/Popups.js"),CAbstractPopup=require("%PathToCoreWebclientModule%/js/popups/CAbstractPopup.js"),CreateFolderPopup=require("modules/%ModuleName%/js/popups/CreateFolderPopup.js"),AccountList=require("modules/%ModuleName%/js/AccountList.js"),MailCache=require("modules/%ModuleName%/js/Cache.js"),Settings=require("modules/%ModuleName%/js/Settings.js"),CServerPropertiesView=require("modules/%ModuleName%/js/views/CServerPropertiesView.js");_.extendOwn(CCreateFetcherPopup.prototype,CAbstractPopup.prototype),CCreateFetcherPopup.prototype.PopupTemplate="%ModuleName%_Settings_CreateFetcherPopup",CCreateFetcherPopup.prototype.onOpen=function(e){this.iAccountId=e,this.bShown=!0,this.populateOptions(),this.incomingLogin(""),this.incomingPassword(""),this.oIncoming.clear(),this.folder(""),this.leaveMessagesOnServer(!0)},CCreateFetcherPopup.prototype.populateOptions=function(){this.bShown&&this.options(MailCache.folderList().getOptions("",!0,!1,!1))},CCreateFetcherPopup.prototype.onClose=function(){this.bShown=!1},CCreateFetcherPopup.prototype.save=function(){if(this.isEmptyRequiredFields())Screens.showError(TextUtils.i18n("%MODULENAME%/ERROR_REQUIRED_FIELDS_EMPTY"));else{var e={AccountId:this.iAccountId,Folder:this.folder(),IncomingServer:this.oIncoming.server(),IncomingPort:this.oIncoming.getIntPort(),IncomingUseSsl:this.oIncoming.ssl(),IncomingLogin:$.trim(this.incomingLogin()),IncomingPassword:$.trim(this.incomingPassword()),LeaveMessagesOnServer:this.leaveMessagesOnServer()};this.loading(!0),CoreAjax.send(Settings.FetchersServerModuleName,"CreateFetcher",e,this.onCreateFetcherResponse,this)}},CCreateFetcherPopup.prototype.onCreateFetcherResponse=function(e,o){this.loading(!1),e.Result?(AccountList.populateFetchers(),this.closePopup()):Api.showErrorByCode(e,TextUtils.i18n("COREWEBCLIENT/ERROR_UNKNOWN"))},CCreateFetcherPopup.prototype.cancelPopup=function(){this.newFolderCreating()||this.closePopup()},CCreateFetcherPopup.prototype.isEmptyRequiredFields=function(){switch(""){case this.oIncoming.server():return this.oIncoming.server.focused(!0),!0;case $.trim(this.incomingLogin()):return this.loginIsSelected(!0),!0;case $.trim(this.incomingPassword()):return this.passwordIsSelected(!0),!0;default:return!1}},CCreateFetcherPopup.prototype.onAddNewFolderClick=function(){this.newFolderCreating(!0),Popups.showPopup(CreateFolderPopup,[_.bind(this.chooseFolderInList,this)])},CCreateFetcherPopup.prototype.chooseFolderInList=function(e,o){var t=MailCache.folderList().sDelimiter,s=[];""!==e&&""!==o&&(this.options(MailCache.folderList().getOptions("",!0,!1,!1)),_.each(this.options(),_.bind(function(i){e===i.name&&((s=i.fullName.split(t)).pop(),o===s.join(t)&&this.folder(i.fullName))},this))),this.newFolderCreating(!1)},module.exports=new CCreateFetcherPopup;