"use strict";function IsPageParam(e){return"p"===e.substr(0,1)&&/^[1-9][\d]*$/.test(e.substr(1))}function IsMsgParam(e){return"msg"===e.substr(0,3)&&/^[1-9][\d]*$/.test(e.substr(3))}var _=require("underscore"),Types=require("%PathToCoreWebclientModule%/js/utils/Types.js"),Settings=require("modules/%ModuleName%/js/Settings.js"),LinksUtils={};LinksUtils.getMailbox=function(e,s,t,r,n,o,u,i){var a=require("modules/%ModuleName%/js/AccountList.js").getCurrent(),l=[Settings.HashModuleName,a?a.hash():""];return s=Types.pInt(s,1),t=Types.pString(t),r=Types.pString(r),n=Types.pString(n),o=Types.pString(o,Settings.MessagesSortBy.DefaultSortBy),u=Types.pInt(u,Settings.MessagesSortBy.DefaultSortOrder),i=Types.pString(i),Types.isNonEmptyString(e)&&l.push(e),""!==n&&l.push("filter:"+n),""!==o&&Settings.MessagesSortBy.DefaultSortBy!==o&&l.push("sortby:"+o),Settings.MessagesSortBy.DefaultSortOrder!==u&&l.push("sortorder:"+u),1<s&&l.push("p"+s),""!==t&&l.push("msg"+t),""!==r&&l.push(r),""!==i&&l.push("custom:"+i),l},LinksUtils.parseMailbox=function(e,s){var t=e.length>0&&"compose"===e[0]&&"to"===e[1],r=t?[]:e,n="",o="INBOX",u=1,i="",a="",l="",p=Settings.MessagesSortBy.DefaultSortBy,g=Settings.MessagesSortBy.DefaultSortOrder,m="",c="",d=0;return Types.isNonEmptyArray(r)&&(n=Types.pString(r[d]),d++),Types.isNonEmptyArray(r)&&(o=Types.pString(r[d]),d++,r.length>d&&((c=Types.pString(r[d]))==="filter:"+Enums.FolderFilter.Flagged&&(l=Enums.FolderFilter.Flagged,d++),c==="filter:"+Enums.FolderFilter.Unseen&&(l=Enums.FolderFilter.Unseen,d++)),r.length>d&&"sortby:"===(c=Types.pString(r[d])).substr(0,7)&&(Settings.MessagesSortBy.Allow&&(p=c.substr(7)),d++),r.length>d&&"sortorder:"===(c=Types.pString(r[d])).substr(0,10)&&(Settings.MessagesSortBy.Allow&&(g=Types.pEnum(Types.pInt(c.substr(10)),Enums.SortOrder,Settings.MessagesSortBy.DefaultSortOrder)),d++),_.find(Settings.MessagesSortBy.List,function(e){return e.SortBy===p})||(p=Settings.MessagesSortBy.DefaultSortBy,g=Settings.MessagesSortBy.DefaultSortOrder),r.length>d&&IsPageParam(c=Types.pString(r[d]))&&((u=Types.pInt(c.substr(1)))<=0&&(u=1),d++),r.length>d&&IsMsgParam(c=Types.pString(r[d]))&&(i=c.substr(3),d++),r.length>d&&"custom:"!==(c=Types.pString(r[d])).substr(0,7)&&(a=c,d++),r.length>d&&"custom:"===(c=Types.pString(r[d])).substr(0,7)&&(m=c.substr(7))),{MailtoCompose:t,AccountHash:n,Folder:""===o?s:o,Page:u,Uid:i,Search:a,Filters:l,SortBy:p,SortOrder:g,Custom:m}},LinksUtils.getViewMessage=function(e,s){var t=require("modules/%ModuleName%/js/AccountList.js").getCurrent(),r=t?t.hash():"";return[Settings.HashModuleName+"-view",r,e,"msg"+s]},LinksUtils.getCompose=function(){var e=require("modules/%ModuleName%/js/AccountList.js").getCurrent(),s=e?e.hash():"";return[Settings.HashModuleName+"-compose",s]},LinksUtils.getComposeFromMessage=function(e,s,t){var r=require("modules/%ModuleName%/js/AccountList.js").getCurrent(),n=r?r.hash():"";return[Settings.HashModuleName+"-compose",n,e,s,t]},LinksUtils.getComposeWithToField=function(e){var s=require("modules/%ModuleName%/js/AccountList.js").getCurrent(),t=s?s.hash():"";return[Settings.HashModuleName+"-compose",t,"to",e]},LinksUtils.getComposeWithData=function(e){var s=require("modules/%ModuleName%/js/AccountList.js").getCurrent(),t=s?s.hash():"";return[Settings.HashModuleName+"-compose",t,"data",e]},LinksUtils.getComposeWithObject=function(e,s){var t=require("modules/%ModuleName%/js/AccountList.js").getCurrent(),r=t?t.hash():"";return[Settings.HashModuleName+"-compose",r,e,s]},LinksUtils.getComposeWithEmlObject=function(e,s,t){var r=require("modules/%ModuleName%/js/AccountList.js").getCurrent(),n=r?r.hash():"";return[Settings.HashModuleName+"-compose",n,Enums.ReplyType.ForwardAsAttach,e,s,t]},LinksUtils.parseCompose=function(e){var s=e.length>0?e[0]:"",t=e.length>1?e[1]:"",r=(t===Enums.ReplyType.ForwardAsAttach||"attachments"===t||"data"===t)&&e.length>2?t===Enums.ReplyType.ForwardAsAttach?e[4]:e[2]:null,n="to"===t&&e.length>2?LinksUtils.parseToAddr(e[2]):null,o=(t===Enums.ReplyType.Reply||t===Enums.ReplyType.ReplyAll||t===Enums.ReplyType.Resend||t===Enums.ReplyType.Forward||"drafts"===t||t===Enums.ReplyType.ForwardAsAttach)&&e.length>2;return{AccountHash:s,RouteType:t,ToAddr:n,Object:r,MessageFolderName:o?e[2]:"",MessageUid:o?e[3]:""}},LinksUtils.parseToAddr=function(e){var s=Types.pString(e),t=-1!==s.indexOf("mailto:"),r=[],n=[],o="",u="",i="",a="";return t&&(s=(r=s.replace(/^mailto:/,"").split("?"))[0],2===r.length&&(n=r[1].split("&"),_.each(n,function(e){var s=e.split("=");if(2===s.length)switch(s[0].toLowerCase()){case"subject":o=decodeURIComponent(s[1]);break;case"cc":u=decodeURIComponent(s[1]);break;case"bcc":i=decodeURIComponent(s[1]);break;case"body":a=decodeURIComponent(s[1])}}))),{to:s,hasMailto:t,subject:o,cc:u,bcc:i,body:a}},module.exports=LinksUtils;