"use strict";function GetReplyMessageBody(e,t,a,n){var r=TextUtils.i18n("%MODULENAME%/TEXT_REPLY_MESSAGE",{DATE:e.oDateModel.getDate(),TIME:e.oDateModel.getTime(),SENDER:TextUtils.encodeHtml(e.oFrom.getFull())});return"<br /><br />"+this.getSignatureText(t,a,n)+'<br /><br /><div data-anchor="reply-title">'+r+"</div><blockquote>"+e.getConvertedHtml()+"</blockquote>"}function GetReplyAllCcAddr(e,t,a){var n=new CAddressListModel,r=_.union(e.oTo.aCollection,e.oCc.aCollection,e.oBcc.aCollection),s=_.find(AccountList.collection(),function(e){return e.id()===t},this),i=new CAddressModel,o=new CAddressModel;return i.sEmail=s.email(),o.sEmail=a?a.email():"",n.addCollection(r),n.excludeCollection(_.union(e.oFrom.aCollection,[i,o])),n.getFull()}var _=require("underscore"),TextUtils=require("%PathToCoreWebclientModule%/js/utils/Text.js"),Types=require("%PathToCoreWebclientModule%/js/utils/Types.js"),Api=require("%PathToCoreWebclientModule%/js/Api.js"),App=require("%PathToCoreWebclientModule%/js/App.js"),Routing=require("%PathToCoreWebclientModule%/js/Routing.js"),Screens=require("%PathToCoreWebclientModule%/js/Screens.js"),CAddressModel=require("%PathToCoreWebclientModule%/js/models/CAddressModel.js"),CAddressListModel=require("%PathToCoreWebclientModule%/js/models/CAddressListModel.js"),MessageUtils=require("modules/%ModuleName%/js/utils/Message.js"),AccountList=require("modules/%ModuleName%/js/AccountList.js"),Ajax=require("modules/%ModuleName%/js/Ajax.js"),MailCache=require("modules/%ModuleName%/js/Cache.js"),Settings=require("modules/%ModuleName%/js/Settings.js"),MainTab=App.isNewTab()&&window.opener&&window.opener.MainTabMailMethods,SendingUtils={sReplyText:"",sReplyDraftUid:"",oPostponedMailData:null};SendingUtils.setReplyData=function(e,t){this.sReplyText=e,this.sReplyDraftUid=t},SendingUtils.send=function(e,t,a,n,r,s){var i=t.AccountID,o=AccountList.getAccount(i),l=MailCache.oFolderListItems[i],c="",d=l?l.sentFolderFullName():"",u=l?l.draftsFolderFullName():"",M=o?o.email():"",g=t.To.indexOf(M)>-1||t.Cc.indexOf(M)>-1||t.Bcc.indexOf(M)>-1;switch(o.bSaveRepliesToCurrFolder&&!g&&Types.isNonEmptyArray(t.DraftInfo,3)&&(d=t.DraftInfo[2]),t.Method=e,t.ShowReport=a,e){case"SendMessage":c=TextUtils.i18n("COREWEBCLIENT/INFO_SENDING"),t.SentFolder=d,""!==t.DraftUid&&(t.DraftFolder=u,MainTab?(MainTab.removeOneMessageFromCacheForFolder(t.AccountID,t.DraftFolder,t.DraftUid),MainTab.replaceHashWithoutMessageUid(t.DraftUid)):(MailCache.removeOneMessageFromCacheForFolder(t.AccountID,t.DraftFolder,t.DraftUid),Routing.replaceHashWithoutMessageUid(t.DraftUid)));break;case"SaveMessage":c=TextUtils.i18n("%MODULENAME%/INFO_SAVING"),void 0===t.DraftFolder&&(t.DraftFolder=u),MailCache.savingDraftUid(t.DraftUid),MainTab?(MainTab.startMessagesLoadingWhenDraftSaving(t.AccountID,t.DraftFolder),MainTab.replaceHashWithoutMessageUid(t.DraftUid)):(MailCache.startMessagesLoadingWhenDraftSaving(t.AccountID,t.DraftFolder),Routing.replaceHashWithoutMessageUid(t.DraftUid))}a&&Screens.showLoading(c),s?this.postponedMailData={Parameters:t,SendMessageResponseHandler:n,SendMessageResponseContext:r}:Ajax.send(e,t,n,r)},SendingUtils.sendPostponedMail=function(e){var t=this.postponedMailData,a=t.Parameters,n=a.AccountID,r=MailCache.oFolderListItems[n],s=r?r.draftsFolderFullName():"";""!==e&&(a.DraftUid=e,a.DraftFolder=s,MainTab?(MainTab.removeOneMessageFromCacheForFolder(a.AccountID,a.DraftFolder,a.DraftUid),MainTab.replaceHashWithoutMessageUid(a.DraftUid)):(MailCache.removeOneMessageFromCacheForFolder(a.AccountID,a.DraftFolder,a.DraftUid),Routing.replaceHashWithoutMessageUid(a.DraftUid))),this.postponedMailData&&(Ajax.send(a.Method,a,t.SendMessageResponseHandler,t.SendMessageResponseContext),this.postponedMailData=null)},SendingUtils.sendReplyMessage=function(e,t,a,n,r,s){var i=null,o=MailCache.currentMessage(),l=[],c=null;o&&(l=o.oTo.aCollection.concat(o.oCc.aCollection),c=this.getFirstFetcherOrIdentityByRecipientsOrDefault(l,o.accountId()),(i=this.getReplyDataFromMessage(o,Enums.ReplyType.ReplyAll,o.accountId(),c,!1,t,a)).AccountID=o.accountId(),c&&(i.FetcherID=c&&c.FETCHER?c.id():"",i.IdentityID=c&&!c.FETCHER?c.id():""),i.Bcc="",i.Importance=Enums.Importance.Normal,i.SendReadingConfirmation=!1,i.IsQuickReply=!0,i.IsHtml=!0,i.Attachments=this.convertAttachmentsForSending(i.Attachments),this.send(e,i,!1,n,r,s))},SendingUtils.convertAttachmentsForSending=function(e){var t={};return _.each(e,function(e){t[e.tempName()]=[e.fileName(),e.linked()?e.cid():"",e.inline()?"1":"0",e.linked()?"1":"0",e.contentLocation()]}),t},SendingUtils.onSendOrSaveMessageResponse=function(e,t,a){var n,r,s,i=t.Parameters,o=!!e.Result;switch(a||Screens.hideLoading(),t.Method){case"SaveMessage":MailCache.savingDraftUid(""),o?(i.ShowReport&&!a&&(-1!==$.inArray(t.Parameters.DraftFolder,MailCache.getCurrentTemplateFolders())?Screens.showReport(TextUtils.i18n("%MODULENAME%/REPORT_TEMPLATE_SAVED")):Screens.showReport(TextUtils.i18n("%MODULENAME%/REPORT_MESSAGE_SAVED"))),e.Result.NewUid||(Settings.AllowAutosaveInDrafts=!1)):i.ShowReport&&(-1!==$.inArray(t.Parameters.DraftFolder,MailCache.getCurrentTemplateFolders())?Api.showErrorByCode(e,TextUtils.i18n("%MODULENAME%/ERROR_TEMPLATE_SAVING")):Api.showErrorByCode(e,TextUtils.i18n("%MODULENAME%/ERROR_MESSAGE_SAVING")));break;case"SendMessage":o?(i.IsQuickReply?Screens.showReport(TextUtils.i18n("%MODULENAME%/REPORT_MESSAGE_SENT")):MainTab?MainTab.showReport(TextUtils.i18n("%MODULENAME%/REPORT_MESSAGE_SENT")):Screens.showReport(TextUtils.i18n("%MODULENAME%/REPORT_MESSAGE_SENT")),_.isArray(i.DraftInfo)&&3===i.DraftInfo.length&&(s=i.DraftInfo[0],r=i.DraftInfo[1],n=i.DraftInfo[2],MailCache.markMessageReplied(i.AccountID,n,r,s))):Api.showErrorByCode(e,TextUtils.i18n("%MODULENAME%/ERROR_MESSAGE_SENDING")),i.SentFolder&&(MainTab?MainTab.removeMessagesFromCacheForFolder(i.AccountID,i.SentFolder):MailCache.removeMessagesFromCacheForFolder(i.AccountID,i.SentFolder))}return i.DraftFolder&&!a&&(MainTab?MainTab.removeMessagesFromCacheForFolder(i.AccountID,i.DraftFolder):MailCache.removeMessagesFromCacheForFolder(i.AccountID,i.DraftFolder)),{Method:t.Method,Result:o,NewUid:e.Result?e.Result.NewUid:""}},SendingUtils.getReplyDataFromMessage=function(e,t,a,n,r,s,i){var o={DraftInfo:[],DraftUid:"",To:"",Cc:"",Bcc:"",Subject:"",Attachments:[],InReplyTo:e.messageId(),References:this.getReplyReferences(e)},l=[],c=e.oReplyTo.getFull(),d=e.oTo.getFull();switch((""===c||e.oFrom.getFirstEmail()===e.oReplyTo.getFirstEmail()&&""===e.oReplyTo.getFirstName())&&(c=e.oFrom.getFull()),s&&""!==s||(s=this.sReplyText,this.sReplyText=""),"forward"===t?o.Text=s+this.getForwardMessageBody(e,a,n):"resend"===t?(o.Text=e.getConvertedHtml(),o.Cc=e.cc(),o.Bcc=e.bcc()):o.Text=s+GetReplyMessageBody.call(this,e,a,n,r),i?o.DraftUid=i:(o.DraftUid=this.sReplyDraftUid,this.sReplyDraftUid=""),t){case Enums.ReplyType.Reply:o.DraftInfo=[Enums.ReplyType.Reply,e.uid(),e.folder()],o.To=c,o.Subject=this.getReplySubject(e.subject(),!0),l=_.filter(e.attachments(),function(e){return e.linked()});break;case Enums.ReplyType.ReplyAll:o.DraftInfo=[Enums.ReplyType.ReplyAll,e.uid(),e.folder()],o.To=c,o.Cc=GetReplyAllCcAddr(e,a,n),o.Subject=this.getReplySubject(e.subject(),!0),l=_.filter(e.attachments(),function(e){return e.linked()});break;case Enums.ReplyType.Resend:o.DraftInfo=[Enums.ReplyType.Resend,e.uid(),e.folder(),e.cc(),e.bcc()],o.To=d,o.Subject=e.subject(),l=e.attachments();break;case Enums.ReplyType.ForwardAsAttach:case Enums.ReplyType.Forward:o.DraftInfo=[Enums.ReplyType.Forward,e.uid(),e.folder()],o.Subject=this.getReplySubject(e.subject(),!1),l=e.attachments()}return _.each(l,function(e){if(e.getCopy){var t=e.getCopy();o.Attachments.push(t)}}),o},SendingUtils.getReplyReferences=function(e){var t=e.references(),a=e.messageId();return-1===t.indexOf(a)&&(t+=" "+a),t},SendingUtils.getClearSignature=function(e,t){var a=AccountList.getAccount(e),n="";return t&&t.accountId()===e&&t.useSignature()?n=t.signature():a&&a.useSignature()&&(n=a.signature()),n},SendingUtils.getSignatureText=function(e,t,a){var n=this.getClearSignature(e,t);return a?'<div data-anchor="signature">'+n+"</div>":"<div>"+n+"</div>"},SendingUtils.getFirstFetcherOrIdentityByRecipientsOrDefault=function(e,t){var a=AccountList.getAccount(t),n=this.getAccountFetchersIdentitiesList(a),r=[],s=null;return _.each(e,function(e){if(!s)switch((r=_.filter(n,function(t){return e.sEmail===t.email})).length){case 0:break;case 1:s=r[0];break;default:(s=_.find(r,function(t){return e.sEmail===t.email&&e.sName===t.name}))||(s=_.find(r,function(e){return e.isDefault}))||(s=r[0])}}),s||(s=_.find(n,function(e){return e.isDefault})),s&&s.result},SendingUtils.getAccountFetchersIdentitiesList=function(e){var t=[];return e&&(_.each(e.fetchers(),function(e){t.push({email:e.email(),name:e.userName(),isDefault:!1,result:e})}),_.each(e.identities(),function(e){t.push({email:e.email(),name:e.friendlyName(),isDefault:e.isDefault(),result:e})})),t},SendingUtils.getForwardMessageBody=function(e,t,a){var n=TextUtils.encodeHtml(e.oCc.getFull()),r=""!==n?TextUtils.i18n("%MODULENAME%/TEXT_FORWARD_MESSAGE_CCPART",{CCADDR:n}):"",s=TextUtils.i18n("%MODULENAME%/TEXT_FORWARD_MESSAGE",{FROMADDR:TextUtils.encodeHtml(e.oFrom.getFull()),TOADDR:TextUtils.encodeHtml(e.oTo.getFull()),CCPART:r,FULLDATE:e.oDateModel.getFullDate(),SUBJECT:TextUtils.encodeHtml(e.subject())});return"<br /><br />"+this.getSignatureText(t,a,!0)+'<br /><br /><div data-anchor="reply-title">'+s+"</div><br /><br />"+e.getConvertedHtml()},SendingUtils.hasReplyAllCcAddrs=function(e){var t=e.accountId(),a=e.oTo.aCollection.concat(e.oCc.aCollection);return""!==GetReplyAllCcAddr(e,t,this.getFirstFetcherOrIdentityByRecipientsOrDefault(a,e.accountId()))},SendingUtils.getReplySubject=function(e,t){var a=TextUtils.i18n("%MODULENAME%/TEXT_REPLY_PREFIX"),n=TextUtils.i18n("%MODULENAME%/TEXT_FORWARD_PREFIX"),r=(t?a:n)+": "+e;return Settings.JoinReplyPrefixes&&(r=MessageUtils.joinReplyPrefixesInSubject(r,a,n)),r},SendingUtils.getHtmlFromText=function(e){return e.replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/\r/g,"").replace(/\n/g,"<br />")},module.exports=SendingUtils;