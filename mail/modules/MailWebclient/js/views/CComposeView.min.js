"use strict";function CComposeView(){CAbstractScreenView.call(this,"%ModuleName%"),this.browserTitle=ko.computed(function(){return AccountList.getEmail()+" - "+TextUtils.i18n("%MODULENAME%/HEADING_COMPOSE_BROWSER_TAB")});var e=this;this.toAddrDom=ko.observable(),this.toAddrDom.subscribe(function(){this.initInputosaurus(this.toAddrDom,this.toAddr,this.lockToAddr,"to")},this),this.ccAddrDom=ko.observable(),this.ccAddrDom.subscribe(function(){this.initInputosaurus(this.ccAddrDom,this.ccAddr,this.lockCcAddr,"cc")},this),this.bccAddrDom=ko.observable(),this.bccAddrDom.subscribe(function(){this.initInputosaurus(this.bccAddrDom,this.bccAddr,this.lockBccAddr,"bcc")},this),this.folderList=MailCache.folderList,this.folderList.subscribe(function(){this.getMessageOnRoute()},this),this.bNewTab=App.isNewTab(),this.bDemo=UserSettings.IsDemo,this.sending=ko.observable(!1),this.saving=ko.observable(!1),this.oHtmlEditor=new CHtmlEditorView(!1,this),this.visibleBcc=ko.observable(!1),this.visibleBcc.subscribe(function(){$html.toggleClass("screen-compose-bcc",this.visibleCc()),_.defer(_.bind(function(){$(this.bccAddrDom()).inputosaurus("resizeInput")},this))},this),this.visibleCc=ko.observable(!1),this.visibleCc.subscribe(function(){$html.toggleClass("screen-compose-cc",this.visibleCc()),_.defer(_.bind(function(){$(this.ccAddrDom()).inputosaurus("resizeInput")},this))},this),this.sendReadingConfirmation=ko.observable(!1).extend({reversible:!0}),this.composeUploaderButton=ko.observable(null),this.composeUploaderButton.subscribe(function(){this.initUploader()},this),this.composeUploaderDropPlace=ko.observable(null),this.composeUploaderBodyDragOver=ko.observable(!1),this.composeUploaderDragOver=ko.observable(!1),this.allowDragNDrop=ko.observable(!1),this.uploaderBodyDragOver=ko.computed(function(){return this.allowDragNDrop()&&this.composeUploaderBodyDragOver()},this),this.uploaderDragOver=ko.computed(function(){return this.allowDragNDrop()&&this.composeUploaderDragOver()},this),this.selectedImportance=ko.observable(Enums.Importance.Normal).extend({reversible:!0}),this.senderAccountId=SenderSelector.senderAccountId,this.senderList=SenderSelector.senderList,this.visibleFrom=ko.computed(function(){return this.senderList().length>1},this),this.selectedSender=SenderSelector.selectedSender,this.selectedFetcherOrIdentity=SenderSelector.selectedFetcherOrIdentity,this.selectedFetcherOrIdentity.subscribe(function(){this.oHtmlEditor.isEditing()||this.oHtmlEditor.clearUndoRedo()},this),this.signature=ko.observable(""),this.prevSignature=ko.observable(null),ko.computed(function(){var e=SendingUtils.getClearSignature(this.senderAccountId(),this.selectedFetcherOrIdentity());null===this.prevSignature()?(this.prevSignature(e),this.signature(e)):(this.prevSignature(this.signature()),this.signature(e),this.oHtmlEditor.changeSignatureContent(this.signature(),this.prevSignature()))},this),this.lockToAddr=ko.observable(!1),this.toAddr=ko.observable("").extend({reversible:!0}),this.toAddr.subscribe(function(){this.lockToAddr()||($(this.toAddrDom()).val(this.toAddr()),$(this.toAddrDom()).inputosaurus("refresh"))},this),this.lockCcAddr=ko.observable(!1),this.ccAddr=ko.observable("").extend({reversible:!0}),this.ccAddr.subscribe(function(){this.lockCcAddr()||($(this.ccAddrDom()).val(this.ccAddr()),$(this.ccAddrDom()).inputosaurus("refresh"))},this),this.lockBccAddr=ko.observable(!1),this.bccAddr=ko.observable("").extend({reversible:!0}),this.bccAddr.subscribe(function(){this.lockBccAddr()||($(this.bccAddrDom()).val(this.bccAddr()),$(this.bccAddrDom()).inputosaurus("refresh"))},this),this.recipientEmails=ko.computed(function(){var e=[this.toAddr(),this.ccAddr(),this.bccAddr()].join(",").split(","),t=[];return _.each(e,function(e){var s=$.trim(e),i=null;""!==s&&(i=AddressUtils.getEmailParts(s)).email&&t.push(i.email)}),t},this),this.subject=ko.observable("").extend({reversible:!0}),this.plainText=ko.observable(!1),this.textBody=ko.observable(""),this.textBody.subscribe(function(e){this.oHtmlEditor.setText(this.textBody(),this.plainText()),this.oHtmlEditor.commit()},this),this.focusedField=ko.observable(),this.oHtmlEditor.textFocused.subscribe(function(e){this.oHtmlEditor.textFocused()&&this.focusedField("text")},this),this.subjectFocused=ko.observable(!1),this.subjectFocused.subscribe(function(){this.subjectFocused()&&this.focusedField("subject")},this),this.templateUid=ko.observable(""),this.templateFolderName=ko.observable(MailCache.getTemplateFolder()),this.draftUid=ko.observable(""),this.draftUid.subscribe(function(){MailCache.editedDraftUid(this.draftUid())},this),this.draftInfo=ko.observableArray([]),this.routeType=ko.observable(""),this.routeParams=ko.observableArray([]),this.inReplyTo=ko.observable(""),this.references=ko.observable(""),this.bUploadStatus=!1,this.iUploadAttachmentsTimer=0,this.messageUploadAttachmentsStarted=ko.observable(!1),this.messageUploadAttachmentsStarted.subscribe(function(t){window.clearTimeout(e.iUploadAttachmentsTimer),t?e.iUploadAttachmentsTimer=window.setTimeout(function(){e.bUploadStatus=!0,Screens.showLoading(TextUtils.i18n("%MODULENAME%/INFO_ATTACHMENTS_LOADING"))},4e3):e.bUploadStatus?e.iUploadAttachmentsTimer=window.setTimeout(function(){e.bUploadStatus=!1,Screens.hideLoading()},1e3):Screens.hideLoading()},this),this.attachments=ko.observableArray([]),this.attachmentsChanged=ko.observable(!1),this.attachments.subscribe(function(){this.attachmentsChanged(!0)},this),this.notUploadedAttachments=ko.computed(function(){return _.filter(this.attachments(),function(e){return!e.uploaded()})},this),this.allAttachmentsUploaded=ko.computed(function(){return 0===this.notUploadedAttachments().length&&!this.messageUploadAttachmentsStarted()},this),this.notInlineAttachments=ko.computed(function(){return _.filter(this.attachments(),function(e){return!e.linked()})},this),this.notInlineAttachments.subscribe(function(){$html.toggleClass("screen-compose-attachments",this.notInlineAttachments().length>0)},this),this.allowStartSending=ko.computed(function(){return!this.saving()},this),this.allowStartSending.subscribe(function(){this.allowStartSending()&&this.requiresPostponedSending()&&(SendingUtils.sendPostponedMail(this.draftUid()),this.requiresPostponedSending(!1))},this),this.requiresPostponedSending=ko.observable(!1),this.oJua=null,this.isDraftsCleared=ko.observable(!1),this.backToListOnSendOrSave=ko.observable(!1),this.composeShown=ko.computed(function(){return!!this.opened&&this.opened()||!!this.shown&&this.shown()},this),this.toolbarControllers=ko.observableArray([]),this.disableHeadersEdit=ko.computed(function(){var e=!1;return _.each(this.toolbarControllers(),function(t){e=e||!!t.disableHeadersEdit&&t.disableHeadersEdit()}),e},this),ko.computed(function(){var e=!1;_.each(this.toolbarControllers(),function(t){e=e||!!t.disableBodyEdit&&t.disableBodyEdit()}),this.oHtmlEditor.setDisableEdit(e)},this),this.draftFolderIsAvailable=ko.computed(function(){return!!MailCache.folderList().draftsFolder()},this),this.disableAutosave=ko.observable(!1),Settings.AllowAutosaveInDrafts&&Settings.AutoSaveIntervalSeconds>0&&(this.iAutosaveInterval=-1,ko.computed(function(){var e=this.draftFolderIsAvailable()&&this.composeShown()&&!this.sending()&&!this.saving()&&!this.disableAutosave()&&!MailCache.disableComposeAutosave();_.each(this.toolbarControllers(),function(t){e=e&&!(t.disableAutosave&&t.disableAutosave())}),window.clearInterval(this.iAutosaveInterval),e&&(this.iAutosaveInterval=window.setInterval(_.bind(this.executeSave,this,!0),1e3*Settings.AutoSaveIntervalSeconds))},this)),this.backToListCommand=Utils.createCommand(this,this.executeBackToList),this.sendCommand=Utils.createCommand(this,this.executeSend,this.isEnableSending),this.saveCommand=Utils.createCommand(this,this.executeSaveCommand,this.isEnableSaving),this.visibleSaveTemplateControl=ko.observable(!1),this.saveTemplateCommand=Utils.createCommand(this,this.executeTemplateSaveCommand,this.isEnableSaving),this.messageFields=ko.observable(null),this.bottomPanel=ko.observable(null),this.sHotkeysHintsViewTemplate=Browser.mobileDevice?"":"%ModuleName%_Compose_HotkeysHintsView",this.sPopupButtonsViewTemplate=App.isNewTab()?"":"%ModuleName%_Compose_PopupButtonsView",this.aHotkeys=[{value:"Ctrl+Enter",action:TextUtils.i18n("%MODULENAME%/LABEL_SEND_HOTKEY"),visible:ko.observable(!0)},{value:"Ctrl+S",action:TextUtils.i18n("%MODULENAME%/LABEL_SAVE_HOTKEY"),visible:this.draftFolderIsAvailable},{value:"Ctrl+Z",action:TextUtils.i18n("%MODULENAME%/LABEL_UNDO_HOTKEY"),visible:ko.observable(!0)},{value:"Ctrl+Y",action:TextUtils.i18n("%MODULENAME%/LABEL_REDO_HOTKEY"),visible:ko.observable(!0)},{value:"Ctrl+K",action:TextUtils.i18n("%MODULENAME%/LABEL_LINK_HOTKEY"),visible:ko.observable(!0)},{value:"Ctrl+B",action:TextUtils.i18n("%MODULENAME%/LABEL_BOLD_HOTKEY"),visible:ko.observable(!0)},{value:"Ctrl+I",action:TextUtils.i18n("%MODULENAME%/LABEL_ITALIC_HOTKEY"),visible:ko.observable(!0)},{value:"Ctrl+U",action:TextUtils.i18n("%MODULENAME%/LABEL_UNDERLINE_HOTKEY"),visible:ko.observable(!0)}],this.bAllowFiles=!!SelectFilesPopup,this.ignoreHasUnsavedChanges=ko.observable(!1),this.changedInPreviousWindow=ko.observable(!1),this.hasUnsavedChanges=ko.computed(function(){return!this.ignoreHasUnsavedChanges()&&this.isChanged()&&this.isEnableSaving()},this),this.saveAndCloseTooltip=ko.computed(function(){return this.draftFolderIsAvailable()&&this.hasUnsavedChanges()?TextUtils.i18n("%MODULENAME%/ACTION_SAVE_CLOSE"):TextUtils.i18n("%MODULENAME%/ACTION_CLOSE")},this),this.splitterDom=ko.observable(),this.headersCompressed=ko.observable(!1),this.allowCcBccSwitchers=ko.computed(function(){return!this.disableHeadersEdit()&&!this.headersCompressed()},this),this.registerOwnToolbarControllers(),App.broadcastEvent("%ModuleName%::ConstructView::after",{Name:this.ViewConstructorName,View:this})}var _=require("underscore"),$=require("jquery"),ko=require("knockout"),AddressUtils=require("%PathToCoreWebclientModule%/js/utils/Address.js"),FilesUtils=require("%PathToCoreWebclientModule%/js/utils/Files.js"),TextUtils=require("%PathToCoreWebclientModule%/js/utils/Text.js"),Types=require("%PathToCoreWebclientModule%/js/utils/Types.js"),Utils=require("%PathToCoreWebclientModule%/js/utils/Common.js"),App=require("%PathToCoreWebclientModule%/js/App.js"),Browser=require("%PathToCoreWebclientModule%/js/Browser.js"),CJua=require("%PathToCoreWebclientModule%/js/CJua.js"),ModulesManager=require("%PathToCoreWebclientModule%/js/ModulesManager.js"),Routing=require("%PathToCoreWebclientModule%/js/Routing.js"),Screens=require("%PathToCoreWebclientModule%/js/Screens.js"),UserSettings=require("%PathToCoreWebclientModule%/js/Settings.js"),WindowOpener=require("%PathToCoreWebclientModule%/js/WindowOpener.js"),CAbstractScreenView=require("%PathToCoreWebclientModule%/js/views/CAbstractScreenView.js"),Popups=require("%PathToCoreWebclientModule%/js/Popups.js"),AlertPopup=require("%PathToCoreWebclientModule%/js/popups/AlertPopup.js"),SelectFilesPopup=ModulesManager.run("FilesWebclient","getSelectFilesPopup"),LinksUtils=require("modules/%ModuleName%/js/utils/Links.js"),SendingUtils=require("modules/%ModuleName%/js/utils/Sending.js"),AccountList=require("modules/%ModuleName%/js/AccountList.js"),CoreAjax=require("%PathToCoreWebclientModule%/js/Ajax.js"),Ajax=require("modules/%ModuleName%/js/Ajax.js"),MailCache=require("modules/%ModuleName%/js/Cache.js"),MainTabExtMethods=require("modules/%ModuleName%/js/MainTabExtMethods.js"),SenderSelector=require("modules/%ModuleName%/js/SenderSelector.js"),Settings=require("modules/%ModuleName%/js/Settings.js"),CMessageModel=require("modules/%ModuleName%/js/models/CMessageModel.js"),CAttachmentModel=require("modules/%ModuleName%/js/models/CAttachmentModel.js"),CHtmlEditorView=require("modules/%ModuleName%/js/views/CHtmlEditorView.js"),MainTab=App.isNewTab()&&window.opener&&window.opener.MainTabMailMethods,$html=$("html");_.extendOwn(CComposeView.prototype,CAbstractScreenView.prototype),CComposeView.prototype.ViewTemplate=App.isNewTab()?"%ModuleName%_ComposeScreenView":"%ModuleName%_ComposeView",CComposeView.prototype.ViewConstructorName="CComposeView",CComposeView.prototype.isEnableSending=function(){var e=0===this.toAddr().length&&0===this.ccAddr().length&&0===this.bccAddr().length;return this.folderList()&&0!==this.folderList().iAccountId&&!this.sending()&&!e&&this.allAttachmentsUploaded()},CComposeView.prototype.isEnableSaving=function(){var e=this.folderList()&&0!==this.folderList().iAccountId;return this.composeShown()&&e&&!this.sending()&&!this.saving()},CComposeView.prototype.initInputosaurus=function(e,t,s,i){e()&&$(e()).length>0&&$(e()).inputosaurus({width:"auto",parseOnBlur:!0,autoCompleteSource:ModulesManager.run("ContactsWebclient","getSuggestionsAutocompleteCallback",["all","",!0])||function(){},autoCompleteDeleteItem:ModulesManager.run("ContactsWebclient","getSuggestionsAutocompleteDeleteHandler")||function(){},autoCompleteAppendTo:$(e()).closest("td"),change:_.bind(function(e){s(!0),this.setRecipient(t,e.target.value),s(!1)},this),copy:_.bind(function(e){this.inputosaurusBuffer=e},this),paste:_.bind(function(){var e=this.inputosaurusBuffer||"";return this.inputosaurusBuffer="",e},this),focus:_.bind(this.focusedField,this,i),mobileDevice:Browser.mobileDevice})},CComposeView.prototype.changeHeadersCompressed=function(){this.headersCompressed(!this.headersCompressed())},CComposeView.prototype.onBind=function(){ModulesManager.run("SessionTimeoutWeblient","registerFunction",[_.bind(this.executeSave,this,!1)]),App.isMobile()||this.hotKeysBind()},CComposeView.prototype.hotKeysBind=function(){(this.$popupDom||this.$viewDom).on("keydown",$.proxy(function(e){if(e&&e.ctrlKey&&!e.altKey&&!e.shiftKey){var t=e.keyCode,s=this.composeShown()&&(!this.minimized||!this.minimized())&&e&&e.ctrlKey;s&&t===Enums.Key.s?(e.preventDefault(),e.returnValue=!1,this.isEnableSaving()&&this.saveCommand()):s&&t===Enums.Key.Enter&&""!==this.toAddr()&&this.sendCommand()}},this))},CComposeView.prototype.getMessageOnRoute=function(){var e=LinksUtils.parseCompose(this.routeParams());""!==this.routeType()&&e.MessageFolderName&&e.MessageUid&&MailCache.getMessage(e.MessageFolderName,e.MessageUid,this.onMessageResponse,this)},CComposeView.prototype.onShow=function(){var e=this.focusedField();$(this.splitterDom()).trigger("resize"),$(this.bottomPanel()).trigger("resize"),this.oHtmlEditor.init(this.textBody(),this.plainText(),"7"),this.oHtmlEditor.commit(),this.initUploader(),this.backToListOnSendOrSave(!1),this.focusedField(e),$html.addClass("screen-compose"),this.oJua&&this.oJua.setDragAndDropEnabledStatus(!0),this.visibleSaveTemplateControl(MailCache.getCurrentTemplateFolders().length>0)},CComposeView.prototype.reset=function(){this.plainText(!1),this.bUploadStatus=!1,window.clearTimeout(this.iUploadAttachmentsTimer),this.messageUploadAttachmentsStarted(!1),this.templateUid(""),this.templateFolderName(MailCache.getTemplateFolder()),this.draftUid(""),this.draftInfo.removeAll(),this.setDataFromMessage(new CMessageModel),this.isDraftsCleared(!1),this.ignoreHasUnsavedChanges(!1)},CComposeView.prototype.onRoute=function(e){var t=LinksUtils.parseCompose(e);switch(AccountList.changeCurrentAccountByHash(t.AccountHash),this.reset(),this.routeType(t.RouteType),this.routeType()){case Enums.ReplyType.ForwardAsAttach:this.routeParams(e),this.fillDefault(t);case Enums.ReplyType.Reply:case Enums.ReplyType.ReplyAll:case Enums.ReplyType.Resend:case Enums.ReplyType.Forward:case"drafts":this.routeParams(e),0!==this.folderList().iAccountId&&this.getMessageOnRoute();break;case"data":var s=t.Object;if(s){s.to&&this.setRecipient(this.toAddr,s.to),s.subject&&this.subject(s.subject),s.isHtml||this.plainText(!0);var i="<div></div>";s.body&&(console.log("oData.body: ",s.body),i=s.isHtml?"<div>"+s.body+"</div>":s.body,this.textBody(i)),this.triggerToolbarControllersAfterPopulatingMessage(!0,!s.isHtml,i)}break;default:this.routeParams(e),this.fillDefault(t)}},CComposeView.prototype.fillDefault=function(e){var t=SendingUtils.getSignatureText(this.senderAccountId(),this.selectedFetcherOrIdentity(),!0),s=MainTab?MainTab.getComposedMessage(window.name):null,i=e.ToAddr;s?(this.setMessageDataInNewTab(s),this.changedInPreviousWindow()&&_.defer(_.bind(this.executeSave,this,!0))):""!==t&&this.textBody("<br /><br />"+t+"<br />"),i&&(this.setRecipient(this.toAddr,i.to),i.hasMailto&&(this.subject(i.subject),this.setRecipient(this.ccAddr,i.cc),this.setRecipient(this.bccAddr,i.bcc),""!==i.body&&this.textBody("<div>"+i.body+"</div>"))),this.routeType()===Enums.ReplyType.ForwardAsAttach&&e.Object&&this.addMessageAsAttachment(e.Object),"attachments"===this.routeType()&&e.Object&&this.addAttachments(e.Object),_.defer(_.bind(function(){this.focusAfterFilling()},this)),this.visibleCc(""!==this.ccAddr()),this.visibleBcc(""!==this.bccAddr()),this.commit(!0)},CComposeView.prototype.focusToAddr=function(){$(this.toAddrDom()).inputosaurus("focus")},CComposeView.prototype.focusCcAddr=function(){$(this.ccAddrDom()).inputosaurus("focus")},CComposeView.prototype.focusBccAddr=function(){$(this.bccAddrDom()).inputosaurus("focus")},CComposeView.prototype.focusAfterFilling=function(){switch(this.focusedField()){case"to":this.focusToAddr();break;case"cc":this.visibleCc(!0),this.focusCcAddr();break;case"bcc":this.visibleBcc(!0),this.focusBccAddr();break;case"subject":this.subjectFocused(!0);break;case"text":this.oHtmlEditor.setFocus();break;default:0===this.toAddr().length?this.focusToAddr():0===this.subject().length?this.subjectFocused(!0):this.oHtmlEditor.setFocus()}},CComposeView.prototype.onHide=function(){!_.isFunction(this.closePopup)&&this.hasUnsavedChanges()&&this.executeSave(!0),this.headersCompressed(!1),this.routeParams([]),this.subjectFocused(!1),this.focusedField(""),this.messageUploadAttachmentsStarted(!1),$html.removeClass("screen-compose").removeClass("screen-compose-cc").removeClass("screen-compose-bcc").removeClass("screen-compose-attachments"),this.oJua&&this.oJua.setDragAndDropEnabledStatus(!1)},CComposeView.prototype.setRecipient=function(e,t){e()===t?e.valueHasMutated():e(t)},CComposeView.prototype.onMessageResponse=function(e){var t=null;if(null===e)this.setDataFromMessage(new CMessageModel);else{switch(this.routeType()){case Enums.ReplyType.Reply:case Enums.ReplyType.ReplyAll:SenderSelector.setFetcherOrIdentityByReplyMessage(e),t=SendingUtils.getReplyDataFromMessage(e,this.routeType(),this.senderAccountId(),this.selectedFetcherOrIdentity(),!0),this.draftInfo(t.DraftInfo),this.draftUid(t.DraftUid),this.setRecipient(this.toAddr,t.To),this.setRecipient(this.ccAddr,t.Cc),this.setRecipient(this.bccAddr,t.Bcc),this.subject(t.Subject),this.textBody(t.Text),this.attachments(t.Attachments),this.inReplyTo(t.InReplyTo),this.references(t.References);break;case Enums.ReplyType.ForwardAsAttach:t=SendingUtils.getReplyDataFromMessage(e,this.routeType(),this.senderAccountId(),this.selectedFetcherOrIdentity(),!0),this.draftInfo(t.DraftInfo),this.draftUid(t.DraftUid),this.inReplyTo(t.InReplyTo),this.references(t.References);break;case Enums.ReplyType.Forward:SenderSelector.setFetcherOrIdentityByReplyMessage(e),t=SendingUtils.getReplyDataFromMessage(e,this.routeType(),this.senderAccountId(),this.selectedFetcherOrIdentity(),!0),this.draftInfo(t.DraftInfo),this.draftUid(t.DraftUid),this.setRecipient(this.toAddr,t.To),this.setRecipient(this.ccAddr,t.Cc),this.subject(t.Subject),this.textBody(t.Text),this.attachments(t.Attachments),this.inReplyTo(t.InReplyTo),this.references(t.References);break;case Enums.ReplyType.Resend:this.setDataFromMessage(e);break;case"drafts":-1!==$.inArray(e.folder(),MailCache.getCurrentTemplateFolders())?(this.templateUid(e.uid()),this.templateFolderName(e.folder())):this.draftUid(e.uid()),this.setDataFromMessage(e)}this.routeType()!==Enums.ReplyType.ForwardAsAttach&&this.attachments().length>0&&this.requestAttachmentsTempName(),this.routeType("")}this.visibleCc(""!==this.ccAddr()),this.visibleBcc(""!==this.bccAddr()),this.commit(!0),_.defer(_.bind(function(){this.focusAfterFilling()},this))},CComposeView.prototype.setDataFromMessage=function(e){var t="",s=SendingUtils.getFirstFetcherOrIdentityByRecipientsOrDefault(e.oFrom.aCollection,e.accountId());SenderSelector.changeSenderAccountId(e.accountId(),s),t=e.isPlain()?e.textRaw():e.getConvertedHtml(),this.draftInfo(e.draftInfo()),this.inReplyTo(e.inReplyTo()),this.references(e.references()),this.setRecipient(this.toAddr,e.oTo.getFull()),this.setRecipient(this.ccAddr,e.oCc.getFull()),this.setRecipient(this.bccAddr,e.oBcc.getFull()),this.subject(e.subject()),this.attachments(e.attachments()),this.plainText(e.isPlain()),this.textBody(t),this.selectedImportance(e.importance()),this.sendReadingConfirmation(""!==e.readingConfirmationAddressee());var i=!!e.folderObject()&&e.folderObject().type()===Enums.FolderTypes.Drafts;this.triggerToolbarControllersAfterPopulatingMessage(i,e.isPlain(),e.textRaw(),e.sensitivity())},CComposeView.prototype.triggerToolbarControllersAfterPopulatingMessage=function(e,t,s,i){_.each(this.toolbarControllers(),function(o){_.isFunction(o.doAfterPopulatingMessage)&&o.doAfterPopulatingMessage({bDraft:e,bPlain:t,sRawText:s,iSensitivity:i})})},CComposeView.prototype.onDataAsAttachmentUpload=function(e,t){var s=t.Parameters,i=e.Result,o=s.Hash,n=_.find(this.attachments(),function(e){return e.hash()===o});this.messageUploadAttachmentsStarted(!1),n&&(i&&i.Attachment?n.parseFromUpload(i.Attachment):n.errorFromUpload())},CComposeView.prototype.addAttachments=function(e){_.each(e,_.bind(function(e){var t=new CAttachmentModel;t.parseFromUpload(e),this.attachments.push(t)},this))},CComposeView.prototype.addFilesAsAttachment=function(e){var t=null,s=[];_.each(e,function(e){(t=new CAttachmentModel).fileName(e.fileName()),t.hash(e.hash()),t.thumbUrlInQueue(e.thumbUrlInQueue()),t.uploadStarted(!0),this.attachments.push(t),s.push(e.hash())},this),s.length>0&&(this.messageUploadAttachmentsStarted(!0),CoreAjax.send("Files","GetFilesForUpload",{Hashes:s},this.onFilesUpload,this))},CComposeView.prototype.onFilesUpload=function(e,t){var s=t.Parameters,i=e.Result,o=s.Hashes;this.messageUploadAttachmentsStarted(!1),_.isArray(i)?_.each(i,function(e){var t=_.find(this.attachments(),function(t){return t.hash()===e.Hash});t&&(t.parseFromUpload(e),t.hash(e.NewHash))},this):_.each(o,function(e){var t=_.find(this.attachments(),function(t){return t.hash()===e});t&&t.errorFromUpload()},this)},CComposeView.prototype.addMessageAsAttachment=function(e){var t=new CAttachmentModel,s=null;e&&(t.fileName(e.subject()+".eml"),t.uploadStarted(!0),this.attachments.push(t),s={MessageFolder:e.folder(),MessageUid:e.uid(),FileName:t.fileName()},this.messageUploadAttachmentsStarted(!0),Ajax.send("SaveMessageAsTempFile",s,this.onSaveMessageAsTempFile,this))},CComposeView.prototype.onSaveMessageAsTempFile=function(e,t){var s=e.Result,i=t.Parameters.FileName,o=null;this.messageUploadAttachmentsStarted(!1),s?(o=_.find(this.attachments(),function(e){return e.fileName()===i&&e.uploadStarted()}))&&o.parseFromUpload(s,t.Parameters.MessageFolder,t.Parameters.MessageUid):(o=_.find(this.attachments(),function(e){return e.fileName()===i&&e.uploadStarted()}))&&o.errorFromUpload()},CComposeView.prototype.onContactVCardUpload=function(e,t){var s=t.Parameters,i=e.Result,o=null;this.messageUploadAttachmentsStarted(!1),i?(o=_.find(this.attachments(),function(e){return e.fileName()===i.Name&&e.uploadStarted()}))&&o.parseFromUpload(i):(o=_.find(this.attachments(),function(e){return e.fileName()===s.Name&&e.uploadStarted()}))&&o.errorFromUpload()},CComposeView.prototype.requestAttachmentsTempName=function(){var e=_.map(this.attachments(),function(e){return e.uploadUid(e.hash()),e.uploadStarted(!0),e.hash()});e.length>0&&(this.messageUploadAttachmentsStarted(!0),Ajax.send("SaveAttachmentsAsTempFiles",{Attachments:e},this.onMessageUploadAttachmentsResponse,this))},CComposeView.prototype.onMessageUploadAttachmentsResponse=function(e,t){var s=t.Parameters.Attachments;this.messageUploadAttachmentsStarted(!1),e.Result?_.each(e.Result,_.bind(this.setAttachTepmNameByHash,this)):(_.each(s,function(e){var t=_.find(this.attachments(),function(t){return t.hash()===e});t&&t.errorFromUpload()},this),Screens.showError(TextUtils.i18n("%MODULENAME%/ERROR_UPLOAD_FORWARD_ATTACHMENTS")))},CComposeView.prototype.setAttachTepmNameByHash=function(e,t){_.each(this.attachments(),function(s){s.hash()===e&&(s.tempName(t),s.uploadStarted(!1))})},CComposeView.prototype.setMessageDataInNewTab=function(e){this.templateUid(e.templateUid),this.templateFolderName(e.templateFolderName),this.draftInfo(e.draftInfo),this.draftUid(e.draftUid),this.inReplyTo(e.inReplyTo),this.references(e.references),this.setRecipient(this.toAddr,e.toAddr),this.setRecipient(this.ccAddr,e.ccAddr),this.setRecipient(this.bccAddr,e.bccAddr),this.subject(e.subject),this.attachments(_.map(e.attachments,function(e){var t=new CAttachmentModel;return t.parse(e),t},this)),this.plainText(e.plainText),this.textBody(e.textBody),this.selectedImportance(e.selectedImportance),this.sendReadingConfirmation(e.sendReadingConfirmation),this.changedInPreviousWindow(e.changedInPreviousWindow),_.each(this.toolbarControllers(),function(t){_.isFunction(t.doAfterApplyingMainTabParameters)&&t.doAfterApplyingMainTabParameters(e)}),SenderSelector.changeSenderAccountId(e.senderAccountId,e.selectedFetcherOrIdentity),this.focusedField(e.focusedField)},CComposeView.prototype.commit=function(e){this.toAddr.commit(),this.ccAddr.commit(),this.bccAddr.commit(),this.subject.commit(),this.selectedImportance.commit(),this.sendReadingConfirmation.commit(),_.each(this.toolbarControllers(),function(e){_.isFunction(e.commit)&&e.commit()}),this.oHtmlEditor.commit(),this.attachmentsChanged(!1),e||this.changedInPreviousWindow(!1)},CComposeView.prototype.isChanged=function(){var e=this.toAddr.changed(),t=this.ccAddr.changed(),s=this.bccAddr.changed(),i=this.subject.changed(),o=this.selectedImportance.changed(),n=this.sendReadingConfirmation.changed(),a=!1,r=this.oHtmlEditor.textChanged(),d=this.attachmentsChanged(),h=this.changedInPreviousWindow();return _.each(this.toolbarControllers(),function(e){_.isFunction(e.isChanged)&&(a=a||e.isChanged())}),e||t||s||i||o||n||a||r||d||h},CComposeView.prototype.executeBackToList=function(){App.isNewTab()?window.close():this.shown&&this.shown()&&Routing.setPreviousHash(),this.backToListOnSendOrSave(!1)},CComposeView.prototype.onFileUploadSelect=function(e,t){var s;return!FilesUtils.showErrorIfAttachmentSizeLimit(t.FileName,Types.pInt(t.Size))&&((s=new CAttachmentModel).onUploadSelect(e,t),this.attachments.push(s),!0)},CComposeView.prototype.getAttachmentByUid=function(e){return _.find(this.attachments(),function(t){return t.uploadUid()===e})},CComposeView.prototype.onFileUploadStart=function(e){var t=this.getAttachmentByUid(e);t&&t.onUploadStart()},CComposeView.prototype.onFileUploadProgress=function(e,t,s){var i=this.getAttachmentByUid(e);i&&i.onUploadProgress(t,s)},CComposeView.prototype.onFileUploadComplete=function(e,t,s){var i=this.getAttachmentByUid(e);i&&i.onUploadComplete(e,t,s)},CComposeView.prototype.onFileRemove=function(e){var t=this.getAttachmentByUid(e);this.oJua&&this.oJua.cancel(e),this.attachments.remove(t)},CComposeView.prototype.initUploader=function(){this.composeShown()&&this.composeUploaderButton()&&(this.oJua=new CJua({action:"?/Api/",name:"jua-uploader",queueSize:2,clickElement:this.composeUploaderButton(),hiddenElementsPosition:UserSettings.IsRTL?"right":"left",dragAndDropElement:this.composeUploaderDropPlace(),disableAjaxUpload:!1,disableFolderDragAndDrop:!1,disableDragAndDrop:!1,hidden:_.extendOwn({Module:Settings.ServerModuleName,Method:"UploadAttachment",Parameters:function(){return JSON.stringify({AccountID:MailCache.currentAccountId()})}},App.getCommonRequestParameters())}),this.oJua.on("onDragEnter",_.bind(this.composeUploaderDragOver,this,!0)).on("onDragLeave",_.bind(this.composeUploaderDragOver,this,!1)).on("onBodyDragEnter",_.bind(this.composeUploaderBodyDragOver,this,!0)).on("onBodyDragLeave",_.bind(this.composeUploaderBodyDragOver,this,!1)).on("onProgress",_.bind(this.onFileUploadProgress,this)).on("onSelect",_.bind(this.onFileUploadSelect,this)).on("onStart",_.bind(this.onFileUploadStart,this)).on("onComplete",_.bind(this.onFileUploadComplete,this)),this.allowDragNDrop(this.oJua.isDragAndDropSupported()))},CComposeView.prototype.getSendSaveParameters=function(e,t){var s=SendingUtils.convertAttachmentsForSending(this.attachments()),i=null;return _.each(this.oHtmlEditor.getUploadedImagesData(),function(e){s[e.TempName]=[e.Name,e.CID,"1","1"]}),i={AccountID:this.senderAccountId(),FetcherID:this.selectedFetcherOrIdentity()&&this.selectedFetcherOrIdentity().FETCHER?this.selectedFetcherOrIdentity().id():"",IdentityID:this.selectedFetcherOrIdentity()&&!this.selectedFetcherOrIdentity().FETCHER?this.selectedFetcherOrIdentity().id():"",DraftInfo:this.draftInfo(),DraftUid:this.draftUid(),To:this.toAddr(),Cc:this.ccAddr(),Bcc:this.bccAddr(),Subject:this.subject(),Text:this.plainText()?this.oHtmlEditor.getPlainText():this.oHtmlEditor.getText(e),IsHtml:!this.plainText(),Importance:this.selectedImportance(),SendReadingConfirmation:this.sendReadingConfirmation(),Attachments:s,InReplyTo:this.inReplyTo(),References:this.references()},_.each(this.toolbarControllers(),function(e){_.isFunction(e.doAfterPreparingSendMessageParameters)&&e.doAfterPreparingSendMessageParameters(i)}),""!==this.templateFolderName()&&t&&(i.DraftFolder=this.templateFolderName(),i.DraftUid=this.templateUid()),i},CComposeView.prototype.onSendOrSaveMessageResponse=function(e,t){var s=SendingUtils.onSendOrSaveMessageResponse(e,t,this.requiresPostponedSending()),i=t.Parameters;switch(this.commit(),s.Method){case"SaveMessage":s.Result&&i.DraftUid===this.templateUid()&&i.DraftFolder===this.templateFolderName()?(this.templateUid(Types.pString(s.NewUid)),this.composeShown()&&this instanceof CComposeView&&Routing.replaceHashDirectly(LinksUtils.getComposeFromMessage("drafts",i.DraftFolder,this.templateUid()))):s.Result&&i.DraftUid===this.draftUid()&&(this.draftUid(Types.pString(s.NewUid)),this.composeShown()&&this instanceof CComposeView&&Routing.replaceHashDirectly(LinksUtils.getComposeFromMessage("drafts",i.DraftFolder,this.draftUid()))),this.saving(!1);break;case"SendMessage":s.Result&&this.backToListOnSendOrSave()&&(_.isFunction(this.closePopup)?this.closePopup():this.executeBackToList()),this.sending(!1)}},CComposeView.prototype.verifyDataForSending=function(){var e=AddressUtils.getIncorrectEmailsFromAddressString(this.toAddr()),t=AddressUtils.getIncorrectEmailsFromAddressString(this.ccAddr()),s=AddressUtils.getIncorrectEmailsFromAddressString(this.bccAddr()),i=_.union(e,t,s),o=_.map(i,function(e){return TextUtils.encodeHtml(e)}),n=TextUtils.i18n("%MODULENAME%/ERROR_INPUT_CORRECT_EMAILS")+o.join(", ");return!(i.length>0)||(Popups.showPopup(AlertPopup,[n]),!1)},CComposeView.prototype.executeSend=function(e){var t=!1,s=_.bind(function(){this.sending(!0),this.requiresPostponedSending(!this.allowStartSending()),SendingUtils.send("SendMessage",this.getSendSaveParameters(!0),!0,this.onSendOrSaveMessageResponse,this,this.requiresPostponedSending()),this.backToListOnSendOrSave(!0)},this);this.isEnableSending()&&this.verifyDataForSending()&&(_.each(this.toolbarControllers(),function(e){_.isFunction(e.doBeforeSend)&&(t=t||e.doBeforeSend(s))}),t||s())},CComposeView.prototype.executeSaveCommand=function(){this.draftFolderIsAvailable()&&this.executeSave(!1)},CComposeView.prototype.executeTemplateSaveCommand=function(){this.executeSave(!1,!0,!0)},CComposeView.prototype.executeSave=function(e,t,s){e=!!e,s=!!s;var i=(t=void 0===t||t)?this.onSendOrSaveMessageResponse:SendingUtils.onSendOrSaveMessageResponse,o=t?this:SendingUtils,n=_.bind(function(n){n&&(this.saving(t),SendingUtils.send("SaveMessage",this.getSendSaveParameters(!1,s),!e,i,o))},this),a=!1;this.isEnableSaving()&&(e&&!this.isChanged()||(e||_.each(this.toolbarControllers(),function(e){_.isFunction(e.doBeforeSave)&&(a=a||e.doBeforeSave(n))},this),a||n(!0)),this.backToListOnSendOrSave(!0))},CComposeView.prototype.changeBccVisibility=function(){this.visibleBcc(!this.visibleBcc()),this.visibleBcc()?this.focusBccAddr():this.focusToAddr()},CComposeView.prototype.changeCcVisibility=function(){this.visibleCc(!this.visibleCc()),this.visibleCc()?this.focusCcAddr():this.focusToAddr()},CComposeView.prototype.getMessageDataForNewTab=function(){var e=_.map(this.attachments(),function(e){return{"@Object":"Object/Aurora\\Modules\\Mail\\Classes\\Attachment",FileName:e.fileName(),TempName:e.tempName(),MimeType:e.mimeType(),MimePartIndex:e.mimePartIndex(),EstimatedSize:e.size(),CID:e.cid(),ContentLocation:e.contentLocation(),IsInline:e.inline(),IsLinked:e.linked(),Hash:e.hash()}}),t=null;return t={accountId:this.senderAccountId(),templateUid:this.templateUid(),templateFolderName:this.templateFolderName(),draftInfo:this.draftInfo(),draftUid:this.draftUid(),inReplyTo:this.inReplyTo(),references:this.references(),senderAccountId:this.senderAccountId(),selectedFetcherOrIdentity:this.selectedFetcherOrIdentity(),toAddr:this.toAddr(),ccAddr:this.ccAddr(),bccAddr:this.bccAddr(),subject:this.subject(),attachments:e,plainText:this.plainText(),textBody:this.plainText()?this.oHtmlEditor.getPlainText():this.oHtmlEditor.getText(),selectedImportance:this.selectedImportance(),sendReadingConfirmation:this.sendReadingConfirmation(),changedInPreviousWindow:this.isChanged(),focusedField:this.focusedField()},_.each(this.toolbarControllers(),function(e){_.isFunction(e.doAfterPreparingMainTabParameters)&&e.doAfterPreparingMainTabParameters(t)}),t},CComposeView.prototype.openInNewWindow=function(){var e="id"+Math.random().toString(),t={},s=Routing.buildHashFromArray(LinksUtils.getCompose());this.ignoreHasUnsavedChanges(!0),t=this.getMessageDataForNewTab(),this.draftUid().length>0&&!this.isChanged()?(s=Routing.buildHashFromArray(LinksUtils.getComposeFromMessage("drafts",MailCache.folderList().draftsFolderFullName(),this.draftUid(),!0)),WindowOpener.openTab("?message-newtab"+s)):this.templateUid().length>0&&!this.isChanged()?(s=Routing.buildHashFromArray(LinksUtils.getComposeFromMessage("drafts",this.templateFolderName(),this.templateUid(),!0)),WindowOpener.openTab("?message-newtab"+s)):this.isChanged()?(MainTabExtMethods.passComposedMessage(e,t),WindowOpener.openTab("?message-newtab"+s,e)):(this.routeParams().length>0&&(s=Routing.buildHashFromArray(_.union([Settings.HashModuleName+"-compose"],this.routeParams()))),WindowOpener.openTab("?message-newtab"+s)),this.commit(),_.isFunction(this.closePopup)?this.closePopup():this.executeBackToList()},CComposeView.prototype.onShowFilesPopupClick=function(){this.bAllowFiles&&Popups.showPopup(SelectFilesPopup,[_.bind(this.addFilesAsAttachment,this)])},CComposeView.prototype.registerOwnToolbarControllers=function(){this.registerToolbarController({ViewTemplate:"%ModuleName%_Compose_BackButtonView",sId:"back",bOnlyMobile:!0,backToListCommand:this.backToListCommand}),this.registerToolbarController({ViewTemplate:"%ModuleName%_Compose_SendButtonView",sId:"send",bAllowMobile:!0,sendCommand:this.sendCommand}),this.registerToolbarController({ViewTemplate:"%ModuleName%_Compose_SaveButtonView",sId:"save",bAllowMobile:!0,visible:this.draftFolderIsAvailable,saveCommand:this.saveCommand}),this.registerToolbarController({ViewTemplate:"%ModuleName%_Compose_SaveTemplateButtonView",sId:"save-template",bAllowMobile:!1,visible:this.visibleSaveTemplateControl,saveTemplateCommand:this.saveTemplateCommand}),this.registerToolbarController({ViewTemplate:"%ModuleName%_Compose_ImportanceDropdownView",sId:"importance",selectedImportance:this.selectedImportance}),this.registerToolbarController({ViewTemplate:"%ModuleName%_Compose_ConfirmationCheckboxView",sId:"confirmation",sendReadingConfirmation:this.sendReadingConfirmation})},CComposeView.prototype.registerToolbarController=function(e){var t=App.isMobile()?e.bAllowMobile:!e.bOnlyMobile,s=Settings.ComposeToolbarOrder.length;t&&(this.toolbarControllers.push(e),this.toolbarControllers(_.sortBy(this.toolbarControllers(),function(e){var t=_.indexOf(Settings.ComposeToolbarOrder,e.sId);return-1!==t?t:s})),_.isFunction(e.assignComposeExtInterface)&&e.assignComposeExtInterface(this.getExtInterface()))},CComposeView.prototype.getExtInterface=function(){return{isHtml:_.bind(function(){return!this.plainText()},this),hasAttachments:_.bind(function(){return this.notInlineAttachments().length>0},this),getPlainText:_.bind(this.oHtmlEditor.getPlainText,this.oHtmlEditor),getFromEmail:_.bind(function(){return AccountList.getEmail(this.senderAccountId())},this),getRecipientEmails:_.bind(function(){return this.recipientEmails()},this),saveSilently:_.bind(this.executeSave,this,!0),setPlainTextMode:_.bind(this.plainText,this,!0),setPlainText:_.bind(function(e){this.textBody(e)},this),setHtmlTextMode:_.bind(this.plainText,this,!1),setHtmlText:_.bind(function(e){this.textBody(e)},this),undoHtml:_.bind(this.oHtmlEditor.undoAndClearRedo,this.oHtmlEditor)}},module.exports=CComposeView;