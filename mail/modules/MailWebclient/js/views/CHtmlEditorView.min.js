"use strict";function CHtmlEditorView(t,e){this.oParent=e,this.creaId="creaId"+Math.random().toString().replace(".",""),this.textFocused=ko.observable(!1),this.workareaDom=ko.observable(),this.uploaderAreaDom=ko.observable(),this.editorUploaderBodyDragOver=ko.observable(!1),this.htmlEditorDom=ko.observable(),this.toolbarDom=ko.observable(),this.colorPickerDropdownDom=ko.observable(),this.insertLinkDropdownDom=ko.observable(),this.insertImageDropdownDom=ko.observable(),this.isFWBold=ko.observable(!1),this.isFSItalic=ko.observable(!1),this.isTDUnderline=ko.observable(!1),this.isTDStrikeThrough=ko.observable(!1),this.isEnumeration=ko.observable(!1),this.isBullets=ko.observable(!1),this.isEnable=ko.observable(!0),this.isEnable.subscribe(function(){this.oCrea&&this.oCrea.setEditable(this.isEnable())},this),this.bInsertImageAsBase64=t,this.bAllowFileUpload=!(t&&void 0===window.File),this.bAllowInsertImage=Settings.AllowInsertImage,this.lockFontSubscribing=ko.observable(!1),this.bAllowImageDragAndDrop=!Browser.ie10AndAbove,this.aFonts=["Arial","Arial Black","Courier New","Tahoma","Times New Roman","Verdana"],this.sDefaultFont=Settings.DefaultFontName,this.correctFontFromSettings(),this.selectedFont=ko.observable(""),this.selectedFont.subscribe(function(){!this.oCrea||this.lockFontSubscribing()||this.inactive()||this.oCrea.fontName(this.selectedFont())},this),this.iDefaultSize=Settings.DefaultFontSize,this.selectedSize=ko.observable(0),this.selectedSize.subscribe(function(){!this.oCrea||this.lockFontSubscribing()||this.inactive()||this.oCrea.fontSize(this.selectedSize())},this),this.visibleInsertLinkPopup=ko.observable(!1),this.linkForInsert=ko.observable(""),this.linkFocused=ko.observable(!1),this.visibleLinkPopup=ko.observable(!1),this.linkPopupDom=ko.observable(null),this.linkHrefDom=ko.observable(null),this.linkHref=ko.observable(""),this.visibleLinkHref=ko.observable(!1),this.visibleImagePopup=ko.observable(!1),this.visibleImagePopup.subscribe(function(){this.onImageOut()},this),this.imagePopupTop=ko.observable(0),this.imagePopupLeft=ko.observable(0),this.imageSelected=ko.observable(!1),this.tooltipText=ko.observable(""),this.tooltipPopupTop=ko.observable(0),this.tooltipPopupLeft=ko.observable(0),this.visibleInsertImagePopup=ko.observable(!1),this.imageUploaderButton=ko.observable(null),this.aUploadedImagesData=[],this.imagePathFromWeb=ko.observable(""),this.visibleFontColorPopup=ko.observable(!1),this.oFontColorPickerView=new CColorPickerView(TextUtils.i18n("%MODULENAME%/LABEL_TEXT_COLOR"),this.setTextColorFromPopup,this),this.oBackColorPickerView=new CColorPickerView(TextUtils.i18n("%MODULENAME%/LABEL_BACKGROUND_COLOR"),this.setBackColorFromPopup,this),this.inactive=ko.observable(!1),this.sPlaceholderText="",this.bAllowChangeInputDirection=UserSettings.IsRTL||Settings.AllowChangeInputDirection,this.disableEdit=ko.observable(!1),this.textChanged=ko.observable(!1),this.actualTextСhanged=ko.observable(!1)}var _=require("underscore"),$=require("jquery"),ko=require("knockout"),AddressUtils=require("%PathToCoreWebclientModule%/js/utils/Address.js"),TextUtils=require("%PathToCoreWebclientModule%/js/utils/Text.js"),Types=require("%PathToCoreWebclientModule%/js/utils/Types.js"),App=require("%PathToCoreWebclientModule%/js/App.js"),Browser=require("%PathToCoreWebclientModule%/js/Browser.js"),CJua=require("%PathToCoreWebclientModule%/js/CJua.js"),UserSettings=require("%PathToCoreWebclientModule%/js/Settings.js"),Popups=require("%PathToCoreWebclientModule%/js/Popups.js"),AlertPopup=require("%PathToCoreWebclientModule%/js/popups/AlertPopup.js"),CAttachmentModel=require("modules/%ModuleName%/js/models/CAttachmentModel.js"),CCrea=require("modules/%ModuleName%/js/CCrea.js"),MailCache=require("modules/%ModuleName%/js/Cache.js"),Settings=require("modules/%ModuleName%/js/Settings.js"),CColorPickerView=require("modules/%ModuleName%/js/views/CColorPickerView.js");CHtmlEditorView.prototype.ViewTemplate="%ModuleName%_HtmlEditorView",CHtmlEditorView.prototype.setInactive=function(t){this.inactive(t),this.inactive()?this.setPlaceholder():this.removePlaceholder()},CHtmlEditorView.prototype.setPlaceholder=function(){var t=this.removeAllTags(this.getText());""!==t&&"&nbsp;"!==t||(this.setText("<span>"+this.sPlaceholderText+"</span>"),this.oCrea&&this.oCrea.setBlur())},CHtmlEditorView.prototype.removePlaceholder=function(){(this.oCrea?this.removeAllTags(this.oCrea.getText(!1)):"")===this.sPlaceholderText&&(this.setText(""),this.oCrea&&this.oCrea.setFocus(!0))},CHtmlEditorView.prototype.hasOpenedPopup=function(){return this.visibleInsertLinkPopup()||this.visibleLinkPopup()||this.visibleImagePopup()||this.visibleInsertImagePopup()||this.visibleFontColorPopup()},CHtmlEditorView.prototype.setDisableEdit=function(t){this.disableEdit(!!t)},CHtmlEditorView.prototype.correctFontFromSettings=function(){var t=this.sDefaultFont,e=!1;_.each(this.aFonts,function(i){i.toLowerCase()===t.toLowerCase()&&(t=i,e=!0)}),e?this.sDefaultFont=t:this.aFonts.push(t)},CHtmlEditorView.prototype.showLinkPopup=function(t){var e=$(this.workareaDom()),i=e.closest(".panel.compose"),o=e.position(),s=t.position(),r=t.height(),n=Math.round(s.left+o.left),a=Math.round(s.top+r+o.top);this.linkHref(t.attr("href")||t.text()),$(this.linkPopupDom()).css({left:n,top:a}),$(this.linkHrefDom()).css({left:n,top:a}),Browser.firefox||1!==i.length||$(this.linkPopupDom()).css({"max-width":i.width()-n-40+"px","white-space":"pre-line","word-wrap":"break-word"}),this.visibleLinkPopup(!0)},CHtmlEditorView.prototype.hideLinkPopup=function(){this.visibleLinkPopup(!1)},CHtmlEditorView.prototype.showChangeLink=function(){this.visibleLinkHref(!0),this.hideLinkPopup()},CHtmlEditorView.prototype.changeLink=function(){this.oCrea.changeLink(this.linkHref()),this.hideChangeLink()},CHtmlEditorView.prototype.hideChangeLink=function(){this.visibleLinkHref(!1)},CHtmlEditorView.prototype.showImagePopup=function(t,e){var i=$(this.workareaDom()),o=i.position(),s=i.offset();this.imagePopupLeft(Math.round(e.pageX+o.left-s.left)),this.imagePopupTop(Math.round(e.pageY+o.top-s.top)),this.visibleImagePopup(!0)},CHtmlEditorView.prototype.hideImagePopup=function(){this.visibleImagePopup(!1)},CHtmlEditorView.prototype.resizeImage=function(t){var e={width:"auto",height:"auto"};switch(t){case Enums.HtmlEditorImageSizes.Small:e.width="300px";break;case Enums.HtmlEditorImageSizes.Medium:e.width="600px";break;case Enums.HtmlEditorImageSizes.Large:e.width="1200px";break;case Enums.HtmlEditorImageSizes.Original:e.width="auto"}this.oCrea.changeCurrentImage(e),this.visibleImagePopup(!1)},CHtmlEditorView.prototype.onImageOver=function(t){if("IMG"===t.target.nodeName&&!this.visibleImagePopup()){this.imageSelected(!0),this.tooltipText(TextUtils.i18n("%MODULENAME%/ACTION_CLICK_TO_EDIT_IMAGE"));var e=this,i=$(this.workareaDom());i.bind("mousemove.image",function(t){var o=i.position(),s=i.offset();e.tooltipPopupTop(Math.round(t.pageY+o.top-s.top)),e.tooltipPopupLeft(Math.round(t.pageX+o.left-s.left))})}return!0},CHtmlEditorView.prototype.onImageOut=function(t){if(this.imageSelected()){this.imageSelected(!1);$(this.workareaDom()).unbind("mousemove.image")}return!0},CHtmlEditorView.prototype.commit=function(){this.textChanged(!1)},CHtmlEditorView.prototype.init=function(t,e,i,o){this.sPlaceholderText=o||"",this.oCrea?(this.oCrea.$container=$("#"+this.oCrea.oOptions.creaId),0===this.oCrea.$container.children().length&&(this.oCrea.start(this.isEnable()),this.initEditorUploader())):($(document.body).on("click",_.bind(function(t){0===$(t.target).parents("span.dropdown_helper").length&&this.closeAllPopups(!0)},this)),this.initEditorUploader(),this.oCrea=new CCrea({creaId:this.creaId,fontNameArray:this.aFonts,defaultFontName:this.sDefaultFont,defaultFontSize:this.iDefaultSize,alwaysTryUseImageWhilePasting:Settings.AlwaysTryUseImageWhilePasting,isRtl:UserSettings.IsRTL,enableDrop:!1,onChange:_.bind(function(){this.textChanged(!0),this.actualTextСhanged.valueHasMutated()},this),onCursorMove:_.bind(this.setFontValuesFromText,this),onFocus:_.bind(this.onCreaFocus,this),onBlur:_.bind(this.onCreaBlur,this),onUrlIn:_.bind(this.showLinkPopup,this),onUrlOut:_.bind(this.hideLinkPopup,this),onImageSelect:_.bind(this.showImagePopup,this),onImageBlur:_.bind(this.hideImagePopup,this),onItemOver:Browser.mobileDevice||App.isMobile()?null:_.bind(this.onImageOver,this),onItemOut:Browser.mobileDevice||App.isMobile()?null:_.bind(this.onImageOut,this),openInsertLinkDialog:_.bind(this.insertLink,this),onUrlClicked:!0}),this.oCrea.start(this.isEnable())),this.oCrea.setTabIndex(i),this.clearUndoRedo(),this.setText(t,e),this.setFontValuesFromText(),this.aUploadedImagesData=[],this.selectedFont(this.sDefaultFont),this.selectedSize(this.iDefaultSize)},CHtmlEditorView.prototype.isInitialized=function(){return!!this.oCrea},CHtmlEditorView.prototype.setFocus=function(){this.oCrea&&this.oCrea.setFocus(!1)},CHtmlEditorView.prototype.changeSignatureContent=function(t,e){this.oCrea&&this.oCrea.changeSignatureContent(t,e)},CHtmlEditorView.prototype.setFontValuesFromText=function(){this.lockFontSubscribing(!0),this.isFWBold(this.oCrea.getIsBold()),this.isFSItalic(this.oCrea.getIsItalic()),this.isTDUnderline(this.oCrea.getIsUnderline()),this.isTDStrikeThrough(this.oCrea.getIsStrikeThrough()),this.isEnumeration(this.oCrea.getIsEnumeration()),this.isBullets(this.oCrea.getIsBullets()),this.selectedFont(this.oCrea.getFontName()),this.selectedSize(this.oCrea.getFontSizeInNumber().toString()),this.lockFontSubscribing(!1)},CHtmlEditorView.prototype.isUndoAvailable=function(){return!!this.oCrea&&this.oCrea.isUndoAvailable()},CHtmlEditorView.prototype.getPlainText=function(){return this.oCrea?this.oCrea.getPlainText():""},CHtmlEditorView.prototype.getText=function(t){var e=this.oCrea?this.oCrea.getText(t):"";return""!==this.sPlaceholderText&&this.removeAllTags(e)===this.sPlaceholderText?"":e},CHtmlEditorView.prototype.setText=function(t,e){this.oCrea&&(e?this.oCrea.setPlainText(t):this.oCrea.setText(t),this.inactive()&&""===t&&this.setPlaceholder())},CHtmlEditorView.prototype.undoAndClearRedo=function(){this.oCrea&&(this.oCrea.undo(),this.oCrea.clearRedo())},CHtmlEditorView.prototype.clearUndoRedo=function(){this.oCrea&&this.oCrea.clearUndoRedo()},CHtmlEditorView.prototype.isEditing=function(){return!!this.oCrea&&this.oCrea.bEditing},CHtmlEditorView.prototype.removeAllTags=function(t){return t.replace(/<style>.*<\/style>/g,"").replace(/<[^>]*>/g,"")},CHtmlEditorView.prototype.onCreaFocus=function(){this.oCrea&&(this.closeAllPopups(),this.textFocused(!0))},CHtmlEditorView.prototype.onCreaBlur=function(){this.oCrea&&this.textFocused(!1)},CHtmlEditorView.prototype.onEscHandler=function(){Popups.hasOpenedMaximizedPopups()||this.closeAllPopups()},CHtmlEditorView.prototype.closeAllPopups=function(t){(t=!!t)||this.visibleLinkPopup(!1),this.visibleInsertLinkPopup(!1),this.visibleImagePopup(!1),this.visibleInsertImagePopup(!1),this.visibleFontColorPopup(!1)},CHtmlEditorView.prototype.insertHtml=function(t){this.oCrea&&(this.oCrea.isFocused()||this.oCrea.setFocus(!0),this.oCrea.insertHtml(t,!1))},CHtmlEditorView.prototype.insertLink=function(t,e){this.inactive()||this.visibleInsertLinkPopup()||(e&&_.isFunction(e.stopPropagation)&&e.stopPropagation(),this.linkForInsert(this.oCrea.getSelectedText()),this.closeAllPopups(),this.visibleInsertLinkPopup(!0),this.linkFocused(!0))},CHtmlEditorView.prototype.insertLinkFromPopup=function(t,e){return this.linkForInsert().length>0&&(AddressUtils.isCorrectEmail(this.linkForInsert())?this.oCrea.insertEmailLink(this.linkForInsert()):this.oCrea.insertLink(this.linkForInsert())),this.closeInsertLinkPopup(t,e),!1},CHtmlEditorView.prototype.closeInsertLinkPopup=function(t,e){this.visibleInsertLinkPopup(!1),e&&e.stopPropagation()},CHtmlEditorView.prototype.textColor=function(t,e){this.inactive()||(this.closeAllPopups(),this.visibleFontColorPopup()||(e.stopPropagation(),this.visibleFontColorPopup(!0),this.oFontColorPickerView.onShow(),this.oBackColorPickerView.onShow()))},CHtmlEditorView.prototype.colorToHex=function(t){if("#"===t.substr(0,1))return t;for(var e=/(.*?)rgb\((\d+), (\d+), (\d+)\)/.exec(t),i=Types.pInt(e[2]),o=Types.pInt(e[3]),s=(Types.pInt(e[4])|o<<8|i<<16).toString(16);s.length<6;)s="0"+s;return e[1]+"#"+s},CHtmlEditorView.prototype.setTextColorFromPopup=function(t){this.oCrea.textColor(this.colorToHex(t)),this.closeAllPopups()},CHtmlEditorView.prototype.setBackColorFromPopup=function(t){this.oCrea.backgroundColor(this.colorToHex(t)),this.closeAllPopups()},CHtmlEditorView.prototype.insertImage=function(t,e){return this.inactive()||!Settings.AllowInsertImage||this.visibleInsertImagePopup()||(e.stopPropagation(),this.imagePathFromWeb(""),this.closeAllPopups(),this.visibleInsertImagePopup(!0),this.initUploader()),!0},CHtmlEditorView.prototype.insertWebImageFromPopup=function(t,e){Settings.AllowInsertImage&&this.imagePathFromWeb().length>0&&this.oCrea.insertImage(this.imagePathFromWeb()),this.closeInsertImagePopup(t,e)},CHtmlEditorView.prototype.insertComputerImageFromPopup=function(t,e){var i=new CAttachmentModel,o="";i.parse(e),o=i.getActionUrl("view"),Settings.AllowInsertImage&&o.length>0&&this.oCrea.insertImage(o)&&($(this.oCrea.$editableArea).find('img[src="'+o+'"]').attr("data-x-src-cid",t),e.CID=t,this.aUploadedImagesData.push(e)),this.closeInsertImagePopup()},CHtmlEditorView.prototype.getUploadedImagesData=function(){return this.aUploadedImagesData},CHtmlEditorView.prototype.closeInsertImagePopup=function(t,e){this.visibleInsertImagePopup(!1),e&&e.stopPropagation()},CHtmlEditorView.prototype.initUploader=function(){this.imageUploaderButton()&&(this.oJua=new CJua({action:"?/Api/",name:"jua-uploader",queueSize:2,clickElement:this.imageUploaderButton(),hiddenElementsPosition:UserSettings.IsRTL?"right":"left",disableMultiple:!0,disableAjaxUpload:!1,disableDragAndDrop:!0,hidden:_.extendOwn({Module:Settings.ServerModuleName,Method:"UploadAttachment",Parameters:function(){return JSON.stringify({AccountID:MailCache.currentAccountId()})}},App.getCommonRequestParameters())}),this.bInsertImageAsBase64?this.oJua.on("onSelect",_.bind(this.onEditorDrop,this)):this.oJua.on("onSelect",_.bind(this.onFileUploadSelect,this)).on("onComplete",_.bind(this.onFileUploadComplete,this)))},CHtmlEditorView.prototype.initEditorUploader=function(){if(Settings.AllowInsertImage&&this.uploaderAreaDom()){var t=null,e=null;this.oParent&&this.oParent.composeUploaderDragOver&&this.oParent.onFileUploadProgress&&this.oParent.onFileUploadStart&&this.oParent.onFileUploadComplete?(t=_.bind(function(){this.editorUploaderBodyDragOver(!0),this.oParent.composeUploaderDragOver(!0)},this),e=_.bind(function(){this.editorUploaderBodyDragOver(!1),this.oParent.composeUploaderDragOver(!1)},this),this.editorUploader=new CJua({action:"?/Api/",name:"jua-uploader",queueSize:1,dragAndDropElement:this.bAllowImageDragAndDrop?this.uploaderAreaDom():null,disableMultiple:!0,disableAjaxUpload:!1,disableDragAndDrop:!this.bAllowImageDragAndDrop,hidden:_.extendOwn({Module:Settings.ServerModuleName,Method:"UploadAttachment",Parameters:function(){return JSON.stringify({AccountID:MailCache.currentAccountId()})}},App.getCommonRequestParameters())}),this.editorUploader.on("onDragEnter",_.bind(this.oParent.composeUploaderDragOver,this.oParent,!0)).on("onDragLeave",_.bind(this.oParent.composeUploaderDragOver,this.oParent,!1)).on("onBodyDragEnter",t).on("onBodyDragLeave",e).on("onProgress",_.bind(this.oParent.onFileUploadProgress,this.oParent)).on("onSelect",_.bind(this.onEditorDrop,this)).on("onStart",_.bind(this.oParent.onFileUploadStart,this.oParent)).on("onComplete",_.bind(this.oParent.onFileUploadComplete,this.oParent))):(t=_.bind(this.editorUploaderBodyDragOver,this,!0),e=_.bind(this.editorUploaderBodyDragOver,this,!1),this.editorUploader=new CJua({queueSize:1,dragAndDropElement:this.bAllowImageDragAndDrop?this.uploaderAreaDom():null,disableMultiple:!0,disableAjaxUpload:!1,disableDragAndDrop:!this.bAllowImageDragAndDrop}),this.editorUploader.on("onBodyDragEnter",t).on("onBodyDragLeave",e).on("onSelect",_.bind(this.onEditorDrop,this)))}},CHtmlEditorView.prototype.isDragAndDropSupported=function(){return!!this.editorUploader&&this.editorUploader.isDragAndDropSupported()},CHtmlEditorView.prototype.onEditorDrop=function(t,e){var i=null,o=null,s=this,r=!1,n=Math.random().toString(),a="";if(e&&e.File&&"string"==typeof e.File.type)if(Settings.AllowInsertImage&&0===e.File.type.indexOf("image/"))o=e.File,Settings.ImageUploadSizeLimit>0&&o.size>Settings.ImageUploadSizeLimit?Popups.showPopup(AlertPopup,[TextUtils.i18n("COREWEBCLIENT/ERROR_UPLOAD_SIZE")]):(i=new window.FileReader,(r=this.oCrea.isFocused())||this.oCrea.setFocus(!0),a=o.name+"_"+n,this.oCrea.insertHtml('<img id="'+a+'" src="./static/styles/images/wait.gif" />',!0),r||this.oCrea.fixFirefoxCursorBug(),i.onload=function(t){s.oCrea.changeImageSource(a,t.target.result)},i.readAsDataURL(o));else{if(this.oParent&&this.oParent.onFileUploadSelect)return this.oParent.onFileUploadSelect(t,e),!0;Browser.ie10AndAbove||Popups.showPopup(AlertPopup,[TextUtils.i18n("%MODULENAME%/ERROR_NOT_IMAGE_CHOOSEN")])}return!1},CHtmlEditorView.prototype.isFileImage=function(t){if("string"==typeof t.Type)return-1!==t.Type.indexOf("image");var e=t.FileName.lastIndexOf("."),i=t.FileName.substr(e+1);return-1!==$.inArray(i,["jpg","jpeg","gif","tif","tiff","png"])},CHtmlEditorView.prototype.onFileUploadSelect=function(t,e){return this.isFileImage(e)?(this.closeInsertImagePopup(),!0):(Popups.showPopup(AlertPopup,[TextUtils.i18n("%MODULENAME%/ERROR_NOT_IMAGE_CHOOSEN")]),!1)},CHtmlEditorView.prototype.onFileUploadComplete=function(t,e,i){var o="";i&&i.Result?i.Result.Error?(o="size"===i.Result.Error?TextUtils.i18n("COREWEBCLIENT/ERROR_UPLOAD_SIZE"):TextUtils.i18n("COREWEBCLIENT/ERROR_UPLOAD_UNKNOWN"),Popups.showPopup(AlertPopup,[o])):(this.oCrea.setFocus(!0),this.insertComputerImageFromPopup(t,i.Result.Attachment)):Popups.showPopup(AlertPopup,[TextUtils.i18n("COREWEBCLIENT/ERROR_UPLOAD_UNKNOWN")])},CHtmlEditorView.prototype.undo=function(){return this.inactive()||this.oCrea.undo(),!1},CHtmlEditorView.prototype.redo=function(){return this.inactive()||this.oCrea.redo(),!1},CHtmlEditorView.prototype.bold=function(){return this.inactive()||(this.oCrea.bold(),this.isFWBold(!this.isFWBold())),!1},CHtmlEditorView.prototype.italic=function(){return this.inactive()||(this.oCrea.italic(),this.isFSItalic(!this.isFSItalic())),!1},CHtmlEditorView.prototype.underline=function(){return this.inactive()||(this.oCrea.underline(),this.isTDUnderline(!this.isTDUnderline())),!1},CHtmlEditorView.prototype.strikeThrough=function(){return this.inactive()||(this.oCrea.strikeThrough(),this.isTDStrikeThrough(!this.isTDStrikeThrough())),!1},CHtmlEditorView.prototype.numbering=function(){return this.inactive()||(this.oCrea.numbering(),this.isBullets(!1),this.isEnumeration(!this.isEnumeration())),!1},CHtmlEditorView.prototype.bullets=function(){return this.inactive()||(this.oCrea.bullets(),this.isEnumeration(!1),this.isBullets(!this.isBullets())),!1},CHtmlEditorView.prototype.removeFormat=function(){return this.inactive()||this.oCrea.removeFormat(),!1},CHtmlEditorView.prototype.setRtlDirection=function(){return this.inactive()||this.oCrea.setRtlDirection(),!1},CHtmlEditorView.prototype.setLtrDirection=function(){return this.inactive()||this.oCrea.setLtrDirection(),!1},module.exports=CHtmlEditorView;