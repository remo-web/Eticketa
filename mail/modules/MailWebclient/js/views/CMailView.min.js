"use strict";function CMailView(){CAbstractScreenView.call(this,"%ModuleName%"),App.broadcastEvent("%ModuleName%::ConstructView::before",{Name:this.ViewConstructorName,View:this,MailCache:MailCache}),this.browserTitle=ko.computed(function(){return AccountList.getEmail()+" - "+TextUtils.i18n("%MODULENAME%/HEADING_BROWSER_TAB")}),this.folderList=MailCache.folderList,this.domFoldersMoveTo=ko.observable(null),this.openMessageInNewWindowBound=_.bind(this.openMessageInNewWindow,this),this.oFolderList=new CFolderListView,this.oMessageList=new CMessageListView(this.openMessageInNewWindowBound),this.oBaseMessagePaneView=MessagePaneView,this.messagePane=ko.observable(this.oBaseMessagePaneView),this.messagePane().openMessageInNewWindowBound=this.openMessageInNewWindowBound,this.messagePane.subscribe(function(){this.bindMessagePane()},this),this.isEnableGroupOperations=this.oMessageList.isEnableGroupOperations,this.composeLink=ko.observable(Routing.buildHashFromArray(LinksUtils.getCompose())),this.sCustomBigButtonModule="",this.fCustomBigButtonHandler=null,this.customBigButtonText=ko.observable(""),this.bigButtonCommand=Utils.createCommand(this,function(){_.isFunction(this.fCustomBigButtonHandler)?this.fCustomBigButtonHandler():this.executeCompose()}),this.bigButtonText=ko.computed(function(){return""!==this.customBigButtonText()?this.customBigButtonText():TextUtils.i18n("%MODULENAME%/ACTION_NEW_MESSAGE")},this),this.checkMailCommand=Utils.createCommand(this,this.executeCheckMail),this.checkMailIndicator=ko.observable(!0).extend({throttle:50}),ko.computed(function(){this.checkMailIndicator(MailCache.checkMailStarted()||MailCache.messagesLoading())},this),this.customModulesDisabledMark=ko.observableArray([]),this.visibleMarkTool=ko.computed(function(){return!Types.isNonEmptyArray(this.customModulesDisabledMark())},this),this.markAsReadCommand=Utils.createCommand(this.oMessageList,this.oMessageList.executeMarkAsRead,this.isEnableGroupOperations),this.markAsUnreadCommand=Utils.createCommand(this.oMessageList,this.oMessageList.executeMarkAsUnread,this.isEnableGroupOperations),this.markAllReadCommand=Utils.createCommand(this.oMessageList,this.oMessageList.executeMarkAllRead),this.customModulesDisabledMove=ko.observableArray([]),this.visibleMoveTool=ko.computed(function(){return!Types.isNonEmptyArray(this.customModulesDisabledMove())},this),this.moveToFolderCommand=Utils.createCommand(this,function(){},this.isEnableGroupOperations),this.deleteCommand=Utils.createCommand(this.oMessageList,this.oMessageList.executeDelete,this.isEnableGroupOperations),this.selectedCount=ko.computed(function(){return this.oMessageList.checkedUids().length},this),this.emptyTrashCommand=Utils.createCommand(MailCache,MailCache.executeEmptyTrash,this.oMessageList.isNotEmptyList),this.emptySpamCommand=Utils.createCommand(MailCache,MailCache.executeEmptySpam,this.oMessageList.isNotEmptyList),this.spamCommand=Utils.createCommand(this.oMessageList,this.oMessageList.executeSpam,this.isEnableGroupOperations),this.notSpamCommand=Utils.createCommand(this.oMessageList,this.oMessageList.executeNotSpam,this.isEnableGroupOperations),this.isVisibleReplyTool=ko.computed(function(){return this.folderList().currentFolder()&&this.folderList().currentFolderFullName().length>0&&this.folderList().currentFolderType()!==Enums.FolderTypes.Drafts&&this.folderList().currentFolderType()!==Enums.FolderTypes.Sent},this),this.isVisibleForwardTool=ko.computed(function(){return this.folderList().currentFolder()&&this.folderList().currentFolderFullName().length>0&&this.folderList().currentFolderType()!==Enums.FolderTypes.Drafts},this),this.isSpamFolder=ko.computed(function(){return this.folderList().currentFolderType()===Enums.FolderTypes.Spam},this),this.customModulesDisabledSpam=ko.observableArray([]),this.allowedSpamAction=ko.computed(function(){return Settings.AllowSpamFolder&&this.folderList().spamFolder()&&!this.isSpamFolder()&&!Types.isNonEmptyArray(this.customModulesDisabledSpam())},this),this.allowedNotSpamAction=ko.computed(function(){return Settings.AllowSpamFolder&&this.isSpamFolder()},this),this.isTrashFolder=ko.computed(function(){return this.folderList().currentFolderType()===Enums.FolderTypes.Trash},this),this.jqPanelHelper=null,Settings.HorizontalLayout&&$("html").addClass("layout-horiz-split"),App.subscribeEvent("CoreWebclient::GetDebugInfo",_.bind(function(e){e.Info.push("checkMailStarted: "+MailCache.checkMailStarted()+", messagesLoading: "+MailCache.messagesLoading())},this)),App.broadcastEvent("%ModuleName%::ConstructView::after",{Name:this.ViewConstructorName,View:this})}var _=require("underscore"),$=require("jquery"),ko=require("knockout"),TextUtils=require("%PathToCoreWebclientModule%/js/utils/Text.js"),Types=require("%PathToCoreWebclientModule%/js/utils/Types.js"),Utils=require("%PathToCoreWebclientModule%/js/utils/Common.js"),App=require("%PathToCoreWebclientModule%/js/App.js"),Routing=require("%PathToCoreWebclientModule%/js/Routing.js"),WindowOpener=require("%PathToCoreWebclientModule%/js/WindowOpener.js"),CAbstractScreenView=require("%PathToCoreWebclientModule%/js/views/CAbstractScreenView.js"),ComposeUtils=require("modules/%ModuleName%/js/utils/Compose.js"),LinksUtils=require("modules/%ModuleName%/js/utils/Links.js"),AccountList=require("modules/%ModuleName%/js/AccountList.js"),MailCache=require("modules/%ModuleName%/js/Cache.js"),Settings=require("modules/%ModuleName%/js/Settings.js"),CFolderListView=require("modules/%ModuleName%/js/views/CFolderListView.js"),CMessageListView=require("modules/%ModuleName%/js/views/CMessageListView.js"),MessagePaneView=require("modules/%ModuleName%/js/views/MessagePaneView.js");_.extendOwn(CMailView.prototype,CAbstractScreenView.prototype),CMailView.prototype.ViewTemplate=Settings.HorizontalLayout?"%ModuleName%_MailHorizontalLayoutView":"%ModuleName%_MailView",CMailView.prototype.ViewConstructorName="CMailView",CMailView.prototype.hasUnsavedChanges=function(){return this.messagePane()&&_.isFunction(this.messagePane().hasUnsavedChanges)&&this.messagePane().hasUnsavedChanges()},CMailView.prototype.discardChanges=function(){this.messagePane()&&_.isFunction(this.messagePane().discardChanges)&&this.messagePane().discardChanges()},CMailView.prototype.setCustomPreviewPane=function(e,s){this.messagePane().__customModuleName!==e&&(_.isFunction(this.messagePane().onHide)&&this.messagePane().onHide(),s.__customModuleName=e,this.messagePane(s),_.isFunction(this.messagePane().onShow)&&this.messagePane().onShow())},CMailView.prototype.removeCustomPreviewPane=function(e){this.messagePane().__customModuleName===e&&(_.isFunction(this.messagePane().onHide)&&this.messagePane().onHide(),this.messagePane(this.oBaseMessagePaneView),_.isFunction(this.messagePane().onShow)&&this.messagePane().onShow())},CMailView.prototype.setCustomBigButton=function(e,s,t){this.sCustomBigButtonModule=e,this.fCustomBigButtonHandler=s,this.customBigButtonText(t)},CMailView.prototype.removeCustomBigButton=function(e){this.sCustomBigButtonModule===e&&(this.sCustomBigButtonModule="",this.fCustomBigButtonHandler=null,this.customBigButtonText(""))},CMailView.prototype.resetDisabledTools=function(e,s){-1!==$.inArray("spam",s)?this.customModulesDisabledSpam(_.union(this.customModulesDisabledSpam(),[e])):this.customModulesDisabledSpam(_.without(this.customModulesDisabledSpam(),e)),-1!==$.inArray("move",s)?this.customModulesDisabledMove(_.union(this.customModulesDisabledMove(),[e])):this.customModulesDisabledMove(_.without(this.customModulesDisabledMove(),e)),-1!==$.inArray("mark",s)?this.customModulesDisabledMark(_.union(this.customModulesDisabledMark(),[e])):this.customModulesDisabledMark(_.without(this.customModulesDisabledMark(),e))},CMailView.prototype.executeCompose=function(){ComposeUtils.composeMessage()},CMailView.prototype.executeCheckMail=function(){MailCache.checkMessageFlags(),MailCache.executeCheckMail(!0)},CMailView.prototype.openMessageInNewWindow=function(e){if(e){var s=e.folder(),t=e.uid(),i="";this.folderList().getFolderByFullName(s).type()===Enums.FolderTypes.Drafts?i=Routing.buildHashFromArray(LinksUtils.getComposeFromMessage("drafts",s,t)):(i=Routing.buildHashFromArray(LinksUtils.getViewMessage(s,t)),_.isFunction(this.messagePane().passReplyDataToNewTab)&&this.messagePane().passReplyDataToNewTab(e.sUniq)),WindowOpener.openTab("?message-newtab"+i)}},CMailView.prototype.resizeDblClick=function(e,s){s.preventDefault(),s.stopPropagation?s.stopPropagation():s.cancelBubble=!0,Utils.removeSelection(),this.jqPanelHelper||(this.jqPanelHelper=$(".MailLayout .panel_helper")),this.jqPanelHelper.trigger("resize",[600,"max"])},CMailView.prototype.onRoute=function(e){if(AccountList.hasAccount()){var s=LinksUtils.parseMailbox(e);AccountList.changeCurrentAccountByHash(s.AccountHash),this.oMessageList.onRoute(e),_.isFunction(this.messagePane().onRoute)&&this.messagePane().onRoute(e,s),s.MailtoCompose&&(ComposeUtils.composeMessageToAddresses(e[2]),Routing.replaceHash(LinksUtils.getMailbox()))}else Routing.replaceHash(["settings","mail-accounts","account","create"])},CMailView.prototype.onShow=function(){this.oMessageList.onShow(),_.isFunction(this.messagePane().onShow)&&this.messagePane().onShow()},CMailView.prototype.onHide=function(){this.oMessageList.onHide(),_.isFunction(this.messagePane().onHide)&&this.messagePane().onHide()},CMailView.prototype.bindMessagePane=function(){_.isFunction(this.messagePane().onBind)&&(this.messagePane().onBind(this.$viewDom),this.messagePane().__bound=!0)},CMailView.prototype.onBind=function(){var e=this.folderList,s=this.oMessageList;this.oMessageList.onBind(this.$viewDom),this.bindMessagePane(),$(this.domFoldersMoveTo()).on("click","span.folder",function(t){var i=$(this).data("folder");e().currentFolderFullName()!==i&&(t.ctrlKey?s.executeCopyToFolder(i):s.executeMoveToFolder(i))}),App.isMobile()||this.hotKeysBind()},CMailView.prototype.hotKeysBind=function(){$(document).on("keydown",$.proxy(function(e){var s=e.keyCode,t=e&&!e.ctrlKey&&!e.altKey&&!e.shiftKey&&!Utils.isTextFieldFocused()&&this.shown(),i=this.oMessageList,o=i.collection()[0],a=o&&MailCache.currentMessage()&&o.uid()===MailCache.currentMessage().uid();t&&s===Enums.Key.s||t&&a&&s===Enums.Key.Up?(e.preventDefault(),this.searchFocus()):i.isFocused()&&e&&s===Enums.Key.Down&&o?(e.preventDefault(),i.isFocused(!1),i.routeForMessage(o)):t&&s===Enums.Key.n&&(this.executeCompose(),e.preventDefault())},this))},CMailView.prototype.routeMessageView=function(e,s){Routing.setHash(LinksUtils.getMailbox(e,this.oMessageList.oPageSwitcher.currentPage(),s))},CMailView.prototype.dragAndDropHelper=function(e,s){e&&e.checked(!0);var t=Utils.draggableItems(),i=this.oMessageList.checkedOrSelectedUids(),o=i.length;return t.data("p7-message-list-folder",this.folderList().currentFolderFullName()),t.data("p7-message-list-uids",i),$(".count-text",t).text(TextUtils.i18n("%MODULENAME%/LABEL_DRAG_MESSAGES_PLURAL",{COUNT:s?"+ "+o:o},null,o)),t},CMailView.prototype.messagesDrop=function(e,s,t){if(e){var i=t&&t.helper?t.helper:null,o=i?i.data("p7-message-list-folder"):"",a=i?i.data("p7-message-list-uids"):null;""!==o&&null!==a&&(Utils.uiDropHelperAnim(s,t),s.ctrlKey?this.oMessageList.executeCopyToFolder(e.fullName()):this.oMessageList.executeMoveToFolder(e.fullName()),this.uncheckMessages())}},CMailView.prototype.searchFocus=function(){this.oMessageList.selector.useKeyboardKeys()&&!Utils.isTextFieldFocused()&&this.oMessageList.isFocused(!0)},CMailView.prototype.onVolumerClick=function(e,s){s.stopPropagation()},CMailView.prototype.uncheckMessages=function(){_.each(MailCache.messages(),function(e){e.checked(!1)})},module.exports=CMailView;