"use strict";function CMessageListView(e){this.bVisibleSortByTool=Settings.MessagesSortBy.Allow&&Settings.MessagesSortBy.List.length>0,this.sSortBy=Settings.MessagesSortBy.DefaultSortBy,this.iSortOrder=Settings.MessagesSortBy.DefaultSortOrder,this.aSortList=[],_.each(Settings.MessagesSortBy.List,function(e){this.aSortList.push({sText:TextUtils.i18n("%MODULENAME%/"+e.LangConst),sSortBy:e.SortBy,sortOrder:ko.observable(Settings.MessagesSortBy.DefaultSortBy),selected:ko.observable(e.SortBy===Settings.MessagesSortBy.DefaultSortOrder)})}.bind(this)),this.uploaderArea=ko.observable(null),this.bDragActive=ko.observable(!1),this.bDragActiveComp=ko.computed(function(){return this.bDragActive()},this),this.openMessageInNewWindowBound=e,this.isFocused=ko.observable(!1),this.messagesContainer=ko.observable(null),this.searchInput=ko.observable(""),this.searchInputFrom=ko.observable(""),this.searchInputTo=ko.observable(""),this.searchInputSubject=ko.observable(""),this.searchInputText=ko.observable(""),this.searchSpan=ko.observable(""),this.highlightTrigger=ko.observable(""),this.currentMessage=MailCache.currentMessage,this.currentMessage.subscribe(function(){this.isFocused(!1),this.selector.itemSelected(this.currentMessage())},this),this.folderList=MailCache.folderList,this.folderList.subscribe(this.onFolderListSubscribe,this),this.folderFullName=ko.observable(""),this.folderType=ko.observable(Enums.FolderTypes.User),this.filters=ko.observable(""),this.uidList=MailCache.uidList,this.uidList.subscribe(function(){this.uidList().searchCountSubscription&&(this.uidList().searchCountSubscription.dispose(),this.uidList().searchCountSubscription=void 0),this.uidList().searchCountSubscription=this.uidList().resultCount.subscribe(function(){this.uidList().resultCount()>=0&&this.oPageSwitcher.setCount(this.uidList().resultCount())},this),this.uidList().resultCount()>=0&&this.oPageSwitcher.setCount(this.uidList().resultCount())},this),this.useThreading=ko.computed(function(){var e=AccountList.getCurrent(),t=this.folderList().currentFolder(),s=t&&t.withoutThreads(),i=""===this.uidList().search()&&""===this.uidList().filters();return e&&e.threadingIsAvailable()&&!s&&i},this),this.collection=MailCache.messages,this._search=ko.observable(""),this.search=ko.computed({read:function(){return $.trim(this._search())},write:this._search,owner:this}),this.isEmptyList=ko.computed(function(){return 0===this.collection().length},this),this.isNotEmptyList=ko.computed(function(){return 0!==this.collection().length},this),this.isSearch=ko.computed(function(){return this.search().length>0},this),this.isUnseenFilter=ko.computed(function(){return this.filters()===Enums.FolderFilter.Unseen},this),this.isLoading=MailCache.messagesLoading,this.isError=MailCache.messagesLoadingError,this.visibleInfoLoading=ko.computed(function(){return!this.isSearch()&&this.isLoading()},this),this.visibleInfoSearchLoading=ko.computed(function(){return this.isSearch()&&this.isLoading()},this),this.visibleInfoSearchList=ko.computed(function(){return this.isSearch()&&!this.isUnseenFilter()&&!this.isLoading()&&!this.isEmptyList()},this),this.visibleInfoMessageListEmpty=ko.computed(function(){return!this.isLoading()&&!this.isSearch()&&""===this.filters()&&this.isEmptyList()&&!this.isError()},this),this.visibleInfoStarredFolderEmpty=ko.computed(function(){return!this.isLoading()&&!this.isSearch()&&this.filters()===Enums.FolderFilter.Flagged&&this.isEmptyList()&&!this.isError()},this),this.visibleInfoSearchEmpty=ko.computed(function(){return this.isSearch()&&!this.isUnseenFilter()&&this.isEmptyList()&&!this.isError()&&!this.isLoading()},this),this.visibleInfoMessageListError=ko.computed(function(){return!this.isSearch()&&this.isError()},this),this.visibleInfoSearchError=ko.computed(function(){return this.isSearch()&&this.isError()},this),this.visibleInfoUnseenFilterList=ko.computed(function(){return this.isUnseenFilter()&&(this.isLoading()||!this.isEmptyList())},this),this.visibleInfoUnseenFilterEmpty=ko.computed(function(){return this.isUnseenFilter()&&this.isEmptyList()&&!this.isError()&&!this.isLoading()},this),this.searchText=ko.computed(function(){return TextUtils.i18n("%MODULENAME%/INFO_SEARCH_RESULT",{SEARCH:this.calculateSearchStringForDescription(),FOLDER:this.folderList().currentFolder()?TextUtils.encodeHtml(this.folderList().currentFolder().displayName()):""})},this),this.unseenFilterText=ko.computed(function(){return""===this.search()?TextUtils.i18n("%MODULENAME%/INFO_UNREAD_MESSAGES",{FOLDER:this.folderList().currentFolder()?TextUtils.encodeHtml(this.folderList().currentFolder().displayName()):""}):TextUtils.i18n("%MODULENAME%/INFO_UNREAD_MESSAGES_SEARCH_RESULT",{SEARCH:this.calculateSearchStringForDescription(),FOLDER:this.folderList().currentFolder()?TextUtils.encodeHtml(this.folderList().currentFolder().displayName()):""})},this),this.unseenFilterEmptyText=ko.computed(function(){return""===this.search()?TextUtils.i18n("%MODULENAME%/INFO_NO_UNREAD_MESSAGES"):TextUtils.i18n("%MODULENAME%/INFO_NO_UNREAD_MESSAGES_FOUND")},this),this.isEnableGroupOperations=ko.observable(!1).extend({throttle:250}),this.selector=new CSelector(this.collection,_.bind(this.routeForMessage,this),_.bind(this.onDeletePress,this),_.bind(this.onMessageDblClick,this),_.bind(this.onEnterPress,this),null,!1,!1,!1,!1,!1),this.checkedUids=ko.computed(function(){var e=this.selector.listChecked(),t=_.map(e,function(e){return e.uid()}),s=MailCache.folderList().currentFolder(),i=s?s.getThreadCheckedUidsFromList(e):[];return _.union(t,i)},this),this.checkedOrSelectedUids=ko.computed(function(){var e=this.checkedUids();return 0===e.length&&MailCache.currentMessage()&&_.isFunction(MailCache.currentMessage().deleted)&&!MailCache.currentMessage().deleted()&&(e=[MailCache.currentMessage().uid()]),e},this),ko.computed(function(){this.isEnableGroupOperations(0<this.selector.listCheckedOrSelected().length)},this),this.checkAll=this.selector.koCheckAll(),this.checkAllIncomplite=this.selector.koCheckAllIncomplete(),this.pageSwitcherLocked=ko.observable(!1),this.oPageSwitcher=new CPageSwitcherView(0,Settings.MailsPerPage),this.oPageSwitcher.currentPage.subscribe(function(e){var t=this.folderList().currentFolderFullName(),s=!App.isMobile()&&this.currentMessage()?this.currentMessage().uid():"",i=this.search();this.pageSwitcherLocked()||this.changeRoutingForMessageList(t,e,s,i,this.filters(),this.sSortBy,this.iSortOrder)},this),this.currentPage=ko.observable(0),Browser.firefox||Browser.ie?this.listChangedThrottle=ko.observable(!1).extend({throttle:10}):this.listChangedThrottle=ko.observable(!1),this.firstCompleteCollection=ko.observable(!0),this.collection.subscribe(function(){this.collection().length>0&&(Types.isNonEmptyArray(this.aRouteParams)?(this.onRoute(this.aRouteParams),this.aRouteParams=[]):this.firstCompleteCollection(!1))},this),this.listChanged=ko.computed(function(){return[this.firstCompleteCollection(),MailCache.currentAccountId(),this.folderFullName(),this.filters(),this.search(),this.oPageSwitcher.currentPage()]},this),this.listChanged.subscribe(function(){this.listChangedThrottle(!this.listChangedThrottle())},this),this.bAdvancedSearch=ko.observable(!1),this.searchAttachmentsCheckbox=ko.observable(!1),this.searchAttachments=ko.observable(""),this.searchAttachments.subscribe(function(e){this.searchAttachmentsCheckbox(!!e)},this),this.searchAttachmentsFocus=ko.observable(!1),this.searchFromFocus=ko.observable(!1),this.searchSubjectFocus=ko.observable(!1),this.searchToFocus=ko.observable(!1),this.searchTextFocus=ko.observable(!1),this.searchTrigger=ko.observable(null),this.searchDateStartFocus=ko.observable(!1),this.searchDateEndFocus=ko.observable(!1),this.searchDateStartDom=ko.observable(null),this.searchDateStart=ko.observable(""),this.searchDateEndDom=ko.observable(null),this.searchDateEnd=ko.observable(""),this.dateFormatDatePicker="yy.mm.dd",this.attachmentsPlaceholder=ko.computed(function(){return TextUtils.i18n("%MODULENAME%/LABEL_HAS_ATTACHMENTS")},this),_.delay(_.bind(function(){this.createDatePickerObject(this.searchDateStartDom(),this.searchDateStart),this.createDatePickerObject(this.searchDateEndDom(),this.searchDateEnd)},this),1e3),this.customMessageItemViewTemplate=ko.observable(""),App.broadcastEvent("%ModuleName%::ConstructView::after",{Name:this.ViewConstructorName,View:this,MailCache:MailCache})}var _=require("underscore"),$=require("jquery"),ko=require("knockout"),DateUtils=require("%PathToCoreWebclientModule%/js/utils/Date.js"),TextUtils=require("%PathToCoreWebclientModule%/js/utils/Text.js"),Types=require("%PathToCoreWebclientModule%/js/utils/Types.js"),Api=require("%PathToCoreWebclientModule%/js/Api.js"),App=require("%PathToCoreWebclientModule%/js/App.js"),Browser=require("%PathToCoreWebclientModule%/js/Browser.js"),CJua=require("%PathToCoreWebclientModule%/js/CJua.js"),CSelector=require("%PathToCoreWebclientModule%/js/CSelector.js"),ModulesManager=require("%PathToCoreWebclientModule%/js/ModulesManager.js"),Routing=require("%PathToCoreWebclientModule%/js/Routing.js"),Screens=require("%PathToCoreWebclientModule%/js/Screens.js"),CPageSwitcherView=require("%PathToCoreWebclientModule%/js/views/CPageSwitcherView.js"),ComposeUtils=require("modules/%ModuleName%/js/utils/Compose.js"),LinksUtils=require("modules/%ModuleName%/js/utils/Links.js"),MailUtils=require("modules/%ModuleName%/js/utils/Mail.js"),AccountList=require("modules/%ModuleName%/js/AccountList.js"),MailCache=require("modules/%ModuleName%/js/Cache.js"),Settings=require("modules/%ModuleName%/js/Settings.js");require("jquery-ui/ui/widgets/datepicker"),CMessageListView.prototype.ViewTemplate="%ModuleName%_MessagesView",CMessageListView.prototype.ViewConstructorName="CMessageListView",CMessageListView.prototype.addNewAccount=function(){App.Api.createMailAccount(AccountList.getEmail())},CMessageListView.prototype.createDatePickerObject=function(e,t){$(e).datepicker({showOtherMonths:!0,selectOtherMonths:!0,monthNames:DateUtils.getMonthNamesArray(),dayNamesMin:TextUtils.i18n("COREWEBCLIENT/LIST_DAY_NAMES_MIN").split(" "),nextText:"",prevText:"",firstDay:Types.pInt(ModulesManager.run("CalendarWebclient","getWeekStartsOn")),showOn:"focus",dateFormat:this.dateFormatDatePicker,onClose:function(e){ko.isObservable(t)&&t(e)}}),$(e).mousedown(function(){$("#ui-datepicker-div").toggle()})},CMessageListView.prototype.changeRoutingForMessageList=function(e,t,s,i,r,o,a){Routing.setHash(LinksUtils.getMailbox(e,t,s,i,r,o,a))&&i.length>0&&this.search()===i&&this.listChangedThrottle(!this.listChangedThrottle())},CMessageListView.prototype.onEnterPress=function(e){e.threadNextLoadingVisible()?e.loadNextMessages():e.openThread()},CMessageListView.prototype.onMessageDblClick=function(e){if(!this.isSavingDraft(e)){var t=this.folderList().getFolderByFullName(e.folder()),s=-1!==$.inArray(e.folder(),MailCache.getCurrentTemplateFolders()),i={Message:e,Cancel:!1};App.broadcastEvent("%ModuleName%::MessageDblClick::before",i),i.Cancel||(t.type()===Enums.FolderTypes.Drafts||s?ComposeUtils.composeMessageFromDrafts(e.folder(),e.uid()):this.openMessageInNewWindowBound(e))}},CMessageListView.prototype.onFolderListSubscribe=function(){this.setCurrentFolder(),this.requestMessageList()},CMessageListView.prototype.onShow=function(e){this.selector.useKeyboardKeys(!0),this.oPageSwitcher.show(),this.oJua&&this.oJua.setDragAndDropEnabledStatus(!0)},CMessageListView.prototype.onHide=function(e){this.selector.useKeyboardKeys(!1),this.oPageSwitcher.hide(),this.oJua&&this.oJua.setDragAndDropEnabledStatus(!1)},CMessageListView.prototype.onRoute=function(e){var t=this.folderList().inboxFolder(),s=t?t.fullName():"",i=LinksUtils.parseMailbox(e,s),r=""===this.folderFullName()?s:this.folderFullName(),o=this.currentPage()!==i.Page||r!==i.Folder||this.filters()!==i.Filters||i.Filters===Enums.FolderFilter.Unseen&&MailCache.waitForUnseenMessages()||this.search()!==i.Search||this.sSortBy!==i.SortBy||this.iSortOrder!==i.SortOrder,a=Settings.MailsPerPage!==this.oPageSwitcher.perPage();this.pageSwitcherLocked(!0),r!==i.Folder||this.search()!==i.Search||this.filters()!==i.Filters?this.oPageSwitcher.clear():this.oPageSwitcher.setPage(i.Page,Settings.MailsPerPage),this.pageSwitcherLocked(!1),i.Page!==this.oPageSwitcher.currentPage()&&(0===this.folderList().iAccountId?this.aRouteParams=e:Routing.replaceHash(LinksUtils.getMailbox(i.Folder,this.oPageSwitcher.currentPage(),i.Uid,i.Search,i.Filters))),this.currentPage(this.oPageSwitcher.currentPage()),this.folderFullName(i.Folder),this.filters(i.Filters),this.search(i.Search),this.searchInput(this.search()),this.searchSpan.notifySubscribers(),this.sSortBy=i.SortBy,this.iSortOrder=i.SortOrder,_.each(this.aSortList,function(e){e.sSortBy===this.sSortBy?(e.selected(!0),e.sortOrder(this.iSortOrder)):e.selected(!1)}.bind(this)),this.setCurrentFolder(),(o||a||0===this.collection().length)&&(i.Filters===Enums.FolderFilter.Unseen&&MailCache.waitForUnseenMessages(!0),this.requestMessageList()),this.highlightTrigger.notifySubscribers(!0)},CMessageListView.prototype.setCurrentFolder=function(){this.folderList().setCurrentFolder(this.folderFullName(),this.filters()),this.folderType(MailCache.folderList().currentFolderType())},CMessageListView.prototype.requestMessageList=function(){var e=this.folderList().currentFolderFullName(),t=this.oPageSwitcher.currentPage();e.length>0?MailCache.changeCurrentMessageList(e,t,this.search(),this.filters(),this.sSortBy,this.iSortOrder):MailCache.checkCurrentFolderList()},CMessageListView.prototype.calculateSearchStringFromAdvancedForm=function(){var e=this.searchInputFrom(),t=this.searchInputTo(),s=this.searchInputSubject(),i=this.searchInputText(),r=this.searchAttachmentsCheckbox(),o=this.searchDateStart(),a=this.searchDateEnd(),h=[],n=function(e){return(-1<(e=$.trim(e).replace(/"/g,'\\"')).indexOf(" ")||-1<e.indexOf('"'))&&(e='"'+e+'"'),e};return""!==e&&h.push("from:"+n(e)),""!==t&&h.push("to:"+n(t)),""!==s&&h.push("subject:"+n(s)),""!==i&&h.push("text:"+n(i)),r&&h.push("has:attachments"),""===o&&""===a||h.push("date:"+n(o)+"/"+n(a)),h.join(" ")},CMessageListView.prototype.onSearchClick=function(){var e=this.folderList().currentFolderFullName(),t=this.searchInput();this.bAdvancedSearch()&&(t=this.calculateSearchStringFromAdvancedForm(),this.searchInput(t),this.bAdvancedSearch(!1)),this.changeRoutingForMessageList(e,1,"",t,this.filters())},CMessageListView.prototype.onRetryClick=function(){this.requestMessageList()},CMessageListView.prototype.onClearSearchClick=function(){var e=this.folderList().currentFolderFullName(),t=this.currentMessage()?this.currentMessage().uid():"";this.clearAdvancedSearch(),this.changeRoutingForMessageList(e,1,t,"",this.filters(),this.sSortBy,this.iSortOrder)},CMessageListView.prototype.onClearFilterClick=function(){var e=this.folderList().currentFolderFullName(),t=this.currentMessage()?this.currentMessage().uid():"";this.clearAdvancedSearch(),this.changeRoutingForMessageList(e,1,t,"","",this.sSortBy,this.iSortOrder)},CMessageListView.prototype.onStopSearchClick=function(){this.onClearSearchClick()},CMessageListView.prototype.isSavingDraft=function(e){return this.folderList().currentFolder().type()===Enums.FolderTypes.Drafts&&e.uid()===MailCache.savingDraftUid()},CMessageListView.prototype.routeForMessage=function(e){if(null!==e&&!this.isSavingDraft(e)){var t=this.folderList().currentFolder(),s=this.folderList().currentFolderFullName(),i=this.oPageSwitcher.currentPage(),r=e.uid(),o=this.search();""!==r&&(App.isMobile()&&t.type()===Enums.FolderTypes.Drafts?Routing.setHash(LinksUtils.getComposeFromMessage("drafts",e.folder(),e.uid())):(this.changeRoutingForMessageList(s,i,r,o,this.filters(),this.sSortBy,this.iSortOrder),App.isMobile()&&MailCache.currentMessage()&&r===MailCache.currentMessage().uid()&&MailCache.currentMessage.valueHasMutated()))}},CMessageListView.prototype.onBind=function(e){var t=this,s=_.bind(function(e){e&&e.stopPropagation&&e.stopPropagation()},this);$(".message_list",e).on("click",function(){t.isFocused(!1)}).on("click",".message_sub_list .item .flag",function(e){t.onFlagClick(ko.dataFor(this)),e&&e.stopPropagation&&e.stopPropagation()}).on("dblclick",".message_sub_list .item .flag",s).on("click",".message_sub_list .item .thread-pin",s).on("dblclick",".message_sub_list .item .thread-pin",s),this.selector.initOnApplyBindings(".message_sub_list .item",".message_sub_list .item.selected",".message_sub_list .item .custom_checkbox",$(".message_list",e),$(".message_list_scroll.scroll-inner",e)),this.initUploader()},CMessageListView.prototype.onFlagClick=function(e){this.isSavingDraft(e)||MailCache.executeGroupOperation("SetMessageFlagged",[e.uid()],"flagged",!e.flagged())},CMessageListView.prototype.executeMarkAsRead=function(){MailCache.executeGroupOperation("SetMessagesSeen",this.checkedOrSelectedUids(),"seen",!0)},CMessageListView.prototype.executeMarkAsUnread=function(){MailCache.executeGroupOperation("SetMessagesSeen",this.checkedOrSelectedUids(),"seen",!1)},CMessageListView.prototype.executeMarkAllRead=function(){MailCache.executeGroupOperation("SetAllMessagesSeen",[],"seen",!0)},CMessageListView.prototype.executeMoveToFolder=function(e){MailCache.moveMessagesToFolder(e,this.checkedOrSelectedUids())},CMessageListView.prototype.executeCopyToFolder=function(e){MailCache.copyMessagesToFolder(e,this.checkedOrSelectedUids())},CMessageListView.prototype.onDeletePress=function(e){var t=_.map(e,function(e){return e.uid()});t.length>0&&this.deleteMessages(t)},CMessageListView.prototype.executeDelete=function(){this.deleteMessages(this.checkedOrSelectedUids())},CMessageListView.prototype.deleteMessages=function(e){var t="",s=null;1===e.length&&MailCache.currentMessage()&&e[0]===MailCache.currentMessage().uid()&&""===(t=MailCache.prevMessageUid())&&(t=MailCache.nextMessageUid()),e.length>0&&MailUtils.deleteMessages(e,function(){""!==t&&(s=_.find(this.collection(),function(e){return e.uid()===t}))&&this.routeForMessage(s)}.bind(this))},CMessageListView.prototype.executeSpam=function(){var e=this.folderList().spamFolderFullName();this.folderList().currentFolderFullName()!==e&&MailCache.moveMessagesToFolder(e,this.checkedOrSelectedUids())},CMessageListView.prototype.executeNotSpam=function(){var e=this.folderList().inboxFolder();e&&this.folderList().currentFolderFullName()!==e.fullName()&&MailCache.moveMessagesToFolder(e.fullName(),this.checkedOrSelectedUids())},CMessageListView.prototype.executeSort=function(e){_.each(this.aSortList,function(t){if(t.sSortBy===e){t.selected()&&t.sortOrder(t.sortOrder()===Enums.SortOrder.Asc?Enums.SortOrder.Desc:Enums.SortOrder.Asc),t.selected(!0);var s=this.folderList().currentFolderFullName(),i=this.oPageSwitcher.currentPage(),r=this.search();this.changeRoutingForMessageList(s,i,"",r,this.filters(),t.sSortBy,t.sortOrder())}else t.selected(!1)}.bind(this))},CMessageListView.prototype.clearAdvancedSearch=function(){this.searchInputFrom(""),this.searchInputTo(""),this.searchInputSubject(""),this.searchInputText(""),this.bAdvancedSearch(!1),this.searchAttachmentsCheckbox(!1),this.searchAttachments(""),this.searchDateStart(""),this.searchDateEnd("")},CMessageListView.prototype.onAdvancedSearchClick=function(){this.bAdvancedSearch(!this.bAdvancedSearch())},CMessageListView.prototype.calculateSearchStringForDescription=function(){return'<span class="part">'+TextUtils.encodeHtml(this.search())+"</span>"},CMessageListView.prototype.initUploader=function(){var e=this;this.uploaderArea()&&(this.oJua=new CJua({action:"?/Api/",name:"jua-uploader",queueSize:2,dragAndDropElement:this.uploaderArea(),disableAjaxUpload:!1,disableFolderDragAndDrop:!1,disableDragAndDrop:!1,hidden:_.extendOwn({Module:Settings.ServerModuleName,Method:"UploadMessage",Parameters:function(){return JSON.stringify({AccountID:MailCache.currentAccountId(),Folder:e.folderFullName()})}},App.getCommonRequestParameters())}),this.oJua.on("onDrop",_.bind(this.onFileDrop,this)).on("onComplete",_.bind(this.onFileUploadComplete,this)).on("onBodyDragEnter",_.bind(this.bDragActive,this,!0)).on("onBodyDragLeave",_.bind(this.bDragActive,this,!1)))},CMessageListView.prototype.onFileDrop=function(e){e&&e.File&&e.File.type&&0===e.File.type.indexOf("message/")||Screens.showError(TextUtils.i18n("%MODULENAME%/ERROR_FILE_NOT_EML"))},CMessageListView.prototype.onFileUploadComplete=function(e,t,s){t&&s&&!s.ErrorCode?MailCache.executeCheckMail(!0):Api.showErrorByCode(s||{},TextUtils.i18n("COREWEBCLIENT/ERROR_UPLOAD_FILE"))},module.exports=CMessageListView;