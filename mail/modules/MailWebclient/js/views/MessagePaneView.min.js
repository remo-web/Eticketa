"use strict";function CMessagePaneView(){CAbstractScreenView.call(this,"%ModuleName%"),this.bNewTab=App.isNewTab(),this.isLoading=ko.observable(!1),this.bAllowSearchMessagesBySubject=Settings.AllowSearchMessagesBySubject,MailCache.folderList.subscribe(this.onFolderListSubscribe,this),this.messages=MailCache.messages,this.messages.subscribe(this.onMessagesSubscribe,this),this.currentMessage=MailCache.currentMessage,this.currentMessage.subscribe(this.onCurrentMessageSubscribe,this),UserSettings.timeFormat.subscribe(this.onCurrentMessageSubscribe,this),UserSettings.dateFormat.subscribe(this.onCurrentMessageSubscribe,this),this.displayedMessageUid=ko.observable(""),this.browserTitle=ko.computed(function(){var e=this.currentMessage(),t=e?e.subject():"";return(t?t+" - ":"")+AccountList.getEmail()+" - "+TextUtils.i18n("%MODULENAME%/HEADING_MESSAGE_BROWSER_TAB")},this),this.isCurrentMessage=ko.computed(function(){return!!this.currentMessage()},this),this.isCurrentMessageLoaded=ko.computed(function(){return this.isCurrentMessage()&&!this.isLoading()},this),this.visibleNoMessageSelectedText=ko.computed(function(){return this.messages().length>0&&!this.isCurrentMessage()},this),this.prevMessageUid=MailCache.prevMessageUid,this.nextMessageUid=MailCache.nextMessageUid,this.isEnablePrevMessage=ko.computed(function(){return App.isNewTab()&&Types.isNonEmptyString(this.prevMessageUid())},this),this.isEnableNextMessage=ko.computed(function(){return App.isNewTab()&&Types.isNonEmptyString(this.nextMessageUid())},this),this.isEnableDelete=this.isCurrentMessage,this.isEnableReply=this.isCurrentMessageLoaded,this.isEnableReplyAll=this.isCurrentMessageLoaded,this.isEnableResend=this.isCurrentMessageLoaded,this.isEnableForward=this.isCurrentMessageLoaded,this.isEnablePrint=this.isCurrentMessageLoaded,this.isEnableSave=function(){return this.isCurrentMessage()&&""!==this.currentMessage().sDownloadAsEmlUrl},this.deleteCommand=Utils.createCommand(this,this.executeDeleteMessage,this.isEnableDelete),this.prevMessageCommand=Utils.createCommand(this,this.executePrevMessage,this.isEnablePrevMessage),this.nextMessageCommand=Utils.createCommand(this,this.executeNextMessage,this.isEnableNextMessage),this.replyCommand=Utils.createCommand(this,this.executeReply,this.isEnableReply),this.replyAllCommand=Utils.createCommand(this,this.executeReplyAll,this.isEnableReplyAll),this.resendCommand=Utils.createCommand(this,this.executeResend,this.isEnableResend),this.forwardCommand=Utils.createCommand(this,this.executeForward,this.isEnableForward),this.printCommand=Utils.createCommand(this,this.executePrint,this.isEnablePrint),this.saveCommand=Utils.createCommand(this,this.executeSave,this.isEnableSave),this.forwardAsAttachment=Utils.createCommand(this,this.executeForwardAsAttachment,this.isCurrentMessageLoaded),this.moreCommand=Utils.createCommand(this,null,this.isCurrentMessageLoaded),this.moreSectionCommands=ko.observableArray([]),App.broadcastEvent("%ModuleName%::AddMoreSectionCommand",_.bind(function(e){var t=_.extend({Text:"",CssClass:"",Handler:function(){}},e);t.Command=Utils.createCommand(this,t.Handler,this.isCurrentMessageLoaded),this.moreSectionCommands.push(t)},this)),this.visiblePicturesControl=ko.observable(!1),this.visibleShowPicturesLink=ko.observable(!1),this.visibleConfirmationControl=ko.computed(function(){return this.currentMessage()&&""!==this.currentMessage().readingConfirmationAddressee()&&this.currentMessage()&&this.currentMessage().readingConfirmationAddressee()!==AccountList.getEmail()},this),this.isCurrentNotDraftOrSent=ko.computed(function(){var e=MailCache.folderList().currentFolder();return e&&e.fullName().length>0&&e.type()!==Enums.FolderTypes.Drafts&&e.type()!==Enums.FolderTypes.Sent},this),this.isCurrentSentFolder=ko.computed(function(){var e=MailCache.folderList().currentFolder();return!!e&&e.fullName().length>0&&e.type()===Enums.FolderTypes.Sent},this),this.isCurrentNotDraftFolder=ko.computed(function(){var e=MailCache.folderList().currentFolder();return!!e&&e.fullName().length>0&&e.type()!==Enums.FolderTypes.Drafts},this),this.isVisibleReplyTool=this.isCurrentNotDraftOrSent,this.isVisibleResendTool=this.isCurrentSentFolder,this.isVisibleForwardTool=this.isCurrentNotDraftFolder,this.uid=ko.observable(""),this.folder=ko.observable(""),this.folder.subscribe(function(){this.jqPanelHelper&&this.jqPanelHelper.trigger("resize",[null,"min",null,!0])},this),this.subject=ko.observable(""),this.emptySubject=ko.computed(function(){return""===$.trim(this.subject())},this),this.subjectForDisplay=ko.computed(function(){return this.emptySubject()?TextUtils.i18n("%MODULENAME%/LABEL_NO_SUBJECT"):this.subject()},this),this.importance=ko.observable(Enums.Importance.Normal),this.oFromAddr=ko.observable(null),this.from=ko.observable(""),this.fromEmail=ko.observable(""),this.fullFrom=ko.observable(""),this.to=ko.observable(""),this.aToAddr=ko.observableArray([]),this.cc=ko.observable(""),this.aCcAddr=ko.observableArray([]),this.bcc=ko.observable(""),this.aBccAddr=ko.observableArray([]),this.allRecipients=ko.observableArray([]),this.currentAccountEmail=ko.observable(),this.meSender=TextUtils.i18n("%MODULENAME%/LABEL_ME_SENDER"),this.meRecipient=TextUtils.i18n("%MODULENAME%/LABEL_ME_RECIPIENT"),this.fullDate=ko.observable(""),this.midDate=ko.observable(""),this.textBody=ko.observable(""),this.textBodyForNewWindow=ko.observable(""),this.domTextBody=ko.observable(null),this.rtlMessage=ko.observable(!1),this.contentHasFocus=ko.observable(!1),this.topControllers=ko.observableArray(),this.bodyControllers=ko.observableArray(),this.controllers=ko.computed(function(){return _.union(this.topControllers(),this.bodyControllers())},this),App.broadcastEvent("%ModuleName%::RegisterMessagePaneController",_.bind(function(e,t){this.registerController(e,t)},this)),this.fakeHeader=ko.computed(function(){var e=!!_.find(this.topControllers(),function(e){return!!e.visible&&e.visible()});return!(this.visiblePicturesControl()||this.visibleConfirmationControl()||e)},this),this.sAttachmentsSwitcherViewTemplate=App.isMobile()?"%ModuleName%_Message_AttachmentsSwitcherView":"",this.sQuickReplyViewTemplate=App.isMobile()?"":"%ModuleName%_Message_QuickReplyView",this.attachments=ko.observableArray([]),this.notInlineAttachments=ko.computed(function(){return _.filter(this.attachments(),function(e){return!e.linked()})},this),this.notInlineAttachmentsInString=ko.computed(function(){return _.map(this.notInlineAttachments(),function(e){return e.fileName()},this).join(", ")},this),this.allAttachmentsDownloadMethods=ko.observableArray([]),this.visibleDownloadAllAttachmentsSeparately=ko.computed(function(){return this.notInlineAttachments().length>1},this),this.visibleExtendedDownload=ko.computed(function(){return this.visibleDownloadAllAttachmentsSeparately()||this.allAttachmentsDownloadMethods().length>0},this),App.broadcastEvent("%ModuleName%::AddAllAttachmentsDownloadMethod",_.bind(function(e){this.allAttachmentsDownloadMethods.push(e)},this)),this.detailsVisible=ko.observable("1"===Storage.getData("MessageDetailsVisible")),this.detailsTooltip=ko.computed(function(){return this.detailsVisible()?TextUtils.i18n("COREWEBCLIENT/ACTION_HIDE_DETAILS"):TextUtils.i18n("COREWEBCLIENT/ACTION_SHOW_DETAILS")},this),this.hasNotInlineAttachments=ko.computed(function(){return this.notInlineAttachments().length>0},this),this.hasBodyText=ko.computed(function(){return this.textBody().length>0},this),this.visibleAddMenu=ko.observable(!1),this.replyText=ko.observable(""),this.replyTextFocus=ko.observable(!1),this.replyPaneVisible=ko.computed(function(){return this.currentMessage()&&this.currentMessage().completelyFilled()},this),this.replySendingStarted=ko.observable(!1),this.replySavingStarted=ko.observable(!1),this.replyAutoSavingStarted=ko.observable(!1),this.requiresPostponedSending=ko.observable(!1),this.replyAutoSavingStarted.subscribe(function(){!this.replyAutoSavingStarted()&&this.requiresPostponedSending()&&(SendingUtils.sendPostponedMail(this.replyDraftUid()),this.requiresPostponedSending(!1))},this),this.hasReplyAllCcAddrs=ko.observable(!1),this.placeholderText=ko.computed(function(){return this.hasReplyAllCcAddrs()?TextUtils.i18n("%MODULENAME%/LABEL_QUICK_REPLY_ALL"):TextUtils.i18n("%MODULENAME%/LABEL_QUICK_REPLY")},this),this.sendButtonText=ko.computed(function(){return this.hasReplyAllCcAddrs()?TextUtils.i18n("%MODULENAME%/ACTION_SEND_ALL"):TextUtils.i18n("%MODULENAME%/ACTION_SEND")},this),ko.computed(function(){(!this.replyTextFocus()||this.replyAutoSavingStarted()||this.replySavingStarted()||this.replySendingStarted())&&this.stopAutosaveTimer(),!this.replyTextFocus()||this.replyAutoSavingStarted()||this.replySavingStarted()||this.replySendingStarted()||this.startAutosaveTimer()},this),this.saveButtonText=ko.computed(function(){return this.replyAutoSavingStarted()?TextUtils.i18n("%MODULENAME%/ACTION_SAVE_IN_PROGRESS"):TextUtils.i18n("%MODULENAME%/ACTION_SAVE")},this),this.replyDraftUid=ko.observable(""),this.replyLoadingText=ko.computed(function(){return this.replySendingStarted()?TextUtils.i18n("COREWEBCLIENT/INFO_SENDING"):this.replySavingStarted()?TextUtils.i18n("%MODULENAME%/INFO_SAVING"):""},this),this.isEnableSendQuickReply=ko.computed(function(){return this.isCurrentMessageLoaded()&&""!==this.replyText()&&!this.replySendingStarted()},this),this.isEnableSaveQuickReply=ko.computed(function(){return this.isEnableSendQuickReply()&&!this.replySavingStarted()&&!this.replyAutoSavingStarted()},this),this.saveQuickReplyCommand=Utils.createCommand(this,this.executeSaveQuickReply,this.isEnableSaveQuickReply),this.sendQuickReplyCommand=Utils.createCommand(this,this.executeSendQuickReply,this.isEnableSendQuickReply),this.domMessageHeader=ko.observable(null),this.domQuickReply=ko.observable(null),this.domMessageForPrint=ko.observable(null),this.replyTextFocusThrottled=ko.observable(!1).extend({throttle:50}),this.replyTextFocus.subscribe(function(){this.replyTextFocusThrottled(this.replyTextFocus())},this),this.isQuickReplyActive=ko.computed(function(){return this.replyText().length>0||this.replyTextFocusThrottled()},this),this.jqPanelHelper=null,this.visibleAttachments=ko.observable(!1),this.showMessage=function(){this.visibleAttachments(!1)},this.showAttachments=function(){this.visibleAttachments(!0)},this.sDefaultFontName=Settings.DefaultFontName,Pulse.registerDayOfMonthFunction(_.bind(this.updateMomentDate,this)),App.broadcastEvent("%ModuleName%::ConstructView::after",{Name:"CMessagePaneView",View:this})}var _=require("underscore"),$=require("jquery"),ko=require("knockout"),TextUtils=require("%PathToCoreWebclientModule%/js/utils/Text.js"),Types=require("%PathToCoreWebclientModule%/js/utils/Types.js"),UrlUtils=require("%PathToCoreWebclientModule%/js/utils/Url.js"),Utils=require("%PathToCoreWebclientModule%/js/utils/Common.js"),App=require("%PathToCoreWebclientModule%/js/App.js"),MainTabExtMethods=require("modules/%ModuleName%/js/MainTabExtMethods.js"),ModulesManager=require("%PathToCoreWebclientModule%/js/ModulesManager.js"),Pulse=require("%PathToCoreWebclientModule%/js/Pulse.js"),Routing=require("%PathToCoreWebclientModule%/js/Routing.js"),Storage=require("%PathToCoreWebclientModule%/js/Storage.js"),UserSettings=require("%PathToCoreWebclientModule%/js/Settings.js"),WindowOpener=require("%PathToCoreWebclientModule%/js/WindowOpener.js"),CAbstractScreenView=require("%PathToCoreWebclientModule%/js/views/CAbstractScreenView.js"),ComposeUtils=require("modules/%ModuleName%/js/utils/Compose.js"),LinksUtils=require("modules/%ModuleName%/js/utils/Links.js"),MailUtils=require("modules/%ModuleName%/js/utils/Mail.js"),SendingUtils=require("modules/%ModuleName%/js/utils/Sending.js"),AccountList=require("modules/%ModuleName%/js/AccountList.js"),Ajax=require("modules/%ModuleName%/js/Ajax.js"),MailCache=require("modules/%ModuleName%/js/Cache.js"),Settings=require("modules/%ModuleName%/js/Settings.js"),CAttachmentModel=require("modules/%ModuleName%/js/models/CAttachmentModel.js"),MainTab=App.isNewTab()&&window.opener&&window.opener.MainTabMailMethods;_.extendOwn(CMessagePaneView.prototype,CAbstractScreenView.prototype),CMessagePaneView.prototype.ViewTemplate=App.isNewTab()?"%ModuleName%_MessagePaneScreenView":"%ModuleName%_MessagePaneView",CMessagePaneView.prototype.ViewConstructorName="CMessagePaneView",CMessagePaneView.prototype.resizeDblClick=function(e,t){""!==t.target.className&&t.target.className.search(/add_contact|icon|link|title|subject|link|date|from/)&&(Utils.calmEvent(t),Utils.removeSelection(),this.jqPanelHelper||(this.jqPanelHelper=$(".MailLayout .panel_helper")),this.jqPanelHelper.trigger("resize",[5,"min",!0]))},CMessagePaneView.prototype.notifySender=function(){if(this.currentMessage()&&""!==this.currentMessage().readingConfirmationAddressee()){var e=TextUtils.i18n("%MODULENAME%/LABEL_RETURN_RECEIPT_MAIL_TEXT",{EMAIL:AccountList.getEmail(),SUBJECT:this.subject()}).replace(/\\r\\n/g,"\n");Ajax.send("SendMessage",{To:this.currentMessage().readingConfirmationAddressee(),Subject:TextUtils.i18n("%MODULENAME%/LABEL_RETURN_RECEIPT_MAIL_SUBJECT"),Text:e,ConfirmFolder:this.currentMessage().folder(),ConfirmUid:this.currentMessage().uid()}),this.currentMessage().readingConfirmationAddressee("")}},CMessagePaneView.prototype.onFolderListSubscribe=function(){App.isNewTab()&&this.onMessagesSubscribe()},CMessagePaneView.prototype.onMessagesSubscribe=function(){!this.currentMessage()&&this.uid().length>0&&MailCache.setCurrentMessage(this.uid(),this.folder())},CMessagePaneView.prototype.passReplyDataToNewTab=function(e){this.currentMessage()&&this.currentMessage().sUniq===e&&""!==this.replyText()&&(MainTabExtMethods.passReplyData(e,{ReplyText:this.replyText(),ReplyDraftUid:this.replyDraftUid()}),this.replyText(""),this.replyDraftUid(""))},CMessagePaneView.prototype.onCurrentMessageSubscribe=function(){var e=this.currentMessage(),t=e?AccountList.getAccount(e.accountId()):null,s=null;if(MainTab&&e?(s=MainTab.getReplyData(e.sUniq))&&(this.replyText(s.ReplyText),this.replyDraftUid(s.ReplyDraftUid)):e&&e.uid()===this.displayedMessageUid()||(this.replyText(""),this.replyDraftUid("")),e&&this.uid()===e.uid()){if(this.hasReplyAllCcAddrs(SendingUtils.hasReplyAllCcAddrs(e)),this.subject(e.subject()),this.importance(e.importance()),this.from(e.oFrom.getDisplay()),this.fromEmail(e.oFrom.getFirstEmail()),this.fullFrom(e.oFrom.getFull()),e.oFrom.aCollection.length>0?this.oFromAddr(e.oFrom.aCollection[0]):this.oFromAddr(null),this.to(e.oTo.getFull()),this.aToAddr(e.oTo.aCollection),this.cc(e.oCc.getFull()),this.aCcAddr(e.oCc.aCollection),this.bcc(e.oBcc.getFull()),this.aBccAddr(e.oBcc.aCollection),this.currentAccountEmail(t.email()),this.allRecipients(_.uniq(_.union(this.aToAddr(),this.aCcAddr(),this.aBccAddr()))),this.midDate(e.oDateModel.getMidDate()),this.fullDate(e.oDateModel.getFullDate()),this.isLoading(""!==e.uid()&&!e.completelyFilled()),this.setMessageBody(),this.rtlMessage(e.rtl()),App.isNewTab()){var i=[];_.each(e.attachments(),_.bind(function(e){var t=new CAttachmentModel;t.copyProperties(e),i.push(t)},this)),this.attachments(i)}else this.attachments(e.attachments());if(!e.completelyFilled()||e.truncated()){var o=e.completelyFilled()?e.truncated:e.completelyFilled;App.isNewTab()?e.completelyFilledNewTabSubscription=o.subscribe(this.onCurrentMessageSubscribe,this):e.completelyFilledSubscription=o.subscribe(this.onCurrentMessageSubscribe,this)}else e.completelyFilledSubscription?(e.completelyFilledSubscription.dispose(),e.completelyFilledSubscription=void 0):e.completelyFilledNewTabSubscription&&(e.completelyFilledNewTabSubscription.dispose(),e.completelyFilledNewTabSubscription=void 0)}else this.hasReplyAllCcAddrs(!1),this.isLoading(!1),$(this.domTextBody()).empty().data("displayed-message-uid",""),this.displayedMessageUid(""),this.rtlMessage(!1),this.attachments([]),this.visiblePicturesControl(!1),this.visibleShowPicturesLink(!1);this.doAfterPopulatingMessage()},CMessagePaneView.prototype.updateMomentDate=function(){var e=this.currentMessage();e&&e.oDateModel&&(this.midDate(e.oDateModel.getMidDate()),this.fullDate(e.oDateModel.getFullDate()))},CMessagePaneView.prototype.setMessageBody=function(){if(this.currentMessage()){var e=this.currentMessage(),t=e.text(),s=$(this.domTextBody()),i=null,o="",n=t.length,a=[];this.textBody(t),s.data("displayed-message-uid")===e.uid()&&(a=this.getBlockquotesStatus()),s.empty(),e.isPlain()||n>5e6?(s.html(t),this.visiblePicturesControl(!1)):(o=(i=e.getDomText()).length>0?i.html():"",s.append(o),this.visiblePicturesControl(e.hasExternals()&&!e.isExternalsAlwaysShown()),this.visibleShowPicturesLink(!e.isExternalsShown()),TextUtils.htmlStartsWithBlockquote(o)||this.doHidingBlockquotes(a)),s.data("displayed-message-uid",e.uid()),this.displayedMessageUid(e.uid())}},CMessagePaneView.prototype.getBlockquotesStatus=function(){var e=[];return $($("blockquote",$(this.domTextBody())).get()).each(function(){var t=$(this);t.hasClass("blockquote_before_toggle")&&e.push(t.hasClass("collapsed"))}),e},CMessagePaneView.prototype.doHidingBlockquotes=function(e){var t=0;$($("blockquote",$(this.domTextBody())).get()).each(function(){var s=$(this),i=s.parents("blockquote"),o=$('<span class="blockquote_toggle"></span>').html(TextUtils.i18n("%MODULENAME%/ACTION_SHOW_QUOTED_TEXT")),n=!0;0===i.length&&s.height()>120&&(s.addClass("blockquote_before_toggle").after(o).wrapInner('<div class="blockquote_content"></div>'),o.bind("click",function(){n?(s.height("auto"),o.html(TextUtils.i18n("%MODULENAME%/ACTION_HIDE_QUOTED_TEXT")),n=!1):(s.height(80),o.html(TextUtils.i18n("%MODULENAME%/ACTION_SHOW_QUOTED_TEXT")),n=!0),s.toggleClass("collapsed",n)}),t<e.length&&(n=e[t],t++),s.height(n?80:"auto").toggleClass("collapsed",n))})},CMessagePaneView.prototype.onRoute=function(e){var t=LinksUtils.parseMailbox(e);AccountList.changeCurrentAccountByHash(t.AccountHash),""!==this.replyText()&&this.uid()!==t.Uid&&this.saveReplyMessage(!1),this.uid(t.Uid),this.folder(t.Folder),MailCache.setCurrentMessage(this.uid(),this.folder()),this.contentHasFocus(!0)},CMessagePaneView.prototype.showPictures=function(){MailCache.showExternalPictures(!1),this.visibleShowPicturesLink(!1),this.setMessageBody()},CMessagePaneView.prototype.alwaysShowPictures=function(){var e=this.currentMessage()?this.currentMessage().oFrom.getFirstEmail():"";e.length>0&&Ajax.send("SetEmailSafety",{Email:e}),MailCache.showExternalPictures(!0),this.visiblePicturesControl(!1),this.setMessageBody()},CMessagePaneView.prototype.openInNewWindow=function(){this.openMessageInNewWindowBound(this.currentMessage())},CMessagePaneView.prototype.getReplyHtmlText=function(){return'<div style="font-family: '+this.sDefaultFontName+'; font-size: 16px">'+SendingUtils.getHtmlFromText(this.replyText())+"</div>"},CMessagePaneView.prototype.executeReplyOrForward=function(e){this.currentMessage()&&(SendingUtils.setReplyData(this.getReplyHtmlText(),this.replyDraftUid()),this.replyText(""),this.replyDraftUid(""),ComposeUtils.composeMessageAsReplyOrForward(e,this.currentMessage().folder(),this.currentMessage().uid()))},CMessagePaneView.prototype.executeDeleteMessage=function(){this.currentMessage()&&(MainTab?MainTab.deleteMessage(this.currentMessage().uid(),function(){window.close()}):App.isMobile()&&MailUtils.deleteMessages([this.currentMessage().uid()],App))},CMessagePaneView.prototype.executePrevMessage=function(){this.isEnablePrevMessage()&&Routing.setHash(LinksUtils.getViewMessage(MailCache.folderList().currentFolderFullName(),this.prevMessageUid()))},CMessagePaneView.prototype.executeNextMessage=function(){this.isEnableNextMessage()&&Routing.setHash(LinksUtils.getViewMessage(MailCache.folderList().currentFolderFullName(),this.nextMessageUid()))},CMessagePaneView.prototype.executeReply=function(){this.executeReplyOrForward(Enums.ReplyType.Reply)},CMessagePaneView.prototype.executeReplyAll=function(){this.executeReplyOrForward(Enums.ReplyType.ReplyAll)},CMessagePaneView.prototype.executeResend=function(){this.executeReplyOrForward(Enums.ReplyType.Resend)},CMessagePaneView.prototype.executeForward=function(){this.executeReplyOrForward(Enums.ReplyType.Forward)},CMessagePaneView.prototype.executePrint=function(){var e=this.currentMessage(),t=e?WindowOpener.open("",this.subject()+"-print"):null,s="";e&&t&&(this.textBodyForNewWindow(e.getConvertedHtml(UrlUtils.getAppPath(),!0)),s=$(this.domMessageForPrint()).html(),$(t.document.body).html(s),t.print())},CMessagePaneView.prototype.executeSave=function(){this.isEnableSave()&&this.currentMessage()&&UrlUtils.downloadByUrl(this.currentMessage().sDownloadAsEmlUrl)},CMessagePaneView.prototype.executeForwardAsAttachment=function(){this.currentMessage()&&ComposeUtils.composeMessageWithEml(this.currentMessage())},CMessagePaneView.prototype.changeAddMenuVisibility=function(){var e=!this.visibleAddMenu();this.visibleAddMenu(e)},CMessagePaneView.prototype.onSendOrSaveMessageResponse=function(e,t){var s=SendingUtils.onSendOrSaveMessageResponse(e,t,this.requiresPostponedSending());switch(s.Method){case"SendMessage":this.replySendingStarted(!1),s.Result&&this.replyText("");break;case"SaveMessage":s.Result&&this.replyDraftUid(s.NewUid),this.replySavingStarted(!1),this.replyAutoSavingStarted(!1)}},CMessagePaneView.prototype.executeSendQuickReply=function(){this.isEnableSendQuickReply()&&(this.replySendingStarted(!0),this.requiresPostponedSending(this.replyAutoSavingStarted()),SendingUtils.sendReplyMessage("SendMessage",this.getReplyHtmlText(),this.replyDraftUid(),this.onSendOrSaveMessageResponse,this,this.requiresPostponedSending()),this.replyTextFocus(!1))},CMessagePaneView.prototype.executeSaveQuickReply=function(){this.saveReplyMessage(!1)},CMessagePaneView.prototype.saveReplyMessage=function(e){this.isEnableSaveQuickReply()&&(e?this.replyAutoSavingStarted(!0):this.replySavingStarted(!0),SendingUtils.sendReplyMessage("SaveMessage",this.getReplyHtmlText(),this.replyDraftUid(),this.onSendOrSaveMessageResponse,this))},CMessagePaneView.prototype.stopAutosaveTimer=function(){window.clearTimeout(this.autoSaveTimer)},CMessagePaneView.prototype.startAutosaveTimer=function(){if(this.isEnableSaveQuickReply()){var e=_.bind(this.saveReplyMessage,this,!0);this.stopAutosaveTimer(),Settings.AllowAutosaveInDrafts&&(this.autoSaveTimer=window.setTimeout(e,1e3*Settings.AutoSaveIntervalSeconds))}},CMessagePaneView.prototype.executeAllAttachmentsDownloadMethod=function(e){this.currentMessage()&&e(this.currentMessage().accountId(),this.currentMessage().getAttachmentsHashes())},CMessagePaneView.prototype.downloadAllAttachmentsSeparately=function(){this.currentMessage()&&this.currentMessage().downloadAllAttachmentsSeparately()},CMessagePaneView.prototype.onShow=function(){this.bShown=!0},CMessagePaneView.prototype.onHide=function(){this.bShown=!1},CMessagePaneView.prototype.onBind=function(e){ModulesManager.run("SessionTimeoutWeblient","registerFunction",[_.bind(function(){""!==this.replyText()&&this.saveReplyMessage(!1)},this)]),this.$MailViewDom=_.isUndefined(e)?this.$viewDom:e,this.$MailViewDom.on("mousedown","a",function(e){if(e&&3!==e.which){var t=$(this).attr("href");if(t&&"mailto:"===t.toString().toLowerCase().substr(0,7))return ComposeUtils.composeMessageToAddresses(t.toString()),!1}return!0}),App.isMobile()||this.hotKeysBind()},CMessagePaneView.prototype.hotKeysBind=function(){$(document).on("keydown",$.proxy(function(e){var t=this.bShown&&e&&!e.ctrlKey&&!e.shiftKey&&!Utils.isTextFieldFocused()&&this.isEnableReply();t&&e.keyCode===Enums.Key.q?(e.preventDefault(),this.replyTextFocus(!0)):t&&e.keyCode===Enums.Key.r&&this.executeReply()},this))},CMessagePaneView.prototype.showSourceHeaders=function(){var e=this.currentMessage(),t=e&&e.completelyFilled()?WindowOpener.open("",this.subject()+"-headers"):null;t&&$(t.document.body).html("<pre>"+TextUtils.encodeHtml(e.sourceHeaders())+"</pre>")},CMessagePaneView.prototype.switchDetailsVisibility=function(){this.detailsVisible(!this.detailsVisible()),Storage.setData("MessageDetailsVisible",this.detailsVisible()?"1":"0")},CMessagePaneView.prototype.registerController=function(e,t){switch(t){case"BeforeMessageHeaders":this.topControllers.push(e);break;case"BeforeMessageBody":this.bodyControllers.push(e)}$.isFunction(e.assignMessagePaneExtInterface)&&e.assignMessagePaneExtInterface(this.getExtInterface())},CMessagePaneView.prototype.getExtInterface=function(){return{changeText:_.bind(function(e){var t=this.currentMessage();t&&this.isCurrentMessageLoaded()&&(t.text(e),t.$text=null,this.setMessageBody())},this)}},CMessagePaneView.prototype.doAfterPopulatingMessage=function(){var e=this.currentMessage(),t=e&&this.isCurrentMessageLoaded()?{aToEmails:e.oTo.getEmails(),bPlain:e.isPlain(),sRawText:e.textRaw(),sText:e.text(),sAccountEmail:AccountList.getEmail(e.accountId()),sFromEmail:e.oFrom.getFirstEmail(),iSensitivity:e.sensitivity(),aExtend:e.aExtend}:null;_.each(this.controllers(),_.bind(function(e){$.isFunction(e.doAfterPopulatingMessage)&&e.doAfterPopulatingMessage(t)},this)),ModulesManager.run("ContactsWebclient","applyContactsCards",[this.$MailViewDom.find("span.address")])},CMessagePaneView.prototype.searchBySubject=function(){if(Settings.AllowSearchMessagesBySubject&&this.currentMessage()){var e=this.currentMessage().folder(),t=this.currentMessage().uid(),s="",i=this.currentMessage().subject().split(":"),o=Settings.PrefixesToRemoveBeforeSearchMessagesBySubject,n=[];0===o.length?s=i:(_.each(i,function(e){if(n.length>0)n.push(e);else{var t=!1,s=$.trim(e);_.each(o,function(e){var i=new RegExp("^"+e+"(\\[\\d*\\]){0,1}$","i");t=t||i.test(s)}),t||n.push(e)}}),s=$.trim(n.join(":"))),Routing.setHash(LinksUtils.getMailbox(e,1,t,s,""))}},module.exports=new CMessagePaneView;