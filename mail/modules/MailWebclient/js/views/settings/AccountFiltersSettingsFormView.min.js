"use strict";function CAccountFiltersSettingsFormView(){CAbstractSettingsFormView.call(this,Settings.ServerModuleName),this.bShown=!1,this.foldersOptions=ko.observableArray([]),MailCache.editedFolderList.subscribe(function(){this.bShown&&this.populate()},this),this.loading=ko.observable(!0),this.collection=ko.observableArray([]),this.fieldOptions=[{text:TextUtils.i18n("%MODULENAME%/LABEL_FROM"),value:0},{text:TextUtils.i18n("%MODULENAME%/LABEL_TO"),value:1},{text:TextUtils.i18n("%MODULENAME%/LABEL_SUBJECT"),value:2}],this.conditionOptions=[{text:TextUtils.i18n("%MODULENAME%/LABEL_CONTAINING"),value:0},{text:TextUtils.i18n("%MODULENAME%/LABEL_EQUAL_TO"),value:1},{text:TextUtils.i18n("%MODULENAME%/LABEL_NOT_CONTAINING"),value:2}],this.actionOptions=[{text:TextUtils.i18n("%MODULENAME%/LABEL_MOVE_FILTER_ACTION"),value:3},{text:TextUtils.i18n("%MODULENAME%/LABEL_DELETE_FILTER_ACTION"),value:1}],this.phaseArray=[""],_.each(TextUtils.i18n("%MODULENAME%/INFO_FILTER").split(/,{0,1}\s/),function(t){var e=this.phaseArray.length-1;"%"===t.substr(0,1)||"%"===this.phaseArray[e].substr(-1,1)?this.phaseArray.push(t):this.phaseArray[e]+=" "+t},this),this.firstState=null}var _=require("underscore"),ko=require("knockout"),TextUtils=require("%PathToCoreWebclientModule%/js/utils/Text.js"),Types=require("%PathToCoreWebclientModule%/js/utils/Types.js"),Screens=require("%PathToCoreWebclientModule%/js/Screens.js"),ModulesManager=require("%PathToCoreWebclientModule%/js/ModulesManager.js"),CAbstractSettingsFormView=ModulesManager.run("SettingsWebclient","getAbstractSettingsFormViewClass"),AccountList=require("modules/%ModuleName%/js/AccountList.js"),Ajax=require("modules/%ModuleName%/js/Ajax.js"),MailCache=require("modules/%ModuleName%/js/Cache.js"),Settings=require("modules/%ModuleName%/js/Settings.js"),CFilterModel=require("modules/%ModuleName%/js/models/CFilterModel.js"),CFiltersModel=require("modules/%ModuleName%/js/models/CFiltersModel.js");_.extendOwn(CAccountFiltersSettingsFormView.prototype,CAbstractSettingsFormView.prototype),CAccountFiltersSettingsFormView.prototype.ViewTemplate="%ModuleName%_Settings_AccountFiltersSettingsFormView",CAccountFiltersSettingsFormView.prototype.onShow=function(){this.populate()},CAccountFiltersSettingsFormView.prototype.onHide=function(){this.bShown=!1},CAccountFiltersSettingsFormView.prototype.populate=function(){var t=MailCache.editedFolderList(),e=[];t.iAccountId===AccountList.editedId()?(e=t.getOptions(TextUtils.i18n("%MODULENAME%/LABEL_FOLDER_NOT_SELECTED"),!0,!0,!1,!0),this.foldersOptions(e),this.populateFilters()):(this.loading(!0),this.collection([]))},CAccountFiltersSettingsFormView.prototype.revert=function(){_.each(this.collection(),function(t){t.revert()})},CAccountFiltersSettingsFormView.prototype.commit=function(){_.each(this.collection(),function(t){t.commit()})},CAccountFiltersSettingsFormView.prototype.getCurrentValues=function(){return _.map(this.collection(),function(t){return t.toString()},this)},CAccountFiltersSettingsFormView.prototype.getParametersForSave=function(){var t=_.map(this.collection(),function(t){return{Enable:t.enable()?"1":"0",Field:t.field(),Filter:t.filter(),Condition:t.condition(),Action:t.action(),FolderFullName:t.folder()}});return{AccountID:AccountList.editedId(),Filters:t}},CAccountFiltersSettingsFormView.prototype.save=function(){_.some(this.collection(),function(t){return""===t.filter()||"3"===Types.pString(t.action())&&""===t.folder()})?Screens.showError(TextUtils.i18n("%MODULENAME%/ERROR_FILTER_FIELDS_EMPTY")):(this.isSaving(!0),this.commit(),this.updateSavedState(),Ajax.send("UpdateFilters",this.getParametersForSave(),this.onAccountSieveFiltersUpdateResponse,this))},CAccountFiltersSettingsFormView.prototype.populateFilters=function(){var t=AccountList.getEdited();t&&(null!==t.filters()?(this.loading(!1),this.collection(t.filters().collection()),this.updateSavedState()):(this.loading(!0),this.collection([]),Ajax.send("GetFilters",{AccountID:t.id()},this.onGetFiltersResponse,this)))},CAccountFiltersSettingsFormView.prototype.deleteFilter=function(t){this.collection.remove(t)},CAccountFiltersSettingsFormView.prototype.addFilter=function(){var t=new CFilterModel(AccountList.editedId());this.collection.push(t)},CAccountFiltersSettingsFormView.prototype.displayFilterPart=function(t,e){var i="";return i="%FIELD%"===t?"Field":"%CONDITION%"===t?"Condition":"%STRING%"===t?"String":"%ACTION%"===t?"Action":"%FOLDER%"===t?"Folder":"%DEPENDED"===t.substr(0,9)?"DependedText":"Text",e+i},CAccountFiltersSettingsFormView.prototype.getDependedText=function(t){return(t=Types.pString(t))&&(t=t.replace(/%/g,"").split("=")[1]||""),t},CAccountFiltersSettingsFormView.prototype.getDependedField=function(t,e){return(t=Types.pString(t))&&(t=(t=t.replace(/[=](.*)/g,"").split("-")[1]||"").toLowerCase()),!!e[t]&&e[t]()},CAccountFiltersSettingsFormView.prototype.onGetFiltersResponse=function(t,e){var i=e.Parameters,o=Types.pInt(i.AccountID),s=AccountList.getAccount(o),r=new CFiltersModel;this.loading(!1),t&&t.Result&&s?(r.parse(o,t.Result),s.filters(r),o===AccountList.editedId()&&this.populateFilters()):Screens.showError(TextUtils.i18n("COREWEBCLIENT/ERROR_UNKNOWN"))},CAccountFiltersSettingsFormView.prototype.onAccountSieveFiltersUpdateResponse=function(t,e){this.isSaving(!1),e&&e.Method?t&&t.Result?Screens.showReport(TextUtils.i18n("%MODULENAME%/REPORT_FILTERS_UPDATE_SUCCESS")):Screens.showError(TextUtils.i18n("COREWEBCLIENT/ERROR_SAVING_SETTINGS_FAILED")):Screens.showError(TextUtils.i18n("COREWEBCLIENT/ERROR_UNKNOWN"))},module.exports=new CAccountFiltersSettingsFormView;