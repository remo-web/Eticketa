"use strict";function CAccountSettingsFormView(){CAbstractSettingsFormView.call(this,Settings.ServerModuleName),this.sFakePass="xxxxxxxx",this.bAllowIdentities=Settings.AllowIdentities,this.useToAuthorize=ko.observable(!1),this.canBeUsedToAuthorize=ko.observable(!1),this.isDefaultAccount=ko.observable(!1),this.isServerOwner=ko.observable(!1),this.friendlyName=ko.observable(""),this.email=ko.observable(""),this.incomingLogin=ko.observable(""),this.incomingPassword=ko.observable(""),this.allowSpecifyPassword=ko.observable(!1),this.useThreading=ko.observable(!1),this.saveRepliesToCurrFolder=ko.observable(!1),this.oServerPairPropertiesView=new CServerPairPropertiesView("acc_edit"),this.enableThreading=this.oServerPairPropertiesView.enableThreading,this.enableThreading.subscribe(function(){this.enableThreading()||this.useThreading(!1)},this),this.allowChangePassword=ko.observable(!1),this.incLoginFocused=ko.observable(!1),this.incLoginFocused.subscribe(function(){this.incLoginFocused()&&""===this.incomingLogin()&&this.incomingLogin(this.email())},this),AccountList.editedId.subscribe(function(){this.bShown&&this.populate()},this),this.updateSavedState(),this.oServerPairPropertiesView.currentValues.subscribe(function(){this.updateSavedState()},this),this.visibleTab=ko.observable(!0),ko.computed(function(){var e=AccountList.getEdited();e?(this.allowChangePassword(ModulesManager.run("ChangePasswordWebclient","isChangePasswordButtonAllowed",[AccountList.collection().length,e])),this.isDefaultAccount(e.bDefault),this.isServerOwner(e.oServer.sOwnerType===Enums.ServerOwnerType.Account)):(this.allowChangePassword(!1),this.isDefaultAccount(!1))},this),this.isDisableAuthorize=ko.observable(App.userAccountsCount()<=1),this.oDefaultAccountHostsSettingsView=require("modules/%ModuleName%/js/views/DefaultAccountHostsSettingsView.js")}var _=require("underscore"),$=require("jquery"),ko=require("knockout"),TextUtils=require("%PathToCoreWebclientModule%/js/utils/Text.js"),Types=require("%PathToCoreWebclientModule%/js/utils/Types.js"),Api=require("%PathToCoreWebclientModule%/js/Api.js"),ModulesManager=require("%PathToCoreWebclientModule%/js/ModulesManager.js"),Screens=require("%PathToCoreWebclientModule%/js/Screens.js"),App=require("%PathToCoreWebclientModule%/js/App.js"),CAbstractSettingsFormView=ModulesManager.run("SettingsWebclient","getAbstractSettingsFormViewClass"),Popups=require("%PathToCoreWebclientModule%/js/Popups.js"),ChangePasswordPopup=ModulesManager.run("ChangePasswordWebclient","getChangePasswordPopup"),AccountList=require("modules/%ModuleName%/js/AccountList.js"),Ajax=require("modules/%ModuleName%/js/Ajax.js"),Settings=require("modules/%ModuleName%/js/Settings.js"),CServerPairPropertiesView=require("modules/%ModuleName%/js/views/settings/CServerPairPropertiesView.js");_.extendOwn(CAccountSettingsFormView.prototype,CAbstractSettingsFormView.prototype),CAccountSettingsFormView.prototype.ViewTemplate="%ModuleName%_Settings_AccountSettingsFormView",CAccountSettingsFormView.prototype.onShow=function(){this.oServerPairPropertiesView.fullInit(),this.populate()},CAccountSettingsFormView.prototype.getCurrentValues=function(){var e=[this.useToAuthorize(),this.friendlyName(),this.email(),this.incomingLogin(),this.incomingPassword(),this.useThreading(),this.saveRepliesToCurrFolder()],i=this.oServerPairPropertiesView.currentValues();return e.concat(i)},CAccountSettingsFormView.prototype.getParametersForSave=function(){var e=AccountList.getEdited(),i=$.trim(this.incomingPassword());return{AccountID:e.id(),UseToAuthorize:this.useToAuthorize(),FriendlyName:this.friendlyName(),Email:$.trim(this.email()),IncomingLogin:$.trim(this.incomingLogin()),IncomingPassword:i===this.sFakePass?"":i,Server:this.oServerPairPropertiesView.getParametersForSave(),UseThreading:this.useThreading(),SaveRepliesToCurrFolder:this.saveRepliesToCurrFolder()}},CAccountSettingsFormView.prototype.revert=function(){this.populate()},CAccountSettingsFormView.prototype.populate=function(){var e=AccountList.getEdited();this.passwordMightBeIncorrectSubscribtion&&(this.passwordMightBeIncorrectSubscribtion.dispose(),this.passwordMightBeIncorrectSubscribtion=null),e?(this.friendlyName(e.friendlyName()),this.email(e.email()),this.incomingLogin(e.incomingLogin()),this.incomingPassword(this.sFakePass),this.allowSpecifyPassword(e.passwordMightBeIncorrect()),e.passwordMightBeIncorrect()||(this.passwordMightBeIncorrectSubscribtion=e.passwordMightBeIncorrect.subscribe(function(){this.allowSpecifyPassword(e.passwordMightBeIncorrect()),this.passwordMightBeIncorrectSubscribtion.dispose(),this.passwordMightBeIncorrectSubscribtion=null}.bind(this))),this.oServerPairPropertiesView.setServer(e.oServer),this.useToAuthorize(e.useToAuthorize()),this.canBeUsedToAuthorize(e.canBeUsedToAuthorize()),this.useThreading(e.useThreading()),this.saveRepliesToCurrFolder(e.bSaveRepliesToCurrFolder),this.isDisableAuthorize(!!this.useToAuthorize()&&App.userAccountsCount()<=1)):(this.friendlyName(""),this.email(""),this.incomingLogin(""),this.incomingPassword(""),this.allowSpecifyPassword(!1),this.oServerPairPropertiesView.clear(),this.useToAuthorize(!0),this.canBeUsedToAuthorize(!1),this.useThreading(!1),this.isDisableAuthorize(!0)),this.updateSavedState()},CAccountSettingsFormView.prototype.remove=function(){if(this.isDisableAuthorize())Screens.showError(TextUtils.i18n("COREWEBCLIENT/ERROR_ACCOUNT_DELETING_DISABLE"),!0);else{var e=AccountList.getEdited();e&&e.remove()}},CAccountSettingsFormView.prototype.save=function(){this.isSaving(!0),this.updateSavedState(),Ajax.send("UpdateAccount",this.getParametersForSave(),this.onResponse,this)},CAccountSettingsFormView.prototype.onResponse=function(e,i){if(this.isSaving(!1),e.Result){var t=i.Parameters,s=Types.pInt(t.AccountID),o=AccountList.getAccount(s);o&&(Types.isNonEmptyString(t.IncomingPassword)&&t.IncomingPassword!==this.sFakePass&&o.passwordMightBeIncorrect(!1),o.updateFromServer(e.Result),this.populate(),Screens.showReport(TextUtils.i18n("COREWEBCLIENT/REPORT_SETTINGS_UPDATE_SUCCESS")))}else Api.showErrorByCode(e,TextUtils.i18n("COREWEBCLIENT/ERROR_SAVING_SETTINGS_FAILED"))},CAccountSettingsFormView.prototype.changePassword=function(){this.allowChangePassword()&&Popups.showPopup(ChangePasswordPopup,[{iAccountId:AccountList.editedId(),sModule:Settings.ServerModuleName,bHasOldPassword:!0}])},module.exports=new CAccountSettingsFormView;