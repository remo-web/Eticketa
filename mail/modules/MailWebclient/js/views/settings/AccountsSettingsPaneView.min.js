"use strict";function CAccountsSettingsPaneView(){this.bAllowAddAccounts=Settings.AllowAddAccounts,this.bAllowMultiAccounts=Settings.AllowMultiAccounts,this.bAllowIdentities=!!Settings.AllowIdentities,this.bAllowFetchers=!!Settings.AllowFetchers,this.accounts=AccountList.collection,this.editedAccountId=AccountList.editedId,this.editedFetcher=ko.observable(null),this.editedFetcherId=ko.computed(function(){return this.editedFetcher()?this.editedFetcher().id():null},this),this.editedIdentity=ko.observable(null),this.editedIdentityId=ko.computed(function(){return this.editedIdentity()?this.editedIdentity().id():null},this),this.allowFolders=ko.observable(!1),this.allowForward=ko.observable(!1),this.allowAutoresponder=ko.observable(!1),this.allowFilters=ko.observable(!1),this.allowSignature=ko.observable(!1),this.aAccountTabs=[{name:"properties",title:TextUtils.i18n("%MODULENAME%/LABEL_PROPERTIES_TAB"),view:AccountSettingsFormView,visible:AccountSettingsFormView.visibleTab},{name:"folders",title:TextUtils.i18n("%MODULENAME%/LABEL_MANAGE_FOLDERS_TAB"),view:AccountFoldersPaneView,visible:this.allowFolders},{name:"forward",title:TextUtils.i18n("%MODULENAME%/LABEL_FORWARD_TAB"),view:AccountForwardSettingsFormView,visible:this.allowForward},{name:"autoresponder",title:TextUtils.i18n("%MODULENAME%/LABEL_AUTORESPONDER_TAB"),view:AccountAutoresponderSettingsFormView,visible:this.allowAutoresponder},{name:"filters",title:TextUtils.i18n("%MODULENAME%/LABEL_FILTERS_TAB"),view:AccountFiltersSettingsFormView,visible:this.allowFilters},{name:"signature",title:TextUtils.i18n("%MODULENAME%/LABEL_SIGNATURE_TAB"),view:SignatureSettingsFormView,visible:this.allowSignature}],this.aIdentityTabs=[{name:"properties",title:TextUtils.i18n("%MODULENAME%/LABEL_PROPERTIES_TAB"),view:new CIdentitySettingsFormView(this),visible:ko.observable(!0)},{name:"signature",title:TextUtils.i18n("%MODULENAME%/LABEL_SIGNATURE_TAB"),view:SignatureSettingsFormView,visible:ko.observable(!0)}],this.aFetcherTabs=[{name:"incoming",title:TextUtils.i18n("%MODULENAME%/LABEL_POP3_SETTINGS_TAB"),view:new CFetcherIncomingSettingsFormView(this),visible:ko.observable(!0)},{name:"outgoing",title:TextUtils.i18n("%MODULENAME%/LABEL_SMTP_SETTINGS_TAB"),view:FetcherOutgoingSettingsFormView,visible:ko.observable(!0)},{name:"signature",title:TextUtils.i18n("%MODULENAME%/LABEL_SIGNATURE_TAB"),view:SignatureSettingsFormView,visible:ko.observable(!0)}],this.currentTab=ko.observable(null),this.tabs=ko.computed(function(){return this.editedIdentity()?this.aIdentityTabs:this.editedFetcher()?this.aFetcherTabs:this.aAccountTabs},this),AccountList.editedId.subscribe(function(){this.populate()},this)}var _=require("underscore"),ko=require("knockout"),TextUtils=require("%PathToCoreWebclientModule%/js/utils/Text.js"),ModulesManager=require("%PathToCoreWebclientModule%/js/ModulesManager.js"),Routing=require("%PathToCoreWebclientModule%/js/Routing.js"),Screens=require("%PathToCoreWebclientModule%/js/Screens.js"),Popups=require("%PathToCoreWebclientModule%/js/Popups.js"),CreateAccountShortFormPopup=require("modules/%ModuleName%/js/popups/CreateAccountShortFormPopup.js"),CreateIdentityPopup=require("modules/%ModuleName%/js/popups/CreateIdentityPopup.js"),CreateFetcherPopup=require("modules/%ModuleName%/js/popups/CreateFetcherPopup.js"),AccountList=require("modules/%ModuleName%/js/AccountList.js"),Settings=require("modules/%ModuleName%/js/Settings.js"),AccountAutoresponderSettingsFormView=require("modules/%ModuleName%/js/views/settings/AccountAutoresponderSettingsFormView.js"),AccountFiltersSettingsFormView=require("modules/%ModuleName%/js/views/settings/AccountFiltersSettingsFormView.js"),AccountFoldersPaneView=require("modules/%ModuleName%/js/views/settings/AccountFoldersPaneView.js"),AccountForwardSettingsFormView=require("modules/%ModuleName%/js/views/settings/AccountForwardSettingsFormView.js"),AccountSettingsFormView=require("modules/%ModuleName%/js/views/settings/AccountSettingsFormView.js"),CIdentitySettingsFormView=require("modules/%ModuleName%/js/views/settings/CIdentitySettingsFormView.js"),CFetcherIncomingSettingsFormView=require("modules/%ModuleName%/js/views/settings/CFetcherIncomingSettingsFormView.js"),FetcherOutgoingSettingsFormView=require("modules/%ModuleName%/js/views/settings/FetcherOutgoingSettingsFormView.js"),SignatureSettingsFormView=require("modules/%ModuleName%/js/views/settings/SignatureSettingsFormView.js");CAccountsSettingsPaneView.prototype.ViewTemplate="%ModuleName%_Settings_AccountsSettingsPaneView",CAccountsSettingsPaneView.prototype.hasUnsavedChanges=function(){var e=this.currentTab();return e&&e.view&&_.isFunction(e.view.hasUnsavedChanges)&&e.view.hasUnsavedChanges()},CAccountsSettingsPaneView.prototype.revert=function(){var e=this.currentTab();e&&e.view&&_.isFunction(e.view.revert)&&e.view.revert()},CAccountsSettingsPaneView.prototype.hide=function(e,t){this.currentTab()&&_.isFunction(this.currentTab().view.hide)?this.currentTab().view.hide(e,t):e()},CAccountsSettingsPaneView.prototype.showTab=function(e){var t=e.length>0?e[0]:"account",i=AccountList.getEdited(),s=e.length>1?e[1]:i?i.hash():"",n=e.length>2?e[2]:"";this.editedIdentity("identity"===t?AccountList.getIdentityByHash(s)||null:null),this.editedFetcher("fetcher"===t?AccountList.getFetcherByHash(s)||null:null),"account"===t&&("create"!==e[1]||AccountList.hasAccount()?""!==s&&(i&&i.hash()===s?this.populate():_.find(AccountList.collection(),function(e){return e.hash()===s})?AccountList.changeEditedAccountByHash(s):Routing.replaceHash(["settings","mail-accounts"])):(this.addAccount(),Screens.showError(TextUtils.i18n("%MODULENAME%/INFO_SPECIFY_CREDENTIALS")),Routing.replaceHashDirectly(["settings","mail-accounts"]))),this.changeTab(n||this.getAutoselectedTab().name)},CAccountsSettingsPaneView.prototype.getAutoselectedTab=function(){var e=_.find(this.tabs(),function(e){return e.visible()});return e||(e=this.tabs()[0]),e},CAccountsSettingsPaneView.prototype.addAccount=function(){Popups.showPopup(CreateAccountShortFormPopup,[_.bind(function(e){var t=AccountList.getAccount(e);t&&this.editAccount(t.hash())},this)])},CAccountsSettingsPaneView.prototype.editAccount=function(e){ModulesManager.run("SettingsWebclient","setAddHash",[["account",e]])},CAccountsSettingsPaneView.prototype.addIdentity=function(e,t){t.stopPropagation(),Popups.showPopup(CreateIdentityPopup,[e])},CAccountsSettingsPaneView.prototype.editIdentity=function(e){ModulesManager.run("SettingsWebclient","setAddHash",[["identity",e]])},CAccountsSettingsPaneView.prototype.addFetcher=function(e,t){t.stopPropagation(),Popups.showPopup(CreateFetcherPopup,[e])},CAccountsSettingsPaneView.prototype.editFetcher=function(e){ModulesManager.run("SettingsWebclient","setAddHash",[["fetcher",e]])},CAccountsSettingsPaneView.prototype.changeRoute=function(e){var t=AccountList.getEdited(),i=["account",t?t.hash():"",e];this.editedIdentity()?i=["identity",this.editedIdentity().hash(),e]:this.editedFetcher()&&(i=["fetcher",this.editedFetcher().hash(),e]),ModulesManager.run("SettingsWebclient","setAddHash",[i])},CAccountsSettingsPaneView.prototype.changeTab=function(e){var t=this.currentTab(),i=_.find(this.tabs(),function(t){return t.visible()&&t.name===e}),s=function(){i&&(_.isFunction(i.view.showTab)&&i.view.showTab(this.editedIdentity()||this.editedFetcher()),this.currentTab(i))}.bind(this),n=!0;i?t&&_.isFunction(t.view.hide)&&(t.view.hide(s,_.bind(function(){_.isFunction(Routing.stopListening)&&_.isFunction(Routing.startListening)&&Routing.stopListening(),this.changeRoute(t.name),_.isFunction(Routing.startListening)&&Routing.startListening()},this)),n=!1):t||(i=this.getAutoselectedTab()),t||_.delay(_.bind(function(){this.changeRoute(i.name)},this)),n&&s()},CAccountsSettingsPaneView.prototype.populate=function(){var e=AccountList.getEdited();e&&(this.allowFolders(!0),this.allowForward(e.allowForward()),this.allowAutoresponder(e.allowAutoresponder()),this.allowFilters(e.allowFilters()),this.allowSignature(!Settings.AllowIdentities),this.currentTab()&&this.currentTab().visible()||this.currentTab(this.getAutoselectedTab()))},CAccountsSettingsPaneView.prototype.onRemoveIdentity=function(){this.editedIdentity(null),this.changeTab(this.currentTab()?this.currentTab().name:"")},CAccountsSettingsPaneView.prototype.onRemoveFetcher=function(){this.editedFetcher(null),this.changeRoute("")},module.exports=new CAccountsSettingsPaneView;