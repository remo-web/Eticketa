"use strict";function CFetcherIncomingSettingsFormView(e){CAbstractSettingsFormView.call(this,Settings.ServerModuleName),this.oParent=e,this.bShown=!1,this.fetcher=ko.observable(null),this.idFetcher=ko.observable(null),this.isEnabled=ko.observable(!0),this.incomingLogin=ko.observable(""),this.sFakePass="******",this.incomingPassword=ko.observable(this.sFakePass),this.oIncoming=new CServerPropertiesView(110,995,"fetcher_edit_incoming",TextUtils.i18n("%MODULENAME%/LABEL_POP3_SERVER")),this.sFetcherFolder="",this.folder=ko.observable(""),this.options=ko.observableArray([]),MailCache.folderList.subscribe(function(){this.populateOptions()},this),this.leaveMessagesOnServer=ko.observable(!1),this.passwordIsSelected=ko.observable(!1),this.defaultOptionsAfterRender=Utils.defaultOptionsAfterRender,this.fetcherIntervalHint=ko.computed(function(){var e=this.fetcher()?this.fetcher().iCheckIntervalMinutes:0;return 0!==e?TextUtils.i18n("%MODULENAME%/INFO_POP3_FETCHER_PLURAL",{INTERVAL:e},null,e):""},this)}var _=require("underscore"),$=require("jquery"),ko=require("knockout"),TextUtils=require("%PathToCoreWebclientModule%/js/utils/Text.js"),Utils=require("%PathToCoreWebclientModule%/js/utils/Common.js"),Api=require("%PathToCoreWebclientModule%/js/Api.js"),ModulesManager=require("%PathToCoreWebclientModule%/js/ModulesManager.js"),Screens=require("%PathToCoreWebclientModule%/js/Screens.js"),CoreAjax=require("%PathToCoreWebclientModule%/js/Ajax.js"),Popups=require("%PathToCoreWebclientModule%/js/Popups.js"),ConfirmPopup=require("%PathToCoreWebclientModule%/js/popups/ConfirmPopup.js"),CAbstractSettingsFormView=ModulesManager.run("SettingsWebclient","getAbstractSettingsFormViewClass"),AccountList=require("modules/%ModuleName%/js/AccountList.js"),MailCache=require("modules/%ModuleName%/js/Cache.js"),Settings=require("modules/%ModuleName%/js/Settings.js"),CServerPropertiesView=require("modules/%ModuleName%/js/views/CServerPropertiesView.js");_.extendOwn(CFetcherIncomingSettingsFormView.prototype,CAbstractSettingsFormView.prototype),CFetcherIncomingSettingsFormView.prototype.ViewTemplate="%ModuleName%_Settings_FetcherIncomingSettingsFormView",CFetcherIncomingSettingsFormView.prototype.onShow=function(e){this.fetcher(e&&e.FETCHER?e:null),this.populateOptions(),this.populate()},CFetcherIncomingSettingsFormView.prototype.hide=function(e){this.bShown=!1,e()},CFetcherIncomingSettingsFormView.prototype.populateOptions=function(){this.bShown&&(this.options(MailCache.folderList().getOptions("",!0,!1,!1)),this.sFetcherFolder!==this.folder()&&(this.folder(this.sFetcherFolder),this.updateSavedState()))},CFetcherIncomingSettingsFormView.prototype.getCurrentValues=function(){return[this.isEnabled(),this.oIncoming.server(),this.oIncoming.port(),this.oIncoming.ssl(),this.incomingPassword(),this.folder(),this.leaveMessagesOnServer()]},CFetcherIncomingSettingsFormView.prototype.getParametersForSave=function(){if(this.fetcher()){var e=$.trim(this.incomingPassword()),t={FetcherId:this.idFetcher(),IsEnabled:this.isEnabled(),Folder:this.folder(),IncomingServer:this.oIncoming.server(),IncomingPort:this.oIncoming.getIntPort(),IncomingUseSsl:this.oIncoming.ssl(),LeaveMessagesOnServer:this.leaveMessagesOnServer()};return""!==e&&e!==this.sFakePass&&(t.IncomingPassword=e),t}return{}},CFetcherIncomingSettingsFormView.prototype.save=function(){this.isEmptyRequiredFields()?Screens.showError(TextUtils.i18n("%MODULENAME%/ERROR_REQUIRED_FIELDS_EMPTY")):(this.isSaving(!0),this.updateSavedState(),CoreAjax.send(Settings.FetchersServerModuleName,"UpdateFetcher",this.getParametersForSave(),this.onResponse,this))},CFetcherIncomingSettingsFormView.prototype.onResponse=function(e,t){this.isSaving(!1),e.Result?(AccountList.populateFetchers(),Screens.showReport(TextUtils.i18n("%MODULENAME%/REPORT_SUCCESSFULLY_SAVED"))):Api.showErrorByCode(e,TextUtils.i18n("COREWEBCLIENT/ERROR_UNKNOWN"))},CFetcherIncomingSettingsFormView.prototype.populate=function(){var e=this.fetcher();e&&(this.sFetcherFolder=e.folder(),this.idFetcher(e.id()),this.isEnabled(e.isEnabled()),this.folder(e.folder()),this.oIncoming.set(e.incomingServer(),e.incomingPort(),e.incomingUseSsl()),this.incomingLogin(e.incomingLogin()),this.incomingPassword(this.sFakePass),this.leaveMessagesOnServer(e.leaveMessagesOnServer()),this.updateSavedState())},CFetcherIncomingSettingsFormView.prototype.isEmptyRequiredFields=function(){return""===this.oIncoming.server()?(this.oIncoming.server.focused(!0),!0):""===$.trim(this.incomingPassword())&&(this.passwordIsSelected(!0),!0)},CFetcherIncomingSettingsFormView.prototype.remove=function(){var e=this.fetcher(),t=function(t){if(t){var i={FetcherId:e.id()};CoreAjax.send(Settings.FetchersServerModuleName,"DeleteFetcher",i,this.onAccountDeleteFetcherResponse,this),this.oParent&&_.isFunction(this.oParent.onRemoveFetcher)&&this.oParent.onRemoveFetcher()}}.bind(this);e&&Popups.showPopup(ConfirmPopup,[TextUtils.i18n("%MODULENAME%/CONFIRM_REMOVE_FETCHER"),t,e.incomingLogin()])},CFetcherIncomingSettingsFormView.prototype.onAccountDeleteFetcherResponse=function(e,t){e.Result||Api.showErrorByCode(e,TextUtils.i18n("%MODULENAME%/ERROR_FETCHER_DELETING")),AccountList.populateFetchers()},module.exports=CFetcherIncomingSettingsFormView;