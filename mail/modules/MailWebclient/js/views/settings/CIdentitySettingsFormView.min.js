"use strict";function CIdentitySettingsFormView(t,e){CAbstractSettingsFormView.call(this,Settings.ServerModuleName),this.identity=ko.observable(null),this.oParent=t,this.bCreate=e,this.disableCheckbox=ko.observable(!1),this.isDefault=ko.observable(!1),this.email=ko.observable(""),this.emailList=ko.observableArray([]),this.selectedEmail=ko.observable(""),this.disableEditEmail=ko.observable(Settings.OnlyUserEmailsInIdentities),this.disableRemoveIdentity=ko.observable(e),this.friendlyName=ko.observable(""),this.friendlyNameHasFocus=ko.observable(!1)}var _=require("underscore"),$=require("jquery"),ko=require("knockout"),TextUtils=require("%PathToCoreWebclientModule%/js/utils/Text.js"),Types=require("%PathToCoreWebclientModule%/js/utils/Types.js"),Utils=require("%PathToCoreWebclientModule%/js/utils/Common.js"),Api=require("%PathToCoreWebclientModule%/js/Api.js"),ModulesManager=require("%PathToCoreWebclientModule%/js/ModulesManager.js"),Screens=require("%PathToCoreWebclientModule%/js/Screens.js"),CAbstractSettingsFormView=ModulesManager.run("SettingsWebclient","getAbstractSettingsFormViewClass"),AccountList=require("modules/%ModuleName%/js/AccountList.js"),Ajax=require("modules/%ModuleName%/js/Ajax.js"),Settings=require("modules/%ModuleName%/js/Settings.js");_.extendOwn(CIdentitySettingsFormView.prototype,CAbstractSettingsFormView.prototype),CIdentitySettingsFormView.prototype.ViewTemplate="%ModuleName%_Settings_IdentitySettingsFormView",CIdentitySettingsFormView.prototype.ViewConstructorName="CIdentitySettingsFormView",CIdentitySettingsFormView.prototype.onShow=function(t){this.identity(t&&!t.FETCHER?t:null),this.populate()},CIdentitySettingsFormView.prototype.getCurrentValues=function(){return[this.friendlyName(),this.email()]},CIdentitySettingsFormView.prototype.getParametersForSave=function(){if(this.identity()){var t={AccountID:this.identity().accountId(),Default:this.isDefault(),FriendlyName:this.friendlyName(),AccountPart:this.identity().bAccountPart};return this.identity().bAccountPart||(_.extendOwn(t,{Email:this.emailList().length>0?$.trim(this.selectedEmail()):$.trim(this.email())}),this.bCreate||(t.EntityId=this.identity().id())),t}return{}},CIdentitySettingsFormView.prototype.save=function(){""===$.trim(this.email())?Screens.showError(Utils.i18n("%MODULENAME%/ERROR_IDENTITY_FIELDS_BLANK")):(this.isSaving(!0),this.updateSavedState(),Ajax.send(this.bCreate?"CreateIdentity":"UpdateIdentity",this.getParametersForSave(),this.onResponse,this))},CIdentitySettingsFormView.prototype.onResponse=function(t,e){if(this.isSaving(!1),t.Result){var i=e.Parameters,s=Types.pInt(i.AccountID),n=0<s?AccountList.getAccount(s):null;AccountList.populateIdentities(function(){var e=AccountList.getCurrent().identities(),i=_.find(e,function(e){return e.id()===t.Result});i&&ModulesManager.run("SettingsWebclient","setAddHash",[["identity",i.hash()]])}),this.bCreate&&_.isFunction(this.oParent.closePopup)&&this.oParent.closePopup(),i.AccountPart&&n&&n.updateFriendlyName(i.FriendlyName),this.disableCheckbox(this.isDefault()),Screens.showReport(TextUtils.i18n("COREWEBCLIENT/REPORT_SETTINGS_UPDATE_SUCCESS"))}else Api.showErrorByCode(t,TextUtils.i18n("%MODULENAME%/ERROR_IDENTITY_ADDING"))},CIdentitySettingsFormView.prototype.populate=function(){var t=this.identity();if(t){if(this.isDefault(t.isDefault()),this.email(t.email()),this.disableEditEmail(Settings.OnlyUserEmailsInIdentities||t.bAccountPart),this.disableRemoveIdentity(this.bCreate||t.bAccountPart),this.emailList([]),Settings.OnlyUserEmailsInIdentities&&!t.bAccountPart){var e=[],i=AccountList.getAccount(t.accountId());i&&(e=i.aExtend.Aliases),Types.isNonEmptyArray(e)&&(this.emailList(_.clone(e)),this.emailList.unshift(t.email()),this.selectedEmail(t.email()))}this.friendlyName(t.friendlyName()),this.disableCheckbox(t.isDefault()),setTimeout(function(){this.updateSavedState()}.bind(this),1)}},CIdentitySettingsFormView.prototype.remove=function(){if(this.identity()&&!this.identity().bAccountPart){var t={AccountID:this.identity().accountId(),EntityId:this.identity().id()};Ajax.send("DeleteIdentity",t,this.onAccountIdentityDeleteResponse,this),!this.bCreate&&_.isFunction(this.oParent.onRemoveIdentity)&&this.oParent.onRemoveIdentity()}},CIdentitySettingsFormView.prototype.onAccountIdentityDeleteResponse=function(t,e){t.Result||Api.showErrorByCode(t,TextUtils.i18n("%MODULENAME%/ERROR_IDENTITY_DELETING")),AccountList.populateIdentities()},CIdentitySettingsFormView.prototype.cancel=function(){_.isFunction(this.oParent.cancelPopup)&&this.oParent.cancelPopup()},module.exports=CIdentitySettingsFormView;