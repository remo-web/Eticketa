"use strict";function CServerPairPropertiesView(e,t){this.servers=ko.observableArray([]),this.serversRetrieved=ko.observable(!1),this.serverOptions=ko.observableArray([{Name:TextUtils.i18n("%MODULENAME%/LABEL_CONFIGURE_SERVER_MANUALLY"),Id:0}]),this.selectedServerId=ko.observable(0),this.oLastEditableServer=new CServerModel,this.iEditedServerId=0,this.selectedServerId.subscribe(function(){var e=this.selectedServerId(),t=_.find(this.servers(),function(t){return t.iId===e});t?(this.oIncoming.isEnabled()&&(this.oLastEditableServer=new CServerModel(this.getParametersForSave())),this.setExternalAccessServers(t.bSetExternalAccessServers),this.externalAccessImapServer(t.sExternalAccessImapServer),this.externalAccessImapPort(t.iExternalAccessImapPort),this.externalAccessSmtpServer(t.sExternalAccessSmtpServer),this.externalAccessSmtpPort(t.iExternalAccessSmtpPort),this.tenantId(t.iTenantId),this.name(t.sName),this.oIncoming.set(t.sIncomingServer,t.iIncomingPort,t.bIncomingUseSsl),this.oIncoming.isEnabled(this.bAdminEdit),this.oOutgoing.set(t.sOutgoingServer,t.iOutgoingPort,t.bOutgoingUseSsl),this.oOutgoing.isEnabled(this.bAdminEdit),this.outgoingUseAuth(t.sSmtpAuthType===window.Enums.SmtpAuthType.UseUserCredentials),this.outgoingUseAuth.enable(this.bAdminEdit),this.domains(t.sDomains),this.smtpAuthType(t.sSmtpAuthType),this.smtpLogin(t.sSmtpLogin),this.smtpPassword(t.sSmtpPassword),this.enableSieve(t.bEnableSieve),this.sievePort(t.iSievePort),this.enableThreading(t.bEnableThreading),this.useFullEmailAddressAsLogin(t.bUseFullEmailAddressAsLogin)):(this.setExternalAccessServers(this.oLastEditableServer.bSetExternalAccessServers),this.externalAccessImapServer(this.oLastEditableServer.sExternalAccessImapServer),this.externalAccessImapPort(this.oLastEditableServer.iExternalAccessImapPort),this.externalAccessSmtpServer(this.oLastEditableServer.sExternalAccessSmtpServer),this.externalAccessSmtpPort(this.oLastEditableServer.iExternalAccessSmtpPort),this.tenantId(0),this.name(this.oLastEditableServer.sName),this.oIncoming.set(this.oLastEditableServer.sIncomingServer,this.oLastEditableServer.iIncomingPort,this.oLastEditableServer.bIncomingUseSsl),this.oIncoming.isEnabled(!0),this.oOutgoing.set(this.oLastEditableServer.sOutgoingServer,this.oLastEditableServer.iOutgoingPort,this.oLastEditableServer.bOutgoingUseSsl),this.oOutgoing.isEnabled(!0),this.outgoingUseAuth(this.oLastEditableServer.sSmtpAuthType===window.Enums.SmtpAuthType.UseUserCredentials),this.outgoingUseAuth.enable(!0),this.domains(""),this.smtpAuthType(window.Enums.SmtpAuthType.UseUserCredentials),this.smtpLogin(""),this.smtpPassword(""),this.enableSieve(!1),this.sievePort(4190),this.enableThreading(!0),this.useFullEmailAddressAsLogin(!0)),this.setCurrentValues()},this),this.tenantId=ko.observable(0),this.name=ko.observable(""),this.name.focused=ko.observable(!1),this.bAdminEdit=t,this.oIncoming=new CServerPropertiesView(143,993,e+"_incoming",TextUtils.i18n("%MODULENAME%/LABEL_IMAP_SERVER"),t?this.name:null),this.oOutgoing=new CServerPropertiesView(25,465,e+"_outgoing",TextUtils.i18n("%MODULENAME%/LABEL_SMTP_SERVER"),this.oIncoming.server),this.outgoingUseAuth=ko.observable(!0),this.outgoingUseAuth.enable=ko.observable(!0),this.domains=ko.observable(""),this.bAllowEditDomains=Settings.AllowEditDomainsInServer,this.name.focused.subscribe(function(){this.bAllowEditDomains&&!this.name.focused()&&""===this.domains()&&this.domains(this.name())},this),this.smtpAuthType=ko.observable(window.Enums.SmtpAuthType.UseUserCredentials),this.smtpLogin=ko.observable(""),this.smtpPassword=ko.observable(""),this.enableSieve=ko.observable(!1),this.sievePort=ko.observable(4190),this.enableThreading=ko.observable(!0),this.useFullEmailAddressAsLogin=ko.observable(!0),this.currentValues=ko.observable(""),this.aRequiredFields=[this.oIncoming.server,this.oIncoming.port,this.oOutgoing.server,this.oOutgoing.port],t&&this.aRequiredFields.unshift(this.name),this.setExternalAccessServers=ko.observable(!1),this.externalAccessImapServer=ko.observable(this.oIncoming.server()),this.externalAccessImapPort=ko.observable(this.oIncoming.port()),this.externalAccessSmtpServer=ko.observable(this.oOutgoing.server()),this.externalAccessSmtpPort=ko.observable(this.oOutgoing.port()),ko.computed(function(){this.setExternalAccessServers()||(this.externalAccessImapServer(this.oIncoming.server()),this.externalAccessImapPort(this.oIncoming.port()),this.externalAccessSmtpServer(this.oOutgoing.server()),this.externalAccessSmtpPort(this.oOutgoing.port()))},this)}var _=require("underscore"),$=require("jquery"),ko=require("knockout"),TextUtils=require("%PathToCoreWebclientModule%/js/utils/Text.js"),Types=require("%PathToCoreWebclientModule%/js/utils/Types.js"),ValidationUtils=require("%PathToCoreWebclientModule%/js/utils/Validation.js"),Api=require("%PathToCoreWebclientModule%/js/Api.js"),App=require("%PathToCoreWebclientModule%/js/App.js"),Ajax=require("modules/%ModuleName%/js/Ajax.js"),Settings=require("modules/%ModuleName%/js/Settings.js"),CServerModel=require("modules/%ModuleName%/js/models/CServerModel.js"),CServerPropertiesView=require("modules/%ModuleName%/js/views/CServerPropertiesView.js");CServerPairPropertiesView.prototype.ViewTemplate="%ModuleName%_Settings_ServerPairPropertiesView",CServerPairPropertiesView.prototype.serverInit=function(e){this.setServer(e?new CServerModel:this.oLastEditableServer)},CServerPairPropertiesView.prototype.fullInit=function(){this.setServer(this.oLastEditableServer),this.serversRetrieved()||this.requestServers()},CServerPairPropertiesView.prototype.setServer=function(e){this.oLastEditableServer=e,this.setServerId(e.iId)},CServerPairPropertiesView.prototype.setServerId=function(e){if(this.serversRetrieved()){var t=0===this.selectedServerId();this.selectedServerId(0),this.selectedServerId(e),t&&0===e&&this.selectedServerId.valueHasMutated()}else this.iEditedServerId=e},CServerPairPropertiesView.prototype.requestServers=function(){var e=_.isFunction(App.getTenantId)?App.getTenantId():0;this.serversRetrieved(!1),Ajax.send("GetServers",{TenantId:e},function(e){if(_.isArray(e.Result)){var t=[{Name:TextUtils.i18n("%MODULENAME%/LABEL_CONFIGURE_SERVER_MANUALLY"),Id:0}];_.each(e.Result,function(e){t.push({Name:e.Name,Id:Types.pInt(e.EntityId)})}),this.servers(_.map(e.Result,function(e){return new CServerModel(e)})),this.serverOptions(t),this.serversRetrieved(!0),this.iEditedServerId&&(this.setServerId(this.iEditedServerId),this.iEditedServerId=0)}else Api.showErrorByCode(e)},this)},CServerPairPropertiesView.prototype.clear=function(){this.oIncoming.clear(),this.oOutgoing.clear(),this.outgoingUseAuth(!0)},CServerPairPropertiesView.prototype.setCurrentValues=function(){var e=this.bAdminEdit?[this.selectedServerId(),this.name()]:[],t=[this.oIncoming.port(),this.oIncoming.server(),this.oIncoming.ssl(),this.oOutgoing.port(),this.oOutgoing.server(),this.oOutgoing.ssl(),this.outgoingUseAuth(),this.domains(),this.smtpAuthType(),this.smtpLogin(),this.smtpPassword(),this.enableSieve(),this.sievePort(),this.enableThreading(),this.useFullEmailAddressAsLogin(),this.setExternalAccessServers(),this.externalAccessImapServer(),this.externalAccessImapPort(),this.externalAccessSmtpServer(),this.externalAccessSmtpPort()];this.currentValues(e.concat(t).join(":"))},CServerPairPropertiesView.prototype.getCurrentValues=function(){return this.setCurrentValues(),[this.currentValues()]},CServerPairPropertiesView.prototype.getSmtpAuthType=function(){return this.bAdminEdit||this.smtpAuthType()===window.Enums.SmtpAuthType.UseSpecifiedCredentials?this.smtpAuthType():this.outgoingUseAuth()?window.Enums.SmtpAuthType.UseUserCredentials:window.Enums.SmtpAuthType.NoAuthentication},CServerPairPropertiesView.prototype.getParametersForSave=function(){var e=this.selectedServerId(),t=this.oLastEditableServer.iId,s=this.getSmtpAuthType(),i={};return 0!==e||_.find(this.servers(),function(e){return t===e.iId})||(e=t),i={ServerId:e,Name:this.bAdminEdit?this.name():this.oIncoming.server(),IncomingServer:this.oIncoming.server(),IncomingPort:this.oIncoming.getIntPort(),IncomingUseSsl:this.oIncoming.ssl(),OutgoingServer:this.oOutgoing.server(),OutgoingPort:this.oOutgoing.getIntPort(),OutgoingUseSsl:this.oOutgoing.ssl(),Domains:this.domains(),SmtpAuthType:s,SmtpLogin:s===window.Enums.SmtpAuthType.UseSpecifiedCredentials?$.trim(this.smtpLogin()):"",SmtpPassword:s===window.Enums.SmtpAuthType.UseSpecifiedCredentials?$.trim(this.smtpPassword()):"",EnableSieve:this.enableSieve(),SievePort:this.sievePort(),EnableThreading:this.enableThreading(),UseFullEmailAddressAsLogin:this.useFullEmailAddressAsLogin(),SetExternalAccessServers:this.setExternalAccessServers()},this.setExternalAccessServers()&&(i.ExternalAccessImapServer=this.externalAccessImapServer(),i.ExternalAccessImapPort=this.externalAccessImapPort(),i.ExternalAccessSmtpServer=this.externalAccessSmtpServer(),i.ExternalAccessSmtpPort=this.externalAccessSmtpPort()),i},CServerPairPropertiesView.prototype.validateBeforeSave=function(){return ValidationUtils.checkIfFieldsEmpty(this.aRequiredFields,TextUtils.i18n("%MODULENAME%/ERROR_REQUIRED_FIELDS_EMPTY"))},CServerPairPropertiesView.prototype.onDomainsClick=function(){this.bAllowEditDomains||($(".tabsbar .item.admin.domain").removeClass("recivedAnim"),setTimeout(function(){$(".tabsbar .item.admin.domain").addClass("recivedAnim")}))},module.exports=CServerPairPropertiesView;