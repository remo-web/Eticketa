"use strict";function CServersAdminSettingsPaneView(){CAbstractSettingsFormView.call(this,Settings.ServerModuleName),this.visible=ko.observable(!0),this.oServerPairPropertiesView=new CServerPairPropertiesView("server_edit",!0),this.tenants=ModulesManager.run("AdminPanelWebclient","getTenantsObservable"),this.tenantOptions=ko.computed(function(){return _.union([{Name:"system-wide",Id:0}],this.tenants())},this),this.selectedTenantId=ko.observable(this.getSelectedTenantId()),this.servers=this.oServerPairPropertiesView.servers,this.servers.subscribe(function(){_.each(this.servers(),function(e){if(0!==e.iTenantId&&Settings.EnableMultiTenant){var t=_.find(this.tenants(),function(t){return t.Id===e.iTenantId});e.sTenantHint=t?" "+TextUtils.i18n("%MODULENAME%/LABEL_HINT_SERVERS_TENANTNAME",{TENANTNAME:t.Name}):""}else e.sTenantHint=""}.bind(this)),this.editedServer()||this.routeServerList(),this.serversRetrieved()||this.revert()},this),this.serversRetrieved=this.oServerPairPropertiesView.serversRetrieved,this.createMode=ko.observable(!1),this.editedServerId=ko.observable(0),this.editedServer=ko.computed(function(){return _.find(this.servers(),_.bind(function(e){return e.iId===this.editedServerId()},this))},this),this.updateSavedState(),this.oServerPairPropertiesView.currentValues.subscribe(function(){this.updateSavedState()},this)}var _=require("underscore"),ko=require("knockout"),TextUtils=require("%PathToCoreWebclientModule%/js/utils/Text.js"),Types=require("%PathToCoreWebclientModule%/js/utils/Types.js"),Api=require("%PathToCoreWebclientModule%/js/Api.js"),App=require("%PathToCoreWebclientModule%/js/App.js"),ModulesManager=require("%PathToCoreWebclientModule%/js/ModulesManager.js"),Screens=require("%PathToCoreWebclientModule%/js/Screens.js"),CAbstractSettingsFormView=ModulesManager.run("AdminPanelWebclient","getAbstractSettingsFormViewClass"),Popups=require("%PathToCoreWebclientModule%/js/Popups.js"),ConfirmPopup=require("%PathToCoreWebclientModule%/js/popups/ConfirmPopup.js"),Ajax=require("modules/%ModuleName%/js/Ajax.js"),CServerPairPropertiesView=require("modules/%ModuleName%/js/views/settings/CServerPairPropertiesView.js"),Settings=require("modules/%ModuleName%/js/Settings.js");_.extendOwn(CServersAdminSettingsPaneView.prototype,CAbstractSettingsFormView.prototype),CServersAdminSettingsPaneView.prototype.ViewTemplate="%ModuleName%_Settings_ServersAdminSettingsPaneView",CServersAdminSettingsPaneView.prototype.getSelectedTenantId=function(){if(this.tenants().length<2)return 0;var e=ModulesManager.run("AdminPanelWebclient","getKoSelectedTenantId");return _.isFunction(e)?e():0},CServersAdminSettingsPaneView.prototype.routeCreateServer=function(){ModulesManager.run("AdminPanelWebclient","setAddHash",[["create"]])},CServersAdminSettingsPaneView.prototype.routeEditServer=function(e){ModulesManager.run("AdminPanelWebclient","setAddHash",[[e]])},CServersAdminSettingsPaneView.prototype.routeServerList=function(){ModulesManager.run("AdminPanelWebclient","setAddHash",[[]])},CServersAdminSettingsPaneView.prototype.onRouteChild=function(e){var t=Types.isNonEmptyArray(e)&&"create"===e[0],r=!t&&Types.isNonEmptyArray(e)?Types.pInt(e[0]):0;this.createMode(t),this.editedServerId(r),this.oServerPairPropertiesView.serverInit(t),this.revert()},CServersAdminSettingsPaneView.prototype.onShow=function(){this.selectedTenantId(this.getSelectedTenantId()),this.oServerPairPropertiesView.requestServers()},CServersAdminSettingsPaneView.prototype.deleteServer=function(e){var t=_.bind(function(t){t&&Ajax.send("DeleteServer",{ServerId:e,TenantId:r.iTenantId,DeletionConfirmedByAdmin:!0},function(e){e.Result||Api.showErrorByCode(e,TextUtils.i18n("%MODULENAME%/ERROR_DELETE_MAIL_SERVER")),this.oServerPairPropertiesView.requestServers()},this)},this),r=_.find(this.servers(),_.bind(function(t){return t.iId===e},this)),i={Type:"Server",Count:1,ConfirmText:TextUtils.i18n("%MODULENAME%/CONFIRM_REMOVE_SERVER")};r&&r.bAllowToDelete&&(App.broadcastEvent("ConfirmDeleteEntity::before",i),Popups.showPopup(ConfirmPopup,[i.ConfirmText,t,r.sName]))},CServersAdminSettingsPaneView.prototype.save=function(){if(this.oServerPairPropertiesView.validateBeforeSave()){var e=this.createMode()?"CreateServer":"UpdateServer";this.isSaving(!0),Ajax.send(e,this.getParametersForSave(),function(e){this.isSaving(!1),this.oServerPairPropertiesView.requestServers(),this.createMode()?this.routeServerList():e.Result?Screens.showReport(TextUtils.i18n("COREWEBCLIENT/REPORT_SETTINGS_UPDATE_SUCCESS")):Api.showErrorByCode(e,TextUtils.i18n("COREWEBCLIENT/ERROR_SAVING_SETTINGS_FAILED"))},this)}},CServersAdminSettingsPaneView.prototype.getCurrentValues=function(){return this.oServerPairPropertiesView.getCurrentValues()},CServersAdminSettingsPaneView.prototype.revertGlobalValues=function(){this.oServerPairPropertiesView.setServerId(this.editedServerId())},CServersAdminSettingsPaneView.prototype.getParametersForSave=function(){var e=this.oServerPairPropertiesView.getParametersForSave();return this.createMode()?e.TenantId=this.selectedTenantId():e.TenantId=this.editedServer().iTenantId,e},CServersAdminSettingsPaneView.prototype.setAccessLevel=function(e,t){this.visible(""===e)},module.exports=new CServersAdminSettingsPaneView;