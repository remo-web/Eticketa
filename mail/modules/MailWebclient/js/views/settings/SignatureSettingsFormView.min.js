"use strict";function CSignatureSettingsFormView(){CAbstractSettingsFormView.call(this,Settings.ServerModuleName),this.fetcherOrIdentity=ko.observable(null),this.useSignatureRadio=ko.observable(Enums.UseSignature.Off),this.signature=ko.observable(""),this.oHtmlEditor=new CHtmlEditorView(!0),this.oHtmlEditor.textFocused.subscribe(function(){this.oHtmlEditor.textFocused()&&this.useSignatureRadio(Enums.UseSignature.On)},this),this.useSignatureRadio.subscribe(function(){this.oHtmlEditor.setInactive(this.useSignatureRadio()===Enums.UseSignature.Off)},this),this.enableImageDragNDrop=ko.observable(!1),this.enabled=ko.observable(!0)}var _=require("underscore"),ko=require("knockout"),TextUtils=require("%PathToCoreWebclientModule%/js/utils/Text.js"),Types=require("%PathToCoreWebclientModule%/js/utils/Types.js"),Api=require("%PathToCoreWebclientModule%/js/Api.js"),Browser=require("%PathToCoreWebclientModule%/js/Browser.js"),ModulesManager=require("%PathToCoreWebclientModule%/js/ModulesManager.js"),Screens=require("%PathToCoreWebclientModule%/js/Screens.js"),CoreAjax=require("%PathToCoreWebclientModule%/js/Ajax.js"),CAbstractSettingsFormView=ModulesManager.run("SettingsWebclient","getAbstractSettingsFormViewClass"),AccountList=require("modules/%ModuleName%/js/AccountList.js"),Ajax=require("modules/%ModuleName%/js/Ajax.js"),Settings=require("modules/%ModuleName%/js/Settings.js"),CHtmlEditorView=require("modules/%ModuleName%/js/views/CHtmlEditorView.js");_.extendOwn(CSignatureSettingsFormView.prototype,CAbstractSettingsFormView.prototype),CSignatureSettingsFormView.prototype.ViewTemplate="%ModuleName%_Settings_SignatureSettingsFormView",CSignatureSettingsFormView.prototype.ViewConstructorName="CSignatureSettingsFormView",CSignatureSettingsFormView.prototype.onShow=function(e){this.fetcherOrIdentity(e||null),this.populate(),_.defer(_.bind(this.init,this))},CSignatureSettingsFormView.prototype.init=function(){this.oHtmlEditor.setInactive(this.useSignatureRadio()===Enums.UseSignature.Off),this.oHtmlEditor.init(this.signature(),!1,"",TextUtils.i18n("%MODULENAME%/LABEL_ENTER_SIGNATURE_HERE")),this.enableImageDragNDrop(this.oHtmlEditor.isDragAndDropSupported()&&!Browser.ie10AndAbove)},CSignatureSettingsFormView.prototype.getCurrentValues=function(){return this.oHtmlEditor.isInitialized()&&this.signature(this.oHtmlEditor.getText()),[this.useSignatureRadio(),this.signature()]},CSignatureSettingsFormView.prototype.revert=function(){this.populate()},CSignatureSettingsFormView.prototype.getParametersForSave=function(){this.signature(this.oHtmlEditor.getText());var e=AccountList.getEdited(),t={AccountID:this.fetcherOrIdentity()?this.fetcherOrIdentity().accountId():e?e.id():0,UseSignature:this.useSignatureRadio()===Enums.UseSignature.On,Signature:this.signature()};return this.fetcherOrIdentity()&&(this.fetcherOrIdentity().FETCHER?_.extendOwn(t,{FetcherId:this.fetcherOrIdentity().id()}):this.fetcherOrIdentity().bAccountPart||_.extendOwn(t,{IdentityId:this.fetcherOrIdentity().id()})),t},CSignatureSettingsFormView.prototype.applySavedValues=function(e){if(e.FetcherId)AccountList.populateFetchers();else if(!e.IdentityId){var t=AccountList.getAccount(e.AccountID);t&&(t.useSignature(!!e.UseSignature),t.signature(e.Signature))}AccountList.populateIdentities()},CSignatureSettingsFormView.prototype.populate=function(){var e=AccountList.getEdited(),t=this.fetcherOrIdentity()||e;t?(this.useSignatureRadio(t.useSignature()?Enums.UseSignature.On:Enums.UseSignature.Off),this.signature(t.signature()),this.oHtmlEditor.setText(this.signature())):e&&Ajax.send("GetSignature",{AccountID:e.id()},this.onGetSignatureResponse,this),this.updateSavedState()},CSignatureSettingsFormView.prototype.onGetSignatureResponse=function(e,t){if(e&&e.Result){var i=t.Parameters,s=Types.pInt(i.AccountID);AccountList.getAccount(s)&&(this.parseSignature(e.Result),s===AccountList.editedId()&&this.populate())}},CSignatureSettingsFormView.prototype.save=function(){this.isSaving(!0),this.updateSavedState(),this.fetcherOrIdentity()&&this.fetcherOrIdentity().FETCHER?CoreAjax.send(Settings.FetchersServerModuleName,"UpdateSignature",this.getParametersForSave(),this.onResponse,this):Ajax.send("UpdateSignature",this.getParametersForSave(),this.onResponse,this)},CSignatureSettingsFormView.prototype.onResponse=function(e,t){this.isSaving(!1),e.Result?(this.applySavedValues(t.Parameters),Screens.showReport(TextUtils.i18n("COREWEBCLIENT/REPORT_SETTINGS_UPDATE_SUCCESS"))):Api.showErrorByCode(e,TextUtils.i18n("COREWEBCLIENT/ERROR_SAVING_SETTINGS_FAILED"))},module.exports=new CSignatureSettingsFormView;