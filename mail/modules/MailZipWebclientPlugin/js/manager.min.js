"use strict";module.exports=function(e){var i=require("%PathToCoreWebclientModule%/js/App.js");if(i.isUserNormalOrTenant()){var s=require("underscore"),t=require("knockout"),n=require("%PathToCoreWebclientModule%/js/utils/Text.js"),l=require("%PathToCoreWebclientModule%/js/utils/Types.js"),o=require("%PathToCoreWebclientModule%/js/utils/Url.js"),a=require("%PathToCoreWebclientModule%/js/Ajax.js"),u=require("%PathToCoreWebclientModule%/js/Api.js"),r=require("%PathToCoreWebclientModule%/js/Screens.js"),d=!!e["%ModuleName%"]&&!!e["%ModuleName%"].AllowZip;return{start:function(e){d&&(i.subscribeEvent("MailWebclient::ParseFile::after",function(e){if(e&&s.isFunction(e.addAction)&&"zip"===e.extension()){e.mailzipSubFilesLoaded=t.observable(!1),e.mailzipSubFilesLoading=t.observable(!1),e.mailzipExpandFile=function(){this.mailzipSubFilesLoaded()||this.mailzipSubFilesLoading()?this.subFilesExpanded(!0):(this.mailzipSubFilesLoading(!0),a.send("%ModuleName%","ExpandFile",{Hash:this.hash()},function(i){var t=i.Result&&s.isArray(i.Result.Files)?i.Result.Files:[];this.mailzipSubFilesLoading(!1),this.subFiles([]),l.isNonEmptyArray(t)&&s.each(t,s.bind(function(i){var s=e.getNewInstance();s.parse(i),this.subFiles.push(s)},this)),this.mailzipSubFilesLoaded(!0),this.subFilesExpanded(!0)},this))};var i={Text:t.computed(function(){return this.subFilesExpanded()?n.i18n("COREWEBCLIENT/ACTION_COLLAPSE_FILE"):this.mailzipSubFilesLoading()?n.i18n("COREWEBCLIENT/INFO_LOADING"):n.i18n("COREWEBCLIENT/ACTION_EXPAND_FILE")},e),Handler:s.bind(function(){this.mailzipSubFilesLoading()||(this.subFilesExpanded()?this.subFilesExpanded(!1):this.mailzipExpandFile())},e)};e.addAction("expand",!0,i),e.removeAction("view")}}),i.subscribeEvent("MailWebclient::AddAllAttachmentsDownloadMethod",function(e){e({Text:n.i18n("%MODULENAME%/ACTION_DOWNLOAD_ATTACHMENTS_ZIP"),Handler:function(e,i){r.showLoading(n.i18n("COREWEBCLIENT/INFO_LOADING")),a.send("%ModuleName%","SaveAttachments",{AccountID:e,Attachments:i},function(e){if(r.hideLoading(),e.Result&&e.Result.Actions&&e.Result.Actions.download){var i=e.Result.Actions.download.url;o.downloadByUrl(i)}else u.showErrorByCode(e)})}})}))}}}return null};