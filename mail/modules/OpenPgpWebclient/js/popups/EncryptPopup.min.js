"use strict";function CEncryptPopup(){CAbstractPopup.call(this),this.bMobile=App.isMobile(),this.data=ko.observable(""),this.fromEmail=ko.observable(""),this.emails=ko.observableArray([]),this.okCallback=null,this.cancelCallback=null,this.sign=ko.observable(!0),this.password=ko.observable(""),this.passwordFocused=ko.observable(!1),this.encrypt=ko.observable(!0),this.signEncryptButtonText=ko.computed(function(){var t=TextUtils.i18n("%MODULENAME%/ACTION_SIGN_ENCRYPT");return this.sign()&&!this.encrypt()&&(t=TextUtils.i18n("%MODULENAME%/ACTION_SIGN")),!this.sign()&&this.encrypt()&&(t=TextUtils.i18n("%MODULENAME%/ACTION_ENCRYPT")),t},this),this.isEnableSignEncrypt=ko.computed(function(){return this.sign()||this.encrypt()},this),this.signEncryptCommand=Utils.createCommand(this,this.executeSignEncrypt,this.isEnableSignEncrypt),this.signAndSend=ko.observable(!1)}var _=require("underscore"),$=require("jquery"),ko=require("knockout"),TextUtils=require("%PathToCoreWebclientModule%/js/utils/Text.js"),Utils=require("%PathToCoreWebclientModule%/js/utils/Common.js"),App=require("%PathToCoreWebclientModule%/js/App.js"),Screens=require("%PathToCoreWebclientModule%/js/Screens.js"),CAbstractPopup=require("%PathToCoreWebclientModule%/js/popups/CAbstractPopup.js"),ErrorsUtils=require("modules/%ModuleName%/js/utils/Errors.js"),Enums=require("modules/%ModuleName%/js/Enums.js"),OpenPgp=require("modules/%ModuleName%/js/OpenPgp.js");_.extendOwn(CEncryptPopup.prototype,CAbstractPopup.prototype),CEncryptPopup.prototype.PopupTemplate="%ModuleName%_EncryptPopup",CEncryptPopup.prototype.onOpen=function(t,e,s,i,n,o){this.data(t),this.fromEmail(e),this.emails(s),this.okCallback=n,this.cancelCallback=o,this.sign(!0),this.password(""),this.encrypt(!i),this.signAndSend(i)},CEncryptPopup.prototype.executeSignEncrypt=function(){var t=this.data(),e=this.sign()?this.fromEmail():"",s=this.emails(),i=this.sign()?$.trim(this.password()):"",n="",o="",r=_.bind(function(t){this.closePopup(),this.okCallback&&(this.signAndSend()||Screens.showReport(n),this.okCallback(t.result,this.encrypt()))},this),p=function(t){ErrorsUtils.showPgpErrorByCode(t,o)};if(this.encrypt())if(0===s.length)Screens.showError(TextUtils.i18n("%MODULENAME%/ERROR_TO_ENCRYPT_SPECIFY_RECIPIENTS"));else{var l=[this.fromEmail()],c=OpenPgp.findKeysByEmails(l,!0).length>0?_.union(s,l):s;this.sign()?(o=Enums.PgpAction.EncryptSign,n=TextUtils.i18n("%MODULENAME%/REPORT_MESSAGE_SIGNED_ENCRYPTED_SUCCSESSFULLY"),OpenPgp.signAndEncrypt(t,e,c,i,r,p)):(o=Enums.PgpAction.Encrypt,n=TextUtils.i18n("%MODULENAME%/REPORT_MESSAGE_ENCRYPTED_SUCCSESSFULLY"),OpenPgp.encrypt(t,c,r,p))}else this.sign()&&(o=Enums.PgpAction.Sign,n=TextUtils.i18n("%MODULENAME%/REPORT_MESSAGE_SIGNED_SUCCSESSFULLY"),OpenPgp.sign(t,e,i,r,p))},CEncryptPopup.prototype.cancelPopup=function(){this.cancelCallback&&this.cancelCallback(),this.closePopup()},module.exports=new CEncryptPopup;