"use strict";function CShowKeyArmorPopup(){CAbstractPopup.call(this),this.bAllowSendEmails=_.isFunction(ComposeMessageWithAttachments),this.armor=ko.observable(""),this.htmlArmor=ko.computed(function(){return TextUtils.encodeHtml(this.armor().replace(/\r/g,""))},this),this.user=ko.observable(""),this.private=ko.observable(!1),this.popupHeading=ko.computed(function(){return this.private()?TextUtils.i18n("%MODULENAME%/HEADING_VIEW_PRIVATE_KEY",{USER:this.user()}):TextUtils.i18n("%MODULENAME%/HEADING_VIEW_PUBLIC_KEY",{USER:this.user()})},this),this.downloadLinkHref=ko.computed(function(){var e="#",t=null;return Blob&&window.URL&&$.isFunction(window.URL.createObjectURL)&&(t=new Blob([this.armor()],{type:"text/plain"}),e=window.URL.createObjectURL(t)),e},this),this.downloadLinkFilename=ko.computed(function(){var e=this.user().replace(/</g,"").replace(/>/g,""),t=this.private()?"%MODULENAME%/TEXT_PRIVATE_KEY_FILENAME":"%MODULENAME%/TEXT_PUBLIC_KEY_FILENAME";return TextUtils.i18n(t,{USER:e})+".asc"},this),this.domKey=ko.observable(null)}var _=require("underscore"),$=require("jquery"),ko=require("knockout"),TextUtils=require("%PathToCoreWebclientModule%/js/utils/Text.js"),Ajax=require("%PathToCoreWebclientModule%/js/Ajax.js"),ModulesManager=require("%PathToCoreWebclientModule%/js/ModulesManager.js"),Screens=require("%PathToCoreWebclientModule%/js/Screens.js"),ComposeMessageWithAttachments=ModulesManager.run("MailWebclient","getComposeMessageWithAttachments"),CAbstractPopup=require("%PathToCoreWebclientModule%/js/popups/CAbstractPopup.js");_.extendOwn(CShowKeyArmorPopup.prototype,CAbstractPopup.prototype),CShowKeyArmorPopup.prototype.PopupTemplate="%ModuleName%_ShowKeyArmorPopup",CShowKeyArmorPopup.prototype.onOpen=function(e){this.armor(e.getArmor()),this.user(e.getUser()),this.private(e.isPrivate())},CShowKeyArmorPopup.prototype.send=function(){this.bAllowSendEmails&&""!==this.armor()&&""!==this.downloadLinkFilename()&&Ajax.send("Core","SaveContentAsTempFile",{Content:this.armor(),FileName:this.downloadLinkFilename()},function(e){e.Result&&(ComposeMessageWithAttachments([e.Result]),this.closePopup())},this)},CShowKeyArmorPopup.prototype.select=function(){var e=this.domKey()&&1===this.domKey().length?this.domKey()[0]:null,t=null,o=null;e&&window.getSelection&&document.createRange&&((o=document.createRange()).setStart(e,0),o.setEnd(e,1),(t=window.getSelection()).removeAllRanges(),t.addRange(o),document.queryCommandSupported("copy")&&(document.execCommand("copy"),Screens.showReport(TextUtils.i18n("%MODULENAME%/REPORT_KEY_IN_CLIPBOARD"))))},module.exports=new CShowKeyArmorPopup;