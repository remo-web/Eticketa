"use strict";function CComposeButtonsView(){this.sId="OpenPgp",this.bAllowMobile=!0,this.enableOpenPgp=Settings.enableOpenPgp,this.pgpSecured=ko.observable(!1),this.pgpEncrypted=ko.observable(!1),this.fromDrafts=ko.observable(!1),this.disableHeadersEdit=this.pgpEncrypted,this.disableBodyEdit=this.pgpSecured,this.disableAutosave=this.pgpSecured,this.visibleDoPgpButton=ko.computed(function(){return this.enableOpenPgp()&&(!this.pgpSecured()||this.pgpEncrypted()&&this.fromDrafts())},this),this.visibleUndoPgpButton=ko.computed(function(){return this.enableOpenPgp()&&this.pgpSecured()&&(!this.pgpEncrypted()||!this.fromDrafts())},this),this.isEnableOpenPgpCommand=ko.computed(function(){return this.enableOpenPgp()&&!this.pgpSecured()},this),this.openPgpCommand=Utils.createCommand(this,this.confirmOpenPgp,this.isEnableOpenPgpCommand),this.bComposeModeChanged=!1}var _=require("underscore"),$=require("jquery"),ko=require("knockout"),Utils=require("%PathToCoreWebclientModule%/js/utils/Common.js"),TextUtils=require("%PathToCoreWebclientModule%/js/utils/Text.js"),App=require("%PathToCoreWebclientModule%/js/App.js"),Screens=require("%PathToCoreWebclientModule%/js/Screens.js"),Popups=require("%PathToCoreWebclientModule%/js/Popups.js"),ConfirmPopup=require("%PathToCoreWebclientModule%/js/popups/ConfirmPopup.js"),EncryptPopup=require("modules/%ModuleName%/js/popups/EncryptPopup.js"),Settings=require("modules/%ModuleName%/js/Settings.js");CComposeButtonsView.prototype.ViewTemplate=App.isMobile()?"%ModuleName%_ComposeButtonsMobileView":"%ModuleName%_ComposeButtonsView",CComposeButtonsView.prototype.assignComposeExtInterface=function(e){this.oCompose=e},CComposeButtonsView.prototype.doAfterApplyingMainTabParameters=function(e){e.OpenPgp&&(this.pgpSecured(e.OpenPgp.Secured),this.pgpEncrypted(e.OpenPgp.Encrypted),this.fromDrafts(e.OpenPgp.FromDrafts),(this.pgpSecured()||this.pgpEncrypted())&&this.fromDrafts(!0))},CComposeButtonsView.prototype.doAfterPreparingMainTabParameters=function(e){e.OpenPgp={Secured:this.pgpSecured(),Encrypted:this.pgpEncrypted(),FromDrafts:this.fromDrafts()}},CComposeButtonsView.prototype.doAfterPopulatingMessage=function(e){if(this.bComposeModeChanged=!1,this.fromDrafts(e.bDraft),e.bPlain){var t=-1!==e.sRawText.indexOf("-----BEGIN PGP MESSAGE-----"),o=-1!==e.sRawText.indexOf("-----BEGIN PGP SIGNED MESSAGE-----");this.pgpSecured(o||t),this.pgpEncrypted(t)}else this.pgpSecured(!1),this.pgpEncrypted(!1)},CComposeButtonsView.prototype.doBeforeSend=function(e){return!(!this.enableOpenPgp()||!Settings.AutosignOutgoingEmails||this.pgpSecured())&&(this.openPgpPopup(e),!0)},CComposeButtonsView.prototype.doBeforeSave=function(e){return!!this.pgpSecured()&&(Popups.showPopup(ConfirmPopup,[TextUtils.i18n("%MODULENAME%/CONFIRM_SAVE_ENCRYPTED_DRAFT"),e,"",TextUtils.i18n("COREWEBCLIENT/ACTION_SAVE")]),!0)},CComposeButtonsView.prototype.confirmOpenPgp=function(){if(this.oCompose)if(this.oCompose.getRecipientEmails().length<1)Screens.showError(TextUtils.i18n("%MODULENAME%/ERROR_TO_ENCRYPT_SPECIFY_RECIPIENTS"));else if(this.oCompose.isHtml()){var e=TextUtils.i18n("%MODULENAME%/CONFIRM_HTML_TO_PLAIN_FORMATTING"),t=_.bind(function(e){e&&this.openPgpPopup()},this);this.oCompose.hasAttachments()&&(e+="\r\n\r\n"+TextUtils.i18n("%MODULENAME%/CONFIRM_HTML_TO_PLAIN_ATTACHMENTS")),Popups.showPopup(ConfirmPopup,[e,t])}else this.openPgpPopup()},CComposeButtonsView.prototype.openPgpPopup=function(e){if(this.oCompose){var t=$.isFunction(e),o=_.bind(function(o,p){this.oCompose.isHtml()&&(this.oCompose.setPlainTextMode(),this.bComposeModeChanged=!0),this.oCompose.setPlainText(o),t&&e(),this.pgpSecured(!0),this.pgpEncrypted(p)},this),p=t?e:function(){};Popups.showPopup(EncryptPopup,[this.oCompose.getPlainText(),this.oCompose.getFromEmail(),this.oCompose.getRecipientEmails(),t,o,p])}},CComposeButtonsView.prototype.undoPgp=function(){var e="",t=[];this.oCompose&&this.pgpSecured()&&(this.bComposeModeChanged&&(this.oCompose.setHtmlTextMode(),this.bComposeModeChanged=!1),this.fromDrafts()&&!this.pgpEncrypted()?(2===(t=(e=this.oCompose.getPlainText()).split("-----BEGIN PGP SIGNED MESSAGE-----")).length&&(e=t[1]),2===(t=e.split("-----BEGIN PGP SIGNATURE-----")).length&&(e=t[0]),(t=e.split("\r\n\r\n")).length>0&&(t.shift(),e=t.join("\r\n\r\n")),this.oCompose.isHtml()?this.oCompose.setHtmlText("<div>"+e.replace(/\r\n/gi,"<br />")+"</div>"):this.oCompose.setPlainText(e)):this.oCompose.undoHtml(),this.pgpSecured(!1),this.pgpEncrypted(!1))},module.exports=new CComposeButtonsView;