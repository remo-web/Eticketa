!function(){function e(e){var t=e||n,o=(window.innerHeight-t.offsetHeight)/2,a=(window.innerWidth-t.offsetWidth)/2,s=t.getBoundingClientRect();assert.closeTo(s.top,o,1,"top should be nearby"),assert.closeTo(s.left,a,1,"left should be nearby")}function t(e,t){var o=document.createEvent("Events");return o.initEvent(t||"keydown",!0,!0),o.keyCode=e,o.which=e,o}function o(e){var t=document.createElement("dialog");return t.innerHTML=e||"Dialog #"+a.length,document.body.appendChild(t),"?force"==window.location.search?dialogPolyfill.forceRegisterDialog(t):dialogPolyfill.registerDialog(t),a(t)}var n,a=function(){var e=[];return teardown(function(){e.forEach(function(e){try{e.close()}catch(e){}e.parentElement&&e.parentElement.removeChild(e)}),e=[]}),function(t){return e.push(t),t}}();setup(function(){n=o("Default Dialog")}),suite("basic",function(){test("show and close",function(){assert.isFalse(n.hasAttribute("open")),n.show(),assert.isTrue(n.hasAttribute("open")),assert.isTrue(n.open);n.close(1234),assert.isFalse(n.hasAttribute("open")),assert.equal(n.returnValue,1234),n.show(),n.close(),assert.isFalse(n.open),assert.equal(n.returnValue,1234)}),test("open property",function(){assert.isFalse(n.hasAttribute("open")),n.show(),assert.isTrue(n.hasAttribute("open")),assert.isTrue(n.open),n.open=!1,assert.isFalse(n.open),assert.isFalse(n.hasAttribute("open"),"open property should clear attribute"),assert.throws(n.close);var e=document.querySelector("._dialog_overlay");assert.isNull(e)}),test("show/showModal interaction",function(){assert.isFalse(n.hasAttribute("open")),n.show();var e=function(){n.show()},t=function(){n.showModal()};assert.doesNotThrow(e),assert.throws(t),n.open=!1,assert.doesNotThrow(t),assert.doesNotThrow(e),assert.throws(t),assert.isTrue(n.open)}),test("setAttribute reflects property",function(){n.setAttribute("open",""),assert.isTrue(n.open,"attribute opens dialog")}),test("changing open to dummy value is ignored",function(){n.showModal(),n.setAttribute("open","dummy, ignored"),assert.isTrue(n.open,"dialog open with dummy open value");var e=document.querySelector("._dialog_overlay");assert(e,"dialog is still modal")}),test("show/showModal outside document",function(){n.open=!1,n.parentNode.removeChild(n),assert.throws(function(){n.showModal()}),assert.doesNotThrow(function(){n.show()}),assert.isTrue(n.open,"can open non-modal outside document"),assert.isFalse(document.body.contains(n))}),test("has a11y property",function(){assert.equal(n.getAttribute("role"),"dialog","role should be dialog")})}),suite("DOM",function(){setup(function(e){n.showModal(),window.setTimeout(e,0)}),test("DOM direct removal",function(e){assert.isTrue(n.open),assert.isNotNull(document.querySelector(".backdrop"));var t=n.parentNode;t.removeChild(n),window.setTimeout(function(){assert.isNull(document.querySelector(".backdrop"),"dialog removal should clear modal"),assert.isTrue(n.open,"removed dialog should still be open"),t.appendChild(n),assert.isTrue(n.open,"re-added dialog should still be open"),assert.isNull(document.querySelector(".backdrop"),"re-add dialog should not be modal"),e()},0)}),test("DOM removal inside other element",function(e){var t=a(document.createElement("div"));document.body.appendChild(t),t.appendChild(n),document.body.removeChild(t),window.setTimeout(function(){assert.isNull(document.querySelector(".backdrop"),"dialog removal should clear modal"),assert.isTrue(n.open,"removed dialog should still be open"),e()},0)}),test("DOM instant remove/add",function(e){var t=a(document.createElement("div"));document.body.appendChild(t),n.parentNode.removeChild(n),t.appendChild(n),window.setTimeout(function(){assert.isNull(document.querySelector(".backdrop"),"backdrop should disappear"),assert.isTrue(n.open),e()},0)})}),suite("position",function(){test("non-modal is not centered",function(){var e=a(document.createElement("div"));n.parentNode.insertBefore(e,n);var t=e.getBoundingClientRect();n.show();var o=n.getBoundingClientRect();assert.equal(o.top,t.top,"dialog should not be centered")}),test("default modal centering",function(){n.showModal(),e(),assert.ok(n.style.top,"expected top to be set"),n.close(),assert.notOk(n.style.top,"expected top to be cleared")}),test("modal respects static position",function(){n.style.top="10px",n.showModal();var e=n.getBoundingClientRect();assert.equal(e.top,10)}),test("modal recentering",function(){var t=document.body.scrollLeft,o=document.body.scrollTop,s=a(document.createElement("div"));s.style.height="200vh",document.body.appendChild(s);try{n.showModal(),n.close(),window.scrollTo(0,200),n.showModal(),e();var l=n.getBoundingClientRect();window.scrollTo(0,0);var d=n.getBoundingClientRect();assert.closeTo(l.top+200,d.top,1)}finally{window.scrollTo(t,o)}}),test("clamped to top of page",function(){var e=a(document.createElement("div"));e.style.height="200vh",document.body.appendChild(e),document.documentElement.scrollTop=document.documentElement.scrollHeight/2,n.style.height=document.documentElement.scrollHeight+200+"px",n.showModal();var t=n.getBoundingClientRect();assert.equal(t.top,0,"large dialog should be visible at top of page");var o=window.getComputedStyle(n);assert.equal(o.top,document.documentElement.scrollTop+"px","large dialog should be absolutely positioned at scroll top")})}),suite("backdrop",function(){test("backdrop div on modal",function(){n.showModal();var e=document.querySelector(".backdrop");assert.isNotNull(e);var t=n.nextElementSibling;assert.strictEqual(e,t)}),test("no backdrop on non-modal",function(){n.show(),assert.isNull(document.querySelector(".backdrop")),n.close()}),test("backdrop click appears as dialog",function(){n.showModal();var e=n.nextElementSibling,t=0;n.addEventListener("click",function(e){assert.equal(e.target,n),++t}),e.click(),assert.equal(t,1)}),test("backdrop click focuses dialog",function(){n.showModal(),n.tabIndex=0;var e=document.createElement("input");e.type="text",n.appendChild(e);n.nextElementSibling.click(),assert.equal(document.activeElement,n)})}),suite("form focus",function(){test("non-modal inside modal is focusable",function(){var e=o();n.appendChild(e);var t=document.createElement("input");t.type="text",e.appendChild(t),n.showModal(),e.show(),t.focus(),assert.equal(t,document.activeElement)}),test("clear focus when nothing focusable in modal",function(){var e=a(document.createElement("input"));e.type="text",document.body.appendChild(e),e.focus();var t=document.activeElement;n.showModal(),assert.notEqual(t,document.activeElement)}),test("default focus on modal",function(){var e=a(document.createElement("input"));e.type="text",n.appendChild(e);var t=a(document.createElement("input"));t.type="text",n.appendChild(t),n.showModal(),assert.equal(document.activeElement,e)}),test("default focus on non-modal",function(){var e=a(document.createElement("div"));e.tabIndex=4,n.appendChild(e),n.show(),assert.equal(document.activeElement,e)}),test("autofocus element chosen",function(){var e=a(document.createElement("input"));e.type="text",n.appendChild(e);var t=a(document.createElement("input"));t.type="text",t.autofocus=!0,n.appendChild(t),n.showModal(),assert.equal(document.activeElement,t)}),test("child modal dialog",function(){n.showModal();var e=a(document.createElement("input"));e.type="text",n.appendChild(e),e.focus(),assert.equal(document.activeElement,e);var t=o();t.showModal(),assert.notEqual(document.activeElement,e,"additional modal dialog should clear parent focus"),t.close(),assert.notEqual(document.activeElement,e,"parent focus should not be restored")}),test("don't scroll anything into focus",function(){var e=a(document.createElement("div"));document.body.appendChild(e);var t=document.createElement("div");t.style.height="10000px",e.appendChild(t),e.appendChild(n);var o=a(document.createElement("input"));o.type="text",n.appendChild(o);var s=document.documentElement.scrollTop;n.showModal(),assert.equal(document.documentElement.scrollTop,s)})}),suite("top layer / inert",function(){test("background focus allowed on non-modal",function(){var e=a(document.createElement("input"));e.type="text",document.body.appendChild(e),e.focus(),n.show(),assert.notEqual(document.activeElement,e,"non-modal dialog should clear focus, even with no dialog content"),document.body.focus(),e.focus(),assert.equal(document.activeElement,e,"non-modal should allow background focus")}),test("modal disallows background focus",function(){var e=a(document.createElement("input"));e.type="text",document.body.appendChild(e),n.showModal(),e.focus(),document.hasFocus()||(console.warn("background focus test requires document focus"),document.documentElement.focus()),assert.notEqual(document.activeElement,e,"modal should disallow background focus")}),test("overlay is a sibling of topmost dialog",function(){var e=a(document.createElement("div"));e.style.opacity=.8,document.body.appendChild(e),e.appendChild(n),n.showModal();var t=document.querySelector("._dialog_overlay");assert.isNotNull(t),assert.equal(t.parentNode,n.parentNode)}),test("overlay is between topmost and remaining dialogs",function(){n.showModal();var e=a(o());document.body.appendChild(e),e.showModal();var t=document.querySelector("._dialog_overlay");assert.isNotNull(t),assert.equal(t.parentNode,e.parentNode),assert.isAbove(+e.style.zIndex,+t.style.zIndex,"top-most dialog above overlay"),assert.isAbove(+t.style.zIndex,+n.style.zIndex,"overlay above other dialogs")})}),suite("events",function(){test("close event",function(){var e=0;n.addEventListener("close",function(){++e}),n.show(),assert.equal(e,0),n.close(),assert.equal(e,1),assert.throws(n.close),assert.equal(e,1),n.showModal(),n.close(),assert.equal(e,2)}),test("cancel event",function(){n.showModal(),n.dispatchEvent(t(27)),assert.isFalse(n.open,"esc should close modal");var e=0;n.addEventListener("cancel",function(){++e}),n.showModal(),n.dispatchEvent(t(27)),assert.equal(e,1,"expected cancel to be fired"),assert.isFalse(n.open),n.show(),n.dispatchEvent(t(27)),assert.isTrue(n.open,"esc should only close modal dialog"),assert.equal(e,1)}),test("overlay click is prevented",function(){n.showModal();var e=document.querySelector("._dialog_overlay");assert.isNotNull(e);var t=function(e){throw Error("body should not be clicked")};try{document.body.addEventListener("click",t),e.click()}finally{document.body.removeEventListener("click",t)}})}),suite("form",function(){test("method attribute is translated to property",function(){var e=document.createElement("form");e.method="dialog",assert.equal(e.method,"dialog"),e.method="PoSt",assert.equal(e.method,"post"),assert.equal(e.getAttribute("method"),"PoSt")}),test("dialog method input",function(){var e="ExpectedValue"+Math.random(),t=document.createElement("form");try{t.method="dialog"}catch(e){t.setAttribute("method","dialog")}n.appendChild(t);var o=document.createElement("input");o.type="submit",o.value=e,t.appendChild(o),n.show(),o.focus(),o.click(),assert.isFalse(n.open),assert.equal(n.returnValue,e)}),test("dialog with button preventDefault does not trigger submit",function(){var e=document.createElement("form");e.setAttribute("method","dialog"),n.appendChild(e);var t=document.createElement("button");t.value="does not matter",e.appendChild(t),t.addEventListener("click",function(e){e.preventDefault()}),n.showModal(),t.click(),assert.isTrue(n.open,"dialog should remain open"),assert.equal(n.returnValue,"")}),test("dialog programmatic submit does not change returnValue",function(){var e=document.createElement("form");e.setAttribute("method","dialog"),n.returnValue="manually set",n.appendChild(e),n.showModal(),e.submit(),assert.isFalse(n.open),assert.equal(n.returnValue,"manually set","returnValue should not change")}),test("dialog method button",function(){var e="ExpectedValue"+Math.random(),t=document.createElement("form");t.setAttribute("method","dialog"),n.appendChild(t);var o=document.createElement("button");o.value=e,t.appendChild(o),n.showModal(),o.focus(),o.click(),assert.isFalse(n.open),assert.equal(n.returnValue,e),o.value="blah blah",o.removeAttribute("value"),o.textContent=e,n.show(),o.focus(),o.click(),assert.equal(n.returnValue,o.value,"don't take button textContent as value")}),test("boring form inside dialog",function(){var e=document.createElement("form");n.appendChild(e),e.addEventListener("submit",function(e){e.preventDefault()});var t=document.createElement("button");t.value="Moot",e.appendChild(t),n.showModal(),t.focus(),t.click(),assert.isTrue(n.open,"non-dialog form should not close dialog"),assert(!n.returnValue)}),test('type="image" submitter',function(){var e=document.createElement("form");e.setAttribute("method","dialog"),n.appendChild(e),n.show();var t=document.createElement("input");t.type="image",t.src="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==",t.setAttribute("value","image should not accept value"),e.appendChild(t),t.click(),assert.notEqual(t.getAttribute("value"),n.returnValue),assert.equal(n.returnValue,"0,0")}),test("form submitter across dialogs",function(){var e=document.createElement("form");e.setAttribute("method","dialog"),n.appendChild(e);var t=document.createElement("button");t.value="from form1: first value",e.appendChild(t),n.showModal();var a=o();a.returnValue="dialog2 default close value";var s=document.createElement("form");s.setAttribute("method","dialog"),a.appendChild(s),a.showModal(),t.click(),assert.isFalse(n.open),s.submit(),assert.isFalse(a.open),assert.equal(a.returnValue,"dialog2 default close value","second dialog shouldn't reuse formSubmitter")})}),suite("order",function(){test("non-modal unchanged",function(){var e=o(),t=o();e.style.zIndex=100,t.style.zIndex=200,e.show(),t.show(),assert.equal(window.getComputedStyle(e).zIndex,100),assert.equal(window.getComputedStyle(t).zIndex,200),t.close(),assert.equal(window.getComputedStyle(t).zIndex,200)}),test("modal stacking order",function(){n.showModal();var e=o(),t=o();e.style.zIndex=100,t.style.zIndex=200,t.showModal(),e.showModal();var a=+window.getComputedStyle(e).zIndex,s=+window.getComputedStyle(t).zIndex;assert.isAbove(a,s,"showModal order dictates z-index");var l=t.nextElementSibling,d=+window.getComputedStyle(l).zIndex;assert.equal(l.className,"backdrop"),assert.isBelow(d,s,"backdrop below dialog");var r=e.nextElementSibling,u=+window.getComputedStyle(r).zIndex;assert.equal(r.className,"backdrop"),assert.isBelow(u,a," backdrop below dialog"),assert.isAbove(u,s,"front backdrop is above back dialog"),e.close(),assert.notOk(e.style.zIndex,"modal close should clear zindex")})}),suite("press tab key",function(){test("tab key",function(){var e=o();e.showModal(),document.documentElement.dispatchEvent(t(9));var n=document.createEvent("Events");n.initEvent("focus",!0,!0),document.documentElement.dispatchEvent(n),e.close()})})}();